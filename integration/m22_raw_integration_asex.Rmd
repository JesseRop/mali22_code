---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  # library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(slingshot)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
})
```







# MSC Preprocessing


## setup, read input files and exploratory visualizations and general functions


```{r, setup}
# library(reticulate)
# # use_condaenv("/Users/jr35/envs/scv_jupcon/", required = TRUE)
# # matplotlib <- reticulate::import("matplotlib")
# # matplotlib$use("Agg", force = TRUE)
# 
# knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali')
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
```



########START TRY SCT ########
Integrated asexual to integrate with the rescued parasites
```{r}
## subset where field parasites are for slingshot
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_ss_res_fld_pt.RDS")
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_res_fld_pt.RDS")
v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/all_msc_cb_no_dbt_mrg_noM12_asex.RDS")

# %in% c("MSC25" ,"MSC41", "MSC51")

```


########################################START## !!! CHEATING - SHORTCUT FOR REPLACING COUNTS WITH LATEST CELLRANGER COUNTS 
THIS WILL BECOME REDUNDANT ONCE I DO A CLEAN ANALYSIS FROM THE START ########################################## 

######## Replace the counts with new counts including pseudogenes and noncoding RNA among other features that were missing in the original

```{r}
all_msc_bp_raw_noHsGns <- readRDS("data/processed/Pf/m2_all/all_msc_bp_raw_noHsGns.RDS")
```

```{r}
v3_m2_asex_harmony_ss_res_fld_pt_list <- SplitObject(v3_m2_asex_harmony_ss_res_fld_pt, split.by = "orig.ident")
```

```{r}
names(v3_m2_asex_harmony_ss_res_fld_pt_list) <- str_remove(names(v3_m2_asex_harmony_ss_res_fld_pt_list), ".mrna")
```

```{r}
m2_asex_raw_list <- map2(all_msc_bp_raw_noHsGns[names(v3_m2_asex_harmony_ss_res_fld_pt_list)], v3_m2_asex_harmony_ss_res_fld_pt_list, ~.x[,str_remove(colnames(.y), "M.*_")])
```

```{r}
m2_asex_raw_list <- m2_asex_raw_list[unlist(map(m2_asex_raw_list, ~dim(.x)[2] >=50))]
```

```{r}
m2_asex_raw_mrg <- merge(m2_asex_raw_list[[1]], m2_asex_raw_list[2:length(m2_asex_raw_list)], add.cell.ids = str_remove(names(m2_asex_raw_list), "SC"))
```


```{r}
m2_asex_raw_mrg <- AddMetaData(m2_asex_raw_mrg, v3_m2_asex_harmony_ss_res_fld_pt@meta.data[,!colnames(v3_m2_asex_harmony_ss_res_fld_pt@meta.data) %in% colnames(m2_asex_raw_mrg@meta.data)])
```

```{r}
## rRNA_gns
gff <- data.table::fread("/lustre/scratch126/tol/teams/lawniczak/users/jr35/Pf3D7_genomes_gtfs_indexs/PlasmoDB-68_Pfalciparum3D7.gff", skip = 18)
```

```{r}

gff = gff %>% 
  filter(!str_detect(V9, "Parent")) %>% 
  mutate(biotype = str_remove(V9, ".*ebi_biotype="),
         gene_id = str_replace(str_remove_all(str_extract(V9, "ID=PF3D7_.*[0-9]+"), "ID=|;.*"), "_", "-"))
```

```{r}

gff %>% glimpse
```

```{r}

gff %>%count(V3, biotype)
```

```{r}
## Get trnas, snRNA, snoRNA for later removal
gff %>% filter(biotype %in% c("snRNA", "snoRNA", "tRNA")) 
```

```{r}
## Get trnas, snRNA, snoRNA for later removal
t_sn_sno_rnas <- gff %>% filter(biotype %in% c("snRNA", "snoRNA", "tRNA")) %>% pull("gene_id")
```


```{r}
## rRNA_gns
rRNA_gns <- c("PF3D7-0112300", "PF3D7-0112500", "PF3D7-0112700", "PF3D7-0531600", "PF3D7-0531800", "PF3D7-0532000", "PF3D7-0725600", "PF3D7-0725800", "PF3D7-0726000", "PF3D7-0830000", "PF3D7-0830200", "PF3D7-1148600", "PF3D7-1371000", "PF3D7-1371200", "PF3D7-1371300", "PF3D7-1418500", "PF3D7-1418600", "PF3D7-1418700", "PF3D7-API04900",  "PF3D7-API05700")

```


```{r}
## Remove rRNA_gns genes as is standard in literature - may be due to conserved with humans and other organisms
m2_asex_raw_mrg <- m2_asex_raw_mrg[!(rownames(m2_asex_raw_mrg) %in% rRNA_gns),]
```

########################################END## !!! CHEATING - SHORTCUT FOR REPLACING COUNTS WITH LATEST CELLRANGER COUNTS 
THIS WILL BECOME REDUNDANT ONCE I DO A CLEAN ANALYSIS FROM THE START ########################################## 

```{r, warning=FALSE, message=FALSE}
# split layers
# v3_m2_asex_cr_filt[["RNA"]] <- split(v3_m2_asex_cr_filt[["RNA"]], f = v3_m2_asex_cr_filt$donor)

```


############################


```{r}
## read in 
# all_resc_asex_sct_ap2g <- readRDS("data/processed/Pf/m2_all/all_resc_asex_sct_ap2g.RDS")

```

Integrated asexual to integrate with the rescued parasites
```{r}
## subset where field parasites are for slingshot
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_ss_res_fld_pt.RDS")
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_res_fld_pt.RDS")
# %in% c("MSC25" ,"MSC41", "MSC51")

```


########START TRY SCT ########

Integrated asexual to integrate with the rescued parasites
```{r}
## subset where field parasites are for slingshot
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_ss_res_fld_pt.RDS")
# v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_res_fld_pt.RDS")
# %in% c("MSC25" ,"MSC41", "MSC51")

```

```{r, warning=FALSE, message=FALSE}
m2_asex_raw_mrg@meta.data %>% count(sR_fine_stg)
```

```{r, warning=FALSE, message=FALSE}
m2_asex_raw_mrg <- m2_asex_raw_mrg@meta.data %>% 
  rownames_to_column('bcode') %>%
  mutate(dset_labmrg = "Field",
         stage = case_when(sR_fine_stg == "Gametocyte (developing)" ~ "Early ring", 
                           T ~ sR_fine_stg),
         donor = str_remove_all(orig.ident, ".mrna")) %>% 
  add_count(donor, name = "don_count") %>%
  select(bcode, dset_labmrg, donor, don_count, stage) %>%
  column_to_rownames('bcode') %>%
  AddMetaData(m2_asex_raw_mrg, .)
  
```



```{r, warning=FALSE, message=FALSE}
m2_asex_raw_mrg@meta.data %>% dplyr::count(donor, dset_labmrg)
```

```{r}
## remove lab and M12
v3_m2_asex_cr_filt_all <- m2_asex_raw_mrg[, !m2_asex_raw_mrg@meta.data$dset_labmrg %in% c("Lab", "MSC12")]
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_all@meta.data %>% count(donor, sR_fine_stg) %>% group_by(donor) %>% mutate(prop = round(n/sum(n), 3)) %>% filter(sR_fine_stg == "Gametocyte (developing)")
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_all@meta.data %>% add_count(sR_fine_stg, name = "stg_n") %>% group_by() %>% dplyr::count(donor)
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_all@meta.data %>% filter(sR_fine_stg == "Gametocyte (developing)") %>% dplyr::count(donor)
```

```{r, eval=T}
## Making list of objects and renaming before integrating
# v3_m2_asex_cr_filt <- subset(v3_m2_asex_cr_filt, subset = donor != "MSC55")

```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_all@meta.data %>% dplyr::count(donor, dset_labmrg)
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_all@meta.data %>% add_count(donor) %>% dplyr::filter( n < 100)
```

```{r}
## remove weird 2 cells with >9000 ncountRNA
VlnPlot(v3_m2_asex_cr_filt_all, features = "nCount_RNA") + geom_hline(yintercept = 9000)
```

```{r}
## remove weird 2 cells with >9000 ncountRNA
table(v3_m2_asex_cr_filt_all@meta.data$nCount_RNA >9000)
v3_m2_asex_cr_filt_all <- v3_m2_asex_cr_filt_all[, !v3_m2_asex_cr_filt_all@meta.data$nCount_RNA >9000]
```

```{r}
## remove any donor with less than 100 cells
v3_m2_asex_cr_filt_all <- v3_m2_asex_cr_filt_all[, !v3_m2_asex_cr_filt_all@meta.data$don_count < 150]
```


```{r}
saveRDS(v3_m2_asex_cr_filt_all, "data/processed/Pf/m2_all/v3_m2_asex_cr_filt_all.RDS")
```

```{r}
## remove any donor with less than 100 cells and donor MSC55
v3_m2_asex_cr_filt_noM55 <- v3_m2_asex_cr_filt_all[, !v3_m2_asex_cr_filt_all@meta.data$donor == "MSC55"]
```

```{r}
## remove any donor with less than 100 cells and donor MSC55
saveRDS(v3_m2_asex_cr_filt_noM55, "data/processed/Pf/m2_all/v3_m2_asex_cr_filt_noM55.RDS")
```


```{r, eval=T}
gogo()
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_integration_bsub.sh

```


```{r, eval=T}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_intgrtn_pc_harmony_bsub.sh

```

```{r, message=F, warning=F}
# ##Read BPcells matrices
# v3_m2_asex_cr_filt_norm_harmony <- list.files("data/processed/Pf", pattern = "v3_m2_asex_cr_(filt|filt_noM55)_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/m2_all/v3_m2_asex_cr_|_norm.*'))) %>% 
#   # .[sample_name] %>%
#   map(readRDS)

```

```{r, message=F, warning=F}
##Read BPcells matrices
v3_m2_asex_cr_filt_norm_harmony <- list.files("data/processed/Pf", pattern = "v3_m2_asex_cr_filt_(all|noM55)_norm_harmony_PC_man.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/m2_all/v3_m2_asex_cr_filt_|_norm.*'))) %>% 
  # .[sample_name] %>%
  map(readRDS)

```

```{r, warning=FALSE, message=FALSE}
# # v3_m2_asex_cr_filt_norm_harmony <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_norm_harmony.RDS")
# v3_m2_asex_cr_filt_norm_harmony <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_norm_harmony_pc_man.RDS")
# 
# ### 1. Run on asexuals after QC with PC specified manually
# # --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/v3_m2_asex_cr_filt_norm.RDS" \ 
# # --mthd_nm "harmony_pc_man" --cluster_resoln 0.4 --intgrtn_pc 6 --integrtd_pc_man "yes" \
# # --ncores "10" --mem "100 GB" --run_time="1.hour"

```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_norm_harmony_elbo <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_norm_harmony_elbo.RDS")
v3_m2_asex_cr_filt_norm_harmony_elbo
```

```{r, warning=FALSE, message=FALSE}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "integrated.harmony_PC_man"))
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man"))
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, group.by = "stage", reduction = "umap.harmony_PC_man") + scale_color_manual(values = sp_fld_colors))
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, group.by = "donor", reduction = "umap.harmony_PC_man"))
map(v3_m2_asex_cr_filt_norm_harmony, ~FeaturePlot(.x, features = "nFeature_RNA", reduction = "umap.harmony_PC_man"))
map(v3_m2_asex_cr_filt_norm_harmony, ~FeaturePlot(.x, features = "nCount_RNA", reduction = "umap.harmony_PC_man"))
# VlnPlot(v3_m2_asex_cr_filt_norm_harmony, features = "nCount_RNA", group.by = "seurat_clusters", reduction = "umap.harmony_PC_man")

```



```{r, warning=FALSE, message=FALSE}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, group.by = "stage", reduction = "umap.harmony_PC_man") + scale_color_manual(values = sp_col_new))

```

```{r, warning=FALSE, message=FALSE, fig.width= 15, fig.height=4}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, split.by = "stage", reduction = "umap.harmony_PC_man", pt.size = 0.0001) )

```

```{r, warning=FALSE, message=FALSE, fig.width=12, fig.height=3}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", split.by = 'donor'))

```

```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_cr_filt_norm_harmony[[1]]@reductions[["umap.harmony_PC_man"]]@cell.embeddings),
        x = ~umapharmonyPCman_1, y = ~umapharmonyPCman_2, z = ~umapharmonyPCman_3,
        color= v3_m2_asex_cr_filt_norm_harmony[[1]]@meta.data$sR_fine_stg,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.1, 
        type = 'scatter3d'
)

```


############# START find all markers to test for merozoites #############

```{r, warning=FALSE, message=FALSE}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_PC_man_clusters"))

```

```{r, warning=FALSE, message=FALSE}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_pc_man_clusters", dims = c(1,3)))

```

```{r, warning=FALSE, message=FALSE}
map(v3_m2_asex_cr_filt_norm_harmony, ~DimPlot(.x, label = T, reduction = "integrated.harmony_PC_man", group.by = "harmony_pc_man_clusters", dims = c(2,3)))

```



```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_norm_harmony_jnd <- map(v3_m2_asex_cr_filt_norm_harmony, ~JoinLayers(.x))
map(v3_m2_asex_cr_filt_norm_harmony_jnd, ~DefaultAssay(.x))
map(v3_m2_asex_cr_filt_norm_harmony_jnd, ~unique(Idents(.x)))
```


```{r, warning=FALSE, message=FALSE}
gogo()
```

```{r, warning=FALSE, message=FALSE}
rm(v3_m2_asex_cr_filt_norm_harmony)
```


```{r, warning=FALSE, message=FALSE}
imap(v3_m2_asex_cr_filt_norm_harmony_jnd, ~saveRDS(., paste0("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_", .y,"_norm_harmony_jnd.RDS")))
```

##!!!! NOTE - Below should be deleted if we decide not to use SCT
####################SCT INTEGRATION alternative ####################

```{r, warning=FALSE, message=FALSE}
# split layers
v3_m2_asex_cr_filt[["RNA"]] <- split(v3_m2_asex_cr_filt[["RNA"]], f = v3_m2_asex_cr_filt$donor)

```


```{r, warning=FALSE, message=FALSE}
# run sctransform
v3_m2_asex_cr_filt_sct <- SCTransform(v3_m2_asex_cr_filt, verbose = FALSE, variable.features.n = 400)
# v3_m2_asex_cr_filt_sct <- SCTransform(v3_m2_asex_cr_filt, verbose = FALSE, variable.features.n = 300)
```

```{r, warning=FALSE, message=FALSE}
# These are now standard steps in the Seurat workflow for visualization and clustering
v3_m2_asex_cr_filt_sct <- RunPCA(v3_m2_asex_cr_filt_sct, verbose = FALSE, npcs = 20)

```

```{r, warning=FALSE, message=FALSE}
# run sctransform
DimPlot(v3_m2_asex_cr_filt_sct, reduction = "pca")

```

```{r, warning=FALSE, message=FALSE}
# Error in getGlobalsAndPackages(expr, envir = envir, globals = globals) : 
options(future.globals.maxSize = 1000 * 1024^2)  # 1000 MiB (or 1 GiB)

v3_m2_asex_cr_filt_sct_int <- IntegrateLayers(
  object = v3_m2_asex_cr_filt_sct,
  method = RPCAIntegration,
  normalization.method = "SCT",
  verbose = F,
  # k.weight = 90,
)


```

```{r, warning=FALSE, message=FALSE}

v3_m2_asex_cr_filt_sct_int <- FindNeighbors(v3_m2_asex_cr_filt_sct_int, dims = 1:5, reduction = "integrated.dr")
v3_m2_asex_cr_filt_sct_int <- FindClusters(v3_m2_asex_cr_filt_sct_int, resolution = 0.5)
```

```{r, warning=FALSE, message=FALSE}
# These are now standard steps in the Seurat workflow for visualization and clustering
v3_m2_asex_cr_filt_sct_int <- RunUMAP(v3_m2_asex_cr_filt_sct_int, dims = 1:5, verbose = FALSE, n.components = 3, seed.use = 867)
v3_m2_asex_cr_filt_sct_int <- FindNeighbors(v3_m2_asex_cr_filt_sct_int, dims = 1:5, verbose = FALSE)
v3_m2_asex_cr_filt_sct_int <- FindClusters(v3_m2_asex_cr_filt_sct_int, verbose = FALSE, resolution = 0.1)
```

```{r, warning=FALSE, message=FALSE}
# saveRDS(v3_m2_asex_cr_filt_sct_int, "data/processed/Pf/m2_all/v3_m2_asex_cr_filt_sct_int.RDS")
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_sct_int <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_sct_int.RDS")
```


```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, reduction = "pca")
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T)
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage") + scale_color_manual(values = sp_fld_colors)
DimPlot(v3_m2_asex_cr_filt_sct_int, group.by = "donor")
map(v3_m2_asex_cr_filt_norm_harmony, ~FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "nFeature_RNA")
map(v3_m2_asex_cr_filt_norm_harmony, ~FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "nCount_RNA")
VlnPlot(v3_m2_asex_cr_filt_sct_int, features = "nCount_RNA", group.by = "seurat_clusters")

```


```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_cr_filt_sct_int@reductions[["umap"]]@cell.embeddings),
        x = ~umap_1, y = ~umap_2, z = ~umap_3,
        color= v3_m2_asex_cr_filt_sct_int@meta.data$sR_fine_stg,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.1, 
        type = 'scatter3d'
)

```

```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(2,3))

```

```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, dims = c(1,3))

```


```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, dims = c(1,3))

```

```{r, warning=FALSE, message=FALSE}
## ap2g
DefaultAssay(v3_m2_asex_cr_filt_sct_int) <- "RNA"
v3_m2_asex_cr_filt_sct_int <- NormalizeData(v3_m2_asex_cr_filt_sct_int) 
```

```{r, warning=FALSE, message=FALSE}
## ap2g
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1222600", order = T) 
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1222600", reduction = "pca", order = T) 
```


```{r, warning=FALSE, message=FALSE}
## ap2g
v3_m2_asex_cr_filt_sct_int_ap2g <- subset(v3_m2_asex_cr_filt_sct_int, subset = `PF3D7-1222600` > 0, slot = 'counts')

table(v3_m2_asex_cr_filt_sct_int_ap2g$donor)
```

```{r, warning=FALSE, message=FALSE}
## ap2g
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1215500", order = T) 
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1215500", reduction = "pca", order = T) 
```


```{r, warning=FALSE, message=FALSE}

DefaultAssay(v3_m2_asex_cr_filt_sct_int) <- "SCT"
```



####################SCT INTEGRATION alternative ####################

