---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(scran)
  library(SingleR)
  library(scDblFinder)
  library(duckplyr)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::intersect)
  conflicts_prefer(dplyr::desc)
  conflicts_prefer(dplyr::count)
})
```



# MSC Preprocessing

## setup, read input files and exploratory visualizations and general functions

```{r, setup}

knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source common functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")

```


initialize variable for the sample names

```{r}
# slct_sample_names <-c("MSC48", "MSC68", "MSC14", "MSC49", "MSC60", "MSC66", "MSC67", "MSC70", "MSC24", "MSC33", "MSC40", "MSC54", "MSC55") %>% str_sort(., numeric = T)

```

###################START- RAW READING#############

```{r, eval=T}
pf_all_id_decode <- read_csv("data/raw/pf_all_id_decode.csv")
pf_all_id_decode$sample_nm
```


```{r, eval=T}
# pf_solo_mixed_mdata_decode <- read_csv("data/raw/pf_solo_mixed_mdata_decode.csv")
pf_solo_mixed_mdata_decode <- pf_all_id_decode 

```

## Genotype clustering for MSC

Read in clusters.tsv files with assignment of cells to strains and PCA plots metrics

Transfer clusters.tsv files with assignment of cells to strains and PCA plots metrics for the best K from farm to my local Mac

```{r}

# slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm
# ## get relevant sample names
# pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)
# 
# ##Sample ID
# sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
# smpl_nms <-str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)

```


```{r}
# Remove poor quality samples
# poorQC_samples <- c("MSC1", "MSC24", "MSC37", "MSC38", "MSC39") 
# sample_name <- sample_name[!(sample_name %in% poorQC_samples)] %>% str_sort(., numeric = T)
```

```{r}

slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm
# slct_sample_names <-c("MSC68", "MSC14", "MSC49", "MSC55") %>% str_sort(., numeric = T)


# ## poor quality samples
sample_rm <- c("MSC1", "MSC24", "MSC36", "MSC37", "MSC38", "MSC39")
sample_mxd <- pf_solo_mixed_mdata_decode %>% filter(mixed_infection2 == "mixed") %>% pull(sample_nm)

## slct_sample_names[-c(sample_rm)]
# slct_sample_names <- slct_sample_names[!str_detect(slct_sample_names, paste(c(sample_rm, sample_mxd), collapse = "|"))]

all_samples2rm <- c(sample_rm, sample_mxd)
all_samples2rm <- c(all_samples2rm, paste0(all_samples2rm, "C"), paste0(all_samples2rm, "noJC"))
slct_sample_names <- slct_sample_names[!slct_sample_names %in% all_samples2rm]

## get relevant sample names
pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)

##Sample ID
sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
smpl_nms <-str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)

##Sample IDs
source_irods <- pf_solo_mixed_mdata_decode_slct[,c('sample_nm', 'irods_id')] %>% deframe() %>%.[sample_name]

```


```{r, message=F, warning=F, eval=T}
## Save manual selection of thresholds
man_thresh <- readRDS("data/processed/Pf/m2_all/man_thresh.RDS")
```

Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read BPcells matrices
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))

sample_names <- rep(sample_name, 2) 
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))
# sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))
sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops"), paste0(sample_name, "_cbendr"), paste0(sample_name, "_CbCr"))

# sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops", man_thresh[sample_name]), paste0(sample_name, "_cbendr"))

```



```{r}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/prelim_stage_annotation/submsn_seu_norm_CbEdCr_singleR.sh

```

```{r, message=F, warning=F}
# slct_sample_names <-c("MSC24", "MSC68", "MSC14", "MSC49", "MSC55") %>% str_sort(., numeric = T)
# sample_name_ed_cr <- c(paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))
sample_name_ed_cr <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops"), paste0(sample_name, "_cbendr"), paste0(sample_name, "_cbcr"), paste0(sample_name, "_cbcr"), paste0(sample_name, "_CbendrCr"))

# sample_name_ed_cr <- c(paste0(sample_name, "_edrops", man_thresh[sample_name]), paste0(sample_name, "_cbendr"), paste0(sample_name, "_cr"))

```

```{r, message=F, warning=F}
# Retain only the old cellbender and the new cellbendr_cellranger combination
sample_name_ed_cr_slct <- sample_name_ed_cr[str_detect(sample_name_ed_cr, "CbendrCr|cbendr")]
```

Read in cell annotation singleR processed in farm
```{r, message=F, warning=F}
##Read elbo plots
# all_seu_norm_elbo <- list.files("data/processed/Pf", pattern = "*seu_norm_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|_seu.*|bpc'))) %>% 


all_pref_pred <- list.files("data/processed/Pf", pattern = "bp.*_(cbendr|CbendrCr)_pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>%
# all_pref_pred <- list.files("data/processed/Pf", pattern = "bpc_seu_(cr|cbendr|edrops|cbcr)_pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>%
# all_pref_pred <- list.files("data/processed/Pf", pattern = "bpc_seu_cbendr_pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|bp|_pred.*'))) %>%
# all_pref_pred <- list.files("data/processed/Pf", pattern = "bpseu_.*pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpseu|_pref.*'))) %>% 
  .[sample_name_ed_cr] %>%
  .[sample_name_ed_cr_slct] %>%
  .[!is.na(.)] %>%
  # .[sample_name_ed_cr] %>%
  map(readRDS)

# all_pref_pred
```


```{r}
map(all_pref_pred[1:6], ~table(.x$labels))
```



```{r, eval=FALSE, fig.width=16, fig.height=10}
map(all_pref_pred[1:2], ~plotScoreHeatmap(.x))
```

```{r, eval=FALSE}
map2(all_pref_pred, all_ed_pref_sce[3], ~plotScoreHeatmap(.x, annotation_col=as.data.frame(colData(.y)[,"Is_Cell_50",drop=FALSE])))

```


```{r, eval=FALSE}
map(all_pref_pred, ~{
  to.remove <- is.na(.x$pruned.labels)
  to.remove
  table(Label=.x$labels, Removed=to.remove)
})


```



```{r, eval=FALSE}
map(all_pref_pred[1], ~plotDeltaDistribution(.x))

```




```{r}
# config <- configureMarkerHeatmap(all_pref_pred[[1]], all_ed_pref_sce[[3]], "epsilon")
# mat <- assay(all_ed_pref_sce[[3]], "logcounts")[head(config$rows, 20), config$columns]
# aggregated <- scuttle::summarizeAssayByGroup(mat, config$predictions)
# pheatmap::pheatmap(assay(aggregated), cluster_col=FALSE)
```


```{r}
# map(all_pref_pred, all_ed_pref_sce[3], ~plotMarkerHeatmap(.x, .y, "Male"))

```

```{r}
# collected <- list()
# for (lab in unique(all_pref_pred[[1]]$labels)) {
#   print(lab)
#   collected[[lab]] <- SingleR::plotMarkerHeatmap(results = predictions, test = all_ed_pref_sce[[3]], label = lab)[[4]]
# }

```


```{r}
# config <- configureMarkerHeatmap(predictions, m13_qcd_anotd_sce, "epsilon")
# mat <- assay(m13_qcd_anotd_sce, "logcounts")[head(config$rows, 20), config$columns]
# aggregated <- scuttle::summarizeAssayByGroup(mat, config$predictions)
# pheatmap::pheatmap(assay(aggregated), cluster_col=FALSE)
```


```{r}
# tab <- table(cluster=m13_qcd_anotd_sce$seurat_clusters, label=predictions$labels) 
# pheatmap::pheatmap(log10(tab+10)) # using a larger pseudo-count for smoothing. 
```


```{r}
# scater::plotUMAP(m13_qcd_anotd_sce, colour_by = "seurat_clusters")
```

################## evaluate singleR MAnually

```{r, message=FALSE}
## get predictions for stages
all_pref_pred_df <- map(all_pref_pred, ~.x[, c("scores", "labels", "pruned.labels", "reference")] %>% 
                          as.data.frame() %>% 
                          rename_with(~str_replace_all(., c("\\.\\."="_", "\\."="_", "_$"="")), contains("score")) %>%
                          rownames_to_column("bcode"))
```


```{r, message=FALSE, warning=FALSE}
all_pref_pred_df <- map2(all_pref_pred_df, all_pref_pred, ~{
  df <- .x %>% 
    mutate(sr_score_ref = paste0("scores_", names(.y@listData$orig.results)[reference], "_scores"),
           sr_labl_ref = paste0("scores_", names(.y@listData$orig.results)[reference], "_labels")) 
    
  # df$sR_actl_score <- mapply(function(row, colname) df[row, colname], row = seq_len(nrow(df)), colname = df$sr_score_ref) ## baseR

  df <- df %>% 
    mutate(actl_score = purrr::map2_dbl(row_number(), sr_score_ref, ~df[.x, .y]),
           actl_labl = purrr::map2_chr(row_number(), sr_labl_ref, ~df[.x, .y]),
           MaleFem_consistency = case_when(if_any(ends_with("_labels"), ~str_detect(., "Female")) & if_any(ends_with("_labels"), ~str_detect(., "Male")) ~ "MaleFem",
                                              T ~ labels))
    

  return(df)
  
  
})

```

```{r, message=FALSE, warning=FALSE}

map(all_pref_pred_df, ~.x %>% count(labels, actl_labl, MaleFem_consistency) %>% filter(MaleFem_consistency == "MaleFem"))
```


```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl <- map(all_pref_pred_df, ~.x %>% 
                                         # filter(!is.na(actl_score)) %>% 
                                         select("bcode", "labels", "pruned.labels", "reference", "actl_labl", "actl_score", "MaleFem_consistency") %>% 
                                         mutate(fine_stg = case_when(is.na(pruned.labels) ~ "weak_score",
                                                                     MaleFem_consistency == "MaleFem" ~ "discrepantFM",
                                                                     T ~ pruned.labels),
                                                stage_afm = case_when(str_detect(fine_stg, "ring|troph|schizont|developing") ~ "Asexual",
                                                                      str_detect(fine_stg, "Female") ~ "Female",
                                                                      str_detect(fine_stg, "Male") ~ "Male",
                                                                      T ~ fine_stg),
                                                stage_ag = ifelse(stage_afm %in% c("Female", "Male"), "Gametocyte", stage_afm )) %>%
                                         rename_with(~paste0("sR_", .), .cols = -c(bcode)))
  
```

```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl[1] %>% head
  
```

```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl_merge <- map(all_pref_pred_df_fnl, ~.x %>% 
      select(bcode, sR_fine_stg) ) %>%
  bind_rows(.id = "don_caller") %>% 
  separate_wider_regex(don_caller, c(donor = "MSC.*", "_", caller = "[a-zA-Z].*")) %>%
  pivot_wider(names_from = caller, values_from = sR_fine_stg) %>%
  split(., f = factor(.$donor))

all_pref_pred_df_fnl_snky <- map(all_pref_pred_df_fnl_merge , ~.x %>%  
      mutate(across(any_of(c("cr", "edrops", "cbendr", "CbendrCr")), ~str_replace_all(., c("discrepantFM" = "dFM", "weak_score" = "WS", "Early " = "E", "Late " = "L", "ring" = "R", "trophozoite" = "T", "Female" = "F", "Male" = "M", " \\(LE\\)" = "LE", "Gametocyte \\(developing\\)" = "Gd")))) %>%
        filter(if_any(any_of(c("cr", "edrops", "cbendr", "CbendrCr")), ~!is.na(.x)))
)

  
```


```{r, message=FALSE, warning=FALSE}
sp_col_new_abrv <- sp_col_new
names(sp_col_new_abrv) <- str_replace_all(names(sp_col_new), c("discrepantFM" = "dFM", "weak_score" = "WS", "Early " = "E", "Late " = "L", "ring" = "R", "trophozoite" = "T", "Female" = "F", "Male" = "M", " \\(LE\\)" = "LE", "Gametocyte \\(developing\\)" = "Gd"))

sp_col_new_abrv
```



```{r, fig.width=4, fig.height=4}

snk_pt_fn <- function(decod_tbl, strns_2_plt = c('Strain_2nd', 'n_strains'), labls = paste0("K=", opt_clusters_nms[[3]][1:2]), bp_face = c("bold", "plain"), ttl = "plot", strain_colours = strain_cols_n) {
  decod_tbl %>% 
        mutate(across(contains("train"), ~str_replace_all(., c("Doublet" = "Dbt", "Negative" = "Neg")))) %>%
        make_long(all_of(strns_2_plt)) %>% 
        add_count(x,node, "n") %>%
        ggplot(., aes(x = x, next_x = next_x,node = node,next_node = next_node,fill = factor(node),label = paste0(node,": ",n))) +
            geom_sankey() +
        theme_void()+
        scale_fill_manual(values = strain_colours) +
        scale_x_discrete(labels=labls)+
        geom_sankey_label(size = 3.6, color = 1, fill = "white") +
        labs(title = ttl) +
        theme_sankey(base_size = 9) +
        theme(legend.position = "none",
              axis.title.x = element_blank(),
              axis.text.x = element_text(size = 15, face = bp_face))
      
}


```

```{r, message=FALSE, warning=FALSE}

# imap(all_pref_pred_df_fnl_snky, ~snk_pt_fn(., strns_2_plt = c("cbendr", "edrops", "cr"), labls = c("cbendr", "edrops", "cr"), bp_face = c("bold", "bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
imap(all_pref_pred_df_fnl_snky, ~snk_pt_fn(., strns_2_plt = c("cbendr", "CbendrCr"), labls = c("cbendr", "CbendrCr"), bp_face = c("bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
```


```{r, message=FALSE, warning=FALSE, eval=FALSE}

all_pref_pred_df_fnl_snky_cb_cr <- map(all_pref_pred_df_fnl_snky, ~.x %>% filter(if_any(c(cr, cbendr), ~!is.na(.x))))
all_pref_pred_df_fnl_snky_cb_cr[["MSC3"]] %>% count(cr, cbendr)

```

```{r, message=FALSE, warning=FALSE, eval=FALSE}

imap(all_pref_pred_df_fnl_snky_cb_cr, ~snk_pt_fn(., strns_2_plt = c("cbendr", "cr"), labls = c("cbendr", "cr"), bp_face = c("bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
  
```


```{r, eval=T}
gogo()
```
################## END evaluate singleR MAnually

#### for pseudobulk genotyping

```{r, eval = T}
# !!!!NOTE - MOVE A NOTEBOOK UP
# all_seu_prelim_stg_norm_cb_mdata <- map(all_pref_pred_df_fnl_merge, ~.x %>% mutate(sR_fine_stg = coalesce(cbendr, edrops, cr)) %>% select(bcode, sR_fine_stg)) 
# all_seu_prelim_stg_norm_cb_mdata <- map(all_pref_pred_df_fnl_merge, ~.x %>% mutate(sR_fine_stg = coalesce(cbendr, CbendrCr)) %>% select(bcode, sR_fine_stg)) 
all_seu_prelim_stg_norm_cb_mdata <- map(all_pref_pred_df_fnl_merge, ~.x %>% mutate(sR_fine_stg = CbendrCr) %>% select(bcode, sR_fine_stg)) 
# saveRDS(all_seu_prelim_stg_norm_cb_mdata, "data/processed/Pf/all_seu_prelim_stg_norm_cb_mdata.csv")
species <- "Pf"
sv_dir <- "pbulk_gtypes_preQC_resc"
system(paste0("mkdir -p data/processed/", species, "/" , sv_dir))

# saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/" , sv_dir, "/all_seu_prelim_stg_norm_cb_mdata.RDS"))
# saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/m2_all/all_seu_prelim_stg_norm_cb_mdata.RDS"))
saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/" , sv_dir, "/all_seu_prelim_stg_norm_cb_mdata3.RDS"))
saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/m2_all/all_seu_prelim_stg_norm_cb_mdata3.RDS"))

```


```{r, eval = F}
# # !!!!NOTE - MOVE A NOTEBOOK UP
# all_seu_prelim_stg_norm_cb_mdata <- map(all_seu_prelim_stg_norm, ~.x@meta.data)
# # saveRDS(all_seu_prelim_stg_norm_cb_mdata, "data/processed/Pf/all_seu_prelim_stg_norm_cb_mdata.csv")
# species <- "Pf"
# sv_dir <- "pbulk_gtypes_preQC_resc"
# system(paste0("mkdir -p data/processed/", species, "/" , sv_dir))
# 
# saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/" , sv_dir, "/all_seu_prelim_stg_norm_cb_mdata.csv"))

```


```{r, eval = F}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/prelim_stage_annotation/submsn_scmap_bsub.sh
```

##################################################  END - SingleR use markers to id cells ##################################################

################################################## START - Scmap preliminary annoation #####################################################

```{r}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_CbEdCr_singleR.sh

```

```{r, message=F, warning=F}
##Read BPcells matrices
bpc_seu_prelim_anotd <- list.files("data/processed/Pf", pattern = "bp.*_(CbendrCr)_prelim_anotd.RDS$", full.names = T, recursive = T, include.dirs = T) %>%
# bpc_seu_prelim_anotd <- list.files("data/processed/Pf", pattern = "bpc.*_(cr|cbendr|edrops|cbcr|CbendrCr)_prelim_anotd.RDS$", full.names = T, recursive = T, include.dirs = T) %>%
# bpc_seu_prelim_anotd <- list.files("data/processed/Pf", pattern = "bpc_seu_(cr|cbendr|edrops|cbcr|CbendrCr)_prelim_anotd.RDS$", full.names = T, recursive = T, include.dirs = T) %>%
# bpc_seu_prelim_anotd <- list.files("data/processed/Pf", pattern = "bpc_seu_cbendr_prelim_anotd.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|bp|_prelim_anotd|.RDS'))) %>% 
  .[sample_name_ed_cr] %>%
  .[sample_name_ed_cr_slct] %>%
  .[!is.na(.)] %>%
  # .[sample_name] %>%
  map(readRDS)
```


```{r}
##Modify the stage labels for MSC14

multi_ref_stg_tbl1 <- map(bpc_seu_prelim_anotd, ~{
  obj <- .x
  map(c("stages_mca", "stages_lasse"), ~{
    obj %>% 
  filter(ref == .x ) %>%
  mutate(!!rlang::sym(paste0(.x, "_lf")) := case_when(
    !!rlang::sym(paste0(.x, "_lab")) == "unassigned" & if_any(starts_with("sim_"), ~.x > 0.3) & if_all(starts_with("stage_"), ~str_detect(.x, "ring|rophozoite|eveloping|Ring|chizont")) ~ stage_lab1,
    !!rlang::sym(paste0(.x, "_lab")) == "unassigned" & if_any(starts_with("sim_"), ~.x > 0.4) & if_all(starts_with("stage_"), ~str_detect(.x, "Male| male|\\(male|eveloping")) ~ stage_lab1,
    !!rlang::sym(paste0(.x, "_lab")) == "unassigned" & if_any(starts_with("sim_"), ~.x > 0.4) & if_all(starts_with("stage_"), ~str_detect(.x, "Female|female|eveloping")) ~ stage_lab1,
    TRUE ~ !!rlang::sym(paste0(.x, "_lab"))
  )) #%>%
  #filter(StagePrelim_lf == "unassigned") %>%
  #select(contains("stage"), contains("sim"), StagePrelim_lf, combined_labs)
})
})

```



```{r}
map(multi_ref_stg_tbl1, ~.x[[1]] %>% count(stages_mca_lf, combined_labs))

```

```{r}
# stgtbl1[[1]] %>% filter(stages_mca_lf == "Female", combined_labs == "EarlyRing")
# stgtbl1[[2]] %>% filter(cell_bc == "AAACCCAAGCCTGAGA-1")

```

```{r}
##Modify the stage labels for MSC14
multi_ref_stg_tbl2 <- map(multi_ref_stg_tbl1, ~{
  tbl <- .x
  
  map(tbl, ~.x %>% select(any_of(c('cell_bc', 'stages_mca_lf', 'stages_lasse_lf', 'combined_labs')), contains("sim_"), contains("stage_"))) %>% 
      purrr::reduce(., ~full_join(.x, .y, by = c("cell_bc", "combined_labs"), suffix = c("_mca", "_lasse"))) %>%
  mutate(
    stage_final = case_when(
      combined_labs == "unassigned" & if_any(c('stages_mca_lf', 'stages_lasse_lf'), ~str_detect(.x, "ring|rophozoite|eveloping|Ring|chizont")) ~ stages_lasse_lf, 
      combined_labs == "unassigned" & if_any(c('stages_mca_lf', 'stages_lasse_lf'), ~str_detect(.x, "Male| male|\\(male|eveloping")) ~ stages_mca_lf,  
      combined_labs == "unassigned" & if_any(c('stages_mca_lf', 'stages_lasse_lf'), ~str_detect(.x, "Female|female|eveloping")) ~ stages_mca_lf, 
      T ~ combined_labs),
    stage_final2 = case_when(
      stage_final == "unassigned" & if_any(c('stages_mca_lf', 'stages_lasse_lf'), ~str_detect(.x, "ring|rophozoite|eveloping|Ring|chizont")) ~ stages_mca_lf, 
      T ~ stage_final)
  )
})

```

```{r}
##Modify the stage labels for MSC14
map(multi_ref_stg_tbl2, ~.x %>% filter(stage_final2 == "unassigned") %>% dim() %>% .[1]) %>% data.frame() %>% t()

```

```{r}
##Modify the stage labels for MSC14
map(multi_ref_stg_tbl2, ~.x %>% filter(stage_final2 == "unassigned"))

```

```{r}
## Modify stage annotations to add correct names and retain only necessary columns
multi_ref_stg_tbl2_slct <- map(multi_ref_stg_tbl2, ~ .x %>%
         column_to_rownames("cell_bc") %>%
         select(combined_labs, stage_final, stage_final2) %>% 
         # mutate(across(c(combined_labs, stage_final, stage_final2), ~str_to_sentence(str_remove_all(., " |gametocyte|Gametocyte|\\(|\\)")))) %>% 
         mutate(across(c(stage_final2), ~
           str_replace_all(., c("Trophozoite" = " trophozoite", 
                                "Ring" = " ring",
                                "Schizont" = " schizont", 
                                "early" = "Early",
                                "late" = "Late",
                                "DevelopingGametocyte" = "Gametocyte (developing)",
                                "aleGametocyte" = "ale",
                                "gametocyte" = "Gametocyte",
                                "LE" = "(LE)",
                                "unassigned" = "Unassigned",
                                "Gametocyte \\(male\\)" = "Male",
                                "Gametocyte \\(female\\)" = "Female")))
           ) %>% 
         mutate(stage_fld = str_replace_all(stage_final2, c("Mid trophozoite" = "Early trophozoite", ".*schizont" = "Schizont")),
                stage_afm = case_when(str_detect(stage_fld, "ring|troph|schizont|developing") ~ "Asexual",
                                      str_detect(stage_fld, "Female") ~ "Female",
                                      str_detect(stage_fld, "Male") ~ "Male",
                                      T ~ stage_fld),
                stage_ag = ifelse(stage_afm %in% c("Female", "Male"), "Gametocyte", stage_afm ))
  )

```

################################################## END - Scmap preliminary annoation ################################################## START - Compare scmap with singleR ##############

```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl_cbender <- all_pref_pred_df_fnl[str_detect(names(all_pref_pred_df_fnl), "CbendrCr")] 
  
```

```{r, message=FALSE, warning=FALSE}

singleR_scmap_df_snky <- map2(all_pref_pred_df_fnl_cbender, multi_ref_stg_tbl2_slct[names(all_pref_pred_df_fnl_cbender)], ~.x %>% 
       # rename("stage_final2" = sR_fine_stg) %>%
       select(sR_fine_stg, sR_stage_afm, bcode) %>%
      left_join(., .y %>% 
                  rownames_to_column("bcode") %>% 
                  select(stage_fld, stage_afm, bcode), 
                by = "bcode")  %>%  
      mutate(across(c(stage_fld, sR_fine_stg), ~str_replace_all(., c("discrepantFM" = "dFM", "weak_score" = "WS", "Early " = "E", "Late " = "L", "ring" = "R", "trophozoite" = "T", "Schizont" = "S", "Female" = "F", "Male" = "M", " \\(LE\\)" = "LE", "Gametocyte \\(developing\\)" = "Gd")))) #%>%
        # filter(if_any(c(cr, edrops, cbendr), ~!is.na(.x)))
)

  
```


```{r, message=FALSE, warning=FALSE}

imap(singleR_scmap_df_snky, ~snk_pt_fn(., strns_2_plt = c("sR_fine_stg", "stage_fld"), labls = c("SingleR", "scmap"), bp_face = c("bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
  
```


```{r, message=FALSE, warning=FALSE}

imap(singleR_scmap_df_snky, ~snk_pt_fn(., strns_2_plt = c("sR_stage_afm", "stage_afm"), labls = c("SingleR", "scmap"), bp_face = c("bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
  
```


```{r}
df_counts <-singleR_scmap_df_snky %>%
  bind_rows(.id = "donor") %>%
  filter(!str_detect(donor, "MSC12")) %>%
  filter(sR_stage_afm %in% c("Asexual", "Female", "Male")) %>%
  filter(stage_afm %in% c("Asexual", "Female", "Male")) %>%
  group_by(donor, sR_stage_afm, stage_afm) %>%
  summarise(Count = n(), .groups="drop") %>% 
  group_by(donor) %>%
  mutate(Pct = Count / sum(Count)) %>%
  mutate(sR_don_stg = str_remove_all(paste0(donor, sR_stage_afm), "SC|sexual|emale|ale|cbendr"), 
         scmap_don_stg = str_remove_all(paste0(donor, stage_afm), "SC|sexual|emale|ale|cbendr")) %>% 
  pivot_wider(id_cols = scmap_don_stg, names_from = c(sR_don_stg), values_from = Pct, values_fill = 0)

```

```{r, fig.width=12, fig.height=10}
# Plot faceted heatmaps
df_counts  %>%
  column_to_rownames("scmap_don_stg") %>%
  t() %>%
  ComplexHeatmap::Heatmap(., cluster_rows = F, cluster_columns = F, show_column_names = T, show_row_names = T)
```


```{r, message=FALSE, warning=FALSE, eval=FALSE}

imap(all_pref_pred_df_fnl_snky, ~snk_pt_fn(., strns_2_plt = c("cbendr", "edrops", "cr"), labls = c("cbendr", "edrops", "cr"), bp_face = c("bold", "bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
  
```


################################################## END - Compare scmap with singleR ##############

####### Add annotations to seurat object


```{r, message=F, warning=F}
##Read BPcells matrices
all_seu <- list.files("data/processed/Pf", pattern = "bp_CbendrCr.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
# all_seu <- list.files("data/processed/Pf", pattern = "bpc_seu_(cr|cbendr|edrops|cbcr).RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bp|_norm|.RDS'))) %>% 
# all_seu_norm <- list.files("data/processed/Pf", pattern = "bpc_seu.*_sct.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_sct.*'))) %>% 
  .[sample_name_ed_cr_slct] %>%
  .[!is.na(.)] %>%
  map(readRDS)


```

```{r, message=FALSE}
##Doublet removal
# all_seu_prelim_stg_norm <- list(all_ed_pref_norm, all_pref_pred_df_com_scores_fnl, all_pref_dblt_clst_df, str_remove(names(all_ed_pref), "_.*")) %>%
# all_seu_prelim_stg <- list(all_seu, all_pref_pred_df_fnl) %>%
#   pmap(~ {
#     ..2 %>%
#       column_to_rownames("bcode") %>%
#       AddMetaData(..1, .)
#        })

```

```{r, eval=T}
# gogo()
```


```{r}
## Adding stage annotations to query cells
all_seu_prelim_stg <- list(all_seu, all_pref_pred_df_fnl[names(all_seu)], multi_ref_stg_tbl2_slct[names(all_seu)]) %>%
  pmap(~ ..2 %>%
      column_to_rownames("bcode") %>%
      AddMetaData(..1, .) %>%
      AddMetaData(., ..3) 
  )

```


```{r}
all_seu_prelim_stg %>% map(., ~.x@meta.data %>% count(stage_final2, combined_labs, sR_fine_stg) #%>% 
                                # filter(stage_final2 == "Midtrophozoite")
                              )

```

```{r}
all_seu_prelim_stg %>% map(., ~.x@meta.data %>% count(stage_final2, sR_fine_stg))

```

```{r}
all_seu_prelim_stg %>% map(., ~.x@meta.data %>% count(stage_final2, sR_fine_stg))


```

```{r}
all_seu_prelim_stg %>% map(., ~.x@meta.data %>% 
                                count(stage_final2, combined_labs, sR_fine_stg) %>% 
                                filter(str_detect(sR_fine_stg, "LE"))
                              )

```


```{r, eval=T}
# gogo()
```
###############


```{r, eval=T}
## write out seurat bpcells object files for normalization processing in farm
# imap(all_seu_prelim_stg, ~saveRDS(.x, paste0("data/processed/Pf/",str_remove(.y, "_[cr|ed|cb|Cb].*"), "/seu_obj/bpseu", str_extract(.y, "_[cr|ed|cb|Cb].*"), "_prelim_stg.RDS")))
imap(all_seu_prelim_stg, ~saveRDS(.x, paste0("data/processed/Pf/",str_remove(.y, "_[cr|ed|cb|Cb].*"), "/seu_obj/bp", str_extract(.y, "_[cr|ed|cb|Cb].*"), "_prelim_stg3.RDS")))

```


!!!NB - FARM CODE - DONT DELETE

```{r, eval=T}
# gogo()
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_CbEdCr_bsub.sh
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_sct_CbEdCr_bsub.sh

# --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/bp_CbendrCr_prelim_stg.RDS" \

```
