---
title: "Stage DE figs"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(dreamlet)
  library(muscat)
  # library(ExperimentHub)
  # library(zenith)
  library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  # library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  library(tradeSeq)
  library(ComplexHeatmap)
  library(circlize)
  library(readxl)
  library(ggh4x)
  library(EnhancedVolcano)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::as.factor)
  
})
```


```{r setup}
sample_set = "Mali2"

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```


#  integration of all MSC

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
```


```{r}
read_dir_stage_DE_markers <- "data/processed/Pf/m2_all/stage_DE_markers/"
read_dir_integration <- "data/processed/Pf/m2_all/integration/"
save_dir_stage_DE_markers <- "data/processed/Pf/m2_all/stage_DE_markers/"
published_dset_dir <- "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/published_dsets/"


```


#####!!! DE below in seurat. Already done using scvi. Not sure which one to go with

```{r}
# # Generated in "scvi_leiden_clusters_seuratDE.Rmd"
# all_jcC_seu_scvi_stg_noM55_afm_cln <- readRDS(paste0(read_dir_stage_DE_markers, 'all_jcC_seu_scvi_stg_noM55_afm_cln.RDS'))

# Clean integrated scvi object with the asex+activated_fem doublets removed - Generated in 'scvi_leiden_clusters_doublet_investigations.Rmd'
all_jcC_seu_scvi_noM55_afm_cln <- readRDS(paste0(read_dir_integration, "all_jcC_seu_scvi_noM55_afm_cln.RDS"))


```

```{r, eval=T}
# Generated in "scvi_leiden_clusters_seuratDE.Rmd"
seu_scviLeiden_markers_anot <- readRDS(paste0(read_dir_stage_DE_markers, 'seu_scviLeiden_markers_anot.RDS'))

```

```{r}
# Generated in "scvi_leiden_clusters_seurat_pbulkDE_n_DE_comparisons"
bulk_de_all_stgs_anot <- readRDS(paste0(read_dir_stage_DE_markers, 'bulk_de_all_stgs_anot.RDS'))

```

```{r}
## Read XX generated in XX
all_jcC_seu_scvi_stg_noM55_ActivAsexDbts <- readRDS(paste0(read_dir_integration, "all_jcC_seu_scvi_stg_noM55_ActivAsexDbts.RDS"))

```

```{r}
# generated in 'm2_raw_integration_trial_qcd_DE.ipynb'
scvi_leiden_de_markers <- read.csv("data/processed/Pf/m2_all/scvi/m2_all_scvi_leiden_marker_genes.csv") %>% 
  rename("gene_id" = `X`) %>%
  left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene_id" = "gene_id"))

```


```{r}
# Save for plotting
de_wilcox_bulk_scvi <- readRDS(paste0(read_dir_stage_DE_markers, 'de_wilcox_bulk_scvi.RDS'))

```


```{r}
# dsets to plot
fm_dsets2 <- c("w.5.f", "all.fLE")
```

```{r}
# Generated in 'm2_integration_fm_clustr_gn_explrtn.Rmd'
fm_leiden_w_donors_norm_harmony_jnd_cln_plots <- map(fm_dsets2, ~readRDS(paste0(read_dir_integration, "fm_leiden_w_donors_norm_harmony_jnd_cln_", .x, ".RDS"))) %>% set_names(fm_dsets2)

```

```{r, warning=FALSE, message=FALSE}
fm_leiden_w_donors_norm_harmony_jnd_cln_plots_umap_mdata <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots, ~{
  .x@meta.data %>% 
    rownames_to_column("bcode") %>%
    left_join(., .x@reductions$umap.harmony_PC_man@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode") 
})
```

```{r, warning=FALSE, message=FALSE}
fm_leiden_w_donors_norm_harmony_jnd_cln_plots_umap_mdata <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots_umap_mdata, ~.x %>%
                                                                  mutate(across(harmony_clusters_coarse_bulkDE, as.factor))
)
```


```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_data <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots, ~AverageExpression(.x, group.by = "harmony_clusters_coarse_bulkDE", layer = "data"))
avg_expression_clustrs_counts <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots, ~AverageExpression(.x, group.by = "harmony_clusters_coarse_bulkDE", layer = "counts"))

```


```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_data <- map(avg_expression_clustrs_data, ~.x$RNA %>% as.data.frame() %>% rownames_to_column("gene")) %>% 
  bind_rows(., .id = "dset") %>% 
  pivot_wider(., names_from = dset, values_from = c(g0, g1, g2), names_sep = "_")

```

```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_data %>%
  ggplot(aes(x = `g2_w.5.f_no_asx_dbt`, y = `g2_all.fLE`)) +
  geom_point(size = 0.01) +
  geom_abline()

```

```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_data %>%
  filter(g2_w.5.f_no_asx_dbt < 20 & g2_all.fLE < 20 ) %>%
  ggplot(aes(x = `g2_w.5.f_no_asx_dbt`, y = `g2_all.fLE`)) +
  geom_point(size = 0.01) +
  geom_abline()

```

```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_data %>%
  ggplot(aes(x = `g2_w.5.f_no_asx_dbt`, y = `g2_all.fLE`)) +
  geom_point(size = 0.01) +
  scale_x_log10() +
  scale_y_log10() +
  geom_abline()

```

```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_counts <- map(avg_expression_clustrs_counts, ~.x$RNA %>% as.data.frame() %>% rownames_to_column("gene")) %>% 
  bind_rows(., .id = "dset") %>% 
  pivot_wider(., names_from = dset, values_from = c(g0, g1, g2), names_sep = "_")

```


```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_counts %>%
  ggplot(aes(x = `g2_w.5.f_no_asx_dbt`, y = `g2_all.fLE`)) +
  geom_point(size = 0.01) +
  scale_x_log10() +
  scale_y_log10() +
  geom_abline()

```


```{r, message=FALSE, warning=FALSE, eval=T, fig.width=6, fig.height=3.2}
avg_expression_clustrs_df_counts %>%
  ggplot(aes(x = `g2_w.5.f_no_asx_dbt`, y = `g2_all.fLE`)) +
  geom_point(size = 0.01) +
  scale_x_log10() +
  scale_y_log10() +
  geom_abline()

```



########### START subset the active and non active female and female LE for DE analysis in the main UMAP ################################# 

```{r}
# Generated in "scvi_leiden_clusters_seuratDE.Rmd"
# all_jcC_seu_scvi_stg_noM55_afm_cln <- readRDS(paste0(read_dir_stage_DE_markers, 'all_jcC_seu_scvi_stg_noM55_afm_cln.RDS'))
```


```{r}
## Get barcodes for the relevant subsets
activ_fem <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots_umap_mdata, ~.x %>% filter(harmony_clusters_coarse_bulkDE == "2") %>% pull(bcode)) 
names(activ_fem) <- paste0("ActivFem_", names(activ_fem))

fem <- map(fm_leiden_w_donors_norm_harmony_jnd_cln_plots_umap_mdata, ~.x %>% filter(harmony_clusters_coarse_bulkDE != "2") %>% pull(bcode)) 
names(fem) <- paste0("Fem_", names(fem))
```

```{r}
seu_scvi_fem_sub_clusters <- all_jcC_seu_scvi_noM55_afm_cln[[1]]@meta.data %>%
  rownames_to_column("bcode") %>%
  mutate(fem_subclusters = case_when(bcode %in% activ_fem[["ActivFem_w.5.f_no_asx_dbt"]] ~ "ActivFem",
                                     bcode %in% activ_fem[["ActivFem_all.fLE"]] ~ "ActivFemLE",
                                     bcode %in% fem[["Fem_w.5.f_no_asx_dbt"]] ~ "Female",
                                     bcode %in% fem[["Fem_all.fLE"]] ~ "Female (LE)",
                                     T ~ "Rest")) %>%
  select(bcode, fem_subclusters) %>% 
  column_to_rownames("bcode") %>% 
  AddMetaData(all_jcC_seu_scvi_noM55_afm_cln[[1]], .)

```


```{r}
seu_scvi_fem_sub_clusters <- subset(seu_scvi_fem_sub_clusters, subset = fem_subclusters != "Rest")
seu_scvi_fem_sub_clusters <- list(seu_scvi_fem_sub_clusters)

```

```{r}
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "fem_subclusters") )

```

```{r}
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "fem_subclusters") + geom_hline(yintercept = 10) + geom_vline(xintercept = 5) )

```


```{r}
seu_scvi_fem_sub_clusters <- map(seu_scvi_fem_sub_clusters, ~.x[,.x@reductions$scvi_umap@cell.embeddings[,"umap_1"] >5 & .x@reductions$scvi_umap@cell.embeddings[,"umap_2"] <10])

```

```{r}
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "fem_subclusters"))

```

Retain only those genes expressed in atleast 20 cells for DE
```{r, warning=FALSE, message=FALSE}
seu_scvi_fem_sub_clusters <- map(seu_scvi_fem_sub_clusters, ~{
  
  counts <- GetAssayData(.x, slot = "counts")
  
  keep_genes <- rowSums(counts > 0) >= 20   # expressed in â‰¥10 cells
  # seurat_obj <- subset(seurat_obj, features = rowSums(GetAssayData(seurat_obj, slot="counts") > 0) > 10)
  
  subset(.x, features = rownames(counts)[keep_genes])
  
})
```

```{r}
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "fem_subclusters") + scale_color_manual(values = sp_fld_colors2)) 

```


```{r}
# seu_scvi_fem_sub_clusters <- list(seu_scvi_fem_sub_clusters)

seu_scvi_fem_sub_clusters <- map(seu_scvi_fem_sub_clusters, ~SetIdent(.x, value = "fem_subclusters"))

```

##### DE on active female, active female LE, innert female, innert female LE compared versus the rest using MAST 

```{r, warning=FALSE, message=FALSE}
## Remove pseudobulk groups with less than 50 cells
map(seu_scvi_fem_sub_clusters, ~.x@meta.data %>% group_by(fem_subclusters, orig.ident) %>% count())

seu_scvi_fem_sub_clusters_cln <- map(seu_scvi_fem_sub_clusters, ~.x[, .x@meta.data %>% rownames_to_column('bcode') %>% group_by(fem_subclusters, orig.ident) %>% filter(n() > 20) %>% pull(bcode)]) 
```

```{r, warning=FALSE, message=FALSE}
## Remove leiden clusters with less than 3 donors
map(seu_scvi_fem_sub_clusters_cln, ~ .x@meta.data %>% group_by(fem_subclusters) %>% filter(n_distinct(orig.ident) < 2) %>% count(fem_subclusters, orig.ident))


seu_scvi_fem_sub_clusters_cln <- map(seu_scvi_fem_sub_clusters_cln, ~.x[, .x@meta.data %>% rownames_to_column('bcode') %>% group_by(fem_subclusters) %>% filter(n_distinct(orig.ident) >= 2) %>% pull(bcode)]) 
```

```{r, warning=FALSE, message=FALSE}
## Count the sufficient groups
map(seu_scvi_fem_sub_clusters_cln, ~.x@meta.data %>% group_by(fem_subclusters, orig.ident) %>% count())

```


```{r, warning=FALSE, message=FALSE}
# Save for plotting
imap(seu_scvi_fem_sub_clusters_cln, ~saveRDS(.x, paste0(save_dir_stage_DE_markers, 'seu_scvi_fem_sub_clusters_cln_', .y,'.RDS')))

```

```{r, warning=FALSE, message=FALSE}
# pseudobulk the counts based on donor-condition-celltype
pseudo_fem <- map(seu_scvi_fem_sub_clusters_cln, ~AggregateExpression(.x, assays = "RNA", return.seurat = T, group.by = c("condition", "orig.ident", "fem_subclusters")))
# pseudo_fem <- map(seu_scvi_fem_sub_clusters, ~AggregateExpression(.x, assays = "RNA", return.seurat = T, group.by = c("condition", "orig.ident", "seurat_clusters")))

# each 'cell' is a donor-condition-celltype pseudobulk profile
map(pseudo_fem, ~tail(Cells(.x)))
# pseudo_ifnb$celltype.stim <- paste(pseudo_ifnb$seurat_annotations, pseudo_ifnb$stim, sep = "_")
```


```{r, warning=FALSE, message=FALSE}
pseudo_fem <- map(pseudo_fem, ~.x@meta.data %>%
                    mutate(cluster_condition = paste(fem_subclusters, condition)) %>%
                    select(cluster_condition) %>%
                    AddMetaData(.x, .)
)

```


```{r, warning=FALSE, message=FALSE}
map(pseudo_fem, ~.x@meta.data %>% count(fem_subclusters, orig.ident))

```

### Pseudobulk DE between each female subcluster and all other female subclusters

```{r, warning=FALSE, message=FALSE}
pseudo_fem <- map(pseudo_fem, ~SetIdent(.x, value = "fem_subclusters"))

fem_subclusters_bulk_de <- map(pseudo_fem, ~FindAllMarkers(object = .x, test.use = "DESeq2"))
```

```{r, warning=FALSE, message=FALSE}
fem_subclusters_bulk_de_anot <- map(fem_subclusters_bulk_de, possibly(~.x %>% 
                                                                        # filter(p_val_adj < 0.05) %>% 
                                                                        group_by(cluster) %>% arrange(p_val_adj, .by_group = T) %>% 
                                                                        left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene" = "gene_id"))))

fem_subclusters_bulk_de_anot
```

```{r}
# Save for plotting
saveRDS(fem_subclusters_bulk_de_anot, paste0(save_dir_stage_DE_markers, 'fem_subclusters_bulk_de_anot.RDS'))

```

```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_bulk_de_anot, possibly(~.x %>% 
                                             filter(p_val_adj < 0.05 & avg_log2FC > 0) %>% 
                                             # filter(p_val_adj < 0.05) %>% 
                                             arrange(desc(avg_log2FC)) %>% 
                                             # arrange(desc(abs(avg_log2FC))) %>% 
                                             group_by(cluster) %>% 
                                             slice_min(order_by = p_val_adj, n = 20) %>% 
                                             slice_max(avg_log2FC, n =10)))

```


```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_bulk_de_anot, possibly(~.x %>% 
                                             filter(p_val_adj < 1e-8 & avg_log2FC > 0) %>% 
                                             arrange(desc(abs(avg_log2FC))) %>% 
                                             group_by(cluster) %>% 
                                             slice_min(order_by = p_val_adj, n = 40) %>% 
                                             slice_min(p_val_adj, n =10)))

```

```{r, fig.width=15, fig.height=3}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-1006500", "PF3D7-0210900", "PF3D7-1421700",  "PF3D7-1214300"), reduction = "scvi_umap", order = T, ncol = 4, ))

```

```{r}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = "nFeature_RNA", reduction = "scvi_umap", label = T))
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "leiden", reduction = "scvi_umap", label = T))

```


```{r}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-1471900", "PF3D7-1323000"), reduction = "scvi_umap", label = F, order = F))
# map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = "PF3D7-1141900", reduction = "scvi_umap", label = T))

```

```{r, warning=FALSE, message=FALSE}
top_de_tbl <- map(fem_subclusters_bulk_de_anot, ~.x %>% 
                    # filter(gene %in% gns) %>% 
                    arrange(desc(avg_log2FC)) %>% 
                    filter(p_val_adj< 0.05 & avg_log2FC>0) %>%
                    group_by(cluster) %>% 
                    slice_min(order_by = p_val_adj, n = 40) %>% 
                    slice_max(order_by = avg_log2FC, n = 20) %>%
                    ungroup() %>%
                    mutate(across(cluster, as.character))
)

top_de_tbl
```

###### DE between cluster 2 and 4 which seem to be good quality mature terminal gametocytes that are not activated
```{r, warning=FALSE, message=FALSE}
# pseudobulk by donor and leiden
pseudo_fem_leiden <- map(seu_scvi_fem_sub_clusters_cln, ~AggregateExpression(.x, assays = "RNA", return.seurat = T, group.by = c("orig.ident", "leiden")))

```

```{r, warning=FALSE, message=FALSE}
leiden_combis <- combn(c(2,3,4,8), m = 2, simplify = F)

```

```{r, warning=FALSE, message=FALSE}
pseudo_fem_leiden <- map(pseudo_fem_leiden, ~SetIdent(.x, value = "leiden"))

fem_subclusters_leiden2348_bulk_de <- map(pseudo_fem_leiden, ~{
  obj = .x
  map(leiden_combis, ~FindMarkers(obj, ident.1 = .x[1], ident.2 = .x[2], test.use = "DESeq2" )) %>% 
    set_names(map(leiden_combis, ~paste(., collapse = "vs")))
  
}) %>%
  unlist(., recursive = F)

# top10gns <- map(pseudo_fem_leiden, ~.x %>% map(.,\(obj) obj %>% ungroup() %>% select(Gene, gene) %>% deframe()))

```

```{r, warning=FALSE, message=FALSE}
fem_subclusters_leiden2348_bulk_de_anot <- map(fem_subclusters_leiden2348_bulk_de, ~.x %>% rownames_to_column("gene") %>% left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene" = "gene_id")))

fem_subclusters_leiden2348_bulk_de_anot
```

```{r}
# Save for plotting
saveRDS(fem_subclusters_leiden2348_bulk_de_anot, paste0(save_dir_stage_DE_markers, 'fem_subclusters_leiden2348_bulk_de_anot.RDS'))

```


```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_leiden2348_bulk_de_anot, ~.x %>% 
      slice_min(order_by = p_val_adj, n = 30) %>% 
      slice_max(order_by = avg_log2FC, n = 10))
```

```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_leiden2348_bulk_de_anot, ~.x %>%  slice_min(order_by = p_val_adj, n = 30) %>%  slice_min(order_by = avg_log2FC, n = 10))
```

```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_leiden2348_bulk_de_anot, ~.x %>%  slice_min(order_by = avg_log2FC, n = 30) %>% slice_min(order_by = p_val_adj, n = 10) )
```

```{r}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), reduction = "scvi_umap", label = F, order = T, slot = "counts"))
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), reduction = "scvi_umap", label = F, order = T))

```


```{r}
map(seu_scvi_fem_sub_clusters, ~VlnPlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), group.by = "leiden", slot = "counts"))
map(pseudo_fem_leiden, ~VlnPlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), group.by = "leiden", slot = "counts"))

map(seu_scvi_fem_sub_clusters, ~VlnPlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), group.by = "leiden"))
map(pseudo_fem_leiden, ~VlnPlot(.x, features = c("PF3D7-0417500", "PF3D7-1464400"), group.by = "leiden"))

```


```{r, fig.height=6, fig.width=6}
# vlcano_mrg <- map(c("bulkDseq", "seuWilcox"), ~{
#   EnhancedVolcano(de_wilcox_bulk_scvi %>% filter(cluster == "8"),
#                 lab = de_wilcox_bulk_scvi %>% filter(cluster == "8") %>% pull(!!rlang::sym(paste0("Gene_", .x))),

vlcano_actvFem <- imap(fem_subclusters_leiden2348_bulk_de_anot, ~EnhancedVolcano(.x ,
                                                                                 lab = .x %>% pull(!!rlang::sym(paste0("Gene"))),
                                                                                 # selectLab = .y,
                                                                                 x = paste0("avg_log2FC"),
                                                                                 y = paste0("p_val_adj"),
                                                                                 pCutoff = 1e-10,
                                                                                 FCcutoff = 1.2,
                                                                                 pointSize = 1.2,
                                                                                 labSize = 4.0,
                                                                                 title = .y,
                                                                                 subtitle = "",
                                                                                 titleLabSize = 20,
                                                                                 subtitleLabSize = 0,
                                                                                 axisLabSize = 22,
                                                                                 drawConnectors = TRUE,
                                                                                 # boxedLabels = TRUE,
                                                                                 # legendLabels =c( "p_val_adj"),
                                                                                 gridlines.minor = FALSE
) +
  # labs(title = .y)+
  theme(legend.position = "none")
) 

vlcano_actvFem

```

Findmarkers edgeR but similar to above but dreamlet

```{r}
# seu_scvi_fem_sub_clusters_sce <- map(seu_scvi_fem_sub_clusters, ~as.SingleCellExperiment(.))
```


```{r}
library(edgeR)
y <- Seurat2PB(seu_scvi_fem_sub_clusters[[1]], sample="orig.ident", cluster="leiden")
```

```{r}
summary(y$samples$lib.size)

keep.samples <- y$samples$lib.size > 5e4

table(keep.samples)

y <- y[, keep.samples]
```

```{r}
keep.genes <- filterByExpr(y, group=y$samples$cluster)

table(keep.genes)

y <- y[keep.genes, , keep=FALSE]
```

```{r}
y <- normLibSizes(y)
head(y$samples, n=10L)

summary(y$samples$norm.factors)
```

```{r}
cluster <- as.factor(y$samples$cluster)
limma::plotMDS(y, pch=16, col=c(2:8)[cluster], main="MDS")
legend("topleft", legend=paste0("cluster",levels(cluster)), pch=16, col=2:8, cex=0.8)
```

```{r}
donor <- factor(y$samples$sample)
design <- model.matrix(~ cluster + donor)
colnames(design) <- gsub("donor", "", colnames(design))
colnames(design)[1] <- "Int"
head(design)
```

```{r}
dim(design)
```

```{r}
y <- estimateDisp(y, design, robust=TRUE)

y$common.dispersion

plotBCV(y)
```

```{r}
fit <- glmQLFit(y, design, robust=TRUE)
plotQLDisp(fit)
```

```{r}
ncls <- nlevels(cluster)
contr <- rbind( matrix(1/(1-ncls), ncls, ncls), matrix(0, ncol(design)-ncls, ncls) )
diag(contr) <- 1
contr[1,] <- 0
rownames(contr) <- colnames(design)
colnames(contr) <- paste0("cluster", levels(cluster))
contr
```

```{r}
qlf <- list()
for(i in 1:ncls){
  qlf[[i]] <- glmQLFTest(fit, contrast=contr[,i])
  qlf[[i]]$comparison <- paste0("cluster", levels(cluster)[i], "_vs_others")
}
```

```{r}
qlf
```

```{r}
topTags(qlf[[1]], n=10L)

```

```{r}
qlf[[1]]$table %>% filter(PValue < 0.05) %>% filter(logFC > 0)
```

```{r}
dt <- lapply(lapply(qlf, decideTests), summary)
dt.all <- do.call("cbind", dt)
dt.all
```

```{r}
dt <- lapply(lapply(qlf, decideTests), summary)

```

```{r}
top <- 100
topMarkers <- list()
for(i in 1:ncls) {
  ord <- order(qlf[[i]]$table$PValue, decreasing=FALSE)
  up <- qlf[[i]]$table$logFC[ord] > 0
  topMarkers[[i]] <- rownames(y)[ord[up][1:top]]
}
topMarkers <- unique(unlist(topMarkers))
topMarkers
```

```{r}
lcpm <- edgeR::cpm(y, log=TRUE)
annot <- data.frame(cluster=paste0("cluster ", cluster))
rownames(annot) <- colnames(y)
ann_colors <- list(cluster=2:5)
names(ann_colors$cluster) <- paste0("cluster ", levels(cluster))
pheatmap::pheatmap(lcpm[topMarkers, ], breaks=seq(-2,2,length.out=101),
                   color=colorRampPalette(c("blue","white","red"))(100), scale="row",
                   cluster_cols=TRUE, border_color="NA", fontsize_row=5,
                   treeheight_row=70, treeheight_col=70, cutree_cols=7,
                   clustering_method="ward.D2", show_colnames=FALSE,
                   annotation_col=annot, annotation_colors=ann_colors)
```


##### DE between Female and Female LE for the active and non-active (innert) clusters using MAST

```{r, eval=T}
fem_subclusters_activ_bulk_de <- map2(c("ActivFem", "Female"), c("ActivFemLE", "Female (LE)"), ~FindMarkers(pseudo_fem[[1]], ident.1 = .x, ident.2 = .y, test.use = "DESeq2" )) %>% set_names(c("activ_FvsFLE", "inert_FvsFLE"))
```


```{r, warning=FALSE, message=FALSE, eval=T}
fem_subclusters_activ_bulk_de_anot_anot <- map(fem_subclusters_activ_bulk_de, ~.x %>% rownames_to_column("gene") %>% left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene" = "gene_id")))

# fem_subclusters_activ_bulk_de_anot_anot
```


```{r, eval=T}
saveRDS(fem_subclusters_activ_bulk_de_anot_anot,paste0(save_dir_stage_DE_markers, 'fem_subclusters_activ_bulk_de_anot_anot3.RDS'))

```

```{r, eval=T}
## Read in DE results to avoid recalculating
fem_subclusters_activ_bulk_de_anot_anot <- readRDS(paste0(read_dir_stage_DE_markers, 'fem_subclusters_activ_bulk_de_anot_anot3.RDS'))

```


```{r}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = "nFeature_RNA", reduction = "scvi_umap", label = T))
map(seu_scvi_fem_sub_clusters, ~DimPlot(.x, group.by = "leiden", reduction = "scvi_umap", label = T))

```



```{r, warning=FALSE, message=FALSE}
map(fem_subclusters_activ_bulk_de_anot_anot, ~.x %>% 
      # filter(gene %in% gns) %>% 
      arrange(desc(avg_log2FC)) %>% 
      filter(p_val_adj< 0.05 & abs(avg_log2FC)>1) %>%
      slice_min(order_by = p_val_adj, n = 30) %>% 
      slice_max(order_by = avg_log2FC, n = 30))
```

```{r}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-1356000", "PF3D7-1141900"), reduction = "scvi_umap", label = F, order = F))
# map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = "PF3D7-1141900", reduction = "scvi_umap", label = T))

```


```{r}
map(seu_scvi_fem_sub_clusters, ~VlnPlot(.x, features = c("PF3D7-1356000", "PF3D7-1141900")))

```


```{r, fig.height=6, fig.width=6}
# vlcano_mrg <- map(c("bulkDseq", "seuWilcox"), ~{
#   EnhancedVolcano(de_wilcox_bulk_scvi %>% filter(cluster == "8"),
#                 lab = de_wilcox_bulk_scvi %>% filter(cluster == "8") %>% pull(!!rlang::sym(paste0("Gene_", .x))),

vlcano_actvFem <- map(fem_subclusters_activ_bulk_de_anot_anot, ~EnhancedVolcano(.x ,
                                                                                lab = .x %>% pull(!!rlang::sym(paste0("Gene"))),
                                                                                # selectLab = .y,
                                                                                x = paste0("avg_log2FC"),
                                                                                y = paste0("p_val_adj"),
                                                                                pCutoff = 1e-10,
                                                                                FCcutoff = 1.5,
                                                                                pointSize = 1.5,
                                                                                labSize = 4.0,
                                                                                title = '',
                                                                                subtitle = "",
                                                                                titleLabSize = 0,
                                                                                subtitleLabSize = 0,
                                                                                axisLabSize = 22,
                                                                                drawConnectors = TRUE,
                                                                                # boxedLabels = TRUE,
                                                                                # legendLabels =c( "p_val_adj"),
                                                                                gridlines.minor = FALSE
) +
  theme(legend.position = "none")
)

vlcano_actvFem

```

########### END subset the active and non active female and female LE for DE analysis in the main UMAP ################################# 

########### START DE between active FemalevsFemaleLE and between inert FemalevsFemaleLE  ################################# 

```{r, fig.height=6, fig.width=5.5}
activated_de_activ_inert <- fem_subclusters_activ_bulk_de_anot_anot %>% purrr::reduce(inner_join, by = c("gene"), suffix = c("_activ_FvsFLE", "_inert_FvsFLE"))
```

```{r, fig.height=6, fig.width=5.5}
activated_de_activ_inert %>%
  filter(p_val_adj_activ_FvsFLE < 0.05 | p_val_adj_inert_FvsFLE < 0.05) %>%
  ggplot(aes(x = avg_log2FC_activ_FvsFLE, y = avg_log2FC_inert_FvsFLE)) +
  geom_point(size = 0.1) +
  geom_abline()
```


```{r, fig.height=6, fig.width=5.5}
activated_de_activ_inert %>%
  filter(p_val_adj_activ_FvsFLE < 0.05 & p_val_adj_inert_FvsFLE < 0.05) %>%
  ggplot(aes(x = avg_log2FC_activ_FvsFLE, y = avg_log2FC_inert_FvsFLE)) +
  geom_point(size = 0.1) +
  geom_abline()
```


```{r, warning=FALSE, message=FALSE}
activated_de_activ_inert_hisignf <- activated_de_activ_inert %>%
  filter(p_val_adj_activ_FvsFLE < 0.05 & p_val_adj_inert_FvsFLE < 0.05)

activated_de_activ_inert_hisignf
```


```{r, warning=FALSE, message=FALSE}
top_activ_genes <- activated_de_activ_inert_hisignf |>
  filter(p_val_adj_activ_FvsFLE < 1e-5 & p_val_adj_inert_FvsFLE < 1e-5 & abs(avg_log2FC_activ_FvsFLE) > 2.5 & abs(avg_log2FC_inert_FvsFLE) > 2.5) #|>
#arrange(desc(abs(lfc_mean))) #|>
# slice_head(n = 10)


```




```{r, warning=FALSE, message=FALSE, fig.width=5, fig.height=5}
activated_de_activ_inert_hisignf %>%
  ggplot(aes(x = avg_log2FC_activ_FvsFLE, y = avg_log2FC_inert_FvsFLE)) +
  geom_point(size = 0.1) +
  geom_point(data = top_activ_genes, size = 1) +
  ggpubr::stat_cor(method = "pearson", label.x =1, label.y = 0, size = 5)+ 
  geom_text_repel(
    data = top_activ_genes,
    aes(label = Gene_activ_FvsFLE),
    size = 4,
    segment.size = 0.3,  force = 100
  ) +
  geom_abline() +
  labs(x = "avg Log2FC Active_FvsFLE", y = "avg Log2FC inert_FvsFLE") +
  theme_bw() +
  theme(text = element_text(size = 18)) 

```


```{r, warning=FALSE, message=FALSE}
activated_de_activ_inert |>
  filter((p_val_adj_activ_FvsFLE < 0.05 & p_val_adj_inert_FvsFLE < 0.05) & ((avg_log2FC_activ_FvsFLE > 1 & avg_log2FC_inert_FvsFLE < -1) | (avg_log2FC_activ_FvsFLE < -1 & avg_log2FC_inert_FvsFLE > 1))) #|>
#arrange(desc(abs(lfc_mean))) #|>
# slice_head(n = 10)


```

```{r, fig.width=6, fig.height=4}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-1203300"), reduction = "scvi_umap", order = T, ncol = 1, ))
map(seu_scvi_fem_sub_clusters, ~VlnPlot(.x, features = c("PF3D7-1203300") ))

```

```{r, fig.width=15, fig.height=3}
map(seu_scvi_fem_sub_clusters, ~FeaturePlot(.x, features = c("PF3D7-1203300", "PF3D7-0505700", "PF3D7-0520200",  "PF3D7-0819300"), reduction = "scvi_umap", order = T, ncol = 4, ))

```

########### END DE between active FemalevsFemaleLE and between inert FemalevsFemaleLE  ################################# 

########### START visualize active clusters in independent donor seurat objects  ################################# 

## Samples to be included in the paper
```{r, message=F, warning=F, eval=T}
key_samples <- c("MSC3", "MSC13", "MSC14", "MSC33C", "MSC40C", "MSC45", "MSC48C", "MSC49C", "MSC50_MACS", "MSC50_SLOC", "MSC53", "MSC54", "MSC57", "MSC60C", "MSC66C", "MSC67", "MSC68C", "MSC70C")

don_order <- str_remove(key_samples, "C$")

```


```{r, message=F, warning=F, eval=T}
## Get file list
all_anotd_stg_cln_norm_list_files <- Sys.glob("data/processed/Pf/*/seu_obj/all_anotd_stg_cln_norm.RDS")

all_anotd_stg_cln_norm_list_files
```

```{r, message=F, warning=F, eval=T}
## read filtered barcodes
all_anotd_stg_cln_norm <- map(all_anotd_stg_cln_norm_list_files, ~.x %>% 
                                set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*')))) %>% 
  unlist(., recursive = F) %>% 
  # .[sample_name_all] %>%
  .[key_samples] %>%
  map(readRDS)

```


```{r}
map(all_anotd_stg_cln_norm, ~dim(.x)[2]) %>% unlist()
```

```{r, fig.width=9, fig.height=3.5}
imap(all_anotd_stg_cln_norm, ~DimPlot(.x, group.by = c("seurat_clusters","stage_final2")) + labs(title = .y) + scale_color_manual(values = sp_col_new)) 
```

```{r, fig.width=9, fig.height=3.5}
## Get female subclusters labels for active and inert clusters and split by donor
fem_sub_clusters_labs <- map(seu_scvi_fem_sub_clusters, ~{.x@meta.data %>% 
    select(orig.ident, fem_subclusters) %>%
    rownames_to_column("bcode") %>% 
    mutate(across(bcode, ~str_remove(., "M.*_"))) %>% 
    split(., f=factor(.$orig.ident)) 
}) %>% 
  unlist(., recursive = F) %>% 
  map(., ~.x %>% select(bcode, fem_subclusters) %>% remove_rownames() %>% column_to_rownames("bcode"))  

names(fem_sub_clusters_labs) <- str_remove(names(fem_sub_clusters_labs), ".mrna")
```


```{r}
DimPlot(all_jcC_seu_scvi_stg_noM55_ActivAsexDbts, group.by = "stage_scvi_hires_fem") 
DimPlot(all_jcC_seu_scvi_stg_noM55_ActivAsexDbts, group.by = "stage_scvi_hires_fem", raster = F) + scale_colour_manual(values = sp_fld_colors2)

```

```{r}
# Get UMAPs and metadata for plotting
all_jcC_seu_scvi_stg_noM55_ActivAsexDbts_umap_mdata <- all_jcC_seu_scvi_stg_noM55_ActivAsexDbts@meta.data %>% 
    rownames_to_column("bcode") %>%
    left_join(., all_jcC_seu_scvi_stg_noM55_ActivAsexDbts@reductions$scvi_umap@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode") 

```

```{r, warning=FALSE, message=FALSE}
# Save for plotting
saveRDS(all_jcC_seu_scvi_stg_noM55_ActivAsexDbts_umap_mdata, paste0(save_dir_stage_DE_markers, 'all_jcC_seu_scvi_stg_noM55_ActivAsexDbts_umap_mdata.RDS'))

```

```{r, fig.width=9, fig.height=3.5}
## Get female subclusters labels for active and inert clusters and split by donor
fem_hires_asex_dbt_labs <- all_jcC_seu_scvi_stg_noM55_ActivAsexDbts@meta.data %>% 
  select(orig.ident, stage_scvi_hires_fem) %>%
  rownames_to_column("bcode") %>% 
  mutate(across(bcode, ~str_remove(., "M.*_"))) %>% 
  split(., f=factor(.$orig.ident)) %>% 
  # unlist(., recursive = F) %>% 
  map(., ~.x %>% select(bcode, stage_scvi_hires_fem) %>% remove_rownames() %>% column_to_rownames("bcode"))  

names(fem_hires_asex_dbt_labs) <- str_remove(names(fem_hires_asex_dbt_labs), ".mrna")
```

```{r, fig.width=9, fig.height=3.5}
## Find donors present in both the femal subclusters and qcd independent donor objects
donors_qcd_fem_clusters <- base::intersect(base::intersect(names(all_anotd_stg_cln_norm),names(fem_sub_clusters_labs)), names(fem_hires_asex_dbt_labs))
```


```{r, fig.width=9, fig.height=3.5}
## Add the female subclusters annotation to seurat objects
all_anotd_stg_cln_norm_w_fem_subclusters <- map2(all_anotd_stg_cln_norm[donors_qcd_fem_clusters], fem_sub_clusters_labs[donors_qcd_fem_clusters], ~AddMetaData(.x, .y))
all_anotd_stg_cln_norm_w_fem_subclusters <- map2(all_anotd_stg_cln_norm_w_fem_subclusters[donors_qcd_fem_clusters], fem_hires_asex_dbt_labs[donors_qcd_fem_clusters], ~AddMetaData(.x, .y))

```

```{r, fig.width=9, fig.height=3.5}
## Modify the female sucluster annotation to contain the other labels to allow contextualisation of these clusters with the other clusters

all_anotd_stg_cln_norm_w_fem_subclusters <- map(all_anotd_stg_cln_norm_w_fem_subclusters, ~{
  .x@meta.data %>%
    mutate(fem_detld_labl = case_when(stage_scvi_hires_fem == "fem8_asx_dblt" ~ "fem_asx_dblt",
                                      stage_scvi_hires_fem == "fem_non8_asx_dblt" ~ "fem_asx_dblt",
                                      !(stage_scvi_hires_fem %in% c("fem8_asx_dblt", "fem_non8_asx_dblt")) & !is.na(fem_subclusters) ~ fem_subclusters,
                                      !(stage_scvi_hires_fem %in% c("fem8_asx_dblt", "fem_non8_asx_dblt")) & is.na(fem_subclusters) & !is.na(stage_scvi_hires_fem) ~ stage_scvi_hires_fem,
                                      is.na(stage_scvi_hires_fem) | is.na(fem_subclusters) ~ stage_fld,
                                      T ~ stage_fld)) %>%
    select(fem_detld_labl) %>% 
    AddMetaData(.x, .)
})
```


```{r, fig.width=9, fig.height=3.5}
## Modify the female sucluster annotation to contain the other labels to allow contextualisation of these clusters with the other clusters
map(all_anotd_stg_cln_norm_w_fem_subclusters, ~.x@meta.data %>% count(fem_detld_labl, stage_fld, stage_scvi_hires_fem, fem_subclusters))
```


```{r, fig.width=12, fig.height=5}
imap(all_anotd_stg_cln_norm_w_fem_subclusters, ~DimPlot(.x, group.by = c("fem_detld_labl", "stage_final2")) + labs(title = .y) + scale_color_manual(values = sp_col_new)) 
```

```{r, fig.width=12, fig.height=5}
imap(all_anotd_stg_cln_norm_w_fem_subclusters, ~DimPlot(.x, group.by = c("fem_detld_labl", "stage_final2")) + labs(title = .y) + scale_color_manual(values = sp_col_new)) 
```


```{r}
imap(all_anotd_stg_cln_norm_w_fem_subclusters, ~DimPlot(.x, group.by = c("fem_detld_labl"), pt.size = 0.5) + labs(title = .y) + scale_color_manual(values = sp_fld_colors2)) 
```

```{r, fig.height=4, fig.width=5}
## Highlight likely misplaced clusters to remove
imap(all_anotd_stg_cln_norm_w_fem_subclusters, possibly(~DimPlot(.x, pt.size = 0.01, sizes.highlight = 0.5, cells.highlight = colnames(.x[,.x$fem_detld_labl == "ActivFemLE"]), raster = F) + labs(title = .y)))
```

```{r, fig.height=4, fig.width=5}
## Highlight likely misplaced clusters to remove
imap(all_anotd_stg_cln_norm_w_fem_subclusters, possibly(~DimPlot(.x, pt.size = 0.01, sizes.highlight = 0.5, cells.highlight = colnames(.x[,.x$fem_detld_labl == "ActivFem"]), raster = F) + labs(title = .y)))
```


```{r}
# Get UMAPs and metadata for plotting
all_anotd_stg_cln_norm_w_fem_subclusters_umap_mdata <- map(all_anotd_stg_cln_norm_w_fem_subclusters, ~{
  .x@meta.data %>% 
    rownames_to_column("bcode") %>%
    left_join(., .x@reductions$umap@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode") 
})
```

```{r, warning=FALSE, message=FALSE}
# Save for plotting
saveRDS(all_anotd_stg_cln_norm_w_fem_subclusters_umap_mdata, paste0(save_dir_stage_DE_markers, 'all_anotd_stg_cln_norm_w_fem_subclusters_umap_mdata.RDS'))

```



########### END visualize active clusters in independent donor seurat objects  ################################# 

