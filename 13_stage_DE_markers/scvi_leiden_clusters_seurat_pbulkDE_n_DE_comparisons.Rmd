---
title: "Integration of donor only and with lab"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  # library(dreamlet)
  # library(muscat)
  # library(ExperimentHub)
  # library(zenith)
  library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  # library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  library(tradeSeq)
  library(ComplexHeatmap)
  library(circlize)
  library(readxl)
  library(ggh4x)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  
})
```


```{r setup}
sample_set = "Mali2"

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```

```{r}
read_dir_scvi2seu <- "data/processed/Pf/m2_all/scvi2seu/"
read_dir_stage_DE_markers <- "data/processed/Pf/m2_all/stage_DE_markers/"
save_dir_stage_DE_markers <- "data/processed/Pf/m2_all/stage_DE_markers/"
read_dir_integrated_scvi_cleanup <- "data/processed/Pf/m2_all/integrated_scvi_cleanup/"

published_dset_dir <- "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/published_dsets/"


```

#  integration of all MSC

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
```



```{r}
obj_names = c('M55', 'no_M55', 'no_M55_all_gns', 'asex_allgns', 'fem_allgns', 'male_allgns')

```

#####!!! DE below in seurat. Already done using scvi. Not sure which one to go with

```{r}
# Clean integrated scvi object with the asex+activated_fem doublets removed - Generated in 'scvi_leiden_clusters_doublet_investigations.Rmd'
all_jcC_seu_scvi_noM55_afm_cln <- readRDS(paste0(read_dir_integrated_scvi_cleanup, "all_jcC_seu_scvi_noM55_afm_cln.RDS"))

```

```{r}
## Read XX generated in 'scvi_leiden_clusters_seuratDE.Rmd'
seu_scviLeiden_markers_anot <- readRDS(paste0(read_dir_stage_DE_markers, 'seu_scviLeiden_markers_anot.RDS'))

```


######### START - Pseudobulk DE #####################


```{r, warning=FALSE, message=FALSE}
## Remove pseudobulk donor by leiden groups with less than 50 cells
map(all_jcC_seu_scvi_noM55_afm_cln, ~.x@meta.data %>% group_by(leiden, orig.ident) %>% count())

all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE <- map(all_jcC_seu_scvi_noM55_afm_cln, ~.x[, .x@meta.data %>% rownames_to_column('bcode') %>% group_by(leiden, orig.ident) %>% filter(n() > 50) %>% pull(bcode)]) 
```

```{r, warning=FALSE, message=FALSE}
## Remove leiden clusters with less than 3 donors
map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~ .x@meta.data %>% group_by(leiden) %>% filter(n_distinct(orig.ident) < 2) %>% count(leiden, orig.ident))


all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE <- map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~.x[, .x@meta.data %>% rownames_to_column('bcode') %>% group_by(leiden) %>% filter(n_distinct(orig.ident) >= 2) %>% pull(bcode)]) 
```

```{r, warning=FALSE, message=FALSE}
## Count the sufficient groups
map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~.x@meta.data %>% group_by(leiden, orig.ident) %>% count())

```

```{r}
# Save for plotting
saveRDS(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, paste0(save_dir_stage_DE_markers, 'all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE.RDS'))

```

Remove genes detected in less than 20 cells
```{r, warning=FALSE, message=FALSE}
all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE <- map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~{

  seurat_obj <- .x

  counts <- GetAssayData(seurat_obj, slot = "counts")

  keep_genes <- rowSums(counts > 0) >= 20   # expressed in ≥10 cells
  # seurat_obj <- subset(seurat_obj, features = rowSums(GetAssayData(seurat_obj, slot="counts") > 0) > 10)

  seurat_obj <- subset(seurat_obj, features = rownames(counts)[keep_genes])

})
```

```{r, warning=FALSE, message=FALSE}
# pseudobulk the counts based on donor-condition-celltype
pseudo_all_stgs <- map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~AggregateExpression(.x, assays = "RNA", return.seurat = T, group.by = c("condition", "orig.ident", "leiden")))

# each 'cell' is a donor-condition-celltype pseudobulk profile
map(pseudo_all_stgs, ~tail(Cells(.x)))
# pseudo_ifnb$celltype.stim <- paste(pseudo_ifnb$seurat_annotations, pseudo_ifnb$stim, sep = "_")
```


```{r, warning=FALSE, message=FALSE}
# pseudo_all_stgs <- map(pseudo_all_stgs, ~{
#   
#   seurat_obj <- .x
#   
#   counts <- GetAssayData(seurat_obj, slot = "counts")
#   
#   keep_genes <- rowSums(counts > 0) > 10   # expressed in ≥10 cells
#   seurat_obj <- subset(seurat_obj, features = rownames(counts)[keep_genes])
#   
#   # seurat_obj <- subset(seurat_obj, features = rowSums(GetAssayData(seurat_obj, slot="counts") > 0) > 10)
# 
# })


```


```{r, warning=FALSE, message=FALSE}
pseudo_all_stgs <- map(pseudo_all_stgs, ~.x@meta.data %>%
      mutate(leiden_condition = paste(leiden, condition)) %>%
      select(leiden_condition) %>%
      AddMetaData(.x, .)
)

```


```{r, warning=FALSE, message=FALSE}
map(pseudo_all_stgs, ~.x@meta.data %>% count(leiden))

```


```{r}
# Save for plotting
saveRDS(pseudo_all_stgs, paste0(save_dir_stage_DE_markers, 'pseudo_all_stgs.RDS'))

```

```{r, warning=FALSE, message=FALSE}
pseudo_all_stgs <- map(pseudo_all_stgs, ~SetIdent(.x, value = "leiden"))

bulk_de_all_stgs <- map(pseudo_all_stgs, ~FindAllMarkers(object = .x, test.use = "DESeq2", min.cells.group = 2))
```

```{r, warning=FALSE, message=FALSE}
bulk_de_all_stgs_anot <- map(bulk_de_all_stgs, possibly(~.x %>% 
                                                          # filter(p_val_adj < 0.05) %>% 
                                                          group_by(cluster) %>% 
                                                          arrange(p_val_adj, .by_group = T) %>% 
                                                          left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene" = "gene_id"))))

bulk_de_all_stgs_anot
```

```{r}
# Save for plotting
saveRDS(bulk_de_all_stgs_anot, paste0(save_dir_stage_DE_markers, 'bulk_de_all_stgs_anot.RDS'))

```

```{r, warning=FALSE, message=FALSE}
map(bulk_de_all_stgs_anot, possibly(~.x %>% 
      filter(p_val_adj < 0.05) %>% 
      arrange(desc(abs(avg_log2FC))) %>% 
      group_by(cluster) %>% 
      slice_min(order_by = p_val_adj, n = 10) %>% 
      slice_max(avg_log2FC, n =10)))

```


```{r, warning=FALSE, message=FALSE}
map(bulk_de_all_stgs_anot, possibly(~.x %>% 
      filter(p_val_adj < 0.05 & avg_log2FC >0) %>% 
      arrange(desc(avg_log2FC)) %>% 
      group_by(cluster) %>% 
      slice_min(order_by = p_val_adj, n = 40) %>% 
      slice_min(p_val_adj, n =4) %>%
      ungroup() %>%
      mutate(across(cluster, ~droplevels(factor(.x, levels = c(0:30))))) %>%
      arrange(cluster)
)
)

```

Female LE (cluster 3) activated cluster
PF3D7-1203300 - https://journals.asm.org/doi/10.1128/mbio.03407-25
YOP1L - tubule formation https://onlinelibrary.wiley.com/doi/10.1111/mmi.14526 , 
ADF2 - https://pmc.ncbi.nlm.nih.gov/articles/PMC10100735/ , https://www.sciencedirect.com/science/article/pii/S0006291X10010855
PF3D7_1210200 - https://pubmed.ncbi.nlm.nih.gov/28708996/
FabZ, PK2

Female (cluster 8) activated cluster
PK2
ISP3 - https://pmc.ncbi.nlm.nih.gov/articles/PMC7327484/, https://www.sciencedirect.com/science/article/pii/S1931312823003359 , https://link.springer.com/article/10.1186/1471-2164-14-256 , 
IMC1g - https://www.sciencedirect.com/science/article/pii/S147149222400360X#ab0005 , https://pmc.ncbi.nlm.nih.gov/articles/PMC10653860/ , https://pubmed.ncbi.nlm.nih.gov/39576115/, 

```{r, warning=FALSE, message=FALSE}
imap(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~DimPlot(.x, reduction = "scvi_umap", group.by = "leiden", label = T) + labs(title = .y))
```

```{r, warning=FALSE, message=FALSE}
cluster_8_de_gns <- map(bulk_de_all_stgs_anot, possibly(~.x %>% 
      filter(p_val_adj < 0.001 & avg_log2FC > 0 & cluster == "8") %>% 
      arrange(desc(avg_log2FC)) #%>% 
      # slice_min(order_by = p_val_adj, n = 40) %>% 
      # slice_min(p_val_adj, n =4)
      ))

cluster_8_de_gns
```

```{r, warning=FALSE, message=FALSE, fig.width=16, fig.height=6}
map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~FeaturePlot(.x, features = c("PF3D7-1323000", "PF3D7-1238900", "PF3D7-0404700"), order =T, ncol = 3))

```

```{r, warning=FALSE, message=FALSE, fig.width= 14, fig.height=3}
imap(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~.x@meta.data %>% 
       distinct(leiden, orig.ident) %>%
       mutate(n_dons_all = n_distinct(`orig.ident`))%>%
       group_by(leiden) %>%
       mutate(n_dons_leiden = n_distinct(`orig.ident`),
              prop = n_dons_leiden/n_dons_all) %>%
       arrange(leiden)
     ) 

```

```{r, warning=FALSE, message=FALSE, fig.width= 14, fig.height=3}
imap(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~.x@meta.data %>% 
       count(leiden, orig.ident) %>%
       arrange(leiden)
     ) 

```

```{r, warning=FALSE, message=FALSE, fig.width= 14, fig.height=3}
imap(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE[1:3], ~.x@meta.data %>% 
       filter(stage_afm != "Asexual") %>%
       distinct(stage_afm, leiden, orig.ident) %>%
       group_by(stage_afm) %>%
       mutate(n_dons_all = n_distinct(`orig.ident`))%>%
       group_by(stage_afm, leiden) %>%
       mutate(n_dons_leiden = n_distinct(`orig.ident`),
              propn = n_dons_leiden/n_dons_all) %>%
       ungroup() %>%
       # mutate(prop = round(n/sum(n), 2)) %>%
       ggplot(aes(y = propn, x = factor(leiden), fill = factor(leiden))) +
       geom_point() +
       facet_nested_wrap(vars(stage_afm), nrow = 1, scales = "free_x") +
       geom_hline(yintercept = 0.40) +
       theme_classic()
       )
```
######### END - Pseudobulk DE #####################


####################START all cell leiden scviDE markers ##################

```{r}
# generated in 'm2_raw_integration_trial_qcd_DE.ipynb'
scvi_leiden_de_markers <- read_csv("data/processed/Pf/m2_all/scvi/m2_all_scvi_leiden_marker_genes.csv") %>% 
  rename("gene_id" = `...1`) %>%
  left_join(., Pf3D7_genes_plasmoDB[,c("gene_id", "Gene")], by = c("gene_id" = "gene_id"))

```



```{r}
scvi_leiden_de_markers %>% filter(proba_de > 0.95 & lfc_median > 0) %>% count(comparison)
```


```{r}
top5_lfc <- scvi_leiden_de_markers %>% filter(proba_de > 0.98 & lfc_median > 0) %>% slice_max(lfc_median, n = 3, by = "comparison")

top5_lfc
```


```{r}
top_lfc_gns <- top5_lfc %>% select(comparison, gene_id) %>% split(., f = factor(.$comparison)) %>% map(., deframe)
top_lfc_gns
```



```{r}
all_jcC_seu_scvi_noM55_all_gns <- readRDS("data/processed/Pf/m2_all/scvi2seu/all_jcC_seu_scvino_M55_all_gns.RDS")
# all_jcC_seu_scvi_noM55_all_gns <- readRDS(paste0(save_dir_stage_DE_markers, 'all_jcC_seu_scvino_M55_all_gns.RDS'))

```

```{r}
DimPlot(all_jcC_seu_scvi_noM55_all_gns, group.by = "stage_asx_c", reduction = "scvi_umap", label = T) + scale_color_manual(values = sp_col_new)
DimPlot(all_jcC_seu_scvi_noM55_all_gns, group.by = "leiden", reduction = "scvi_umap", label = T)

```

```{r, fig.width=12, fig.height=3}
FeaturePlot(all_jcC_seu_scvi_noM55_all_gns, features = "nFeature_RNA", reduction = "scvi_umap", raster = T, order = T, ncol = 3, label = F) 
     
```

```{r, fig.width=12, fig.height=3}
imap(top_lfc_gns, ~FeaturePlot(all_jcC_seu_scvi_noM55_all_gns, features = .x, reduction = "scvi_umap", raster = T, order = T, ncol = 3, label = F) + labs(title = .y))
     
```


```{r}
FeaturePlot(all_jcC_seu_scvi_noM55_all_gns, features = "PF3D7-0825800", reduction = "scvi_umap", raster = T, order = T, label = F) 
     
```

```{r}
female_clusters2keep4DE_tbl <- all_jcC_seu_scvi_noM55_all_gns@meta.data %>% filter(str_detect(stage_asx_c, "Fem")) %>% count(leiden) %>% arrange(desc(n)) %>% filter(n>150) 

female_clusters2keep4DE_tbl

female_clusters2keep4DE <- female_clusters2keep4DE_tbl %>% pull(leiden)

```

```{r}
scvi_leiden_de_markers %>% count(comparison)

```

```{r}
# top5_lfc_fem <- scvi_leiden_de_markers %>% filter(group1 %in% female_clusters2keep4DE & proba_de > 0.98 & lfc_median > 0) %>% slice_max(lfc_median, n = 3, by = "comparison")
top5_lfc_fem <- scvi_leiden_de_markers %>% 
  filter(group1 %in% female_clusters2keep4DE & proba_de > 0.98 & non_zeros_proportion1 > 0.2 & lfc_median > 0 ) %>% 
  slice_max(lfc_median, n = 6, by = "comparison")

top5_lfc_fem
```

```{r}
top5_lfc_fem %>% select(Gene, proba_de, lfc_median, comparison, non_zeros_proportion1, non_zeros_proportion2)
```

```{r}
top5_lfc_fem_gns <- top5_lfc_fem %>% select(comparison, gene_id, Gene) %>% split(., f = factor(.$comparison)) %>% map(.,\(obj) obj %>% ungroup() %>% select(Gene, gene_id) %>% deframe())

top5_lfc_fem_gns
```


```{r}
DimPlot(all_jcC_seu_scvi_noM55_all_gns, group.by = "stage_fld", reduction = "scvi_umap", label = T) + scale_color_manual(values = sp_col_new)
DimPlot(all_jcC_seu_scvi_noM55_all_gns, group.by = "leiden", reduction = "scvi_umap", label = T)

```

```{r, fig.width=12, fig.height=8}
imap(top5_lfc_fem_gns, ~FeaturePlot(all_jcC_seu_scvi_noM55_all_gns, features = .x, reduction = "scvi_umap", raster = T, order = T, ncol = 3, label = F) + labs(title = .y))
     
```


```{r, fig.width=12, fig.height=7}
imap(top5_lfc_fem_gns, ~DotPlot(all_jcC_seu_scvi_noM55_all_gns, features = .x, group.by = "leiden") + labs(title = .y))
     
```

```{r}
DimPlot(all_jcC_seu_scvi_noM55_all_gns, group.by = "leiden", reduction = "scvi_umap", label = T)

```

```{r, fig.width=12, fig.height=8}
imap(top5_lfc_fem_gns, ~FeaturePlot(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE[["Female"]], features = .x, reduction = "scvi_umap", raster = T, order = T, ncol = 3, label = F) + labs(title = .y))
     
```

```{r, warning=FALSE, message=FALSE}
## Gamete top marker - PF3D7_0825800 https://www.nature.com/articles/s41586-025-09653-0
map(all_jcC_seu_scvi_noM55_afm_cln_4pbulkDE, ~FeaturePlot(.x, features = c("PF3D7-0825800"), order =T, ncol = 1))

```

####################END all cell leiden scviDE markers ##################

```{r}
scvi_leiden_de_markers %>% head
```

```{r}
scvi_leiden_de_markers %>% count(group1, comparison)
```

```{r}
bulk_de_all_stgs_anot[[1]] %>% head
```


```{r, eval=T}
## Read in DE results
seu_scviLeiden_markers_anot[[1]] %>% head

```


```{r}
# scvi_leiden_de_markers %>% full_join(seu_scviLeiden_markers_anot, by = c("gene_id" = "gene", "group1" = "cluster")) %>% full_join(bulk_de_all_stgs_anot, by = c("gene_id" = "gene", "group1" = "cluster")) 

de_wilcox_bulk_scvi <- seu_scviLeiden_markers_anot[[1]] %>% 
  filter(p_val_adj < 0.001) %>%
  mutate(dset= "seuWilcox") %>%
  full_join(., bulk_de_all_stgs_anot[[1]] %>% 
              filter(p_val_adj < 0.05) %>% 
              mutate(dset= "bulkDseq") ,  
            by = c("gene","cluster"), 
            suffix = c("_seuWilcox", "_bulkDseq")) #%>% 
  # full_join(., scvi_leiden_de_markers%>% 
  #             filter(is_de_fdr_0.05 == T) %>% 
  #             mutate(dset= "scviDE",
  #                    across(group1, factor)), 
  #           by = c("gene" = "gene_id", "cluster" = "group1"), 
  #           suffix = c("", "_scviDE"))  
```

```{r}
# Save for plotting
saveRDS(de_wilcox_bulk_scvi, paste0(save_dir_stage_DE_markers, 'de_wilcox_bulk_scvi.RDS'))

```




```{r}
de_wilcox_bulk_scvi %>% ggplot(aes(x = avg_log2FC_seuWilcox, y = avg_log2FC_bulkDseq)) + geom_point(size = 0.001) + facet_wrap(cluster ~ .)
```


```{r}
de_wilcox_bulk_scvi %>% ggplot(aes(x = -log10(p_val_adj_seuWilcox), y = -log10(p_val_adj_bulkDseq))) + geom_point(size = 0.001)
```

```{r}
de_wilcox_bulk_scvi %>% filter(dset_seuWilcox == "seuWilcox" & dset_bulkDseq == "bulkDseq" )  %>% filter(cluster == "8")
```



