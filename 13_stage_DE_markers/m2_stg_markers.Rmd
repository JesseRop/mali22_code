---
title: "m2_stg_markers"
date: "2025-03-31"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---


```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  # library(patchwork)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  # library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(knitr)
  # library(readxl)
  # library(SCpubr)
  # library(ggh4x)
  # library(htmlwidgets)
  library(slingshot)
  library(harmony)
  library(ggforce)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  
})
```


#  integration of all MSC


```{r setup}
sample_set = "Mali2"

knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("mali22_code_lnk/pf_common_vars.R")
```

```{r, message=FALSE, warning=FALSE, eval=T}
# Generated in 'm2_scvi_to_seurat.Rmd' 
m2_all_raw_mrg <- readRDS("data/processed/Pf/m2_all/m2_all_raw_mrg_no_M55_3.RDS")

```

```{r, message=FALSE, warning=FALSE, eval=T}
m2_all_raw_mrg@meta.data %>% count(stage_afm) 

```


```{r, message=FALSE, warning=FALSE, eval=T}
Idents(m2_all_raw_mrg) <- "stage_afm"

```

```{r, warning=FALSE, message=FALSE}
m2_all_raw_mrg[["RNA"]]$data <- as(m2_all_raw_mrg[["RNA"]]$data, Class = "dgCMatrix")

```


```{r}
all_mrks <- FindAllMarkers(
  object = m2_all_raw_mrg,
  test.use = "MAST",
  latent.vars = c("donor")
)
```

```{r}
all_mrks_anot <- all_mrks %>% 
  left_join(., Pf3D7_genes_plasmoDB[, c("Gene", "gene_id")], by = c("gene"="gene_id")) 

```

```{r}
all_mrks_anot <- all_mrks_anot %>% 
  mutate(spec_index = pct.1 - pct.2,
         sig2noise = avg_log2FC * spec_index)
```

```{r}
saveRDS(all_mrks_anot, "data/processed/Pf/m2_all/all_mrks_anot.RDS")

```

```{r}
all_mrks_anot

```


```{r}
# all_mrks_anot %>% dplyr::filter(pct.2 < 0.05 & avg_log2FC > 0) %>% group_by(cluster) %>% arrange(p_val_adj, .by_group = T) %>% slice_head(n=20) %>% slice_max(avg_log2FC, n = 5) 
```

```{r}
all_mrks_anotP0_rankFC_top10 <- all_mrks_anot %>% dplyr::filter(pct.2 < 0.05 & avg_log2FC > 0 & p_val_adj == 0) %>% group_by(cluster) %>% slice_max(sig2noise, n = 10) %>% ungroup()

all_mrks_anotP0_rankFC_top10
```





```{r}
## https://pubmed.ncbi.nlm.nih.gov/37708854/
## https://www.cell.com/cell-systems/fulltext/S2405-4712(24)00305-3
## https://www.cell.com/cell-systems/fulltext/S2405-4712(24)00305-3
all_mrks_anot %>% dplyr::filter(avg_log2FC > 0 & gene %in% c("PF3D7-1322900", "PF3D7-0418800", "PF3D7-1340400", "PF3D7-0315700", "PF3D7-1220000", "PF3D7-1250600"))
```


```{r}
asx_mkrs <- all_mrks_anotP0_rankFC_top10 %>% filter(cluster == "Asexual") %>% select(Gene, gene) %>% deframe()
```


```{r}
stg_mkrs <- all_mrks_anotP0_rankFC_top10 %>% select(cluster, Gene, gene) %>% base::split(., f=.$cluster) %>% map(., ~.x %>% select(Gene, gene) %>% deframe)

stg_mkrs
```



!!!NOTE - RAW COUNTS BEING USED - NEED TO CHANGE TO NORMALISED(DATA) WHICH IS STANDARD
```{r, fig.width=20, fig.height=5}
#ap2g, gdv1, pfs16, etramp10.3, gexp5, pfg14-744, pfg14-748
# m2_seu_jnd <- JoinLayers(m2_seu)

map(stg_mkrs, ~DotPlot(m2_all_raw_mrg, features = as.character(.x), split.by = "stage_afm", group.by = "donor",  
        cols = c("#90bce5", "#ea5bba",  "#4ba7fc", "#f2e48c", "#af1527", "#af1091"
)) + 
  coord_flip()+
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = names(.x))
)


```


!!!NOTE - RAW COUNTS BEING USED - NEED TO CHANGE TO NORMALISED(DATA) WHICH IS STANDARD
```{r, fig.width=20, fig.height=12}
# Idents(m2_seu_noM12) <- "stage_c"

DotPlot(m2_seu_noM12, features = as.character(unlist(stg_mkrs)), split.by = "stage_c", group.by = "donor",  
        cols = c("#ea5bba", "#90bce5",  "#4ba7fc", "#f2e48c", "#af1527", "#af1091"
)) + 
  coord_flip()+
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = names(unlist(stg_mkrs)))



```

```{r, fig.width=12, fig.height=4}
# add stage metadata
saveRDS(stg_mkrs, "data/processed/Pf/m2_all/stg_mkrs.RDS")

```


```{r}

all_mrks <- readRDS("data/processed/Pf/m2_all/all_mrks.RDS")
```

```{r, fig.width=12, fig.height=4}
# add stage metadata
msc_w_cln_strns_raw <- readRDS("data/processed/Pf/m2_all/msc_w_cln_strns_raw.RDS")
```

```{r, fig.width=12, fig.height=4}
# add stage metadata
stg_mkrs <- readRDS("data/processed/Pf/m2_all/stg_mkrs.RDS")

```


```{r}
## Making list of objects and renaming before integrating
m2_seu <- merge(x = msc_w_cln_strns_raw[[1]], y = msc_w_cln_strns_raw[2:length(msc_w_cln_strns_raw)], add.cell.ids = str_remove(names(msc_w_cln_strns_raw), "SC"))
m2_seu$donor <- str_remove_all(m2_seu$orig.ident, "SC|\\.mrna")
m2_seu$stage_c <- factor(m2_seu$stage_c, levels = c("Asexual", "Female", "Female LE", "Male", "Male LE"))
```


```{r, fig.width=20, fig.height=5}
#ap2g, gdv1, pfs16, etramp10.3, gexp5, pfg14-744, pfg14-748
# m2_seu_jnd <- JoinLayers(m2_seu)
m2_seu_noM12 <- m2_seu[,m2_seu@meta.data$donor != "M12"]

```



!!!NOTE - RAW COUNTS BEING USED - NEED TO CHANGE TO NORMALISED(DATA) WHICH IS STANDARD
```{r, fig.width=20, fig.height=5}
#ap2g, gdv1, pfs16, etramp10.3, gexp5, pfg14-744, pfg14-748
# m2_seu_jnd <- JoinLayers(m2_seu)

map(stg_mkrs, ~DotPlot(m2_seu_noM12, features = as.character(.x), split.by = "stage_c", group.by = "donor",  
        cols = c("#90bce5", "#ea5bba",  "#4ba7fc", "#f2e48c", "#af1527", "#af1091"
)) + 
  coord_flip()+
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = names(.x))
)


```


!!!NOTE - RAW COUNTS BEING USED - NEED TO CHANGE TO NORMALISED(DATA) WHICH IS STANDARD
```{r, fig.width=20, fig.height=12}
Idents(m2_seu_noM12) <- "stage_c"

DotPlot(m2_seu_noM12, features = as.character(unlist(stg_mkrs)), split.by = "stage_c", group.by = "donor",  
        cols = c("#ea5bba", "#90bce5",  "#4ba7fc", "#f2e48c", "#af1527", "#af1091"
)) + 
  coord_flip()+
  RotatedAxis() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_x_discrete(labels = names(unlist(stg_mkrs)))



```