---
title: "Integration of donor only and with lab"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  library(SeuratData)
  library(SeuratDisk)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  library(RColorBrewer)
  library(ggvenn)
  library(conflicted)
  library(MetBrewer)
  # library(dreamlet)
  # library(muscat)
  # library(ExperimentHub)
  # library(zenith)
  # library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  # library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  library(tradeSeq)
  library(BiocParallel)
  library(ggh4x)
  library(broom)
  library(lubridate)
  library(pander)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::as.factor)
  
})
```


#  integration of all MSC

## setup

```{r setup}
sample_set = "Mali2"

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("mali22_code_lnk/pf_common_vars.R")
```





```{r}
optimum_k_qcd <- c("MSC33" =8, "MSC48" =4, "MSC49" =6, "MSC55" =7, "MSC60" =7, "MSC66" =8, "MSC38" =4, "MSC40" =8, "MSC50_MACS" =1, "MSC53" =1, "MSC57" =1, "MSC24" =1, "MSC37" =5, "MSC39" =4, "MSC45" =1, "MSC50_SLO" =1, "MSC54" =1, "MSC67" =1, "MSC68" =3, "MSC70" =1)

optimum_k_qcd <- optimum_k_qcd[sort(names(optimum_k_qcd))]

qcd_dons <- c("MSC1", "MSC12", "MSC13", "MSC14", "MSC24", "MSC25", "MSC3", 
"MSC33", "MSC40", "MSC41", "MSC45", "MSC48", "MSC49", "MSC50_MACS", 
"MSC50_SLO", "MSC51", "MSC53", "MSC54", "MSC55", "MSC57", "MSC60", 
"MSC66", "MSC67", "MSC68", "MSC70")

qcd_dons_nc <- qcd_dons[!qcd_dons == "MSC12"] %>% str_remove(., "_MACS|_SLO") %>% unique()

## Remove MSC1 & MSC24 since these are also poorQC and MSC25, MSC41 and MSC51 which are mixed and M55 which is overloaded
qcd_dons_nc <- qcd_dons_nc[!qcd_dons_nc %in% c("MSC1", "MSC24", "MSC25", "MSC41", "MSC51", "MSC55")] %>% unique()
```

!!!NOTE - Reading in the metadata to add to the mixed species samples which were missed in the initial step - Will need to redo adding to the source
```{r}
mrc_sk21_summary <- read_csv("data/raw/MRC_Sample_Analysis_Summary_Summary.csv", skip = 1) 

mrc_sk21_summary_mxd <- mrc_sk21_summary %>% filter(Sample_Name %in% c("MSC25" ,"MSC41", "MSC51")) %>% mutate(across(Symptomatic, ~str_replace_all(., c("Y" = "Yes", "N" = "No")))) %>% select(Sample_Name,Symptomatic, Hb_Type) %>% rename("donor" = Sample_Name)
```



#### Add metadata age, temperature, parasitaemia_pf etc

```{r, fig.width=15, fig.height=5}
donor_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest_METADATA.csv", col_types =  paste0(c(rep("c", 7), "d", "c","d","d", rep("c", 14)), collapse = ""), show_col_types = T)  
donor_mdata <- donor_mdata %>% rename_all(., ~str_to_lower(str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "ยบ"=""))))
```


Retain only the MSC and remove "MSC19", "MSC20" which are duplicated and retain the set "`MSC19*`", "`MSC20*`" with relevant details
```{r, fig.width=15, fig.height=5}
donor_mdata_cln_nms <- donor_mdata %>%
  filter(!is.na(short_name) & str_detect(short_name, "MSC")) %>%
  filter(!(short_name %in% c("MSC19", "MSC20"))) %>%
  mutate(across(short_name, ~str_remove(., "\\*"))) 
```


```{r, fig.width=15, fig.height=5}
donor_mdata_cln_nms_pfp <- donor_mdata_cln_nms %>%
  mutate(parasitaemia_j0_pf_cln = as.numeric(str_remove(parasitaemia_j0, " Pf.*|Tf.*")),
         parasitaemia_j1_pf_cln = as.numeric(str_remove(parasitaemia_j1, " Pf.*|Tf.*")),
         parasitaemia_pf_cln = coalesce(parasitaemia_j0_pf_cln, parasitaemia_j1_pf_cln)
         )%>%
  mutate(
    parasitaemia_pf_manual = case_when(is.na(parasitaemia_pf_cln) & short_name == "MSC15" ~ as.numeric(str_remove_all(parasitaemia_j1, "[0-9]*Pm|\\+|Tf"))),
    parasitaemia_pf = coalesce(parasitaemia_pf_cln, parasitaemia_pf_manual))


```


```{r, fig.width=15, fig.height=5}
donor_mdata_cln_nms_pfp_pmop <- donor_mdata_cln_nms_pfp %>%
  mutate(parasitaemia_pmo = case_when(str_detect(parasitaemia_j0, "Pm|Po") ~ as.numeric(str_remove_all(parasitaemia_j0, ".*Pf,|Pm|Po")),
                                             str_detect(parasitaemia_j1, "Pm|Po") ~ as.numeric(str_remove_all(parasitaemia_j1, ".*Pf,|\\+.*Tf|Pm|Po"))
  )) 
```


Clean up processing times 
```{r, fig.width=15, fig.height=5}
first_day_21 <- ymd("2021/11/24")
first_day_22 <- ymd("2022/10/17")

  
donor_mdata_cln_nms_pfp_pmop_times <- donor_mdata_cln_nms_pfp_pmop %>%
  mutate(sampling_time_cln = hms(paste0(str_remove(time_of_sampling, c(" AM| PM")), ":00")),
         processing_time_cln = str_replace_all(time_of_sample_processing, c("15:30 PM" = "3:30 PM") ),
         across(processing_time_cln, ~hms(strftime(strptime(., format="%I:%M %p"), format="%H:%M:%S")))) %>%
  mutate(smpl_wait_time = as.numeric(as.duration(processing_time_cln - sampling_time_cln),"minutes")) %>%
  mutate(collection_date = as_date(ymd(date_yyyy_mm_dd)),
         days_frm_ssn_start = case_when(str_detect(date_yyyy_mm_dd, "2021") ~ as.numeric(as.duration(collection_date - first_day_21), "days"),
                                        str_detect(date_yyyy_mm_dd, "2022") ~ as.numeric(as.duration(collection_date - first_day_22), "days"))
  ) 

donor_mdata_cln_nms_pfp_pmop_times %>% select(short_name, contains("time"))
```


```{r, fig.width=15, fig.height=5}
donor_mdata_cln_nms_pfp_pmop_times %>% select(short_name, contains("time"), days_frm_ssn_start)
```

```{r, fig.width=15, fig.height=5}
donor_mdata_slct1 <- donor_mdata_cln_nms_pfp_pmop_times %>%
  mutate(fever = case_when(temperature_c >= 37.5 ~ "Fever", temperature_c < 37.5 ~ "NoFever"),
         condition = ifelse(symptomatic == "Y", "Symptomatic", "Asymptomatic"),
         across(condition, ~case_when(temperature_c > 37.5 & . == "Asymptomatic" ~ "Symptomatic",
                                     T ~ .)),
         across(condition, ~factor(., levels = c("Asymptomatic", "Symptomatic")))) %>% 
  select(short_name, parasitaemia_pf, parasitaemia_pmo, smpl_wait_time, days_frm_ssn_start, gender_m_f, weight_kg, symptomatic, condition, temperature_c, fever, age_years, species_by_microscopy)

```


```{r, fig.width=15, fig.height=5}
## Antoine additional metadata with specific symptoms
donor_mdata_dtld_symptoms <- readxl::read_xlsx("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest_May_2025_additional_info.xlsx")

donor_mdata_dtld_symptoms <- donor_mdata_dtld_symptoms %>% rename_with(.fn = ~str_to_lower(str_replace_all(str_remove(., " \\(.*"), c(" "= "_", "\\[|\\]"="", "/"="_", "ยบ"=""))), .cols = everything())

```


```{r, fig.width=15, fig.height=5}

donor_mdata_dtld_symptoms <- donor_mdata_dtld_symptoms %>%
  mutate(fever = case_when(temperature_c >= 37.5 ~ "Fever", temperature_c < 37.5 ~ "NoFever")) 

donor_mdata_dtld_symptoms %>% count(symptomatic, fever, history_of_fever, headache, vomiting, diarrhoea, abdominal_pain, previous_medication)

```


```{r, fig.width=15, fig.height=5}
donor_mdata_dtld_symptoms %>%
  filter(symptomatic == "N" & temperature_c > 37.5)
```

```{r, fig.width=15, fig.height=5}
donor_mdata_dtld_symptoms_slct <- donor_mdata_dtld_symptoms %>% 
  select(short_name, symptomatic, age_years, gender_m_f, weight_kg, temperature_c, headache, history_of_fever, vomiting, diarrhoea, abdominal_pain, other_comments, previous_medication, village, fever) %>%
  filter(!is.na(short_name))
```


```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 <- donor_mdata_slct1 %>% left_join(., donor_mdata_dtld_symptoms_slct, by = "short_name", suffix = c("_old", "_dara_new"))
```


```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% count(symptomatic_old, symptomatic_dara_new, fever_old, fever_dara_new)
```

Check out discrepancies for symptom status classification
```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% filter(symptomatic_old == "N" & symptomatic_dara_new == "Y" & fever_old == "Fever" & fever_dara_new == "Fever")
```

```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% filter(symptomatic_old == "N" & symptomatic_dara_new == "Y" & fever_old == "NoFever" & fever_dara_new == "NoFever")
```

```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% filter(symptomatic_old == "Y" & symptomatic_dara_new == "N" & fever_old == "NoFever" & fever_dara_new == "NoFever")
```

```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% filter(symptomatic_old == "Y" & symptomatic_dara_new == "Y" & fever_old == "NoFever" & fever_dara_new == "Fever")
```

```{r, fig.width=15, fig.height=5}
donor_mdata_slct2 %>% filter(symptomatic_old == "Y" & symptomatic_dara_new == "Y" & fever_old == "NoFever" & fever_dara_new == "NoFever")
```

```{r}
donor_mdata_slct2 %>% ggplot(aes(x = age_years_old, y = age_years_dara_new)) + geom_point()
donor_mdata_slct2 %>% count(gender_m_f_old,gender_m_f_dara_new)
donor_mdata_slct2 %>% ggplot(aes(x = temperature_c_old, y = temperature_c_dara_new)) + geom_point()
```



```{r, fig.width=15, fig.height=5}
donor_mdata_slct <- donor_mdata_slct2 %>%
  mutate(temperature_c = temperature_c_dara_new,
         symptomatic= symptomatic_dara_new,
         fever= fever_dara_new,
         age_years = age_years_dara_new,
         weight_kg = weight_kg_dara_new,
         gender_m_f = gender_m_f_dara_new,
         sympto_groups = case_when(temperature_c >= 37.5 & symptomatic == "Y" ~ "sympto_fever",
                                    temperature_c < 37.5 & history_of_fever == "Y" ~ "sympto_hist_fever",
                                    # temperature_c < 37.5 & history_of_fever == "N" & symptomatic == "Y" ~ "sympto_no_fever",
                                    temperature_c < 37.5 & history_of_fever == "N" & symptomatic == "Y" & symptomatic_old == "N" ~ "Asympto_NoF_other_symptoms",
                                    temperature_c < 37.5 & history_of_fever == "N" & symptomatic == "Y" & symptomatic_old == "Y" ~ "sympto_confusing",
                                    symptomatic == "N" & temperature_c < 37.5 & history_of_fever == "N" ~ "Asympto"),
         condition = case_when(sympto_groups %in% c("sympto_fever", "sympto_hist_fever", "sympto_confusing") ~ "Symptomatic",
                               sympto_groups %in% c("Asympto", "Asympto_NoF_other_symptoms") ~ "Asymptomatic"),
         # condition = ifelse(symptomatic == "Y", "Symptomatic", "Asymptomatic"),
         # across(condition, ~case_when(temperature_c > 37.5 & . == "Asymptomatic" ~ "Symptomatic",
         #                             T ~ .)),
         across(condition, ~factor(., levels = c("Asymptomatic", "Symptomatic")))) %>% 
  select(short_name, parasitaemia_pf, parasitaemia_pmo, smpl_wait_time, days_frm_ssn_start, gender_m_f, weight_kg, contains("symptomatic"), contains("fever"),  condition, temperature_c, fever, age_years, species_by_microscopy, headache, history_of_fever, vomiting, diarrhoea, abdominal_pain, other_comments, previous_medication, village, sympto_groups)

```



```{r, fig.width=15, fig.height=5}
donor_mdata_slct %>% count(symptomatic, fever, sympto_groups, condition)
```


```{r, fig.width=15, fig.height=5}
donor_mdata_slct %>% filter(fever == "NoFever", sympto_groups == "sympto_confusing")
```

```{r, fig.width=15, fig.height=5}
saveRDS(donor_mdata_slct, "data/processed/Pf/m2_all/donor_mdata_slct.RDS")
write_csv(donor_mdata_slct, "data/processed/Pf/m2_all/donor_mdata_slct.csv")
```

Get the different subsets of participants based on inclusion (all, with scrnaseq, pf with scrnaseq) into lists

```{r}
# (donor_mdata_slct_scrna <- donor_mdata_slct %>% filter(short_name %in% qcd_dons_nc))
(donor_mdata_slct_scrna <- donor_mdata_slct %>% filter(short_name %in% qcd_dons_nc))
(donor_mdata_slct_scrna_pfpure <- donor_mdata_slct %>% filter(short_name %in% qcd_dons_nc) %>% filter(!short_name %in% c("MSC25" ,"MSC41", "MSC51")))
```


```{r}
donor_mdata_lst <- list(donor_mdata_slct, donor_mdata_slct_scrna, donor_mdata_slct_scrna_pfpure) %>% set_names(c("all", "w_scrna", "w_scrna_pf"))
```

```{r}
map(donor_mdata_lst, ~.x %>% 
  # mutate(across(c(parasitaemia_j0, parasitaemia_j1), ~as.numeric(str_remove(., " Pf.*|Tf.*"))), parasitaemia_pf = coalesce(parasitaemia_j0, parasitaemia_j1))  %>% 
  # filter(donor %in% ) %>%
  ggplot(aes(x = condition, y = parasitaemia_pf)) +
  geom_boxplot()
)
```

```{r, fig.width=6, fig.height=5}
map(donor_mdata_lst, ~.x   %>% select(age_years, condition) %>%  ggplot(aes(x = condition, y = age_years)) + geom_boxplot())
```


```{r, fig.width=6, fig.height=5}
map(donor_mdata_lst, ~.x   %>% filter(short_name %in% qcd_dons_nc) %>% select(age_years, condition) %>%  ggplot(aes(x = condition, y = age_years)) + geom_boxplot())
```


```{r, fig.width=6, fig.height=5}
map(donor_mdata_lst, ~.x   %>% filter(short_name %in% qcd_dons_nc) %>% ggplot(aes(x = condition, y = smpl_wait_time)) + geom_boxplot() + geom_point())
```

```{r}
map(donor_mdata_lst, ~.x  %>%  
  ggplot(., aes(x = condition, y = temperature_c)) +
  geom_boxplot() +
  geom_point()
)
```

```{r}
map(donor_mdata_lst, ~.x  %>%  
  filter(short_name %in% qcd_dons_nc) %>% 
  ggplot(., aes(x = condition, y = temperature_c)) +
  geom_boxplot() +
  geom_point()
)
```


```{r}
map(donor_mdata_lst, ~.x  %>%  
  filter(short_name %in% qcd_dons_nc & temperature_c >= 37.5) 
)
```


```{r}
map(donor_mdata_lst, ~.x  %>%  glimpse)

```



```{r}
continuous_variables <- c("parasitaemia_pf", "smpl_wait_time", "weight_kg", "temperature_c", "age_years", "days_frm_ssn_start")
categorical_variables <- c("gender_m_f", "species_by_microscopy")

```

```{r}
categ_var_lst <- c(rep(list(categorical_variables), 2), "gender_m_f")

(donor_mdata_categorical <- map2(donor_mdata_lst, categ_var_lst, ~{
  # map(donor_mdata_lst, ~.x  %>%
  .x %>%
    select(condition, all_of(.y)) %>%
  pivot_longer(cols = .y, names_to = "variable",  values_to = "value")
})
)
```


```{r}

table1.categorical.Ns <- map(donor_mdata_categorical, ~.x  %>%
  group_by(condition, variable, value) %>%
  summarise(N=n()) %>% 
  pivot_wider(names_from = "condition", values_from = "N")
)
```


```{r}

map(donor_mdata_lst, ~.x  %>% filter(if_any(c(categorical_variables, continuous_variables), ~is.na(.x))))

```


```{r}
(table1.categorical.tests <-
   map(donor_mdata_categorical, possibly(~.x  %>%
  group_by(variable) %>%
  do(., fisher.test(.$value, .$condition) %>% tidy) %>%
  # this purely to facilitate matching rows up below
  mutate(firstrowforvar=T) %>%
    mutate(across(where(is.numeric), ~round(.x, digits = 3))),
  "less than 2 categories for fisher exact")
))

```


```{r}
(table1.categorical.both <- map2(table1.categorical.Ns,table1.categorical.tests, possibly(~.x  %>%
  group_by(variable) %>%
  # we join on firstrowforvar to make sure we don't duplicate the tests
  mutate(firstrowforvar=row_number()==1) %>%
  left_join(., .y, by=c("variable", "firstrowforvar")) %>%
  # this is gross, but we don't want to repeat the variable names in our table
  ungroup() %>%
  mutate(variable = ifelse(firstrowforvar==T, as.character(variable), NA)) %>%
  select(variable, value, Asymptomatic, Symptomatic, statistic, parameter, p.value), "less than 2 categories for fisher exact")))

```


```{r}

donor_mdata_continous <- map(donor_mdata_lst, ~.x  %>%
  select(condition, all_of(continuous_variables)) %>%
  pivot_longer(cols = -c(condition), names_to = "variable",  values_to = "value") %>%
  group_by(variable)
)

```



```{r}
(table.continuous_variables.tests <-
    map(donor_mdata_continous, ~.x %>%
  # note that we pass the result of Wilcoxon rank-sum to tidy, which returns a dataframe
  do(., wilcox.test(.$value ~ .$condition) %>% tidy) %>%
    select(variable, statistic, parameter, p.value) %>%
    mutate(across(where(is.numeric), ~round(.x, digits = 3)))
))
```


```{r}
map(donor_mdata_continous, ~.x %>%
  group_by(variable, condition) %>%
  filter(is.na(value))
)
```

```{r}
(table.continuous_variables.descriptives <-
  map(donor_mdata_continous, ~.x %>%
    group_by(variable, condition) %>%
    filter(!is.na(value)) %>% ## Remove NA as SD and mean will fail
    # summarise(Mean=mean(value), SD=sd(value), Median=median(value), IQR=IQR(value)) %>%
    summarise(Mean=mean(value), SD=sd(value)) %>%
    group_by(variable, condition) %>%
    # we format the mean and SD into a single column using sprintf.
    # we don't have to do this, but it makes reshaping simpler and we probably want
    # to round the numbers at some point, and so may as well do this now.
    # transmute(MeanSD = sprintf("%.2f (%.2f)", Mean, SD), MedianIQR = sprintf("%.2f (%.2f)", Median, IQR)) %>%
    transmute(MeanSD = sprintf("%.2f (%.2f)", Mean, SD)) %>%
    pivot_wider(names_from = "condition", values_from = "MeanSD")
)
)
```

```{r}
(table.continuous_variables.both <- map2(table.continuous_variables.descriptives, table.continuous_variables.tests, ~.x %>%
                                           left_join(., .y))
)
```

```{r}
# (table1 <-  map2(table1.categorical.both, table.continuous_variables.both, ~{
#   .x %>%
#   # make these variables into character format to be consistent with
#   # the Mean (SD) column for continuus variables
#   mutate_each(funs(format), Asymptomatic, Symptomatic) 
# }))

```

```{r}
(table1 <-  map2(table1.categorical.both, table.continuous_variables.both, possibly(~{
  .x %>%
  # make these variables into character format to be consistent with
  # the Mean (SD) column for continuus variables
  mutate_each(funs(format), Asymptomatic, Symptomatic) %>%
  bind_rows(., .y) %>%
  # prettify a few things
  rename(df = parameter,
         p=p.value,
         `Asymptomatic N/Mean (SD)`= Asymptomatic,
         `Symptomatic N/Mean (SD)`= Symptomatic,
         Variable=variable,
         Response=value,
         `ฯ2/t` = statistic)
}, "less than 2 categories for fisher exact")))

```


```{r}
table1_key <- c("gender_m_f" = "Sex", "species_by_microscopy" = "Species (microscopy)", "age_years" = "Age (years)", "days_frm_ssn_start" = "Days from start of season", "parasitaemia_pf" = "Parasitaemia", "smpl_wait_time" = "Duration between collection and processing", "temperature_c" = "Body temparature (C)", "weight_kg" = "Weight (Kg)" )
  

```

```{r}
table1_cln_nms <- map(table1, possibly(~.x %>% mutate(Variable = recode(Variable, !!!table1_key)), "less than 2 categories for fisher exact"))
  

```


```{r}
table1_cln_nms
  

```


```{r, fig.width=7.5, fig.height=2, results='markup'}
 map(table1_cln_nms, possibly(~.x  %>%
  # split.tables argument needed to avoid the table wrapping
  pander(split.tables=Inf,
         missing="-",
         justify=c("left", "left", rep("center", 5)),
     caption='Table presenting baseline differences between conditions. Categorical variables tested with Fisher\'s exact test, continuous variables with Wilcoxon rank-sum (Mann-Whitney U).')
   ), "less than 2 categories for fisher exact")
```


```{r, fig.width=7.5, fig.height=2, results='asis', results='hold'}
table1[[3]] %>%
  # split.tables argument needed to avoid the table wrapping
  pander(split.tables=Inf,
         missing="-",
         justify=c("left", "left", rep("center", 5)),
         caption='Table presenting baseline differences between conditions. Categorical variables tested with Fisher\'s exact test, continuous variables with Wilcoxon rank-sum (Mann-Whitney U).')

```


## Multivariate regression for table 1

```{r}
data <- data.frame(
  outcome = rnorm(100, mean = 50, sd = 10),   # Continuous outcome variable
  age = rnorm(100, mean = 30, sd = 5),        # Continuous predictor
  gender = sample(c("Male", "Female"), 100, replace = TRUE),  # Categorical predictor
  treatment = sample(c("Drug A", "Drug B", "Placebo"), 100, replace = TRUE)  # Categorical predictor
)

```

```{r}
data$gender <- as.factor(data$gender)
data$treatment <- as.factor(data$treatment)
data
```

```{r}
model <- lm(outcome ~ age + gender + treatment, data = data)
summary(model)

```


```{r, eval=FALSE}
# install.packages("tableone")
library(tableone)

vars <- c("age", "gender", "treatment", "outcome")
table1 <- CreateTableOne(vars = vars, data = data, factorVars = c("gender", "treatment"))
print(table1, showAllLevels = TRUE)

library(gtsummary)

# Create Table 1
table1 <- data %>%
  tbl_summary(
    by = gender,  # Group by gender (optional)
    statistic = list(all_continuous() ~ "{mean} ({sd})", all_categorical() ~ "{n} ({p}%)"),
    missing = "no"
  ) %>%
  add_p() %>%  # Adds p-values for group comparisons
  add_overall()

```

```{r}
tidy(model)
```

```{r}
donor_mdata_lst[[2]]
```


```{r}
donor_mdata_lst_1 <- donor_mdata_lst[[2]] %>% 
  mutate(across(c(condition),  ~factor(.x, levels = c("Asymptomatic", "Symptomatic"))),
         across(c(gender_m_f),  ~factor(.x, levels = c("F", "M"))),
         across(c(species_by_microscopy),  ~factor(.x, levels = c("Pf", "Pm", "Po", "Mixed Pf/Pm", "Mixed Pf/Po"))),
         sampling_day = days_frm_ssn_start +1)
```


```{r}
glimpse(donor_mdata_lst_1)
```

```{r}
# model <- lm(condition ~ age_years + gender_m_f + smpl_wait_time + weight_kg + temperature_c + species_by_microscopy + days_frm_ssn_start, data = donor_mdata_lst_1)
# model <- glm(condition ~ age_years + gender_m_f + smpl_wait_time + weight_kg + temperature_c , data = donor_mdata_lst_1, family = binomial(link = "logit"))
# model <- glm(condition ~ age_years + gender_m_f + weight_kg + temperature_c + days_frm_ssn_start + species_by_microscopy , data = donor_mdata_lst_1, family = binomial(link = "logit"))

model_time_sampling <- glm(condition ~  days_frm_ssn_start + smpl_wait_time , data = donor_mdata_lst_1, family = binomial(link = "logit"), control = glm.control(maxit = 1000))
summary(model_time_sampling)

model <- glm(condition ~ age_years + gender_m_f + weight_kg + parasitaemia_pf + temperature_c + smpl_wait_time, data = donor_mdata_lst_1, family = binomial(link = "logit"), control = glm.control(maxit = 1000))
summary(model)

model_sig <- glm(condition ~ parasitaemia_pf + temperature_c + smpl_wait_time, data = donor_mdata_lst_1, family = binomial(link = "logit"), control = glm.control(maxit = 1000))
summary(model_sig)

```

```{r}
model <- glm(condition ~ age_years + parasitaemia_pf + temperature_c + smpl_wait_time, data = donor_mdata_lst_1, family = binomial(link = "logit"), control = glm.control(maxit = 1000))
summary(model)

model <- glm(condition ~ age_years + parasitaemia_pf + temperature_c + smpl_wait_time + days_frm_ssn_start , data = donor_mdata_lst_1, family = binomial(link = "logit"), control = glm.control(maxit = 1000))
summary(model)
```

```{r}

```
Read in single cell object and add metadata

##############################START - Sample processing metadata ############################

!!!NOTE - Reading in the metadata to add to the mixed species samples which were missed in the initial step - Will need to redo adding to the source
```{r}
mrc_sk21_summary <- read_csv("data/raw/MRC_Sample_Analysis_Summary_Summary.csv", skip = 1) 

# mrc_sk21_summary_mxd <- mrc_sk21_summary %>% filter(Sample_Name %in% c("MSC25" ,"MSC41", "MSC51")) %>% mutate(across(Symptomatic, ~str_replace_all(., c("Y" = "Yes", "N" = "No")))) %>% select(Sample_Name,Symptomatic, Hb_Type) %>% rename("donor" = Sample_Name)
```

```{r, eval=T}
pf_solo_mixed_mdata_decode <- read_csv("data/raw/pf_solo_mixed_mdata_decode.csv")
```

```{r}
mrc_sk21_summary_w_categories <- mrc_sk21_summary %>% 
  # mutate(donor = str_remove(sample_nm, "_.*")) %>%
  rename("perc_map_p" = `%map to pfpmpo`, "perc_map_hs" = `%map to hs`) %>%
  mutate(p_map_cat = case_when(perc_map_p > 0 & perc_map_p < 33 ~ "low",
                              perc_map_p >= 33 & perc_map_p < 66 ~ "medium",
                              perc_map_p >= 66 & perc_map_p <= 100 ~ "high"),
         hs_map_cat = case_when(perc_map_hs > 0 & perc_map_hs < 33 ~ "low",
                              perc_map_hs >= 33 & perc_map_hs < 66 ~ "medium",
                              perc_map_hs >= 66 & perc_map_hs <= 100 ~ "high"),
         across(c(p_map_cat, hs_map_cat), ~factor(., levels = c("low", "medium", "high")))) %>% 
  mutate(peak = factor(str_replace(str_remove(Peak, " peak"), "Very ", "V."), levels = c("No", "Small", "Medium", "Big", "V.big"))) 
```


```{r}
mrc_sk21_summary_slct <- mrc_sk21_summary_w_categories %>% 
  left_join(pf_solo_mixed_mdata_decode, ., by = c("irods_id" = "Sanger_SampleID")) %>%
  select(sample_nm, pf, pm, po, nStrains_Pf, nStrains_Pm, nStrains_Po, Hb_Type, mixed_infection, Jumpcode, Gel_Emulsion, Symptomatic, perc_map_p, perc_map_hs, p_map_cat, hs_map_cat, Hb_perc, `RBCs loaded`, peak, Comment)
```


```{r}
mrc_sk21_summary_slct
```


```{r}
mrc_sk21_summary_slct %>%
  dplyr::count(p_map_cat, hs_map_cat)

```


```{r, fig.width=15, fig.height=5}
# donor_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest_FOR_GEM_10X.csv.csv", col_types =  paste0(c(rep("c", 7), "d", "c","d","d", rep("c", 14)), collapse = ""), show_col_types = T)  
donor_10x_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest - FOR_GEM_10X.csv", 
                            col_types =  paste0(c(rep("c", 9), rep("d", 8), "c" , rep("d", 6), rep("c", 4), rep("d", 6)), collapse = ""),
                            show_col_types = T
                            ) 

donor_10x_mdata <- donor_10x_mdata %>% rename_all(., ~str_to_lower(str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "ยบ"=""))))
```


```{r, fig.width=15, fig.height=5}

donor_10x_mdata %>%
  filter(!is.na(short_name) & str_detect(short_name, "MSC"))

```

```{r, fig.width=15, fig.height=5}

donor_10x_mdata_full <- donor_10x_mdata %>%
  filter(!is.na(short_name) & str_detect(short_name, "MSC"))%>%
  rename("donor" = short_name,
         "parasites_loaded" = totalparasitesloaded,
         "macsloaded" = macsloaded...29,
         "sloloaded" = sloloaded...30) %>% 
  mutate(frac_load = case_when(macsloaded > 0 & sloloaded > 0 ~ "MACS_SLO",
                               macsloaded > 0 & (sloloaded == 0 | is.na(sloloaded)) ~ "MACS",
                               (macsloaded == 0 | is.na(macsloaded)) & sloloaded > 0 ~ "SLO"),
         overload = case_when(parasites_loaded > 20000 ~ "Yes_20k",
                              parasites_loaded > 16000 ~ "Yes_16_20k",
                              parasites_loaded > 10000 & parasites_loaded <= 16000 ~ "No_10_16K",
                              parasites_loaded < 16000 ~ "No_under10K"),
         overload = factor(overload, levels = c("No_under10K", "No_10_16K", "Yes_16_20k", "Yes_20k")),
         frac_over = case_when(macsloaded > 16000 & sloloaded > 16000 ~ "MACS_SLO",
                               macsloaded > 16000 & (sloloaded == 0 | is.na(sloloaded)) ~ "MACS",
                               (macsloaded == 0 | is.na(macsloaded)) & sloloaded > 16000 ~ "SLO")) %>%
  select(donor, macs_smear_parasitemia_fraction, macs_parasites_per_ul, slo_smear_parasitemia_fraction, slo_parasites_per_ul, slo_volume_10x, rbcs_in_mix, parasites_loaded...23, targeted_cells, gel_emulsion, macsloaded, sloloaded, parasites_loaded, frac_load, overload, frac_over)

```



```{r, fig.width=15, fig.height=5}
donor_10x_mdata_sk21_summ <- donor_10x_mdata_full %>% left_join(., mrc_sk21_summary_slct, by = c("donor" = "sample_nm"))

```


```{r, fig.width=15, fig.height=5}
donor_10x_mdata_sk21_summ <- donor_10x_mdata_sk21_summ %>%
    mutate(across(Jumpcode, ~ifelse(donor == "MSC14", "No", Jumpcode)),
           year = ifelse(donor %in% paste0("MSC",1:20), "2021", "2022"))

```


```{r, fig.width=15, fig.height=5}
saveRDS(donor_10x_mdata_sk21_summ, "data/processed/Pf/m2_all/donor_10x_mdata_sk21_summ.RDS")
saveRDS(donor_10x_mdata_sk21_summ, "data/processed/Pf/m2_all/donor_10x_mdata_sk21_summ.csv")

```

##############################END - Sample processing metadata ############################

##############################START - Sample from total participants VS sequenced ############################

```{r, fig.width=15, fig.height=5}
donor_mdata_lst[[1]] %>% glimpse

```


```{r, fig.width=15, fig.height=5}
glimpse(mrc_sk21_summary_w_categories)
```

```{r count-runs-per-sample}
# Count number of unique irods ids to get the total number of sequenced output
length(unique(mrc_sk21_summary_w_categories$Sanger_SampleID))
```

```{r count-runs-per-sample}
mrc_sk21_summary_sequenced_distinct_dons <- mrc_sk21_summary_w_categories %>% 
  # filter(str_detect(mixed_infection, "pf") & (str_detect(shortids, "SetB|SetC") | Sample_Name %in% c("MSC1", "MSC3", "MSC13", "MSC14", "MSC12C72") )) %>%
  mutate(sample_nm = str_remove_all(Sample_Name, "_JC|C72|_MACS|_SLO")) %>%
  group_by(sample_nm) %>%
  add_count(name = "runs") %>% 
  ungroup() %>%
  mutate(sequenced = "yes") %>%
  distinct(sample_nm, sequenced, .keep_all = T)
```


```{r count-runs-per-sample}
mrc_sk21_summary_sequenced_distinct_dons
```


```{r count-runs-per-sample}
donor_mdata_all_w_sequence_info <- donor_mdata_lst[[1]] %>% 
  left_join(mrc_sk21_summary_sequenced_distinct_dons, by = c("short_name"= "sample_nm"))

```


```{r count-runs-per-sample}
donor_mdata_all_w_sequence_info %>% 
  count(sequenced, mixed_infection, mixed_infection2)

```

```{r count-runs-per-sample}
## Non - pf
donor_mdata_all_w_sequence_info %>% 
  filter(sequenced == "yes" & !(mixed_infection == "pf" & mixed_infection2 == "solo"))

```

```{r count-runs-per-sample}
## Non - pf
donor_mdata_all_w_sequence_info %>% 
  filter(sequenced == "yes" & !(mixed_infection == "pf" & mixed_infection2 == "solo")) %>%
  pull(short_name) %>%
  unique()

```


## Samples to be included in the paper
```{r, message=F, warning=F, eval=T}
key_samples <- c("MSC3", "MSC13", "MSC14", "MSC33C", "MSC40C", "MSC45", "MSC48C", "MSC49C", "MSC50_MACS", "MSC50_SLOC", "MSC53", "MSC54", "MSC57", "MSC60C", "MSC66C", "MSC67", "MSC68C", "MSC70C")

don_order <- str_remove(key_samples, "C$")

```

```{r, message=F, warning=F, eval=T}
don_order_plus_m50 <- c(don_order, "MSC50")
```


```{r, message=F, warning=F, eval=T}
## Jr35 excluded due to poor QC outlook
jr35_exclude <- c("MSC1", "MSC24", "MSC37", "MSC38", "MSC39", "MSC55")
```

```{r, message=F, warning=F, eval=T}
## Jr35 excluded due to poor QC outlook
culture <- c("MSC12")
```

Reason for including or not including sample in the final analysis for the paper

```{r count-runs-per-sample}

donor_mdata_all_w_sequence_info_criteria <- donor_mdata_all_w_sequence_info %>% 
  mutate(publication_inclusion = case_when(sequenced == "yes" & mixed_infection == "pf" & short_name %in% don_order_plus_m50 ~ "Included",
                                           sequenced == "yes" & mixed_infection == "pf" & short_name %in% culture ~ "Ex-vivo culture",
                                           sequenced == "yes" & mixed_infection == "pf" & short_name %in% jr35_exclude ~ "Pf low post-seq qual (poor cells jr35)",
                                           sequenced == "yes" & mixed_infection == "pf" & !(short_name %in% don_order_plus_m50) ~ "Pf low post-seq qual (sk21)",
                                           sequenced == "yes" & str_detect(mixed_infection, "pm|po") ~ "Non Pf",
                                           is.na(sequenced) ~ "Not sequenced"
                                           ))

```

```{r count-runs-per-sample}
donor_mdata_all_w_sequence_info_criteria %>%
  count(publication_inclusion)

```

```{r count-runs-per-sample}
donor_mdata_all_w_sequence_info_criteria %>%
  filter(publication_inclusion == "Not sequenced")

```

```{r count-runs-per-sample}
donor_mdata_all_w_sequence_info_criteria %>%
  count(publication_inclusion, Reason, Gel_Emulsion)

```
