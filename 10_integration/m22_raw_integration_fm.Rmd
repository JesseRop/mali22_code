---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  # library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(slingshot)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
})
```







# MSC Preprocessing


## setup, read input files and exploratory visualizations and general functions


```{r, setup}
# library(reticulate)
# # use_condaenv("/Users/jr35/envs/scv_jupcon/", required = TRUE)
# # matplotlib <- reticulate::import("matplotlib")
# # matplotlib$use("Agg", force = TRUE)
# 
# knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali')
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
```


################  START ### Get cells from the intergrated object  ################
```{r}
# m2_all_raw_mrg <- readRDS("data/processed/Pf/m2_all/m2_all_raw_mrg.RDS")

all_jcC_seu_scvi_noM55 <- readRDS("data/processed/Pf/m2_all/scvi2seu/all_jcC_seu_scvino_M55.RDS")

```

```{r}
DimPlot(all_jcC_seu_scvi_noM55, reduction = "scvi_umap", group.by = "stage_fld", cols = sp_col_new)

```

```{r}
DimPlot(all_jcC_seu_scvi_noM55, reduction = "scvi_umap", group.by = "stage_fld", cols = sp_col_new, dims = c(1,2))

```

```{r, warning=FALSE, message=FALSE}
VlnPlot(all_jcC_seu_scvi_noM55, features = "nFeature_RNA", group.by = "stage_fld", pt.size = 0) + geom_hline(yintercept = c(200, 400, 500, 1000))
```

```{r, warning=FALSE, message=FALSE}
VlnPlot(all_jcC_seu_scvi_noM55, features = "nFeature_RNA", group.by = "leiden", pt.size = 0) + geom_hline(yintercept = c(200, 400, 500, 1000))
```

```{r}
all_seu_scvi_fem <- all_jcC_seu_scvi_noM55[, all_jcC_seu_scvi_noM55$stage_fld  == "Female"]
all_seu_scvi_femLE <- all_jcC_seu_scvi_noM55[, all_jcC_seu_scvi_noM55$stage_fld  == "Female (LE)"]
all_seu_scvi_male <- all_jcC_seu_scvi_noM55[, all_jcC_seu_scvi_noM55$stage_fld  == "Male"]
all_seu_scvi_maleLE <- all_jcC_seu_scvi_noM55[, all_jcC_seu_scvi_noM55$stage_fld  == "Male (LE)"]

```

```{r}
all_seu_scvi_fm <- list(all_seu_scvi_fem, all_seu_scvi_femLE, all_seu_scvi_male, all_seu_scvi_maleLE) %>% set_names(c("f", "fLE", "m", "mLE"))

```

##############################START Female DE ##########################

```{r}
map(all_seu_scvi_fm, ~DimPlot(.x, reduction = "scvi_umap", group.by = "leiden", label = T))
```

```{r}
map(all_seu_scvi_fm, ~.x@meta.data %>% count(leiden) %>% arrange(desc(n)))
```


```{r}
clstrs2keep <- list(c(2, 4, 8, 9, 10, 14, 15), c(3), c(0, 6, 11), c(11))
```

```{r}
## Subset clusters that correlate with stage. I.e remove clusters that group together with non-interest clusters
all_seu_scvi_fm_cln <- map2(all_seu_scvi_fm, clstrs2keep, ~subset(.x, subset = leiden %in% .y))
```

```{r}
map(all_seu_scvi_fm_cln, ~DimPlot(.x, reduction = "scvi_umap", group.by = "leiden", label = T))
```

```{r}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% count(orig.ident))
```


```{r}
## Remove donors with less than 50 cells
don50 <- map(all_seu_scvi_fm_cln, ~.x@meta.data %>% filter(n() > 50 , .by = orig.ident) %>% pull(orig.ident) %>% unique())

all_seu_scvi_fm_cln <- map2(all_seu_scvi_fm_cln, don50, ~subset(.x, subset = orig.ident %in% .y))
```


```{r}
## Keep only those stages with more than one donor for further downstream processing since intergration cannot be performed on one donor
len_greater_than1 <- map(all_seu_scvi_fm_cln, ~length(unique(.x$orig.ident)) > 1) %>% unlist()
len_greater_than1

all_seu_scvi_fm_cln <- all_seu_scvi_fm_cln[len_greater_than1]
```


```{r, fig.width=14, fig.height=4}
map(all_seu_scvi_fm_cln, ~VlnPlot(.x, group.by = "orig.ident", split.by = "stage_fld", features = "nCount_RNA", pt.size = 0) + scale_y_log10())
```


```{r, warning=FALSE, message=FALSE}
for (nm in names(all_seu_scvi_fm_cln)) {
  DefaultAssay(all_seu_scvi_fm_cln[[nm]]) <- "RNA"
  all_seu_scvi_fm_cln[[nm]][["RNA"]]$data <- NULL
  all_seu_scvi_fm_cln[[nm]][["SCT"]] <- NULL
}
```

```{r, warning=FALSE, message=FALSE}
all_seu_scvi_fm_cln <- map(all_seu_scvi_fm_cln, ~split(.x, f = .x$orig.ident))

```


```{r}
map(all_seu_scvi_fm_cln, ~table(.x$orig.ident))
```

################  END ### Get cells from the intergrated object  ################

```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% count(stage_fld))
```

```{r, warning=FALSE, message=FALSE}
all_seu_scvi_fm_cln <- map(all_seu_scvi_fm_cln, ~.x@meta.data %>% 
  rownames_to_column('bcode') %>%
  mutate(dset_labmrg = "Field",
         stage = stage_fld,
         donor = str_remove_all(orig.ident, ".mrna")) %>% 
  add_count(donor, name = "don_count") %>%
  select(bcode, dset_labmrg, donor, don_count, stage) %>%
  column_to_rownames('bcode') %>%
  AddMetaData(.x, .))
  
```


```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% count(stage, dset_labmrg, donor))
```

```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% dplyr::count(donor, dset_labmrg))
```


```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% add_count(stage_fld, name = "stg_n") %>% group_by() %>% dplyr::count(donor))
```

```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% dplyr::count(donor, dset_labmrg))
```

```{r, warning=FALSE, message=FALSE}
map(all_seu_scvi_fm_cln, ~.x@meta.data %>% add_count(donor) %>% dplyr::filter( n < 100))
```

Identify clusters with balanced representation across donors and subset these as separate object for within strain DE

```{r, warning=FALSE, message=FALSE}
## Count donors within each scvi leiden cluster factoring only those donors with more than 50 cells
donor_counts_in_leiden_clusters <- map(all_seu_scvi_fm_cln, ~.x@meta.data %>% count(orig.ident, leiden) %>% group_by(leiden) %>% arrange(desc(n), .by_group = T) %>% filter(n > 50) %>% mutate(don_n = n_distinct(orig.ident), don_prop = don_n/length(unique(.x$orig.ident)))) 

donor_counts_in_leiden_clusters
```

```{r}
## Get clusters with equal to or more than 70%/50% of total donors as clusters for within strain DE
donor_counts_in_leiden0.7 <- map(donor_counts_in_leiden_clusters, ~.x %>% filter(don_prop >= 0.7) %>% pull(leiden) %>% unique())
donor_counts_in_leiden0.7

donor_counts_in_leiden0.5 <- map(donor_counts_in_leiden_clusters, ~.x %>% filter(don_prop >= 0.5) %>% pull(leiden) %>% unique())
donor_counts_in_leiden0.5

donor_counts_in_leiden_all <- map(donor_counts_in_leiden_clusters, ~.x %>% pull(leiden) %>% unique())
donor_counts_in_leiden_all
```

```{r}
## Keep only unique cluster sets across the lists
lists <- list(donor_counts_in_leiden_all, donor_counts_in_leiden0.7, donor_counts_in_leiden0.5)

seen <- character()

dedup_lists <- lapply(lists, function(x) {
  keep <- !x %in% seen
  seen <<- c(seen, x[keep])
  x[keep]
})

names(dedup_lists) <- c("all", "w.7", "w.5")

dedup_lists <- unlist(dedup_lists, recursive = F)
dedup_lists
```

```{r}
## Keep clusters with all, >=70%, and >=50% of total donors as clusters for within strain DE
fm_leiden_w_donors <- imap(dedup_lists, ~subset(all_seu_scvi_fm_cln[[str_extract(.y, "[aA-zZ]+$")]], subset = leiden %in% .x))

```


```{r}
map(fm_leiden_w_donors, ~DimPlot(.x, reduction = "scvi_umap", group.by = "leiden", label = T))
```

```{r}
## assess cells above 99% quantile for UMI count
map(fm_leiden_w_donors, ~VlnPlot(.x, features = "nCount_RNA", group.by = "leiden") + geom_hline(yintercept = quantile(.x$nCount_RNA, probs = c(0.01, 0.99))))
```

```{r}
## assess cells above 99% quantile for gene count
map(fm_leiden_w_donors, ~VlnPlot(.x, features = "nFeature_RNA", group.by = "leiden") + geom_hline(yintercept = quantile(.x$nFeature_RNA, probs = c(0.01, 0.99))))
```

```{r}
# ## !! NOTE - Not necessary for now since outliers have been removed before in single donor QC 
# ## Remove extreme outliers <0.01 and >0.99 percentiles
# 
# map(fm_leiden_w_donors, ~table(.x@meta.data$nFeature_RNA >= quantile(.x$nFeature_RNA, probs = c(0.01)) & 
#                                  .x@meta.data$nFeature_RNA <= quantile(.x$nFeature_RNA, probs = c(0.99))))
# 
# 
# fm_leiden_w_donors <- map(fm_leiden_w_donors, ~subset(nFeature_RNA >= quantile(.x$nFeature_RNA, probs = c(0.01)) & nFeature_RNA <= quantile(.x$nFeature_RNA, probs = c(0.99))))

```

```{r}
## remove any donor with less than 50 cells
map(fm_leiden_w_donors, ~.x@meta.data %>% count(orig.ident, don_count))
```

```{r}
## remove any donor with less than 100 cells
fm_leiden_w_donors <- map(fm_leiden_w_donors, ~.x[, !.x@meta.data$don_count < 100])
```


```{r}
# imap(fm_leiden_w_donors, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_all_", .y, ".RDS")))
imap(fm_leiden_w_donors, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/integration/fm_leiden_w_donors_", .y, ".RDS")))

```


```{r, eval=T}
gogo()
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_integration_bsub.sh

# --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/integration/fm_leiden_w_donors_*.f.RDS" \
# --hvg 1000 --cluster_resoln 0.1 --cl_nm "seurat_clusters" --integrtd_pc30 "no" \
# --ncores "5" --mem "50 GB" --run_time="55.min" \

# --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/integration/fm_leiden_w_donors_*.fLE.RDS" \
# --hvg 500 --cluster_resoln 0.1 --cl_nm "seurat_clusters" --integrtd_pc30 "no" \
# --ncores "5" --mem "50 GB" --run_time="55.min" \

# --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/integration/fm_leiden_w_donors_*.m.RDS" \
# --hvg 800 --cluster_resoln 0.1 --cl_nm "seurat_clusters" --integrtd_pc30 "no" \
# --ncores "5" --mem "50 GB" --run_time="55.min" \
```


```{r, eval=T}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_intgrtn_pc_harmony_bsub.sh

# --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/integration/fm_leiden_w_donors_*_norm.RDS" \
# --mthd_nm "harmony_PC_man" --cluster_resoln 0.3 --intgrtn_pc 8 --integrtd_pc_man "yes" \
# --ncores "5" --mem "40 GB" --run_time="1.hour" \
```

```{r, message=F, warning=F}
# ##Read BPcells matrices
# fm_leiden_w_donors_norm_harmony <- list.files("data/processed/Pf", pattern = "v3_m2_asex_cr_(filt|filt_noM55)_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/m2_all/v3_m2_asex_cr_|_norm.*'))) %>% 
#   # .[sample_name] %>%
#   map(readRDS)

```

```{r, message=F, warning=F}
##Read BPcells matrices
# fm_leiden_w_donors_norm_harmony <- list.files("data/processed/Pf", pattern = "v3_m2_asex_cr_filt_(all|noM55)_jc._norm_harmony_PC_man.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
fm_leiden_w_donors_norm_harmony <- list.files("data/processed/Pf", pattern = "fm_leiden_w_donors_.*_norm_harmony_PC_man.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/m2_all/fm_leiden_w_donors_.|_norm.*'))) %>% 
  # .[sample_name] %>%
  map(readRDS)

```



```{r, warning=FALSE, message=FALSE}
fm_leiden_w_donors_norm_harmony[[3]]
```

```{r, warning=FALSE, message=FALSE}
fm_leiden_w_donors_norm_harmony[[3]]@meta.data %>% count(orig.ident)
```


```{r, warning=FALSE, message=FALSE}
#ap2g
fm_leiden_w_donors_norm_harmony_umap_mdata <- map(fm_leiden_w_donors_norm_harmony, ~{
  .x@meta.data %>% 
    rownames_to_column("bcode") %>%
      left_join(., .x@reductions$umap.harmony_PC_man@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode")
})
```


```{r, message=FALSE, warning=FALSE, eval=T}
# Save the clean umaps for plotting
saveRDS(fm_leiden_w_donors_norm_harmony_umap_mdata, "data/processed/Pf/m2_all/asex_integration_comtmnt_DE_figs/fm_leiden_w_donors_norm_harmony_umap_mdata.RDS")
# go()
```


```{r, warning=FALSE, message=FALSE}
# # fm_leiden_w_donors_norm_harmony <- readRDS("data/processed/Pf/m2_all/fm_leiden_w_donors_norm_harmony.RDS")
# fm_leiden_w_donors_norm_harmony <- readRDS("data/processed/Pf/m2_all/fm_leiden_w_donors_norm_harmony_pc_man.RDS")
# 
# ### 1. Run on asexuals after QC with PC specified manually
# # --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/v3_m2_asex_cr_filt_norm.RDS" \ 
# # --mthd_nm "harmony_pc_man" --cluster_resoln 0.4 --intgrtn_pc 6 --integrtd_pc_man "yes" \
# # --ncores "10" --mem "100 GB" --run_time="1.hour"

```

```{r, warning=FALSE, message=FALSE}
# fm_leiden_w_donors_norm_harmony_elbo <- readRDS("data/processed/Pf/m2_all/fm_leiden_w_donors_norm_harmony_elbo.RDS")
# fm_leiden_w_donors_norm_harmony_elbo
```


```{r, warning=FALSE, message=FALSE}
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "integrated.harmony_PC_man"))
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man"))
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, group.by = "stage", reduction = "umap.harmony_PC_man") + scale_color_manual(values = sp_fld_colors))
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, group.by = "donor", reduction = "umap.harmony_PC_man"))
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(.x, features = "nFeature_RNA", reduction = "umap.harmony_PC_man"))
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(.x, features = "nCount_RNA", reduction = "umap.harmony_PC_man"))
# VlnPlot(fm_leiden_w_donors_norm_harmony, features = "nCount_RNA", group.by = "seurat_clusters", reduction = "umap.harmony_PC_man")

```



```{r, warning=FALSE, message=FALSE}
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, group.by = "stage", reduction = "umap.harmony_PC_man") + scale_color_manual(values = sp_col_new))

```

```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=3}
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(.x, features = c("PF3D7-1222600", "PF3D7-0113600", "PF3D7-1102500"), reduction = "umap.harmony_PC_man", ncol = 3))

```

```{r, warning=FALSE, message=FALSE, fig.width=8, fig.height=3}
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(.x, features = c("PF3D7-1222600", "PF3D7-0113600", "PF3D7-1102500"), reduction = "umap.harmony_PC_man", ncol = 3, order = T))

```


```{r, warning=FALSE, message=FALSE}
# map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", cells.highlight = colnames(.x[,.x@meta.data$Strain_DN == "Doublet"])))

```
```{r, warning=FALSE, message=FALSE}
# map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", cells.highlight = colnames(.x[,.x@meta.data$stage_fld == "Unassigned"])))

```

```{r, warning=FALSE, message=FALSE, fig.width= 15, fig.height=4}
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, split.by = "stage", reduction = "umap.harmony_PC_man", pt.size = 0.0001) )

```

```{r, warning=FALSE, message=FALSE, fig.width=12, fig.height=3}
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", split.by = 'donor'))

```

```{r, warning=FALSE, message=FALSE, eval=F}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(fm_leiden_w_donors_norm_harmony[["noM55_jcC"]]@reductions[["umap.harmony_PC_man"]]@cell.embeddings),
        x = ~umapharmonyPCman_1, y = ~umapharmonyPCman_2, z = ~umapharmonyPCman_3,
        color= fm_leiden_w_donors_norm_harmony[["noM55_jcC"]]@meta.data$harmony_PC_man_clusters,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.1, 
        type = 'scatter3d'
)

```


```{r, warning=FALSE, message=FALSE, eval=F}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(fm_leiden_w_donors_norm_harmony[["all_jcC"]]@reductions[["umap.harmony_PC_man"]]@cell.embeddings),
        x = ~umapharmonyPCman_1, y = ~umapharmonyPCman_2, z = ~umapharmonyPCman_3,
        color= fm_leiden_w_donors_norm_harmony[["all_jcC"]]@meta.data$harmony_PC_man_clusters,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.1, 
        type = 'scatter3d'
)

```

```{r, warning=FALSE, message=FALSE}
imap(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_PC_man_clusters") + labs(title = .y))

```

```{r, warning=FALSE, message=FALSE}
# imap(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, reduction = "umap.harmony_PC_man", cells.highlight = colnames(.x[,.x@meta.data$stage_fld == "Unassigned"])) + labs(title = .y))

```

```{r, warning=FALSE, message=FALSE}
imap(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_PC_man_clusters", dims = c(1,3))+ labs(title = .y))

```

```{r, warning=FALSE, message=FALSE}
map(fm_leiden_w_donors_norm_harmony, ~DimPlot(.x, label = T, reduction = "integrated.harmony_PC_man", group.by = "harmony_PC_man_clusters", dims = c(2,3)))

```



```{r, warning=FALSE, message=FALSE}
fm_leiden_w_donors_norm_harmony_jnd <- map(fm_leiden_w_donors_norm_harmony, ~JoinLayers(.x))
map(fm_leiden_w_donors_norm_harmony_jnd, ~DefaultAssay(.x))
map(fm_leiden_w_donors_norm_harmony_jnd, ~unique(Idents(.x)))
```


```{r, warning=FALSE, message=FALSE}
rm(fm_leiden_w_donors_norm_harmony)
```


```{r, warning=FALSE, message=FALSE}
# imap(fm_leiden_w_donors_norm_harmony_jnd, ~saveRDS(., paste0("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_", .y,"_norm_harmony_jnd.RDS")))
imap(fm_leiden_w_donors_norm_harmony_jnd, ~saveRDS(., paste0("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_", .y,"_norm_harmony_jnd3.RDS")))

```

######################START## Save a diet slim object which is lighter for faster processing if one just needs counts#####################

```{r, message=F, warning=F}
fm_leiden_w_donors_norm_harmony_jnd_slim <- fm_leiden_w_donors_norm_harmony_jnd
```

```{r, warning=FALSE, message=FALSE}
for (nm in names(fm_leiden_w_donors_norm_harmony_jnd_slim)) {
  fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]][["RNA"]]$counts <- as(fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]][["RNA"]]$counts, Class = "dgCMatrix")
  fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]][["RNA"]]$data <- as(fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]][["RNA"]]$data, Class = "dgCMatrix")

}
```

```{r, message=F, warning=F}
fm_leiden_w_donors_norm_harmony_jnd_slim <- map(fm_leiden_w_donors_norm_harmony_jnd_slim, ~CreateSeuratObject(
  counts = LayerData(.x, layer = "counts"), 
  data = LayerData(.x, layer = "data"),  
  meta.data = .x@meta.data))
```

```{r, warning=FALSE, message=FALSE}
for (nm in names(fm_leiden_w_donors_norm_harmony_jnd_slim)) {
  
  fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]]@reductions$umap.harmony_PC_man = fm_leiden_w_donors_norm_harmony_jnd[[nm]]@reductions$umap.harmony_PC_man
  
  fm_leiden_w_donors_norm_harmony_jnd_slim[[nm]]@reductions$integrated.harmony_PC_man = fm_leiden_w_donors_norm_harmony_jnd[[nm]]@reductions$integrated.harmony_PC_man

}
```


```{r}
# save object
imap(fm_leiden_w_donors_norm_harmony_jnd_slim, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_", .y, "_norm_harmony_jnd_slim3.RDS")))

```

######################END## Save a diet slim object which is lighter for faster processing if one just needs counts#####################

```{r, warning=FALSE, message=FALSE}
map(fm_leiden_w_donors_norm_harmony_jnd, ~FeaturePlot(.x, features = c("PF3D7-1222600", "PF3D7-0113600"), reduction = "umap.harmony_PC_man", order = T))

```

```{r, warning=FALSE, message=FALSE}
gogo()
```

##!!!! NOTE - Below should be deleted if we decide not to use SCT
####################SCT INTEGRATION alternative ####################

```{r, warning=FALSE, message=FALSE}
# split layers
v3_m2_asex_cr_filt[["RNA"]] <- split(v3_m2_asex_cr_filt[["RNA"]], f = v3_m2_asex_cr_filt$donor)

```


```{r, warning=FALSE, message=FALSE}
# run sctransform
v3_m2_asex_cr_filt_sct <- SCTransform(v3_m2_asex_cr_filt, verbose = FALSE, variable.features.n = 400)
# v3_m2_asex_cr_filt_sct <- SCTransform(v3_m2_asex_cr_filt, verbose = FALSE, variable.features.n = 300)
```

```{r, warning=FALSE, message=FALSE}
# These are now standard steps in the Seurat workflow for visualization and clustering
v3_m2_asex_cr_filt_sct <- RunPCA(v3_m2_asex_cr_filt_sct, verbose = FALSE, npcs = 20)

```

```{r, warning=FALSE, message=FALSE}
# run sctransform
DimPlot(v3_m2_asex_cr_filt_sct, reduction = "pca")

```

```{r, warning=FALSE, message=FALSE}
# Error in getGlobalsAndPackages(expr, envir = envir, globals = globals) : 
options(future.globals.maxSize = 1000 * 1024^2)  # 1000 MiB (or 1 GiB)

v3_m2_asex_cr_filt_sct_int <- IntegrateLayers(
  object = v3_m2_asex_cr_filt_sct,
  method = RPCAIntegration,
  normalization.method = "SCT",
  verbose = F,
  # k.weight = 90,
)


```

```{r, warning=FALSE, message=FALSE}

v3_m2_asex_cr_filt_sct_int <- FindNeighbors(v3_m2_asex_cr_filt_sct_int, dims = 1:5, reduction = "integrated.dr")
v3_m2_asex_cr_filt_sct_int <- FindClusters(v3_m2_asex_cr_filt_sct_int, resolution = 0.5)
```

```{r, warning=FALSE, message=FALSE}
# These are now standard steps in the Seurat workflow for visualization and clustering
v3_m2_asex_cr_filt_sct_int <- RunUMAP(v3_m2_asex_cr_filt_sct_int, dims = 1:5, verbose = FALSE, n.components = 3, seed.use = 867)
v3_m2_asex_cr_filt_sct_int <- FindNeighbors(v3_m2_asex_cr_filt_sct_int, dims = 1:5, verbose = FALSE)
v3_m2_asex_cr_filt_sct_int <- FindClusters(v3_m2_asex_cr_filt_sct_int, verbose = FALSE, resolution = 0.1)
```

```{r, warning=FALSE, message=FALSE}
# saveRDS(v3_m2_asex_cr_filt_sct_int, "data/processed/Pf/m2_all/v3_m2_asex_cr_filt_sct_int.RDS")
```

```{r, warning=FALSE, message=FALSE}
v3_m2_asex_cr_filt_sct_int <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_cr_filt_sct_int.RDS")
```


```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, reduction = "pca")
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T)
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage") + scale_color_manual(values = sp_fld_colors)
DimPlot(v3_m2_asex_cr_filt_sct_int, group.by = "donor")
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "nFeature_RNA"))
map(fm_leiden_w_donors_norm_harmony, ~FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "nCount_RNA"))
VlnPlot(v3_m2_asex_cr_filt_sct_int, features = "nCount_RNA", group.by = "seurat_clusters")

```


```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_cr_filt_sct_int@reductions[["umap"]]@cell.embeddings),
        x = ~umap_1, y = ~umap_2, z = ~umap_3,
        color= v3_m2_asex_cr_filt_sct_int@meta.data$stage_fld,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.1, 
        type = 'scatter3d'
)

```

```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(2,3))

```

```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, dims = c(1,3))

```


```{r, warning=FALSE, message=FALSE}
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, group.by = "stage", dims = c(1,3))
DimPlot(v3_m2_asex_cr_filt_sct_int, label = T, dims = c(1,3))

```

```{r, warning=FALSE, message=FALSE}
## ap2g
DefaultAssay(v3_m2_asex_cr_filt_sct_int) <- "RNA"
v3_m2_asex_cr_filt_sct_int <- NormalizeData(v3_m2_asex_cr_filt_sct_int) 
```

```{r, warning=FALSE, message=FALSE}
## ap2g
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1222600", order = T) 
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1222600", reduction = "pca", order = T) 
```


```{r, warning=FALSE, message=FALSE}
## ap2g
v3_m2_asex_cr_filt_sct_int_ap2g <- subset(v3_m2_asex_cr_filt_sct_int, subset = `PF3D7-1222600` > 0, slot = 'counts')

table(v3_m2_asex_cr_filt_sct_int_ap2g$donor)
```

```{r, warning=FALSE, message=FALSE}
## ap2g
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1215500", order = T) 
FeaturePlot(v3_m2_asex_cr_filt_sct_int, features = "PF3D7-1215500", reduction = "pca", order = T) 
```


```{r, warning=FALSE, message=FALSE}

DefaultAssay(v3_m2_asex_cr_filt_sct_int) <- "SCT"
```



####################SCT INTEGRATION alternative ####################

