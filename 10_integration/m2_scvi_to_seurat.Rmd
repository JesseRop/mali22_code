---
title: "Integration of donor only and with lab"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  # library(dreamlet)
  # library(muscat)
  # library(ExperimentHub)
  # library(zenith)
  library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  # library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  library(tradeSeq)
  library(ComplexHeatmap)
  library(circlize)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  
})
```


```{r setup}
sample_set = "Mali2"

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```


#  integration of all MSC

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
```


```{r}
obj_names = c('M55', 'no_M55', 'no_M55_all_gns', 'asex_allgns', 'fem_allgns', 'male_allgns')

```


```{r}
map(obj_names, ~Convert(paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/scvi/m2_all_scvi_", .x,".h5ad"), dest = "h5seurat", overwrite = T))
```

```{r}
m2_all_scvi_seu <- map(obj_names, ~LoadH5Seurat(paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/scvi/m2_all_scvi_", .x,".h5seurat"), meta.data = FALSE, misc = FALSE)) %>% set_names(obj_names)
```

```{r}
m2_all_scvi_mdata <- map(obj_names, ~read_csv(paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/scvi/m2_all_scvi_mdata_", .x,".csv"))) 
```



```{r}
m2_all_scvi_seu <- map2(m2_all_scvi_seu, m2_all_scvi_mdata, ~AddMetaData(.x, .y %>% column_to_rownames("...1")))
```


```{r}
m2_all_scvi_seu

```


```{r}
map(m2_all_scvi_seu, ~DimPlot(.x, group.by = "leiden", reduction = "umap", label = T))

```


```{r}
# saveRDS(m2_all_scvi_seu, "data/processed/Pf/m2_all/scvi/m2_all_scvi_seu.RDS")
# saveRDS(m2_all_scvi_seu, "data/processed/Pf/m2_all/scvi/m2_all_scvi_seu3.RDS")
imap(m2_all_scvi_seu, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/scvi2seu/m2_all_scvi_", .y, "_seu.RDS")))

```

```{r}
# m2_all_scvi_seu <- readRDS("data/processed/Pf/m2_all/scvi/m2_all_scvi_seu3.RDS")

```

```{r}
# m2_all_raw_mrg <- readRDS("data/processed/Pf/m2_all/m2_all_raw_mrg.RDS")
# m2_all_raw_mrg <- readRDS("data/processed/Pf/m2_all/all_msc_qcd_anotd_orig_mrg3.RDS")
m2_all_raw_mrg <- readRDS("data/processed/Pf/m2_all/all_msc_qcd_anotd_jcC_mrg3.RDS")

```

```{r}
m2_all_raw_mrg <- JoinLayers(m2_all_raw_mrg)
m2_all_raw_mrg <- NormalizeData(m2_all_raw_mrg)
```

```{r}
# m2_all_raw_mrg_list <- map(m2_all_scvi_seu, ~{
#   m2_all_raw_mrg[,colnames(.x)]
# }) %>% 
#   set_names(names(m2_all_scvi_seu))

```


```{r}
###!!!!! NOTE - CHEATING - Rerun scvi - unassigned and doublet strains have been removed from seurat object but this update object has not been reran in jupyter
# map(m2_all_scvi_seu, m2_all_raw_mrg_list, ~.x[,colnames(.x) %in% colnames(.y)])
```

```{r}
all_jcC_seu_scvi <- map(m2_all_scvi_seu, ~m2_all_raw_mrg[,colnames(.x)]) 

```

```{r, warning=FALSE, message=FALSE}
## Add scvi dimensions to the seurat object
for (nm in names(all_jcC_seu_scvi)) {
  all_jcC_seu_scvi[[nm]][["scvi_umap"]] <- m2_all_scvi_seu[[nm]][["umap"]]
  all_jcC_seu_scvi[[nm]][["scvi"]] <- m2_all_scvi_seu[[nm]][["scVI"]]
  all_jcC_seu_scvi[[nm]]@meta.data[,c("_scvi_batch", "_scvi_labels", "leiden")] <- m2_all_scvi_seu[[nm]]@meta.data[,c("_scvi_batch", "_scvi_labels", "leiden")]
}
```


```{r}
all_jcC_seu_scvi <- map(all_jcC_seu_scvi, ~AddMetaData(.x, 
                                  .x@meta.data %>%
                                    mutate(stage = stage_fld,
                                           stage_afm = case_when(stage %in% c("Early ring", "Late ring", "Early trophozoite", "Late trophozoite", "Schizont", "Gametocyte (developing)") ~ "Asexual",
                                                               stage %in% c("Female", "Female (LE)") ~ "Female",
                                                               stage %in% c("Male", "Male (LE)") ~ "Male"),
                                           stage_ag = case_when(stage_afm %in% c("Female", "Female (LE)","Male", "Male (LE)") ~ "Gametocyte",
                                                                T ~ stage_afm)) %>%
                                    select(stage_afm, stage_ag)
                                  ))

```



```{r}
map(all_jcC_seu_scvi, ~DimPlot(.x, group.by = "leiden", reduction = "scvi_umap", label = T))

```

```{r, fig.height=6, fig.width=10}
map(all_jcC_seu_scvi, ~DimPlot(.x, reduction = "scvi_umap", group.by = "stage_fld", cols = sp_col_new, pt.size = 0.01, raster = F))
```


```{r, fig.height=6, fig.width=10}
map(all_jcC_seu_scvi, ~FeaturePlot(.x, features = "PF3D7-1102500", reduction = "scvi_umap", pt.size = 0.01, raster = F, order = T))
```

```{r}
# map(all_jcC_seu_scvi, ~DimPlot(.x, group.by = "leiden", reduction = "umap.rpca_sct_PC10", label = T))

```

```{r}
# saveRDS(m2_all_raw_mrg_list, "data/processed/Pf/m2_all/m2_all_raw_mrg_list.RDS")
# saveRDS(m2_all_raw_mrg_list, "data/processed/Pf/m2_all/m2_all_raw_mrg_list3.RDS")
imap(all_jcC_seu_scvi, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/scvi2seu/all_jcC_seu_scvi", .y, ".RDS")))

```

```{r, warning=FALSE, message=FALSE}
#ap2g
all_jcC_seu_scvi_umap_mdata <- map(all_jcC_seu_scvi, ~{
  .x@meta.data %>% 
    rownames_to_column("bcode") %>%
      left_join(., .x@reductions$scvi_umap@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode") %>%
      left_join(., .x@reductions$scvi@cell.embeddings %>% data.frame() %>% rownames_to_column("bcode"), by = "bcode")
})
```

```{r, message=FALSE, warning=FALSE, eval=T}
# Save the clean umaps for plotting
# saveRDS(m2_all_raw_mrg_list_umap_mdata, "data/processed/Pf/m2_all/all_stgs_figs/m2_all_raw_mrg_list_umap_mdata.RDS")
# imap(m2_all_raw_mrg_list_umap_mdata, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/scvi2seu/m2_all_raw_mrg_", .y, "_umap_mdata_3.RDS")))
imap(all_jcC_seu_scvi_umap_mdata, ~saveRDS(.x, paste0("data/processed/Pf/m2_all/scvi2seu/all_jcC_seu_scvi_", .y, "_umap_mdata_3.RDS")))

```

```{r, warning=FALSE, message=FALSE, eval=FALSE}
for (nm in names(all_jcC_seu_scvi)) {
  all_jcC_seu_scvi[[nm]][["RNA"]]$data <- as(all_jcC_seu_scvi[[nm]][["RNA"]]$data, Class = "dgCMatrix")
  # Idents(all_jcC_seu_scvi[[nm]]) <- "leiden"
}
```


```{r}
# saveRDS(m2_all_raw_mrg_list, "data/processed/Pf/m2_all/m2_all_raw_mrg_list.RDS")
# saveRDS(m2_all_raw_mrg_list, "data/processed/Pf/m2_all/m2_all_raw_mrg_list3.RDS")

```
