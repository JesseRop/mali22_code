---
title: "Untitled"
output: html_document
date: "2025-11-17"
---
---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  # library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(scran)
  library(SingleR)
  library(scDblFinder)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::intersect)
  conflicts_prefer(dplyr::desc)
  conflicts_prefer(dplyr::count)
})
```



# MSC Preprocessing

## setup, read input files and exploratory visualizations and general functions

```{r, setup}
# library(reticulate)
# # use_condaenv("/Users/jr35/envs/scv_jupcon/", required = TRUE)
# # matplotlib <- reticulate::import("matplotlib")
# # matplotlib$use("Agg", force = TRUE)
# 
# knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali')
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Variable declarations

```{r}
##colors
sp_col_new <- c(`Late ring` = "#78C679", `Early trophozoite` = "#FEEEAA", `Female (LE)` = "#a97f2f", 
Female = "#551A8B", `Male (LE)` = "#7e5522", Male = "mediumpurple", 
`Gametocyte (male)` = "#1a6c8b", `Gametocyte (female)` = "#d1b252", 
Lab = "#D3D3D3", Unassigned = "#DCDCDC", `Failed QC` = "grey", 
`Not assigned` = "grey", Atlas = "grey", `Early ring` = "#D1EC9F", 
`Late trophozoite` = "#FEB24C", `Early schizont` = "#C9E8F1", 
`Late schizont` = "#85B1D3", `Gametocyte (developing)` = "thistle", 
`early female` = "#749E89", `late female` = "#4E6D58", Asexual = "#FF6961", 
`NULL` = "lightgrey", `Field unlabelled` = "#D2C1DC", "weak_score" = "#c9c9c9", "unclear" = "#dddddd")

```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")

```

## Genotype clustering for MSC

```{r, eval=T}
pf_all_id_decode <- read_csv("data/raw/pf_all_id_decode.csv")
pf_all_id_decode$sample_nm
```


```{r, eval=T}
# pf_solo_mixed_mdata_decode <- read_csv("data/raw/pf_solo_mixed_mdata_decode.csv")
pf_solo_mixed_mdata_decode <- pf_all_id_decode 

```

## Select Sample Names

```{r}
# Select sample names, remove poor quality and mixed infection samples
slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm

## poor quality samples
sample_rm <- c("MSC1", "MSC24", "MSC36", "MSC37", "MSC38", "MSC39", "MSC12")
sample_mxd <- pf_solo_mixed_mdata_decode %>% filter(mixed_infection2 == "mixed") %>% pull(sample_nm)
# slct_sample_names <- slct_sample_names[!(slct_sample_names %in% c(sample_rm, sample_mxd))]

all_samples2rm <- c(sample_rm, sample_mxd)
all_samples2rm <- c(all_samples2rm, paste0(all_samples2rm, "C"), paste0(all_samples2rm, "noJC"))
slct_sample_names <- slct_sample_names[!slct_sample_names %in% all_samples2rm]

# Filter metadata for selected samples
pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)

# Sorted sample names and irods IDs
sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
smpl_nms <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
source_irods <- pf_solo_mixed_mdata_decode_slct[,c('sample_nm', 'irods_id')] %>% deframe() %>% .[sample_name]
```



```{r, message=F, warning=F}
##Read BPcells matrices
all_msc_cb_no_dbt_sct <- list.files("data/processed/Pf", pattern = "all_msc_cb_no_dbt_sct.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|all_msc_cb_no_dbt_sct.RDS'))) %>% 
  # .[sample_name_all] %>%
  .[sample_name] %>%
  map(readRDS)
```


###########################START Seurat norm Qcd cells######################################

```{r, message=FALSE, warning=FALSE, eval=T}
## Save as h5ad 

imap(all_msc_cb_no_dbt_sct[c("MSC55", "MSC55C", "MSC55noJC")], ~{
  
  ##Convert to v3 object since v5 not supported by seuratdisk 
  obj <- .x
  DefaultAssay(obj) <- "RNA"
  obj[["RNA"]] <- CreateAssayObject(counts = obj[["RNA"]]$counts) #Convert Assay v5 to Assay
  obj[["SCT"]] <- NULL
  print(obj)
  
  SeuratDisk::SaveH5Seurat(obj, filename =  paste0("data/processed/Pf/", .y, "/all_msc_cb_no_dbt_sct.h5Seurat"), overwrite = T)

  Convert(paste0("data/processed/Pf/", .y, "/all_msc_cb_no_dbt_sct.h5Seurat"), dest = "h5ad", overwrite = T)
  
})

```

############ Merge
```{r, eval=FALSE}
## Making list of objects and renaming before integrating
all_msc_cb_no_dbt_mrg <- merge(x = all_msc_cb_no_dbt_sct[[1]],
                             y = all_msc_cb_no_dbt_sct[2:length(all_msc_cb_no_dbt_sct)],
                             add.cell.ids = str_remove(names(all_msc_cb_no_dbt_sct), "SC"))
  
```

```{r, eval=FALSE}
rm(all_msc_cb_no_dbt_sct)
```

```{r, eval=FALSE}
## Join layers before conversion
all_msc_cb_no_dbt_mrg
```


Write out annotated MCA reference in .h5ad 
```{r, message=FALSE, warning=FALSE, eval=F}
all_msc_cb_no_dbt_mrg_v3 <- all_msc_cb_no_dbt_mrg
  
DefaultAssay(all_msc_cb_no_dbt_mrg_v3) <- "RNA"

## Join layers before conversion
all_msc_cb_no_dbt_mrg_v3 <- JoinLayers(all_msc_cb_no_dbt_mrg_v3, assay = "RNA", layers = "counts")

# ## !!!NB - NEEDS SORTING IN FUTURE UPGRADING TO SEURAT 5 RESULTED IN ERROR AS DESCRIBED https://github.com/mojaveazure/seurat-disk/issues/147#top

all_msc_cb_no_dbt_mrg_v3[["RNA"]] <- CreateAssayObject(counts = all_msc_cb_no_dbt_mrg_v3[["RNA"]]$counts) #Convert Assay v5 to Assay
all_msc_cb_no_dbt_mrg_v3[["SCT"]] <- NULL
# all_msc_cb_no_dbt_mrg_v3 <- CreateAssayObject(counts = all_msc_cb_no_dbt_mrg_v3[["RNA"]]$counts) #Convert Assay v5 to Assay
# all_msc_cb_no_dbt_mrg_v3@meta.data <- all_msc_cb_no_dbt_mrg@meta.data
  
SaveH5Seurat(all_msc_cb_no_dbt_mrg_v3, filename =  paste0("data/processed/Pf/m2_all/all_msc_cb_no_dbt_mrg_v3.h5Seurat"), overwrite = T)
  
Convert(paste0("data/processed/Pf/m2_all/all_msc_cb_no_dbt_mrg_v3.h5Seurat"), dest = "h5ad", overwrite = T)
  
rm(all_msc_cb_no_dbt_mrg_v3)

```
