---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(scran)
  library(SingleR)
  library(scDblFinder)
  library(duckplyr)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::intersect)
  conflicts_prefer(dplyr::desc)
  conflicts_prefer(dplyr::count)
})
```



# MSC Preprocessing

## setup, read input files and exploratory visualizations and general functions

```{r, setup}

knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source common functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")

```


initialize variable for the sample names

```{r}
# slct_sample_names <-c("MSC48", "MSC68", "MSC14", "MSC49", "MSC60", "MSC66", "MSC67", "MSC70", "MSC24", "MSC33", "MSC40", "MSC54", "MSC55") %>% str_sort(., numeric = T)

```

###################START- RAW READING#############

```{r, eval=T}
pf_solo_mixed_mdata_decode <- read_csv("data/raw/pf_solo_mixed_mdata_decode.csv")
```

## Genotype clustering for MSC

Read in clusters.tsv files with assignment of cells to strains and PCA plots metrics

Transfer clusters.tsv files with assignment of cells to strains and PCA plots metrics for the best K from farm to my local Mac

```{r}

slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm
## get relevant sample names
pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)

##Sample ID
sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
smpl_nms <-str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)

```


```{r}
# Remove poor quality samples
# poorQC_samples <- c("MSC1", "MSC24", "MSC37", "MSC38", "MSC39") 
# sample_name <- sample_name[!(sample_name %in% poorQC_samples)] %>% str_sort(., numeric = T)
```

Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read BPcells matrices
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))

sample_names <- rep(sample_name, 2) 
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))
sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))

```


##################################################  START - SingleR use markers to id cells ##################################################
NNew samples multisample


```{r}
msc_qcd_anotd <- readRDS("../Mali/data/processed/DB52e_star/msc_qcd_anotd.RDS") 

```


```{r}
lp_NF_postQC <- readRDS("../published_dsets/lasse_portugal/jcr_outs/lp_NF_postQC.RDS") 

```

```{r}
lp_NF_postQC@meta.data %>% filter(n() <30, .by = pseudotime.stages ) %>% count(pseudotime.stages)

```

```{r}
lp_NF_postQC_mdata <- lp_NF_postQC@meta.data %>% 
  mutate("stageHL" = case_when(pseudotime.stages == "EarlyRing" ~ 'Early ring',
                                pseudotime.stages == "LateRing" ~ 'Late ring',
                                pseudotime.stages == "EarlyTrophozoite" ~ 'Early trophozoite',
                                pseudotime.stages == "MidTrophozoite" ~ 'Mid trophozoite',
                                pseudotime.stages == "LateTrophozoite" ~ 'Late trophozoite',
                                pseudotime.stages == "DevelopingGametocyte" ~ 'Gametocyte (developing)',
                                pseudotime.stages == "FemaleGametocyte" ~ 'Female'))

lp_NF_postQC_mdata %>% count(pseudotime.stages)
```



```{r}
lp_NF_postQC_mdata_gt30 <- lp_NF_postQC_mdata %>% filter(n() >30, .by = pseudotime.stages ) 
lp_NF_postQC_mdata_gt30%>% count(pseudotime.stages)

```

```{r}
lp_NF_postQC_gt30 <- lp_NF_postQC[, rownames(lp_NF_postQC_mdata_gt30)] %>% 
  AddMetaData(., lp_NF_postQC_mdata_gt30[, "stageHL", drop = F])

```

```{r}
lp_NF_postQC_gt30_list <-  SplitObject(lp_NF_postQC_gt30, split.by = "orig.ident") %>% set_names(as.character(unique(lp_NF_postQC_gt30$orig.ident)))
```

```{r, message=F, warning=F}
# msc_qcd_anotd_sce <- map(msc_qcd_anotd, ~{
msc_lp_sce <- map(c(msc_qcd_anotd, lp_NF_postQC_gt30_list), ~{
  obj <- as.SingleCellExperiment(.x)
  logcounts(obj) <- NULL
  normcounts(obj) <- NULL
  obj <- logNormCounts(obj)
  
  })

```

```{r, message=F, warning=F}
# saveRDS(msc_qcd_anotd_sce[c("MSC13", "MSC14")], "data/processed/Pf/m2_all/annot_refs/msc_qcd_anotd_sce_13_14.RDS")

```

```{r, message=F, warning=F}
msc_lp_sce <- msc_lp_sce[!(names(msc_lp_sce) %in% c("MSC1", "MSC3"))]
saveRDS(msc_lp_sce, "data/processed/Pf/m2_all/annot_refs/msc_lp_sce.RDS")

```
#### Get singleR classic markers for multi-reference https://bioconductor.org/books/devel/SingleRBook/using-multiple-references.html

```{r, message=F, warning=F}
com_markers_localMac <- getClassicMarkers(
    ref = msc_lp_sce,
    labels = map(msc_lp_sce, ~.x$stageHL))

com_markers_localMac %>% str
```


```{r, message=F, warning=F}
## Save for farm
saveRDS(com_markers_localMac, "data/processed/Pf/m2_all/annot_refs/com_markers_localMac.RDS")

```


```{r}
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_CbEdCr_singleR.sh

```

```{r, message=F, warning=F}
# slct_sample_names <-c("MSC24", "MSC68", "MSC14", "MSC49", "MSC55") %>% str_sort(., numeric = T)
sample_name_ed_cr <- c(paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))
sample_name_ed_cr
```

Read in cell annotation singleR processed in farm
```{r, message=F, warning=F}
##Read elbo plots
# all_seu_norm_elbo <- list.files("data/processed/Pf", pattern = "*seu_norm_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|_seu.*|bpc'))) %>% 

# all_ed_pref_elbo <- list.files("data/processed/Pf", pattern = "bpseu_ed_pref.*_sct_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
all_pref_pred <- list.files("data/processed/Pf", pattern = "bpc_seu_(cr|cbendr|edrops50)_pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_pred.*'))) %>%
# all_pref_pred <- list.files("data/processed/Pf", pattern = "bpseu_.*pred_sR.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpseu|_pref.*'))) %>% 
  .[sample_name_all] %>%
  # .[sample_name_ed_cr] %>%
  map(readRDS)

# all_pref_pred
```


```{r}
map(all_pref_pred[1:6], ~table(.x$labels))
```



```{r, eval=FALSE, fig.width=16, fig.height=10}
map(all_pref_pred[1:2], ~plotScoreHeatmap(.x))
```

```{r, eval=FALSE}
map2(all_pref_pred, all_ed_pref_sce[3], ~plotScoreHeatmap(.x, annotation_col=as.data.frame(colData(.y)[,"Is_Cell_50",drop=FALSE])))

```


```{r, eval=FALSE}
map(all_pref_pred, ~{
  to.remove <- is.na(.x$pruned.labels)
  to.remove
  table(Label=.x$labels, Removed=to.remove)
})


```



```{r, eval=FALSE}
map(all_pref_pred[1], ~plotDeltaDistribution(.x))

```




```{r}
# config <- configureMarkerHeatmap(all_pref_pred[[1]], all_ed_pref_sce[[3]], "epsilon")
# mat <- assay(all_ed_pref_sce[[3]], "logcounts")[head(config$rows, 20), config$columns]
# aggregated <- scuttle::summarizeAssayByGroup(mat, config$predictions)
# pheatmap::pheatmap(assay(aggregated), cluster_col=FALSE)
```


```{r}
# map(all_pref_pred, all_ed_pref_sce[3], ~plotMarkerHeatmap(.x, .y, "Male"))

```

```{r}
# collected <- list()
# for (lab in unique(all_pref_pred[[1]]$labels)) {
#   print(lab)
#   collected[[lab]] <- SingleR::plotMarkerHeatmap(results = predictions, test = all_ed_pref_sce[[3]], label = lab)[[4]]
# }

```


```{r}
# config <- configureMarkerHeatmap(predictions, m13_qcd_anotd_sce, "epsilon")
# mat <- assay(m13_qcd_anotd_sce, "logcounts")[head(config$rows, 20), config$columns]
# aggregated <- scuttle::summarizeAssayByGroup(mat, config$predictions)
# pheatmap::pheatmap(assay(aggregated), cluster_col=FALSE)
```


```{r}
# tab <- table(cluster=m13_qcd_anotd_sce$seurat_clusters, label=predictions$labels) 
# pheatmap::pheatmap(log10(tab+10)) # using a larger pseudo-count for smoothing. 
```


```{r}
# scater::plotUMAP(m13_qcd_anotd_sce, colour_by = "seurat_clusters")
```

################## evaluate singleR MAnually

```{r, message=FALSE}
## get predictions for stages
all_pref_pred_df <- map(all_pref_pred, ~.x[, c("scores", "labels", "pruned.labels", "reference")] %>% 
                          as.data.frame() %>% 
                          rename_with(~str_replace_all(., c("\\.\\."="_", "\\."="_", "_$"="")), contains("score")) %>%
                          rownames_to_column("bcode"))
```


```{r, message=FALSE, warning=FALSE}
all_pref_pred_df <- map2(all_pref_pred_df, all_pref_pred, ~{
  df <- .x %>% 
    mutate(sr_score_ref = paste0("scores_", names(.y@listData$orig.results)[reference], "_scores"),
           sr_labl_ref = paste0("scores_", names(.y@listData$orig.results)[reference], "_labels")) 
    
  # df$sR_actl_score <- mapply(function(row, colname) df[row, colname], row = seq_len(nrow(df)), colname = df$sr_score_ref) ## baseR

  df <- df %>% 
    mutate(actl_score = purrr::map2_dbl(row_number(), sr_score_ref, ~df[.x, .y]),
           actl_labl = purrr::map2_chr(row_number(), sr_labl_ref, ~df[.x, .y]),
           MaleFem_consistency = case_when(if_any(ends_with("_labels"), ~str_detect(., "Female")) & if_any(ends_with("_labels"), ~str_detect(., "Male")) ~ "MaleFem",
                                              T ~ labels))
    

  return(df)
  
  
})

```

```{r, message=FALSE, warning=FALSE}

map(all_pref_pred_df, ~.x %>% count(labels, actl_labl, MaleFem_consistency) %>% filter(MaleFem_consistency == "MaleFem"))
```


```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl <- map(all_pref_pred_df, ~.x %>% 
                                         # filter(!is.na(actl_score)) %>% 
                                         select("bcode", "labels", "pruned.labels", "reference", "actl_labl", "actl_score", "MaleFem_consistency") %>% 
                                         mutate(fine_stg = case_when(is.na(pruned.labels) ~ "weak_score",
                                                                     MaleFem_consistency == "MaleFem" ~ "discrepantFM",
                                                                     T ~ pruned.labels)) %>%
                                         rename_with(~paste0("sR_", .), .cols = -c(bcode)))
  
```

```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl[1] %>% head
  
```

```{r, message=FALSE, warning=FALSE}

all_pref_pred_df_fnl_merge <- map(all_pref_pred_df_fnl, ~.x %>% 
      select(bcode, sR_fine_stg) ) %>%
  bind_rows(.id = "don_caller") %>% 
  separate_wider_regex(don_caller, c(donor = "MSC.*", "_", caller = "[a-z].*")) %>%
  pivot_wider(names_from = caller, values_from = sR_fine_stg) %>%
  split(., f = factor(.$donor))

all_pref_pred_df_fnl_snky <- map(all_pref_pred_df_fnl_merge , ~.x %>%  
      mutate(across(c(cr, edrops50, cbendr), ~str_replace_all(., c("discrepantFM" = "dFM", "weak_score" = "WS", "Early " = "E", "Late " = "L", "ring" = "R", "trophozoite" = "T", "Female" = "F", "Male" = "M", " \\(LE\\)" = "LE", "Gametocyte \\(developing\\)" = "Gd")))) 
)

  
```


```{r, message=FALSE, warning=FALSE}
sp_col_new_abrv <- sp_col_new
names(sp_col_new_abrv) <- str_replace_all(names(sp_col_new), c("discrepantFM" = "dFM", "weak_score" = "WS", "Early " = "E", "Late " = "L", "ring" = "R", "trophozoite" = "T", "Female" = "F", "Male" = "M", " \\(LE\\)" = "LE", "Gametocyte \\(developing\\)" = "Gd"))

sp_col_new_abrv
```



```{r, fig.width=4, fig.height=4}

snk_pt_fn <- function(decod_tbl, strns_2_plt = c('Strain_2nd', 'n_strains'), labls = paste0("K=", opt_clusters_nms[[3]][1:2]), bp_face = c("bold", "plain"), ttl = "plot", strain_colours = strain_cols_n) {
  decod_tbl %>% 
        mutate(across(contains("train"), ~str_replace_all(., c("Doublet" = "Dbt", "Negative" = "Neg")))) %>%
        make_long(all_of(strns_2_plt)) %>% 
        add_count(x,node, "n") %>%
        ggplot(., aes(x = x, next_x = next_x,node = node,next_node = next_node,fill = factor(node),label = paste0(node,": ",n))) +
            geom_sankey() +
        theme_void()+
        scale_fill_manual(values = strain_colours) +
        scale_x_discrete(labels=labls)+
        geom_sankey_label(size = 3.6, color = 1, fill = "white") +
        labs(title = ttl) +
        theme_sankey(base_size = 9) +
        theme(legend.position = "none",
              axis.title.x = element_blank(),
              axis.text.x = element_text(size = 15, face = bp_face))
      
}

```



```{r, message=FALSE, warning=FALSE}

imap(all_pref_pred_df_fnl_snky, ~snk_pt_fn(., strns_2_plt = c("cbendr", "edrops50", "cr"), labls = c("cbendr", "edrops50", "cr"), bp_face = c("bold", "bold", "bold"), ttl = .y, strain_colours = sp_col_new_abrv))
  
```

################## END evaluate singleR MAnually

#### for pseudobulk genotyping

```{r, eval = F}
# !!!!NOTE - MOVE A NOTEBOOK UP
all_seu_prelim_stg_norm_cb_mdata <- map(all_pref_pred_df_fnl_merge, ~.x %>% mutate(sR_fine_stg = coalesce(cbendr, edrops50, cr)) %>% select(bcode, sR_fine_stg)) 
# saveRDS(all_seu_prelim_stg_norm_cb_mdata, "data/processed/Pf/all_seu_prelim_stg_norm_cb_mdata.csv")
species <- "Pf"
sv_dir <- "pbulk_gtypes_preQC_resc"
system(paste0("mkdir -p data/processed/", species, "/" , sv_dir))

saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/" , sv_dir, "/all_seu_prelim_stg_norm_cb_mdata.csv"))

```


```{r, eval = F}
# # !!!!NOTE - MOVE A NOTEBOOK UP
# all_seu_prelim_stg_norm_cb_mdata <- map(all_seu_prelim_stg_norm, ~.x@meta.data)
# # saveRDS(all_seu_prelim_stg_norm_cb_mdata, "data/processed/Pf/all_seu_prelim_stg_norm_cb_mdata.csv")
# species <- "Pf"
# sv_dir <- "pbulk_gtypes_preQC_resc"
# system(paste0("mkdir -p data/processed/", species, "/" , sv_dir))
# 
# saveRDS(all_seu_prelim_stg_norm_cb_mdata, paste0("data/processed/", species, "/" , sv_dir, "/all_seu_prelim_stg_norm_cb_mdata.csv"))

```

###############

```{r, message=F, warning=F}
##Read BPcells matrices
all_seu <- list.files("data/processed/Pf", pattern = "bpc_seu_(cr|cbendr|edrops50).RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|.RDS'))) %>% 
# all_seu_norm <- list.files("data/processed/Pf", pattern = "bpc_seu.*_sct.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_sct.*'))) %>% 
  .[sample_name_all] %>%
  map(readRDS)

```


```{r, message=FALSE}
##Doublet removal
# all_seu_prelim_stg_norm <- list(all_ed_pref_norm, all_pref_pred_df_com_scores_fnl, all_pref_dblt_clst_df, str_remove(names(all_ed_pref), "_.*")) %>%
all_seu_prelim_stg <- list(all_seu, all_pref_pred_df_fnl) %>%
  pmap(~ {
    ..2 %>%
      column_to_rownames("bcode") %>%
      AddMetaData(..1, .)
       })

```


```{r, eval=T}
## write out seurat bpcells object files for normalization processing in farm
imap(all_seu_prelim_stg, ~saveRDS(.x, paste0("data/processed/Pf/",str_remove(.y, "_[cr|ed|cb].*"), "/seu_obj/bpseu", str_extract(.y, "_[cr|ed|cb].*"), "_prelim_stg.RDS")))

```

##################################################  END - SingleR use markers to id cells ##################################################


!!!NB - FARM CODE - DONT DELETE

```{r, eval=T}
# gogo()
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_norm_CbEdCr_bsub.sh
# bsub < /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code_lnk/bash_scripts/submsn_seu_sct_CbEdCr_bsub.sh
```


