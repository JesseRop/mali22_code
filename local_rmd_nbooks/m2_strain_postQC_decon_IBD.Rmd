---
title: "scripts for final QCd cells strain deconvolution"
output: html_document
date: "2024-03-12"
---


```{r, message=FALSE}
suppressPackageStartupMessages({
  # library(Seurat)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  library(pheatmap)
  # library(rmarkdown)
  # library('vcfR')
  library(conflicted)
  # library(RColorBrewer)
  # library(MetBrewer)
  library(ComplexHeatmap)
  # library(SeqArray)
  # library(ggrepel)
  # library(ggvenn)
  # library(magick)
  # library(svglite)
  # library(plotly)
  # library(ggsankey)
  # library(gganimate)
  # library(av)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("count", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("saveRDS", "base")
})

```


# MSC parasites strain deconvolution and VCF visualization 

## Variable declarations

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/plotting_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code/pf_common_vars.R")
```

```{r}
sample_set = 'Mali2'
algn_nm = 'minmap'

# soup_dir = "soupc"
# sv_dir = "pbulk_gtypes_preQC"

soup_dir = "soupc_GE_postQC"
sv_dir = "pbulk_gtypes_clean"

strain_levels_univrs <- c(paste0("SC", 1:20), "Doublet", "Negative")
```

```{r setup}
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/')
```


## Declare variables

```{r}
##Copy souporcell files for the optimum clusters

##Sample ID
# sample_name_nms <- c("MSC33", "MSC48","MSC49", "MSC55", "MSC60", "MSC66") %>% sort()
## All sample ids removing "MSC38" which seems to have lots of doublets
sample_name_nms <- c("MSC33", "MSC48","MSC49", "MSC55", "MSC60", "MSC66", "MSC38", "MSC40", "MSC50_MACS", "MSC53", "MSC57", "MSC24", "MSC37", "MSC39", "MSC45", "MSC50_SLO", "MSC54", "MSC67", "MSC68", "MSC70")

# sample_name_nms <- c("MSC33", "MSC48","MSC49", "MSC55", "MSC60") %>% sort()
# algn_nms = c('minmap', 'hsat', 'lr_ref')
algn_nms = c('minmap', 'hsat')

sample_name_nms_al <- rep(sample_name_nms, length(algn_nms))
algn_nms_al <- rep(algn_nms, each= length(sample_name_nms))

sm_aln_nms_al <- paste(rep(sample_name_nms, length(algn_nms)), rep(algn_nms, each= length(sample_name_nms)), sep ='_')

## optimum QCd ks
opt_clusters_nms <- list("MSC33" = c(6:10),"MSC48" = c(3:7),"MSC49" = c(5:9),"MSC55" = c(4:8),"MSC60" = c(5:9), "MSC66" = c(7:11), "MSC38" = c(2:6), "MSC40" = c(6:10), "MSC50_MACS" = c(2:6), "MSC53" = c(1:3), "MSC57" = c(1:3), "MSC24" = c(1:3), "MSC37" = c(5:9), "MSC39" = c(3:7), "MSC45" = c(1:3), "MSC50_SLO" = c(2:6), "MSC54" = c(1:3), "MSC67" = c(1:3), "MSC68" = c(2:6), "MSC70" = c(1:3))


# optimum_k <- c("MSC24" = 1, "MSC33" = 8, "MSC37" = 5, "MSC38" = 4, "MSC39" = 4, "MSC40" = 8, "MSC45" = 1, "MSC48" = 4, 
# "MSC49" = 6, "MSC50_MACS" = 1, "MSC50_SLO" = 1, "MSC53" = 1, "MSC54" = 1, "MSC55" = 7, "MSC57" = 1, 
# "MSC60" = 7, "MSC66" = 8, "MSC67" = 1, "MSC68" = 3, "MSC70" = 1)

optimum_k_qcd <- c("MSC33" =8, "MSC48" =4, "MSC49" =6, "MSC55" =7, "MSC60" =7, "MSC66" =8, "MSC38" =4, "MSC40" =8, "MSC50_MACS" =1, "MSC53" =1, "MSC57" =1, "MSC24" =1, "MSC37" =5, "MSC39" =4, "MSC45" =1, "MSC50_SLO" =1, "MSC54" =1, "MSC67" =1, "MSC68" =3, "MSC70" =1)

optimum_k_qcd <- optimum_k_qcd[sort(names(optimum_k_qcd))]

# opt_clusters_nms <- list("MSC33" = c(6:10),"MSC48" = c(3:7),"MSC49" = c(5:9),"MSC55" = c(4:8),"MSC60" = c(5:9))
# opt_clusters_nms <- list("MSC33" = c(3:9),"MSC48" = c(2:3),"MSC49" = c(2:6),"MSC55" = c(4:10),"MSC60" = c(2:7), "MSC66")

opt_clusters_len <- map(opt_clusters_nms, length)

## number of optimum clusters to investigate per sample factoring the 2 alignments
opt_clusters_nms_aln <- rep(opt_clusters_nms, length(algn_nms)) %>% set_names(sm_aln_nms_al)
opt_clusters_len_aln <- map(opt_clusters_nms_aln, length)

##Sample IDs
# source_irods_nms <- list("5736STDY13782211","5736STDY13782212","5736STDY13782213","5736STDY13782214","5736STDY13782215", "5736STDY13437393") %>% set_names(sample_name_nms)
# source_irods_nms <- list("5736STDY13782211","5736STDY13782212","5736STDY13782213","5736STDY13782214","5736STDY13782215") %>% set_names(sample_name_nms)

# source_irods <- map2(source_irods_nms, opt_clusters_len[names(source_irods_nms)], ~rep(.x, each = .y))

# source_irods <- unlist(flatten(source_irods))

##Samples
sample_name <- map2(sample_name_nms, opt_clusters_len[sample_name_nms], ~rep(.x, each = .y))

opt_clusters <- unlist(flatten(opt_clusters_nms[sample_name_nms]))

sample_name <- unlist(flatten(sample_name))

## sorted donor_opt_cluster names
sorted_names <- paste0(sample_name, "_", opt_clusters)

## sorted factoring alignment
sorted_names_al <-paste0(sample_name, "_",rep(algn_nms,each=length(sample_name)),"_", opt_clusters)


iter = opt_clusters_len


```



Section to write the genotypes from the QCd cells into a files
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

##Function to save tables in excel as sheets

createWorksheet <- function(x, y){
  wb <- createWorkbook()
  for(i in seq_along(x)){
    addWorksheet(wb, names(x)[i])
    writeData(wb, sheet = names(x)[i], x[[i]])
    saveWorkbook(wb, file = y, overwrite = TRUE)
  }
}

```



Export the SNPs with QC metrics and only clean SNPs for stage&strain combinations and just strain
```{r, eval=F}
##!!!! NOTE - MANUSCRIPT SNPS table

## subset SNP tables to write and rename lists/sheets 
### QC
snps_export_qc <- ss_afm_pf7M_qc[str_detect(names(ss_afm_pf7M_qc), "stage_ag|\\.strain_qcd")] %>% map(., ~rename_with(., ~paste0('Pf7_',.), c("filter","type","VQSLOD","CDS","AC","AN","AF")))
names(snps_export_qc) <- paste0(10:(length(snps_export_qc)+9), ".", str_replace_all(names(snps_export_qc), c("\\.stage_ag_strain_qcd" = " stage_strain QC", "\\.strain_qcd" = " strain QC", "MSC" = "MSC")))

### Clean
snps_export_cln <- ss_afm_pf7M_cln_gt[str_detect(names(ss_afm_pf7M_cln_gt), "stage_ag|\\.strain_qcd")]  %>% map(., ~dplyr::select(.x, -c(chr))) 
names(snps_export_cln) <- paste0(2:(length(snps_export_cln)+1), ".", str_replace_all(names(snps_export_cln), c("\\.stage_ag_strain_qcd" = " stage_strain clean", "\\.strain_qcd" = " strain clean", "MSC" = "MSC")))

createWorksheet(c(snps_export_cln, snps_export_qc), paste0("../",sample_set,"/v3_science_manuscript/tables/data S9 - Strain & stage-strain SNPs including QC categories.xlsx"))
```


Sections containing IBD and other stuff for QCd strains

```{r, fig.height=4.1, fig.width=4.5, eval=FALSE}
## All genotypes done separately since when done together the error for DUPLICATE colnames appears
ss_cln_gt_tbl_afm <- ss_afm_pf7M_cln_gt[c(seq(1,12,3))] %>%
    imap(~ rename_with(.x, function(x) paste(.y, x, sep = "_"), -c(id,chrom, pos, alleles, chr))) %>%
    purrr::reduce(left_join, by = c('id','chrom', 'pos', 'alleles', 'chr')) %>% 
  rename_with(~str_remove(., '\\.st.*ain'), starts_with(c("MSC")) )

ss_cln_gt_tbl_afm<-ss_cln_gt_tbl_afm[,sort(colnames(ss_cln_gt_tbl_afm))]

ss_cln_gt_tbl_ag <- ss_afm_pf7M_cln_gt[c(seq(2,12,3))] %>%
    imap(~ rename_with(.x, function(x) paste(.y, x, sep = "_"), -c(id,chrom, pos, alleles, chr))) %>%
    purrr::reduce(left_join, by = c('id','chrom', 'pos', 'alleles', 'chr')) %>% 
  rename_with(~str_remove(., '\\.st.*ain'), starts_with(c("MSC")) )

ss_cln_gt_tbl_ag<-ss_cln_gt_tbl_ag[,sort(colnames(ss_cln_gt_tbl_ag))]

ss_cln_gt_tbl_s <- ss_afm_pf7M_cln_gt[c(seq(3,12,3))] %>%
    imap(~ rename_with(.x, function(x) paste(.y, x, sep = "_"), -c(id,chrom, pos, alleles, chr))) %>%
    purrr::reduce(left_join, by = c('id','chrom', 'pos', 'alleles', 'chr')) %>% 
  rename_with(~str_remove(., '\\.st.*ain'), starts_with(c("MSC")) )

ss_cln_gt_tbl_s<-ss_cln_gt_tbl_s[,sort(colnames(ss_cln_gt_tbl_s))]

## 
ss_cln_all_mtx <- list(ss_cln_gt_tbl_afm, ss_cln_gt_tbl_ag, ss_cln_gt_tbl_s) %>% set_names(c("all.stage_afm_strain_qcd", "all.stage_afm_strain_qcd", "all.strain_qcd"))
```


```{r, fig.height=4.1, fig.width=4.5}
## gtype for clusters with more than 100
# strn_c_new_mdata <- readRDS("data/processed/Pf/strn_c_new_mdata_m21.RDS")
# # strn_c_new_mdata <- readRDS("data/processed/Pf/strn_c_new_mdata_m21.RDS")
# 
# clstr_200 <- map(strn_c_new_mdata, . %>% 
#       filter(cluster_ag_n >= 15) %>%
#       dplyr::count(Strain_qc, stage_ag) %>% 
#       filter(stage_ag == 'Gametocyte') %>%
#       filter(Strain_qc != 'PoorQC') %>%
#       unite(col = 'cluster',Strain_qc, stage_ag, sep = '_') %>%
#       pull(cluster) %>%
#       str_remove_all(., 'ametocyte|sexual')
# ) %>% imap(., ~paste(.x, .y, sep='_')) %>% unlist() %>% as.vector()
# 
# clstr_200_no55 <- map(strn_c_new_mdata, . %>% 
#       filter(cluster_ag_n >= 15) %>%
#       dplyr::count(Strain_qc, stage_ag) %>% 
#       filter(stage_ag == 'Gametocyte') %>%
#       filter(Strain_qc != 'PoorQC') %>%
#       unite(col = 'cluster',Strain_qc, stage_ag, sep = '_') %>%
#       pull(cluster) %>%
#       str_remove_all(., 'ametocyte|sexual')
# ) %>% .[names(.) != 'MSC55'] %>% imap(., ~paste(.x, .y, sep='_')) %>% unlist() %>% as.vector()
# 
# ss_cln_gt_tbl_100 <- ss_cln_gt_tbl[c("id","chrom" ,"pos","alleles","chr",clstr_200_no55)]

```

```{r}
## Read in msc annotations 

msc_qcd_anotd_stgstrqc <- readRDS('../Mali/data/processed/Pf/msc_qcd_anotd.RDS')
```

```{r}
##Clusters with more than 100

# clustr_numbers <- map(strn_c_new_mdata, . %>% 
#         filter(cluster_ag_n >= 20) %>%
#         dplyr::count(Strain_qc, stage_ag) %>%  
#       filter(stage_ag == 'Gametocyte') %>%
#         mutate(across(stage_ag, ~str_remove_all(., 'ametocyte|sexual'))) %>%
#         filter(Strain_qc != 'PoorQC') %>%
#         unite(col = 'cluster',Strain_qc, stage_ag, sep = '_'))%>% 
#     .[names(.) != 'MSC55'] %>%
#     bind_rows(., .id='sample') %>%
#     unite(col = 'sample_cluster',cluster, sample, sep = '_')

clustr_numbers <- map(msc_qcd_anotd_stgstrqc, ~.x@meta.data %>% 
        filter(strain_ag_n >= 20) %>%
        dplyr::count(strain_qcd, stage_ag) %>%  
      filter(stage_ag == 'Gametocyte') %>%
        mutate(across(stage_ag, ~str_remove_all(., 'ametocyte|sexual'))) %>%
        filter(strain_qcd != 'PoorQC') %>%
        unite(col = 'cluster',strain_qcd, stage_ag, sep = '_'))%>% 
    # .[names(.) != 'MSC55'] %>%
    bind_rows(., .id='sample') %>%
    unite(col = 'sample_cluster',cluster, sample, sep = '_')

```

```{r}
## Read in msc annotations 
# clustr_numbers_plusm14 <- msc_qcd_anotd_stgstrqc@meta.data %>% dplyr::count(stage_ag, strain_qcd) %>% filter(stage_ag == "Gametocyte" & !is.na(strain_qcd)) %>% mutate('sample_cluster'= paste(strain_qcd, str_remove(stage_ag, "ametocyte"), "MSC14", sep = '_')) %>% select(sample_cluster, n) %>% bind_rows(., clustr_numbers)
```


```{r, fig.height=3.8, fig.width=4.2}
##Heatmap function

gtypes_chr_cln_ibs_mtx <- function(gtypes_chr_pos){
  
  # ##Remove SC8 and SC1_F
  # gtypes_chr_pos <- snp_qc_tbl %>% filter(!(groups %in% c("SC8_F", "SC1_F")))%>% dplyr::select(chrom, pos, groups, qc2, alleles) %>% pivot_wider(names_from = groups, values_from = qc2) %>% unite(., col="id", c(chrom, pos), sep = "_", remove = F) %>% mutate(chr = str_remove_all(chrom, 'Pf3D7_0|Pf3D7_|_v3'))
  
  gtMat = gtypes_chr_pos %>% dplyr::select(-c(alleles,chrom, pos, chr))  %>% column_to_rownames("id") %>% mutate(across(everything(), ~as.numeric(str_replace(., '1', '2'))))%>% as.matrix() 
  gtMat = gtMat[,sort(colnames(gtMat))]
  
  
  gdsFile = tempfile()
    
  snpgdsCreateGeno(gdsFile, genmat = gtMat, sample.id = colnames(gtMat), 
                     snp.id = rownames(gtMat), snp.chromosome = gtypes_chr_pos$chr, 
                     snp.position = gtypes_chr_pos$pos, snp.allele = as.character(gtypes_chr_pos$alleles), snpfirstdim = TRUE)  
  
  gds = snpgdsOpen(gdsFile)
  
  gdsSub = snpgdsLDpruning(gds, ld.threshold = 0.2)
  
  ibs = snpgdsIBS(gds, num.thread = 4)
  
  rownames(ibs$ibs) = colnames(ibs$ibs) = colnames(gtMat)
    
  mat<-ibs$ibs
   
}
```

Multisample heatmap

```{r, fig.height=3.8, fig.width=4.2}
##Heatmap function

gtypes_ibs_heatmap <- function(mtx, dendo = F){
  
  colFun = suppressWarnings(brewer.pal(100, 'Greens'))
  colFun = circlize::colorRamp2(seq(0.5, 1, length.out = length(colFun)), 
                                  colFun)
   print(str(mtx))
   
   ##Remove columns and rows where everything in NA
   mtx <- mtx[,colSums(is.na(mtx)) < nrow(mtx)]
   mtx <- mtx[rowSums(is.na(mtx)) < ncol(mtx),]
   
  fa = str_extract(colnames(mtx), 'MSC.*')
  print(str(fa))
  
  # c_d = cluster_between_groups(mtx, fa)
  # dendog = if(dendo == T) c_d else F
  dendog = if(dendo == T) cluster_between_groups(mtx, fa) else F
  print(str(fa))
  print(str(dendog))
  
  # fa = str_extract(colnames(mtx), 'MSC.*')
  # # fa_col = c("a" = 2, "b" = 3, "c" = 4)
  # dend1 = cluster_between_groups(mtx, fa)
  

  hm = Heatmap(mtx, name='IBS', col = colFun, show_row_names = TRUE, 
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = dendog, cluster_columns = dendog)
  
  
  hm2<-Heatmap(mtx, name='IBS', col = colFun, show_row_names = TRUE, 
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = dendog, cluster_columns = dendog, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), border='black',   heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),
                  layer_fun = function(j, i, x, y, width, height, fill) {
                      v = pindex(mtx, i, j)
                      l = v >0.98
                      grid.rect(x[l], y[l], width = width, height = height, gp = gpar(col = "#a4c2f4", lwd = 2, fill = "transparent"))
})
  
  print(hm)
  print(hm2)
  # print(hm3)
}
```


```{r, fig.height=15, fig.width=20}

# gt_all_ibs_mtx<- gtypes_chr_cln_ibs_mtx(gtypes_chr_pos=ss_cln_gt_tbl)
# gt_all_ibs_hmap<- gtypes_ibs_heatmap(mtx=gt_all_ibs_mtx)

gt_all_ibs_mtx<- map(ss_cln_all_mtx, ~gtypes_chr_cln_ibs_mtx(gtypes_chr_pos=.x))
gt_all_ibs_hmap<- map(gt_all_ibs_mtx, ~gtypes_ibs_heatmap(mtx=.x))


# gt_all_ibs_100_mtx<- gtypes_chr_cln_ibs_mtx(gtypes_chr_pos=ss_cln_gt_tbl_100)
# gt_all_ibs_100_hmap<- gtypes_ibs_heatmap(mtx=gt_all_ibs_100_mtx, dendo = T)

```


```{r}
## Read in msc annotations 
clustr_numbers_afm <- map(msc_qcd_anotd_stgstrqc[1:4], ~.x@meta.data %>% 
        filter(strain_ag_n >= 30 & !is.na(strain_qcd)) %>%
        distinct(strain_qcd,stage_afm,strain_afm_n) %>% 
        mutate(across(stage_afm, ~str_remove_all(., 'emale|ale|sexual|ametocyte'))) %>%
        unite(col = 'cluster', strain_qcd, stage_afm, sep = '_'))  %>% 
    bind_rows(., .id='sample') %>%
  mutate(across(sample, ~str_remove_all(., 'sc'))) %>%
    unite(col = 'sample_cluster', sample, cluster, sep = '_')%>%
  mutate(across(sample_cluster, ~str_replace(., "MSC", "M")))

rownames(clustr_numbers_afm) <- NULL

clustr_numbers_ag <- map(msc_qcd_anotd_stgstrqc[1:4], ~.x@meta.data %>% 
        filter(strain_ag_n >= 30 & !is.na(strain_qcd)) %>%
        distinct(strain_qcd,stage_ag,strain_ag_n) %>% 
        mutate(across(stage_ag, ~str_remove_all(., 'emale|ale|sexual|ametocyte'))) %>%
        unite(col = 'cluster', strain_qcd, stage_ag, sep = '_'))  %>% 
    bind_rows(., .id='sample') %>%
  mutate(across(sample, ~str_remove_all(., 'sc'))) %>%
    unite(col = 'sample_cluster', sample, cluster, sep = '_')%>%
  mutate(across(sample_cluster, ~str_replace(., "MSC", "M")))

rownames(clustr_numbers_ag) <- NULL

clustr_numbers_s <- map(msc_qcd_anotd_stgstrqc[1:4], ~.x@meta.data %>% 
        filter(strain_ag_n >= 30 & !is.na(strain_qcd)) %>%
          add_count(strain_qcd, name = "strain_n") %>% 
        distinct(strain_qcd, strain_n) %>% 
        unite(col = 'cluster', strain_qcd, sep = '_'))  %>% 
    bind_rows(., .id='sample') %>%
  mutate(across(sample, ~str_remove_all(., 'sc')))%>% 
    unite(col = 'sample_cluster', sample, cluster, sep = '_')%>%
  mutate(across(sample_cluster, ~str_replace(., "MSC", "M")))

## This will replace the above once the donor labels msc are capitalized
clustr_numbers_s_cap <- map(msc_qcd_anotd_stgstrqc[1:4], ~.x@meta.data %>% 
        filter(strain_ag_n >= 30 & !is.na(strain_qcd)) %>%
          add_count(strain_qcd, name = "strain_n") %>% 
        distinct(strain_qcd, strain_n) %>% 
        unite(col = 'cluster', strain_qcd, sep = '_'))  %>% 
    bind_rows(., .id='sample') %>%
  mutate(across(sample, ~str_remove_all(., 'sc')))%>% 
    unite(col = 'sample_cluster', sample, cluster, sep = '_')#%>%
  #mutate(across(sample_cluster, ~str_replace(., "MSC", "M")))

rownames(clustr_numbers_ag) <- NULL
```



```{r, fig.height=8, fig.width=10.5}
##Merge strain numbers to IBD results
ibs_don_hm <- function(ibsmtx, clustr_numbers, strn_cat, start_no = 0.5, test_nm = "IBS"){
colFun = suppressWarnings(brewer.pal(100, 'Greens'))
colFun = circlize::colorRamp2(seq(start_no, 1, length.out = length(colFun)), 
                                  colFun)
  
sibd_pht_mtx <- ibsmtx
print(colnames(sibd_pht_mtx))
sibd_pht_mtx <- sibd_pht_mtx[,row.names(sibd_pht_mtx)]

# fa = str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]')
fa = str_remove(colnames(sibd_pht_mtx), '_qcd.*')
c_d = cluster_within_group(sibd_pht_mtx, fa)

# fr = str_extract(rownames(sibd_pht_mtx), 'ms.*[0-9]')
fr = str_remove(rownames(sibd_pht_mtx), '_qcd.*')
print(fr)
c_r = cluster_within_group(sibd_pht_mtx, fr)

# nms = unique(str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]'))
nms = unique(str_remove(colnames(sibd_pht_mtx), '_qcd.*'))
# sample_c_cols <- met.brewer("Thomas")[1:length(nms)] %>% set_names(nms)
sample_c_cols <- donor_cols

# sibd_pht_mtx_cln <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('G_MSC' = 'M')))) %>% rename_with(~str_replace_all(., c('G_MSC' = 'M')), starts_with('SC')) %>% column_to_rownames('sid') %>% as.matrix()
sibd_pht_mtx_cln <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('MSC' = 'M', '_qcd'='')))) %>% rename_with(~str_replace_all(., c('MSC' = 'M', '_qcd'='')), starts_with('MSC')) %>% 
  left_join(., clustr_numbers, by = c('sid'='sample_cluster')) %>% mutate(across(sid, ~paste0(., ' [', !!rlang::sym(strn_cat), ']'))) %>% select(-c(!!rlang::sym(strn_cat))) %>%
  column_to_rownames('sid') %>% as.matrix()

  
sibd_pht<- Heatmap(sibd_pht_mtx_cln, name=test_nm, 
                   col = colFun, 
                   show_row_names = TRUE, 
                   row_names_side = c("left"), 
                   show_column_names = TRUE,  
                   show_row_dend = T,  
                   show_column_dend = F, 
                   row_title_rot = 0, 
                   cluster_rows = c_r, 
                   clustering_method_rows = "complete",
                   cluster_columns = c_d, 
                   column_names_gp = gpar(fontsize = 15), 
                   row_names_gp = gpar(fontsize = 15), 
                   heatmap_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15)),
                   bottom_annotation = HeatmapAnnotation(Donor = fa, 
                                                         col = list(Donor = sample_c_cols), 
                                                         annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), 
                                                         annotation_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15))),
                   column_split = length(nms), 
                   border = TRUE, 
                   left_annotation=rowAnnotation(Donor = fa, col = list(Donor = sample_c_cols), annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), show_legend = F), row_split = length(nms), 
                   column_title = NULL,
                   column_title_gp = gpar(fontsize = 16), 
                   row_title = NULL,
                   row_title_gp = gpar(fontsize = 16)
              # border='black',row_gap=unit(.015, "npc"), column_gap=unit(.015, "npc"), 
              ) %>%
  draw(., merge_legend = TRUE)

sibd_pht
}
```


```{r, fig.height=8, fig.width=10}

hms<- pmap(list(gt_all_ibs_mtx, list(clustr_numbers_afm, clustr_numbers_ag, clustr_numbers_s), c("strain_afm_n", "strain_ag_n", "strain_n")), ~ibs_don_hm(ibsmtx=..1, clustr_numbers=..2, strn_cat=..3))

```


```{r, fig.height=4.5, fig.width=6}

hms<- pmap(list(gt_all_ibs_mtx[3], list(clustr_numbers_s), c("strain_n")), ~ibs_don_hm(ibsmtx=..1, clustr_numbers=..2, strn_cat=..3))

```


```{r, fig.height=4.5, fig.width=6}
## Capitalize the donor labels - will need to sort out later for entire notebook
cap_gt_all_ibs_mtx <- gt_all_ibs_mtx[[3]] %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('MSC' = 'MSC', '_qcd'='')))) %>% rename_with(~str_replace_all(., c('MSC' = 'MSC', '_qcd'='')), starts_with('MSC')) %>% column_to_rownames('sid') %>% as.matrix()

```

```{r, fig.height=4, fig.width=5}
##Merge strain numbers to IBD results

colFun = suppressWarnings(brewer.pal(100, 'Greens'))
colFun = circlize::colorRamp2(seq(0.5, 1, length.out = length(colFun)), 
                                  colFun)
  
sibd_pht_mtx <- cap_gt_all_ibs_mtx
print(colnames(sibd_pht_mtx))
sibd_pht_mtx <- sibd_pht_mtx[,row.names(sibd_pht_mtx)]

# fa = str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]')
fa = str_remove(colnames(sibd_pht_mtx), '_S.*')
c_d = cluster_within_group(sibd_pht_mtx, fa)

# fr = str_extract(rownames(sibd_pht_mtx), 'ms.*[0-9]')
fr = str_remove(rownames(sibd_pht_mtx), '_S.*')
print(fr)
c_r = cluster_within_group(sibd_pht_mtx, fr)

# nms = unique(str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]'))
nms = unique(str_remove(colnames(sibd_pht_mtx), '_S.*'))
# sample_c_cols <- met.brewer("Thomas")[1:length(nms)] %>% set_names(nms)
sample_c_cols <- donor_cols

row_labs <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(r_labs =str_remove(sid, "MS.*_")) %>% left_join(., clustr_numbers_s_cap, by = c('sid'='sample_cluster')) %>% mutate(across(r_labs, ~paste0(., ' [', !!rlang::sym("strain_n"), ']'))) %>% select(sid, r_labs) %>% deframe

col_labs <- str_remove(colnames(sibd_pht_mtx), "MS.*_") %>% set_names(colnames(sibd_pht_mtx))

  
sibd_pht<- Heatmap(sibd_pht_mtx, name="IBS", 
                   col = colFun, 
                   show_row_names = TRUE, 
                   row_labels = row_labs,
                   column_labels = col_labs,
                   row_names_side = c("left"), 
                   show_column_names = TRUE,  
                   show_row_dend = F,  
                   show_column_dend = F, 
                   row_title_rot = 0, 
                   cluster_rows = c_r, 
                   clustering_method_rows = "complete",
                   cluster_columns = c_d, 
                   column_names_gp = gpar(fontsize = 15), 
                   row_names_gp = gpar(fontsize = 15), 
                   heatmap_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15)),
                   bottom_annotation = HeatmapAnnotation(Donor = fa, 
                                                         col = list(Donor = sample_c_cols), 
                                                         annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), 
                                                         annotation_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15))),
                   column_split = length(nms), 
                   border = TRUE, 
                   left_annotation=rowAnnotation(Donor = fa, col = list(Donor = sample_c_cols), annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), show_legend = F), row_split = length(nms), 
                   column_title = NULL,
                   column_title_gp = gpar(fontsize = 16), 
                   row_title = NULL,
                   row_title_gp = gpar(fontsize = 16)
              # border='black',row_gap=unit(.015, "npc"), column_gap=unit(.015, "npc"), 
              ) %>%
  draw(., merge_legend = TRUE)

sibd_pht

```

```{r, fig.width= 12, fig.height=7}
##save svg for sk21
save_plot('plots/mali2021_all/fig4/sibd_pht.svg', plot_grid(ggdraw(sibd_pht)), base_width = 4, base_height = 5)
```


```{r, fig.height=8, fig.width=10.5, eval=FALSE}
# ##Merge strain numbers to IBD results - needs IBD!!!!!
# colFun = suppressWarnings(brewer.pal(100, 'Greens'))
# colFun = circlize::colorRamp2(seq(0.5, 1, length.out = length(colFun)), 
#                                   colFun)
#   
# sibd_pht_mtx <- gt_all_ibs_mtx
# 
# sibd_pht_mtx <- sibd_pht_mtx[,row.names(sibd_pht_mtx)]
# 
# # fa = str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]')
# fa = str_remove(colnames(sibd_pht_mtx), '_qcd.*')
# c_d = cluster_within_group(sibd_pht_mtx, fa)
# 
# # fr = str_extract(rownames(sibd_pht_mtx), 'ms.*[0-9]')
# fr = str_remove(rownames(sibd_pht_mtx), '_qcd.*')
# print(fr)
# c_r = cluster_within_group(sibd_pht_mtx, fr)
# 
# # nms = unique(str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]'))
# nms = unique(str_remove(colnames(sibd_pht_mtx), '_qcd.*'))
# # sample_c_cols <- met.brewer("Thomas")[1:length(nms)] %>% set_names(nms)
# sample_c_cols <- donor_cols
# 
# # sibd_pht_mtx_cln <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('G_MSC' = 'M')))) %>% rename_with(~str_replace_all(., c('G_MSC' = 'M')), starts_with('SC')) %>% column_to_rownames('sid') %>% as.matrix()
# sibd_pht_mtx_cln <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('MSC' = 'M', '_qcd'='')))) %>% rename_with(~str_replace_all(., c('MSC' = 'M', '_qcd'='')), starts_with('MSC')) %>% 
#   left_join(., clustr_numbers, by = c('sid'='sample_cluster')) %>% mutate(across(sid, ~paste0(., ' [', strain_afm_n, ']'))) %>% select(-c(strain_afm_n)) %>%
#   column_to_rownames('sid') %>% as.matrix()
# 
#   
# sibd_pht<- Heatmap(sibd_pht_mtx_cln, name='IBS', 
#                    col = colFun, 
#                    show_row_names = TRUE, 
#                    row_names_side = c("left"), 
#                    show_column_names = TRUE,  
#                    show_row_dend = T,  
#                    show_column_dend = F, 
#                    row_title_rot = 0, 
#                    cluster_rows = c_r, 
#                    clustering_method_rows = "complete",
#                    cluster_columns = c_d, 
#                    column_names_gp = gpar(fontsize = 15), 
#                    row_names_gp = gpar(fontsize = 15), 
#                    heatmap_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15)),
#                    bottom_annotation = HeatmapAnnotation(Donor = fa, 
#                                                          col = list(Donor = sample_c_cols), 
#                                                          annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), 
#                                                          annotation_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15))),
#                    column_split = length(nms), 
#                    border = TRUE, 
#                    left_annotation=rowAnnotation(Donor = fa, col = list(Donor = sample_c_cols), annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), show_legend = F), row_split = length(nms), 
#                    column_title = NULL,
#                    column_title_gp = gpar(fontsize = 16), 
#                    row_title = NULL,
#                    row_title_gp = gpar(fontsize = 16)
#               # border='black',row_gap=unit(.015, "npc"), column_gap=unit(.015, "npc"), 
#               ) %>%
#   draw(., merge_legend = TRUE)
# 
# sibd_pht

# Legend(labels = month.name[1:10], legend_gp = gpar(fill = 1:10), 
#     title = "foo", nrow = 3)
```



Read in MSC14 genotypes
```{r, fig.height=5, fig.width=6}
# m14_ss_ag_k8r_pf7M_cln_gt <- read_tsv("/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_ag_k8r_pf7M_cln_gt.tsv") %>% rename_with(~paste0(., "_msc14"), starts_with("SC"))
```


```{r}
##!!NOTE - gfv_p1_bi_strn_pf7_c is created somewhere downstream so this is likely to give an error

# ss_cln_gt_tbl_100 %>% dplyr::select(-c(id, chrom, alleles))%>% dplyr::select(chr, pos, any_of(sort(colnames(.)))) %>% filter(!if_all(starts_with('SC'), ~is.na(.))) %>% mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% write_tsv(., paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21.tsv"))
# 
# ##merge m14 with other donors
# ss_cln_gt_100_plus_m14 <-m14_ss_ag_k8r_pf7M_cln_gt %>% mutate(across(-pos, as.character)) %>% mutate(across(starts_with('SC'), ~na_if(.,"-1"))) %>% select(-c(contains("_A_"))) %>% full_join(.,ss_cln_gt_tbl_100, by=c('chr', 'pos')) %>% mutate(id= paste0(chr, "_", pos))
# 
# ss_cln_gt_100_plus_m14 %>% dplyr::select(-c(id, chrom, alleles))%>% dplyr::select(chr, pos, any_of(sort(colnames(.)))) %>% filter(!if_all(starts_with('SC'), ~is.na(.))) %>% mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% arrange(chr, pos) %>% write_tsv(., paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21_plus_m14.tsv"))

```


```{r}
##Run IBD 
wdir<- '/Users/jr35/Google\\ Drive/My\\ Drive/PHD_documents/sware/hmmIBD-master'

system(paste0(wdir,'/hmmIBD -i ',wdir,'/ss_cln_gt_tbl_100_m21.tsv -o ',wdir,'/ss_cln_gt_tbl_100_m21 -m 100000'))

```


```{r}
wdir<- '/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master'

ss_cln_gt_tbl_100_hmmibd <- read_delim('/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21.hmm.txt')
ss_cln_gt_tbl_100_hmmibd_f <- read_delim('/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21.hmm_fract.txt')

ss_cln_gt_tbl_100_plus_m14_hmmibd <- read_delim('/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21_plus_m14.hmm.txt')
ss_cln_gt_tbl_100_plus_m14_hmmibd_f <- read_delim('/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/ss_cln_gt_tbl_100_m21_plus_m14.hmm_fract.txt')


```




```{r, fig.height=5, fig.width=6}
colFun = suppressWarnings(brewer.pal(100, 'Blues'))
colFun = circlize::colorRamp2(seq(0, 1, length.out = length(colFun)), colFun)
  
cols_rand <- c("#fb9a99", "#cab2d6", "#b2df8a", "#e31a1c", "#ffff99", "#33a02c", "#ff7f00", "#b15928", "#fdbf6f")
```



```{r, fig.height=8, fig.width=10.5, eval=FALSE}
##Merge strain numbers to IBD results
# ss_n_ibd_tbl100 = ss_cln_gt_tbl_100_hmmibd_f %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., clustr_numbers, by = c('sample1'='sample_cluster')) %>% left_join(., clustr_numbers, by = c('sample2'='sample_cluster'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1, '\n[', n_1, ']'), id2 = paste0(sample2, '\n[', n_2, ']'))  
ss_n_ibd_tbl100 = ss_cln_gt_tbl_100_plus_m14_hmmibd_f %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., clustr_numbers_plusm14, by = c('sample1'='sample_cluster')) %>% left_join(., clustr_numbers_plusm14, by = c('sample2'='sample_cluster'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1), id2 = paste0(sample2))  

##Get the IBD and the number of sites for each pairwise comparison to annotate heatmap
s_ibdf_nsites_anno <- ss_n_ibd_tbl100 %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., ss_n_ibd_tbl100) %>% mutate(ibdf_nsites = paste0(round(fract_sites_IBD,2), '\n(',N_informative_sites,')'))%>% dplyr::select(starts_with('id'), ibdf_nsites) %>% pivot_wider(names_from = id2, values_from = ibdf_nsites) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., '1')))%>% column_to_rownames('id1')


##Create mirrored matrix and plot
sibd_pht_mtx <- ss_n_ibd_tbl100 %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., ss_n_ibd_tbl100) %>% dplyr::select(starts_with('id'), fract_sites_IBD) %>%  pivot_wider(names_from = id2, values_from = fract_sites_IBD) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., 1)))%>% column_to_rownames('id1')  
  

sibd_pht_mtx <- sibd_pht_mtx[,row.names(sibd_pht_mtx)]

fa = str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]')
c_d = cluster_within_group(sibd_pht_mtx, fa)

fr = str_extract(rownames(sibd_pht_mtx), 'ms.*[0-9]')
print(fr)
c_r = cluster_within_group(sibd_pht_mtx, fr)

nms = unique(str_extract(colnames(sibd_pht_mtx), 'ms.*[0-9]'))
# sample_c_cols <- met.brewer("Thomas")[1:length(nms)] %>% set_names(nms)
sample_c_cols <- cols_rand[1:length(nms)] %>% set_names(nms)

sibd_pht_mtx_cln <- sibd_pht_mtx %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('G_MSC' = 'M')))) %>% rename_with(~str_replace_all(., c('G_MSC' = 'M')), starts_with('SC')) %>% column_to_rownames('sid') %>% as.matrix()

  
sibd_pht<- Heatmap(sibd_pht_mtx_cln, name='IBD', 
                   col = colFun, 
                   show_row_names = TRUE, 
                   row_names_side = c("left"), 
                   show_column_names = TRUE,  
                   show_row_dend = T,  
                   show_column_dend = F, 
                   row_title_rot = 0, 
                   cluster_rows = c_r, 
                   cluster_columns = c_d, 
                   column_names_gp = gpar(fontsize = 15), 
                   row_names_gp = gpar(fontsize = 15), 
                   heatmap_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15)),
                   bottom_annotation = HeatmapAnnotation(Donor = fa, 
                                                         col = list(Donor = sample_c_cols), 
                                                         annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), 
                                                         annotation_legend_param = list(title_gp = gpar(fontsize = 15, fontface = "bold"), labels_gp = gpar(fontsize = 15))),
                   column_split = length(nms), 
                   border = TRUE, 
                   left_annotation=rowAnnotation(Donor = fa, col = list(Donor = sample_c_cols), annotation_name_gp = gpar(fontsize = 15, fontface = 'bold'), show_legend = F), row_split = length(nms), 
                   column_title = NULL,
                   column_title_gp = gpar(fontsize = 16), 
                   row_title = NULL,
                   row_title_gp = gpar(fontsize = 16)
              # border='black',row_gap=unit(.015, "npc"), column_gap=unit(.015, "npc"), 
              ) %>%
  draw(., merge_legend = TRUE)

sibd_pht

# 
# hm1<- Heatmap(sibd_pht_mtx_cln, rect_gp = gpar(type = "none"), name='IBD', col = colFun, show_row_names = TRUE, row_names_side = c("right"),
#                  # show_column_names = TRUE, 
#                 show_row_dend = T, cluster_rows = c_r, cluster_columns = c_d,
#                  show_column_dend = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
#               heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),
#     top_annotation = HeatmapAnnotation(Sample = fa, col = list(Sample = sample_c_cols)),column_split = length(nms), border = TRUE, right_annotation=rowAnnotation(Sample = fa, col = list(Sample = sample_c_cols)), row_split = length(nms),
#               cell_fun = function(j, i, x, y, w, h, fill) {
#         if(as.numeric(x) <= 1 - as.numeric(y) + 1e-6) {
#             grid.rect(x, y, w, h, gp = gpar(fill = fill, col = fill))
#         }
#     })
#   
# hm1



# od_a = c_r %>% labels
# sibd_pht_mtx_t = sibd_pht_mtx[od_a, od_a]
# 
# sibd_pht_mtx_t_cln <- sibd_pht_mtx_t %>% as.data.frame()%>% rownames_to_column('sid') %>% mutate(across(sid, ~str_replace_all(., c('G_MSC' = 'M')))) %>% rename_with(~str_replace_all(., c('G_MSC' = 'M')), starts_with('SC')) %>% column_to_rownames('sid') %>% as.matrix()
# 
# nmslab = str_extract(od_a, 'ms.*[0-9]')
# nms = unique(nmslab)
# sample_c_cols <- met.brewer("Thomas")[1:length(nms)] %>% set_names(nms)
#   
# hm3<- Heatmap(sibd_pht_mtx_t_cln,rect_gp = gpar(type = "none"),  name='IBS', col = colFun, show_row_names = TRUE, row_names_side = c("right"),
#                  # show_column_names = TRUE, 
#                 show_row_dend = T, cluster_rows = F, cluster_columns = F,
#                  show_column_dend = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
#               heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),
#     top_annotation = HeatmapAnnotation(Sample = nmslab, col = list(Sample = sample_c_cols)), border = TRUE, right_annotation=rowAnnotation(Sample = nmslab, col = list(Sample = sample_c_cols)), row_split = factor(nmslab, levels = nms),column_split = factor(nmslab, levels = nms), 
#               cell_fun = function(j, i, x, y, w, h, fill) {
#         if(as.numeric(x) <= 1 - as.numeric(y) + 1e-6) {
#             grid.rect(x, y, w, h, gp = gpar(fill = fill, col = fill))
#         }
#     })
# hm3
Legend(labels = month.name[1:10], legend_gp = gpar(fill = 1:10), 
    title = "foo", nrow = 3)
```


```{r, fig.height=5, fig.width=6, eval=FALSE}
##Merge strain numbers to IBD results
s_strn_n_ibd_tbl = s_k6r_pf7M_cln_gt_hmmibd_f %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., strn_qcd_n, by = c('sample1'='strain_qcd')) %>% left_join(., strn_qcd_n, by = c('sample2'='strain_qcd'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1, '\n[', n_1, ']'), id2 = paste0(sample2, '\n[', n_2, ']'))  

##Get the IBD and the number of sites for each pairwise comparison to annotate heatmap
s_combi_ibdf_nsites_anno <- s_strn_n_ibd_tbl %>% 
  rename('id2' = id1,  'id1' = id2) %>% 
  bind_rows(., s_lqc_strn_n_ibd_tbl) %>% 
  mutate(ibdf_nsites = paste0(round(fract_sites_IBD,2), '\n(',N_informative_sites,')'))%>% 
  dplyr::select(starts_with('id'), ibdf_nsites) %>% 
  pivot_wider(names_from = id2, values_from = ibdf_nsites) %>% 
  arrange(id1) %>%
  mutate(across(starts_with('SC'), ~replace_na(., '1')))%>%
  column_to_rownames('id1')


##Create mirrored matrix and plot
##!!! TIP - Refer to this if you want more complex arrangements https://github.com/jokergoo/ComplexHeatmap/issues/712 - eg different colours for the different half matrices
s_combi_ibd_pht <- s_strn_n_ibd_tbl %>% 
  rename('id2' = id1,  'id1' = id2) %>% 
  bind_rows(., s_lqc_strn_n_ibd_tbl) %>% 
  dplyr::select(starts_with('id'), fract_sites_IBD) %>%  
  pivot_wider(names_from = id2, values_from = fract_sites_IBD) %>% 
  arrange(id1) %>% 
  mutate(across(starts_with('SC'), ~replace_na(., 1)))%>%
  column_to_rownames('id1') %>% 
  as.matrix()%>%
  Heatmap(., name='IBD', col = colFun, show_row_names = TRUE, row_names_side = c("left"),
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = F, cluster_columns = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
              heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),border='black',
              cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%s", s_combi_ibdf_nsites_anno[i, j]), x, y, gp = gpar(fontsize = 13))
})

s_combi_ibd_pht
  
```

#########€#€######€€€€€€€

```{r}
# m = matrix(rnorm(120), nc = 12)
# colnames(m) = 1:12
# fa = rep(c("a", "b", "c"), times = c(2, 4, 6))
# # fa_col = c("a" = 2, "b" = 3, "c" = 4)
# dend1 = cluster_between_groups(m, fa)
# 
# Heatmap(m, cluster_columns = dend1, 
#     row_title = "cluster_between_groups")
# 
# m
# fa
# fa_col
```


```{r, fig.height=4.1, fig.width=4.5}

ss_afm_hmap_ibs<- map(ss_afm_pf7M_cln_gt, ~gtypes_chr_cln_ibs_hm(gtypes_chr_pos=.x))
```

```{r, fig.height=4.1, fig.width=4.5}
## Remove SC8
ss_afm_pf7M_cln_gt_m14_noSC8 <- ss_afm_pf7M_cln_gt[c("MSC14.stage_ag_strain_qcd", "MSC14.strain_qcd")] %>% map(~.x %>% select(!contains("SC8")))
ss_afm_hmap_ibs_m14_noSC8 <- map(ss_afm_pf7M_cln_gt_m14_noSC8, ~gtypes_chr_cln_ibs_hm(gtypes_chr_pos=.x))

ss_afm_hmap_ibs_m14_noSC8
```


IBD and plots generation


##Simpler chromosome plots(no continous gradient) for SS_AG and S

```{r}
## Function for chromosome painting

chrom_paintr <- function(gtypes_comps_tbl = b_strn_c, ttl, expn=100000, x_font_sz = 13) {

      gs <-gtypes_comps_tbl %>% mutate(across(start, ~(./expn)),across(end, ~(./expn)), across(size, ~(./expn))) %>%
      ggplot()+
      geom_segment(
    aes(x = 0-(2000/expn), xend = size+(2000/expn), y = chr, yend = chr),
    linewidth = 3.5, lineend = "round", colour = "black"
  ) + 
      geom_segment(
    aes(x = 0, xend = size, y = chr, yend = chr),
    linewidth = 2.8, lineend = "round", colour = "white"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  chr, yend =  chr,
      colour = rltd
    ),
    linewidth = 2.8
  ) +
  # scale_color_manual(values = c('Same'= '#D4AF37', 'Different'= '#2C3E50','Both'='lightgrey', 'No SNP'='white'))+      
  scale_color_manual(values = c('Same'= '#DACB7D', 'Different'= '#2C3E50','Both'='#A9B7C5', 'No SNP'='white'))+ ##prev colours "black" ,"#ffd94d" 
  # facet_wrap(comps~., ncol = 5) +
      labs(title = ttl) +
      labs(colour = "Allele \ncomparison", x = 'Position (bases)', y ="Chromosome") +
  theme_classic() +
  theme(#strip.text = element_text(size = 9, face = 'bold'),
        axis.text.y = element_text(size =  13),
        axis.text.x = element_text(size =  x_font_sz),
        # axis.title = element_text(size = 9),
        axis.title = element_blank(),
        # legend.title = element_text(size = 9, face = "bold"),
        # legend.text = element_text(size = 9),
        title = element_text(size = 12, face = "bold"),
        legend.position = "none") 
    
    pie_bar_tbl <- gtypes_comps_tbl %>% 
      separate(.,overlap_snps_No, into=(c('same2', 'diff2')), sep=',' ) %>% 
      pivot_longer(cols = c('same2','diff2'), names_to = 'shared2', values_to = 'shared_n') %>% 
      filter(!is.na(shared_n)) %>%
      mutate('Shared' = case_when(rltd == 'Both' & shared2 == 'same2' ~ 'Same', 
                                  rltd == 'Both' & shared2 == 'diff2' ~ 'Different', 
                                  rltd == 'Different' & shared2 == 'same2' ~ 'Different', 
                                  T ~ rltd)) %>%
      mutate(across(shared_n, as.numeric))
    
    pp <- pie_bar_tbl %>% 
      group_by(Shared) %>% 
      summarise('snpsNo' = sum(shared_n))%>%
    arrange(dplyr::desc(snpsNo), .by_group = T) %>%
    #mutate(lab.ypos = cumsum(prop) - 0.5*prop) %>%
    ggplot(., aes(x="", y=snpsNo, fill=Shared))+
    geom_bar(width = 1, stat = "identity") + 
    coord_polar("y", start=0)+
    # geom_text(aes(y = snpsNo/2 + c(0, cumsum(snpsNo)[-length(snpsNo)]), 
    #               label = snpsNo), size=3, colour = "#90c7ff") +
      geom_label(aes(y = snpsNo/2 + c(0, cumsum(snpsNo)[-length(snpsNo)]), 
                  label = snpsNo), size=5, label.padding = unit(0.07, "lines"), label.size = 0, color = 'black', fill = 'white') +
      scale_fill_manual(values = c('Same'= '#DACB7D', 'Different'= '#2C3E50'))+ #'#D4AF37'
    # labs(title = .y)+
    theme_void()+
      theme(legend.position = "none")
  #theme_minimal_hgrid(11)

    
    ggdraw(gs ) +
                draw_plot(pp, x=.5, y=.1, width = .50, height= .50)

  }

```


strains split by stage Without colour gradients
```{r, warning=F}
# strain stage (afm) chromosome painting
ss_afm_chromp <- map(ss_afm_wndws, ~{
  smp_tbl <- .x
  smp_tbl %>% split(., ~factor(comps)) %>% imap(.,possibly(~chrom_paintr(gtypes_comps_tbl =.x, ttl=.y), 'No overlapping SNPs between the 2 groups'))
})

```

```{r}
# strain stage (afm) chromosome painting
ss_afm_chromp[1]
```

```{r}

# plot_grid(plotlist = ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC1_A_vs_SC2_A", "SC1_A_vs_SC2_A", "SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G", "SC6_A_vs_SC7_G", "SC6_G_vs_SC7_G")], ncol = 3)
# plot_grid(plotlist = plts_strn_ss[c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 2)
```


```{r}

# plot_grid(plotlist = ss_k6r_ag_wndws[c("SC1_A_vs_SC2A", "SC1_A_vs_SC2_G", "SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G", "SC6_A_vs_SC7_G", "SC6_G_vs_SC7_G")], ncol = 3)
# plot_grid(plotlist = ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 1)
```

```{r, fig.height=6, fig.width=12}
plot_grid(plotlist = ss_afm_chromp[["MSC14.strain_qcd"]], ncol = 7)
```


strains split by stage Without colour gradients
```{r}
# strain stage (afm) chromosome painting
s_chromp_xlab_mod <- map(ss_afm_wndws[str_detect(names(ss_afm_wndws), "\\.strain_qcd")], ~{
  smp_tbl <- .x
  smp_tbl %>% split(., ~factor(comps)) %>% imap(.,possibly(~chrom_paintr(gtypes_comps_tbl =.x, ttl=.y, x_font_sz = 0), 'No overlapping SNPs between the 2 groups'))
})

```


```{r}


b_ovrl <-map(ss_afm_pf7M_afm_comps[str_detect(names(ss_afm_pf7M_afm_comps), "\\.strain_qcd")], ~.x %>% 
    group_by(chr) %>% 
    filter(!is.na(chr)) %>%
    mutate(pos_range = cut(pos, breaks = c(-Inf,seq(0, max(pos), by = 100000),Inf)))  %>% 
    dplyr::group_by(chr, pos_range) %>%
    summarise(SNPs_sum = n()) %>%
    ungroup() %>%
    left_join(.,pf_chr_size, by =c('chr')) %>%
    mutate(across(chr, ~factor(., levels = c(1:14)))) %>%
    mutate(start = as.numeric(str_extract(pos_range, "\\d+.*(?=,)")), end = as.numeric(str_extract(pos_range, "(?<=,)\\d+.*(?=])"))) %>%
    mutate(across(c(end), ~case_when(is.na(.) ~ size, T ~ .)))
)

```


```{r, fig.width=14, fig.height=6.5}

plt_ovrl <- b_ovrl %>%
  map(~{ .x %>% ggplot() + 
      geom_segment(
    aes(x = 0-2000, xend = size+2000, y = chr, yend = chr),
    linewidth = 7.5, lineend = "round", colour = "black"
  ) + 
      geom_segment(
    aes(x = 0, xend = size, y = chr, yend = chr),
    linewidth = 6.5, lineend = "round", colour = "white"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  chr, yend =  chr
    ),
      colour = "#C9E0F1",
    linewidth = 6.5
  ) +
  geom_label(aes(label=SNPs_sum, x=(start + end)/2, y = chr), size=5.4, label.padding = unit(0.05, "lines"), fontface = 'bold', label.size = 0, color = alpha('black', .9))+
  # facet_wrap(comps~., ncol = 5) +
      labs(y = 'Chromosome', x = 'Position (bases)') +
  theme_classic() +
  theme(strip.text = element_text(size = 12, face = 'bold'),
        axis.text = element_text(size = 18),
        axis.title = element_text(size = 20, face = 'bold'),
        title = element_text(size = 15, face = "bold"))
})

plt_ovrl


```



######Moved IBD codes from above to below here - may create complications
hmmIBD START

```{r}
##!!NOTE - gfv_p1_bi_strn_pf7_c is created somewhere downstream so this is likely to give an error

system(paste0('mkdir data/processed/ibd/'))
system(paste0('rm data/processed/ibd/*'))

imap(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")], ~{
  .x %>% 
    dplyr::select(-c(id, chrom, alleles))%>% 
    dplyr::select(chr, pos, any_of(sort(colnames(.)))) %>% 
    filter(!if_all(starts_with('SC'), ~is.na(.))) %>% 
    mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% 
    write_tsv(., paste0("data/processed/ibd/", .y, ".tsv"))
})

imap(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")], ~{
  .x %>% 
    dplyr::select(-c(id, chrom, alleles))%>% 
    dplyr::select(chr, pos, any_of(sort(colnames(.)))) %>% 
    filter(!if_all(starts_with('SC'), ~is.na(.))) %>% 
    mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% 
    write_tsv(., paste0("data/processed/ibd/", .y, "_lqc.tsv"))
})

## Write out the combined snps across all samples for ibd
imap(ss_cln_all_mtx[3], ~{
  .x %>% 
    dplyr::select(-c(id, chrom, alleles))%>% 
    dplyr::select(chr, pos, any_of(sort(colnames(.)))) %>% 
    filter(!if_all(starts_with('MSC14_qcd_SC'), ~is.na(.))) %>% 
    mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% 
    write_tsv(., paste0("data/processed/ibd/", .y, ".tsv"))
})

# ##!!!NOTE - Remove SC8 first - use this to include SC8 dplyr::select(chr, pos, paste0('SC', 1:8))
# s_k6r_pf7M_cln_gt %>% dplyr::select(-c(id, chrom, alleles))%>% dplyr::select(chr, pos, any_of(sort(colnames(.))))  %>% filter(!if_all(starts_with('SC'), ~is.na(.))) %>% mutate(across(everything(), ~as.numeric(replace_na(., '-1')))) %>% write_tsv(., "/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master/s_k6r_pf7M_cln_gt.tsv")

```


```{r}
##Run IBD 
##!!!!!!NOTE - sort out the output file -o argument - failure to save in the same directory. Goes to working dir

# imap(ss_afm_pf7M_cln_gt, ~system(paste0('hmmIBD -i data/processed/Pf/', str_remove(.y, "\\.st.*"), '/ibd/', .y, '.tsv -o data/processed/Pf/', str_remove(.y, "\\.st.*"), '/ibd/', .y, ' -m 100000')))

imap(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")], ~system(paste0('hmmIBD -i data/processed/ibd/', .y, '.tsv -o data/processed/ibd/', .y, ' -m 100000')))
imap(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")], ~system(paste0('hmmIBD -i data/processed/ibd/', .y, '_lqc.tsv -o data/processed/ibd/', .y, '_lqc -m 100000')))

## IBD of genotypes combined snps across all samples
imap(ss_cln_all_mtx[3], ~system(paste0('hmmIBD -i data/processed/ibd/', .y, '.tsv -o data/processed/ibd/', .y, ' -m 100000')))

# system('/Users/jr35/Google\\ Drive/My\\ Drive/PHD_documents/sware/hmmIBD-master/hmmIBD -i /Users/jr35/Google\\ Drive/My\\ Drive/PHD_documents/sware/hmmIBD-master/ss_afm_pf7M_cln_gt.tsv -o ss_afm_pf7M_cln_gt -m 100000')
  
```


```{r}
# wdir<- '/Users/jr35/Google Drive/My Drive/PHD_documents/sware/hmmIBD-master'

ss_afm_pf7M_cln_gt_hmmibd <- map(names(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")]), ~read_delim(paste0('data/processed/ibd/', .x, '.hmm.txt'))) %>% set_names(names(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")]))
ss_afm_pf7M_cln_gt_hmmibd_f <- map(names(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")]), ~read_delim(paste0('data/processed/ibd/', .x, '.hmm_fract.txt'))) %>% set_names(names(ss_afm_pf7M_cln_gt[!str_detect(names(ss_afm_pf7M_cln_gt), "\\.stage_afm_strain_qcd")]))

ss_afm_pf7M_cln_gt_hmmibd_lqc <- map(names(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")]), ~read_delim(paste0('data/processed/ibd/', .x, '_lqc.hmm.txt'))) %>% set_names(names(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")]))
ss_afm_pf7M_cln_gt_hmmibd_f_lqc <- map(names(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")]), ~read_delim(paste0('data/processed/ibd/', .x, '_lqc.hmm_fract.txt'))) %>% set_names(names(ss_afm_pf7M_cln_gt_lqc[!str_detect(names(ss_afm_pf7M_cln_gt_lqc), "\\.stage_afm_strain_qcd")]))

## IBD of genotypes combined snps across all samples
all_donors_hmmibd <- map(names(ss_cln_all_mtx[3]), ~read_delim(paste0('data/processed/ibd/', .x, '.hmm.txt'))) %>% set_names(names(ss_cln_all_mtx[3]))
all_donors_hmmibd_f <- map(names(ss_cln_all_mtx[3]), ~read_delim(paste0('data/processed/ibd/', .x, '.hmm_fract.txt'))) %>% set_names(names(ss_cln_all_mtx[3]))


```


```{r}
# ## Remove SC8 from the msc14 results
# ss_afm_pf7M_cln_gt_hmmibd_m14 <- ss_afm_pf7M_cln_gt_hmmibd[[8]] %>% filter(sample1 != "SC8" & sample2 != "SC8" )
# ss_afm_pf7M_cln_gt_hmmibd_f_m14 <- ss_afm_pf7M_cln_gt_hmmibd_f[[8]] %>% filter(sample1 != "SC8" & sample2 != "SC8" )
# 
# ss_afm_pf7M_cln_gt_hmmibd_lqc_m14 <- ss_afm_pf7M_cln_gt_hmmibd_lqc[[8]] %>% filter(sample1 != "SC8" & sample2 != "SC8" )
# ss_afm_pf7M_cln_gt_hmmibd_f_lqc_m14 <- ss_afm_pf7M_cln_gt_hmmibd_f_lqc[[8]] %>% filter(sample1 != "SC8" & sample2 != "SC8" )

```


Export the SNPs with QC metrics and only clean SNPs for stage&strain combinations and just strain
```{r, eval=T}
##!!!! NOTE -MANUSCRIPT IBD table

## subset IBD tables to write and rename lists/sheets 
### IBD results
ibd_export <- ss_afm_pf7M_cln_gt_hmmibd_f[str_detect(names(ss_afm_pf7M_cln_gt_hmmibd_f), "\\.strain_qcd")] %>% map(., ~rename_with(., ~str_replace(.,'sample', 'Strain'), contains("sample")))
names(ibd_export) <- paste0(2:(length(ibd_export)+1), ".", str_replace_all(names(ibd_export), c("\\.strain_qcd" = " IBD", "MSC" = "MSC")))

### IBD summary
ibd_f_export <- ss_afm_pf7M_cln_gt_hmmibd[str_detect(names(ss_afm_pf7M_cln_gt_hmmibd), "\\.strain_qcd")] %>% map(., ~rename_with(., ~str_replace(.,'sample', 'Strain'), contains("sample")))
names(ibd_f_export) <- paste0(6:(length(ibd_f_export)+5), ".", str_replace_all(names(ibd_f_export), c("\\.strain_qcd" = " IBD sites summary", "MSC" = "MSC")))


createWorksheet(c(ibd_export, ibd_f_export), paste0("../",sample_set,"/v3_science_manuscript/tables/data S10 - Strain pairwise IBD.xlsx"))
```


```{r}
## Read in msc annotations 

# msc14_qcd_anotd <- readRDS('data/processed/msc14/msc_qcd_anotd.RDS') %>% .[[1]]

```


```{r, fig.height=5, fig.width=6}
colFun = suppressWarnings(brewer.pal(100, 'Blues'))
colFun = circlize::colorRamp2(seq(0, 1, length.out = length(colFun)), colFun)
  
##Strain relatedness counts
strn_qcd_n <- msc_qcd_anotd_stgstrqc[[4]]@meta.data %>% dplyr::count(strain_qcd) %>% filter(!is.na(strain_qcd))

##Merge strain numbers to IBD results
s_lqc_strn_n_ibd_tbl = ss_afm_pf7M_cln_gt_hmmibd_f_lqc[["MSC14.strain_qcd"]] %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., strn_qcd_n, by = c('sample1'='strain_qcd')) %>% left_join(., strn_qcd_n, by = c('sample2'='strain_qcd'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1, '\n[', n_1, ']'), id2 = paste0(sample2, '\n[', n_2, ']'))

##Get the IBD and the number of sites for each pairwise comparison to annotate heatmap
s_lqc_ibdf_nsites_anno <- s_lqc_strn_n_ibd_tbl %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., s_lqc_strn_n_ibd_tbl)  %>% mutate(ibdf_nsites = paste0(round(fract_sites_IBD,2), '\n(',N_informative_sites,')'))%>% dplyr::select(starts_with('id'), ibdf_nsites) %>% pivot_wider(names_from = id2, values_from = ibdf_nsites) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., '1')))%>% column_to_rownames('id1')

##Create mirrored matrix and plot
##!!! TIP - Refer to this if you want more complex arrangements https://github.com/jokergoo/ComplexHeatmap/issues/712 
s_lqc_sibd_pht_mtx <- s_lqc_strn_n_ibd_tbl %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., s_lqc_strn_n_ibd_tbl) %>% dplyr::select(starts_with('id'), fract_sites_IBD) %>%  pivot_wider(names_from = id2, values_from = fract_sites_IBD) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., 1)))%>% column_to_rownames('id1') %>% as.matrix() 
  
s_lqc_ibd_pht<- Heatmap(s_lqc_sibd_pht_mtx, rect_gp = gpar(type = "none"), name='IBD', col = colFun, show_row_names = TRUE, row_names_side = c("left"),
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = F, cluster_columns = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
              heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),
              # border='black',
              cell_fun = function(j, i, x, y, width, height, fill) {
                if(i >= j) { ## diagonal(i==j), lower triangle (i>j), upper triangle (j>i)
                  grid.rect(x, y, width, height, gp = gpar(fill = fill, col = fill))
                  grid.text(sprintf("%s", s_lqc_ibdf_nsites_anno[i, j]), x, y, gp = gpar(fontsize = 13))
        }
})



s_lqc_ibd_pht

```

```{r, fig.height=5, fig.width=6}
##Merge strain numbers to IBD results
s_strn_n_ibd_tbl = ss_afm_pf7M_cln_gt_hmmibd_f[["MSC14.strain_qcd"]] %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., strn_qcd_n, by = c('sample1'='strain_qcd')) %>% left_join(., strn_qcd_n, by = c('sample2'='strain_qcd'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1, '\n[', n_1, ']'), id2 = paste0(sample2, '\n[', n_2, ']'))  

##Get the IBD and the number of sites for each pairwise comparison to annotate heatmap
s_ibdf_nsites_anno <- s_strn_n_ibd_tbl %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., s_strn_n_ibd_tbl) %>% mutate(ibdf_nsites = paste0(round(fract_sites_IBD,2), '\n(',N_informative_sites,')'))%>% dplyr::select(starts_with('id'), ibdf_nsites) %>% pivot_wider(names_from = id2, values_from = ibdf_nsites) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., '1')))%>% column_to_rownames('id1')


##Create mirrored matrix and plot
sibd_pht_mtx <- s_strn_n_ibd_tbl %>% rename('id2' = id1,  'id1' = id2) %>% bind_rows(., s_strn_n_ibd_tbl) %>% dplyr::select(starts_with('id'), fract_sites_IBD) %>%  pivot_wider(names_from = id2, values_from = fract_sites_IBD) %>% arrange(id1) %>% mutate(across(starts_with('SC'), ~replace_na(., 1)))%>% column_to_rownames('id1')  
  
sibd_pht<- Heatmap(sibd_pht_mtx,rect_gp = gpar(type = "none"), name='IBD', col = colFun, show_row_names = TRUE, row_names_side = c("left"),
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = F, cluster_columns = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
              heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),
              # border='black',
              cell_fun = function(j, i, x, y, width, height, fill) {
                if(i >= j) {
                  grid.rect(x, y, width, height, gp = gpar(fill = fill, col = fill))
                  grid.text(sprintf("%s", s_ibdf_nsites_anno[i, j]), x, y, gp = gpar(fontsize = 13))
        }
})


sibd_pht
  
```

```{r, fig.height=5, fig.width=6}
##Merge strain numbers to IBD results
s_strn_n_ibd_tbl = ss_afm_pf7M_cln_gt_hmmibd_f[["MSC14.strain_qcd"]] %>% dplyr::select(sample1, sample2, fract_sites_IBD,N_informative_sites) %>% left_join(., strn_qcd_n, by = c('sample1'='strain_qcd')) %>% left_join(., strn_qcd_n, by = c('sample2'='strain_qcd'), suffix = c('_1', '_2')) %>% mutate(id1 = paste0(sample1, '\n[', n_1, ']'), id2 = paste0(sample2, '\n[', n_2, ']'))  

##Get the IBD and the number of sites for each pairwise comparison to annotate heatmap
s_combi_ibdf_nsites_anno <- s_strn_n_ibd_tbl %>% 
  rename('id2' = id1,  'id1' = id2) %>% 
  bind_rows(., s_lqc_strn_n_ibd_tbl) %>% 
  mutate(ibdf_nsites = paste0(round(fract_sites_IBD,2), '\n(',N_informative_sites,')'))%>% 
  dplyr::select(starts_with('id'), ibdf_nsites) %>% 
  pivot_wider(names_from = id2, values_from = ibdf_nsites) %>% 
  arrange(id1) %>%
  mutate(across(starts_with('SC'), ~replace_na(., '1')))%>%
  column_to_rownames('id1')


##Create mirrored matrix and plot
##!!! TIP - Refer to this if you want more complex arrangements https://github.com/jokergoo/ComplexHeatmap/issues/712 - eg different colours for the different half matrices
s_combi_ibd_pht <- s_strn_n_ibd_tbl %>% 
  rename('id2' = id1,  'id1' = id2) %>% 
  bind_rows(., s_lqc_strn_n_ibd_tbl) %>% 
  dplyr::select(starts_with('id'), fract_sites_IBD) %>%  
  pivot_wider(names_from = id2, values_from = fract_sites_IBD) %>% 
  arrange(id1) %>% 
  mutate(across(starts_with('SC'), ~replace_na(., 1)))%>%
  column_to_rownames('id1') %>% 
  as.matrix()%>%
  Heatmap(., name='IBD', col = colFun, show_row_names = TRUE, row_names_side = c("left"),
                 show_column_names = TRUE, show_row_dend = T, 
                 show_column_dend = T, row_title_rot = 0, cluster_rows = F, cluster_columns = F, column_names_gp = gpar(fontsize = 15), row_names_gp = gpar(fontsize = 15), 
              heatmap_legend_param = list(title_gp = gpar(fontsize = 12, fontface = "bold"), labels_gp = gpar(fontsize = 12)),border='black',
              cell_fun = function(j, i, x, y, width, height, fill) {
        grid.text(sprintf("%s", s_combi_ibdf_nsites_anno[i, j]), x, y, gp = gpar(fontsize = 13))
})

s_combi_ibd_pht
  
```




```{r}

# k1_ibd_sites_f <- list(gt_fb_vtx_p1_bi_strn_pf7_asx_gam_ibd, gfv_p1_bi_pf7_k7_all_ibd) %>%
# k8_ibd_sites_f <- list(ss_ag_k6r_pf7M_cln_gt_hmmibd, s_k6r_pf7M_cln_gt_hmmibd) %>%
k8_ibd_sites_f <- map(ss_afm_pf7M_cln_gt_hmmibd[7:8], ~{
  tb1=.x
  list(tb1) %>%
  map(~{
    .x%>% 
      mutate(across(chr,as.character)) %>% 
  left_join(.,pf_chr_size, by ='chr') %>% 
  mutate(across(chr, ~factor(., levels = c(1:14)))) %>%
  unite(., 'comps',sample1, sample2, sep='vs', remove = F) %>%  
  group_by(chr) %>% 
  mutate(chr_s = 0, chr_e = size) %>% 
  ungroup() %>% 
  mutate(across(different, as.character))

    })

})
```


```{r}
## Function for chromosome painting

chrom_paintr_ibd <- function(gtypes_comps_tbl, ttl, expn= 100000, x_font_sz = 13) {
  gtypes_comps_tbl %>% mutate(across(start, ~(./expn)),across(end, ~(./expn)), across(size, ~(./expn))) %>%
      ggplot()+ 
      geom_segment(
    aes(x = 0-(2000/expn), xend = size+(2000/expn), y = chr, yend = chr),
    linewidth = 3.5, lineend = "round", colour = "black"
  ) + 
      geom_segment(
    aes(x = 0, xend = size, y = chr, yend = chr),
    linewidth = 2.8, lineend = "round", colour = "white"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  chr, yend =  chr,
      colour = rltd
    ),
    linewidth = 2.8
  ) +
  # scale_color_manual(values = c('Same'= '#D4AF37', 'Different'= '#2C3E50','Both'='lightgrey', 'No SNP'='white'))+ ##prev colours "black" ,"#ffd94d" 
  scale_color_manual(values = c('Same'= '#DACB7D', 'Different'= '#2C3E50','Both'='#A9B7C5', 'No SNP'='white'))+
  # facet_wrap(comps~., ncol = 5) +
      labs(title = ttl) +
      labs(colour = "Allele \ncomparison", x = 'Position (bases)', y ="Chromosome") +
  theme_classic() +
  theme(axis.text.y = element_text(size =  13),
        axis.text.x = element_text(size =  x_font_sz),
        # axis.ticks.x = element_blank(),
        # axis.title = element_text(size = 9),
        axis.title = element_blank(),
        # legend.title = element_text(size = 9, face = "bold"),
        # legend.text = element_text(size = 9),
        title = element_text(size = 12, face = "bold"),
        legend.position = "none",
        plot.background = element_rect(fill = "#bfe5fc")) 

  }


```


```{r, fig.height=14, fig.width=24}
ss_afm_k6r_pf7M_ibd <- k8_ibd_sites_f[[1]][[1]] %>% mutate(across(comps, ~str_replace(., 'vs', '_vs_')), rltd = case_when(different == '0' ~ 'Same', different == '1' ~ 'Different')) 

ss_afm_k6r_pf7M_ibd_p <- ss_afm_k6r_pf7M_ibd %>% split(., ~factor(comps)) %>% imap(., ~chrom_paintr_ibd(.x, .y))
```


```{r, fig.height=2.7, fig.width=6}
ss_afm_k6r_pf7M_ibd_p
# plot_grid(plotlist = c(ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC3_A_vs_SC4_G")], ss_ag_k6r_pf7M_ibd_p[c("SC3_A_vs_SC4_G")]), ncol = 2)
```

```{r, fig.height=14, fig.width=24}
ss_ag_k6r_pf7M_ibd <- k8_ibd_sites_f[[1]][[1]] %>% mutate(across(comps, ~str_replace(., 'vs', '_vs_')), rltd = case_when(different == '0' ~ 'Same', different == '1' ~ 'Different')) 

ss_ag_k6r_pf7M_ibd_p <- ss_ag_k6r_pf7M_ibd %>% split(., ~factor(comps)) %>% imap(., ~chrom_paintr_ibd(.x, .y))
```

```{r, fig.height=2.7, fig.width=6}

# plot_grid(plotlist = c(ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC1_A_vs_SC8A")], ss_ag_k6r_pf7M_ibd_p[c("SC1_A_vs_SC8A")]), ncol = 2)
```

```{r, fig.height=2.7, fig.width=6}
ss_ag_k6r_pf7M_ibd_p
# plot_grid(plotlist = c(ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC3_A_vs_SC4_G")], ss_ag_k6r_pf7M_ibd_p[c("SC3_A_vs_SC4_G")]), ncol = 2)
```

```{r, fig.height=2.7, fig.width=12}

plot_grid(plotlist = c(ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC2_A_vs_SC2_G")], ss_ag_k6r_pf7M_ibd_p[c("SC2_A_vs_SC2_G")],ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC6_A_vs_SC6_G")],ss_ag_k6r_pf7M_ibd_p[c("SC6_A_vs_SC6_G")]), ncol = 4)
```

```{r, fig.height=5.5, fig.width=6}
plot_grid(
plot_grid(plotlist = ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 1),
plot_grid(plotlist =ss_ag_k6r_pf7M_ibd_p[c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 1) , nrow = 1
)
```

```{r, fig.height=14, fig.width=24}
s_k6r_ibd <- k8_ibd_sites_f[[2]][[1]]  %>% mutate(across(comps, ~str_replace(., 'vs', '_vs_')), rltd = case_when(different == '0' ~ 'Same', different == '1' ~ 'Different')) 

s_k6r_ibd_comps = s_k6r_ibd %>% split(., ~factor(comps)) %>% names
s_k6r_ibd_sc7_comps <- c("SC1_vs_SC7", "SC2_vs_SC7", "SC3_vs_SC7", "SC4_vs_SC7", "SC5_vs_SC7", "SC6_vs_SC7")
s_k6r_xlab_sc7 <- ifelse(s_k6r_ibd_comps %in% s_k6r_ibd_sc7_comps, 13, 0)

s_k6r_ibd_plts <- s_k6r_ibd %>% split(., ~factor(comps)) %>% imap(., ~chrom_paintr_ibd(.x, .y))
```

```{r}
s_k6r_ibd_plts_xlab_mod = s_k6r_ibd %>% split(., ~factor(comps)) %>% list(., names(.), s_k6r_xlab_sc7) %>% pmap(., ~chrom_paintr_ibd(..1, ..2, x_font_sz = ..3))

```

```{r}
s_k6r_ibd_plts[1:3]
```


```{r, fig.height=6, fig.width=8}

plot_grid(plotlist = c(ss_afm_chromp[["MSC14.strain_qcd"]][c("SC1_vs_SC2")],ss_afm_chromp[["MSC14.strain_qcd"]][c("SC2_vs_SC5")], ss_afm_chromp[["MSC14.strain_qcd"]][c("SC2_vs_SC6")],ss_afm_chromp[["MSC14.strain_qcd"]][c("SC6_vs_SC7")],ss_afm_chromp[["MSC14.strain_qcd"]][c("SC2_vs_SC7")]), ncol = 3)
```


```{r, fig.height=16, fig.width=12}
## Without position labels in all plots but bottom row
plot_grid(
  plot_grid(plotlist = s_chromp_xlab_mod[["MSC14.strain_qcd"]][1:5], nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod[["MSC14.strain_qcd"]][6:9], s_k6r_ibd_plts_xlab_mod[1]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod[["MSC14.strain_qcd"]][10:12], s_k6r_ibd_plts_xlab_mod[c(6,2)]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod[["MSC14.strain_qcd"]][13:14], s_k6r_ibd_plts_xlab_mod[c(10,7,3)]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod[["MSC14.strain_qcd"]][15], s_k6r_ibd_plts_xlab_mod[c(13,11,8,4)]),nrow = 1),
  plot_grid(plotlist = s_k6r_ibd_plts_xlab_mod[c(15,14,12,9,5)], nrow = 1),
  ncol = 1
)
```

```{r, fig.width= 12, fig.height=15}
##Put together the plots for annotation


plot_grid(plt_ovrl[["MSC14.strain_qcd"]] +
            theme(plot.margin = margin(t=0.7, b=0.3, unit = "cm")),
          plot_grid(grid.grabExpr(draw(ss_afm_hmap_ibs_m14_noSC8[["MSC14.stage_ag_strain_qcd"]])),
                    plot_grid(
                      plot_grid(plotlist =ss_afm_chromp[["MSC14.stage_ag_strain_qcd"]][c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 1),
                      plot_grid(plotlist =ss_ag_k6r_pf7M_ibd_p[c("SC2_A_vs_SC2_G", "SC6_A_vs_SC6_G")], ncol = 1) , 
                      nrow = 1
                    ),
                    ncol = 2,
                    labels = c('B', 'C'),
                    label_size = 24,
                    vjust= 0.1
          )+
              theme(plot.margin = margin(t=0.7, b=0.3, unit = "cm")),
              plot_grid(grid.grabExpr(draw(ss_afm_hmap_ibs_m14_noSC8[["MSC14.strain_qcd"]])), 
              # grid.grabExpr(draw(sibd_pht)),
              grid.grabExpr(draw(s_combi_ibd_pht)),
              nrow = 1,
              rel_widths = c(.45, .55),
              # labels = c('D', 'E', 'F'),
              labels = c('D', 'E'),
              label_size = 24,
              vjust= 0.1) +
            theme(plot.margin = margin(t=0.7, b=0.3, unit = "cm")),
          nrow = 3,
          rel_heights = c(.3, .4, .3),
          labels = c('A', ''),
          label_size = 24,
          vjust= 1
)

``` 

```{r, fig.height=16, fig.width=12}
## Without position labels in all plots but bottom row
s_chromp_xlab_mod_m14_noSC8 <- s_chromp_xlab_mod[["MSC14.strain_qcd"]][!str_detect(names(s_chromp_xlab_mod[["MSC14.strain_qcd"]]), "_SC8")]
s_k6r_ibd_plts_xlab_mod_m14_noSC8 <- s_k6r_ibd_plts_xlab_mod[!str_detect(names(s_k6r_ibd_plts_xlab_mod), "_SC8")]

plot_grid(
  plot_grid(plotlist = s_chromp_xlab_mod_m14_noSC8[1:5], nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod_m14_noSC8[6:9], s_k6r_ibd_plts_xlab_mod_m14_noSC8[1]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod_m14_noSC8[10:12], s_k6r_ibd_plts_xlab_mod_m14_noSC8[c(6,2)]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod_m14_noSC8[13:14], s_k6r_ibd_plts_xlab_mod_m14_noSC8[c(10,7,3)]), nrow = 1),
  plot_grid(plotlist = c(s_chromp_xlab_mod_m14_noSC8[15], s_k6r_ibd_plts_xlab_mod_m14_noSC8[c(13,11,8,4)]),nrow = 1),
  plot_grid(plotlist = s_k6r_ibd_plts_xlab_mod_m14_noSC8[c(15,14,12,9,5)], nrow = 1),
  ncol = 1
)
```


```{r, fig.height=8, fig.width=20}
# k8_ibd_sites_f %>%
#   map(~{
#     .x%>%
# ggplot() +
#   geom_segment(
#     aes(x = 0, xend = chr_e, 
#         y = comps, yend = comps),
#     linewidth = 2.5, lineend = "round", colour = "grey75"
#   ) +
#   geom_segment(
#     aes(
#       x = start, xend = end,
#       y =  comps, yend =  comps,
#       colour = different
#     ),
#     linewidth = 2.5
#   ) +
#   scale_color_manual(values = c('0'='#D4AF37', '1'='#2C3E50'))+
#   facet_wrap(chr~., ncol = 5)+
#   theme_classic() +
#   theme(strip.text = element_text(size = 12, face = 'bold'),
#         axis.text = element_text(size = 12))
#     
#     
#   })

```

```{r, fig.height=14, fig.width=24}
# g8_ibd_chrom_ps <- k8_ibd_sites_f %>%
#   map(~{
#     
# a_plt<- .x %>%
# ggplot() +
#   geom_segment(
#     aes(x = 0, xend = chr_e, y = chr, yend = chr),
#     linewidth = 2, lineend = "round", colour = "grey75"
#   ) +
#   geom_segment(
#     aes(
#       x = start, xend = end,
#       y =  chr, yend =  chr,
#       colour = different
#     ),
#     linewidth = 2
#   ) +
#   scale_color_manual(values = c('0'='black', '1'='#ffd94d'))+
#   facet_wrap(comps~., ncol = 5) +
#   theme_classic() +
#   theme(strip.text = element_text(size = 12, face = 'bold'),
#         axis.text = element_text(size = 12))
# a_plt
# })
```


```{r, fig.height=6, fig.width=20}
# k8_ibd_sites_f %>%
#   map(~{
#     
# b_plt<-.x %>% 
#   ggplot(aes(x=end,y=Nsnp, color = different, fill = different)) +
#   geom_col() + 
#   ggplot2::facet_wrap(comps ~ ., ncol = 5)+theme_classic() + 
#   scale_color_manual(values = c('0'='black', '1'='#ffd94d'))+ 
#   scale_fill_manual(values = c('0'='black', '1'='#ffd94d'))+
#   theme(strip.text = element_text(size = 14, face = 'bold'),
#         axis.text = element_text(size = 13),
#         axis.text.x = element_text(angle = 45, hjust = 1))
# b_plt
# })
```

```{r, fig.height=12, fig.width=14}
# cowplot::plot_grid(a_plt+ 
#                         theme(axis.text.x = element_blank(),
#                               axis.ticks.x = element_blank(),
#                               axis.title.x = element_blank() ), 
#                    b_plt ,
#                    nrow = 2,
#                    ncol = 1,
#                    labels = "auto",
#                    align = "h"
#                    )
```


```{r, fig.height=6, fig.width=20}
k8_ibd_sites_f[[1]] %>%
  map(~{
    .x%>% 
      mutate(across(Nsnp, as.character)) %>%
ggplot() +
  geom_segment(
    aes(x = 0, xend = chr_e, 
        y = comps, yend = comps),
    linewidth =  1.5, lineend = "round", colour = "grey75"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  comps, yend =  comps,
      colour = different
    ),
    linewidth = 1.5
  ) +
  scale_color_manual(values = c('0'='black', '1'='#ffd94d'))+
  geom_label_repel(aes(label=Nsnp, x=(start + end)/2, y = comps), size=4,label.padding = unit(0.05, "lines"),alpha = 1,label.size = 0.01, color = alpha('black', .2)) +
  facet_wrap(chr~., ncol = 7)+
  theme_classic() +
  theme(strip.text = element_text(size = 14, face = 'bold'),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1)) 
  })
```

```{r, fig.height=6, fig.width=20}
k8_ibd_sites_f[[2]][[1]] %>% group_by(chr) %>% group_split() %>%
  map(~{
    .x%>% 
      mutate(across(Nsnp, as.character)) %>%
ggplot() +
  geom_segment(
    aes(x = 0, xend = chr_e, 
        y = comps, yend = comps),
    linewidth =  1.5, lineend = "round", colour = "grey75"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  comps, yend =  comps,
      colour = different
    ),
    linewidth = 1.5
  ) +
  scale_color_manual(values = c('0'='black', '1'='#ffd94d'))+
  geom_label_repel(aes(label=Nsnp, x=(start + end)/2, y = comps), size=4,label.padding = unit(0.05, "lines"),alpha = 1,label.size = 0.01, color = alpha('black', .2)) +
  facet_wrap(chr~., ncol = 7)+
  theme_classic() +
  theme(strip.text = element_text(size = 14, face = 'bold'),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1)) 
  })
```


```{r, fig.height=7, fig.width=20}
k8_ibd_sites_f[[1]] %>%
  map(~{
    .x%>% 
ggplot() +
  geom_segment(
    aes(x = 0, xend = chr_e, 
        y = chr, yend = chr),
    linewidth = 3.5, lineend = "round", colour = "grey75"
  ) +
  geom_segment(
    aes(
      x = start, xend = end,
      y =  chr, yend =  chr,
      colour = Nsnp#,
      # fill = Nsnp,
    ),
    linewidth = 3
  ) +
  # scale_color_manual(values = c('0'='black', '1'='#ffd94d'))+
  facet_wrap(comps~., ncol = 6) +
  theme_classic() +
  theme(strip.text = element_text(size = 14, face = 'bold'),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1))
  })
```

HMMIBD END!!!!!!!!!!!!!

igraph
```{r}
# #==========================================================
# # Function to create an adjacency matrix
# #=========================================================
# construct_adj_matrix = function(Result, Entry){
#   
#   sample_names = unique(c(as.character(Result$individual1), as.character(Result$individual2)))
#   sample_count = length(sample_names)
#   adj_matrix = array(data = NA, dim = c(sample_count, sample_count), 
#                      dimnames = list(sample_names, sample_names))
#   for(i in 1:nrow(Result)){
#     indi = as.character(Result$individual1[i])
#     indj = as.character(Result$individual2[i])
#     adj_matrix[indi, indj] = Result[i, Entry]
#   }
#   return(adj_matrix)
# }
# 
# 
# #==========================================================
# # Function to filter highly related samples within sites
# #==========================================================
# rm_highly_related_within = function(Result, Cities, Edge){
#   
#   if(Edge){
#     # Keep edges statistically diff. from one
#     Result_filtered = Result[Result$`r97.5.` < 1-eps,] 
#   } else {
#     # First construct an adjaceny matrix of 97.5% CI IBD
#     adj_matrix = construct_adj_matrix(Result, Entry = 'r97.5.')
#     sample_names = rownames(adj_matrix)
#     
#     # Second, modify s.t. only edges NOT statistically diff. from one
#     adj_matrix_high = adj_matrix
#     adj_matrix_high[adj_matrix < 1-eps] = 0
#     
#     # Third, create a graph and list its components
#     G = graph_from_adjacency_matrix(adjmatrix = adj_matrix_high, 
#                                     mode='upper', 
#                                     diag=F, weighted = 'w', 
#                                     add.colnames = T)
#     S = components(graph = G) # Lists components
#     
#     # Forth, draw a single sample per site within a component 
#     rep_samples = unlist(lapply(1:S$no, function(s){
#       samples_ids = which(S$membership==s)
#       if(length(samples_ids) == 1){
#         rep_samples = sample_names[samples_ids] # If only one sample per component, keep
#       } else { # Keep one per city
#         cities = Cities[sample_names[samples_ids]]
#         # Pick sample with earliest data (deterministically for comparison across plots)
#         rep_samples = sapply(unique(cities), function(city){
#           samples_to_choose_from = names(cities)[cities == city]
#           rep_sample = samples_to_choose_from[which.min(SNPData[samples_to_choose_from, 'COLLECTION.DATE'])]
#         })
#       }
#       return(rep_samples)
#     }))
#     
#     # Fifth, restructure Result s.t. only one sample per city per component
#     inds = Result$individual1 %in% rep_samples & Result$individual2 %in% rep_samples
#     Result_filtered = Result[inds,]
#   }
#   return(Result_filtered)
# }
# 
# #==========================================================
# # Function to return city subgraph
# #==========================================================
# extract_city_graph = function(x, city1, city2, col_edge = 'white', 
#                               a = 0, b = 1, c = 2){
#   inds = V(x)$site == city1|V(x)$site == city2 # indices for cities
#   z = induced_subgraph(x, vids = which(inds)) # extract subgraph
#   Jitter_sign = rep(1, length(V(z)$site ))
#   Jitter_sign[V(z)$site == city2] = -1
#   # vertical layout
#   Y = as.numeric(V(z)$site == city1) + (Jitter[V(z)$name] * Jitter_sign)
#   attr(z, 'layout') = cbind(X = V(z)$date, Y) # Full layout
#   V(z)$color = M_cols[V(z)$name] # Colour by clonal component
#   E(z)$weight[is.na(E(z)$weight)] = 0 # NAs introduced when filter edges 
#   
#   # Scale edge widths (not weights) and transparancy to range a, b, c
#   weights_rescaled = a + (b-a) * (E(z)$weight - min(E(z)$weight)) / (max(E(z)$weight) - min(E(z)$weight))
#   E(z)$width = weights_rescaled * c
#   E(z)$color = sapply(weights_rescaled, function(x) adjustcolor(col_edge, alpha.f = x)) # Make transparency a function of rhat
#   v_names = do.call(rbind, strsplit(attributes(E(z))$vnames, split = "\\|"))
#   edge_col_ind = which(M_cols[v_names[,1]] == M_cols[v_names[,2]] & M_cols[v_names[,1]] != "#FFFFFF")
#   if(any(edge_col_ind)){
#     E(z)$color[edge_col_ind] = M_cols[v_names[,1]][edge_col_ind]
#   }
#   return(z)}

```

```{r}
# #################################################################################
# #' Script to generate and plot a graph of relatedness between samples
# #################################################################################
# rm(list = ls())
# library(igraph) 
# library(RColorBrewer)
# source('../igraph_functions.R') # for construct_adj_matrix
# eps <- 0.01 # threshold below which LCI is considered zero in Taylor et al. 2019
# a = 0; b = 0.5; c = 0.25 # Scaling parameters for plotting edge width and transparancy
# PDF <- TRUE
# 
# # Load relatedness results and metadata
# freqs_used <- "Taylor2020"
# load(sprintf('../../RData/mles_CIs_extended_freqs%s_meta.RData', freqs_used)) 
# load(sprintf('../../RData/metadata_extended.RData'))
# load("../../RData/sids_to_remove_from_graphs.RData")
# 
# # Define city cols
# cities <- unique(metadata$City)
# cols_cities <- array(c(rev(brewer.pal(5, 'Spectral')), 
#                        brewer.pal(length(cities)-5, 'Dark2')), 
#                      dimnames = list(cities))
# 
# # Remove samples with one or more NA estimate
# sids_to_keep <- setdiff(metadata$SAMPLE.CODE, sids_remv) 
# inds_to_keep <- mle_CIs$individual1 %in% sids_to_keep & mle_CIs$individual2 %in% sids_to_keep
# mles_to_keep <- mle_CIs[inds_to_keep,]
# 
# A_est <- construct_adj_matrix(mles_to_keep, Entry = 'rhat')
# 
# if(PDF) pdf("../../Plots/Relatedness_graphs.pdf")
# 
# for(high_relatedness_threshold in c(0,0.25)){
#   A_est[A_est < high_relatedness_threshold] <- 0
#   fields::image.plot(A_est)
#   
#   # Create graph 
#   G_est <- graph_from_adjacency_matrix(A_est, mode='upper', diag=F, weighted = T) 
#   art_pnts <- names(articulation.points(G_est))
#   ccompnts <- components(G_est)
#   
#   # Add metadata
#   V(G_est)$marker_count <- metadata[V(G_est)$name,  "snp_count"]
#   V(G_est)$city <- metadata[V(G_est)$name, "City"]
#   V(G_est)$color <- cols_cities[V(G_est)$city] 
#   
#   weights_rescaled = a + (b-a) * (E(G_est)$weight - min(E(G_est)$weight)) / (max(E(G_est)$weight) - min(E(G_est)$weight))
#   
#   # Plot graph 
#   plot(G_est, 
#        main = sprintf("High relatedness threshold: %s", high_relatedness_threshold), 
#        cex.main = 0.75, 
#        vertex.label.color = "black", 
#        vertex.label.cex = 1, 
#        vertex.frame.color = NA,
#        vertex.label = NA, 
#        vertex.shape = c("square","circle")[metadata[V(G_est)$name, "PloSGen2020"] + 1],
#        vertex.size = 0.5*log(metadata[V(G_est)$name, "snp_count"]),
#        edge.width = weights_rescaled * c, 
#        edge.color = sapply(weights_rescaled, function(x)adjustcolor('black', alpha.f = x)))
#   
#   # Legend
#   cities_ <- unique(V(G_est)$city)
#   legend('bottomleft', pch = 16, bty = 'n', cex = 0.5, pt.cex = 1, 
#          inset = -0.1, col = cols_cities[cities_], legend = cities_)
#   
#   # R estimate range
#   range(A_est, na.rm = T)
# }
# 
# if(PDF) dev.off()
```

