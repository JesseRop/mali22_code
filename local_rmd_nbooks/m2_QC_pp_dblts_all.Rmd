---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  library(glmGamPoi)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  library(scmap)
  library(ggsankey)
  library(caret)
  library(BPCells)
  library(png)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(SingleCellExperiment::colData)
})
```




# MSC Preprocessing


## setup, read input files and exploratory visualizations and general functions


```{r, setup}
# library(reticulate)
# use_condaenv("/software/team222/jr35/miniconda3/envs/scrublt/", required = TRUE)
# matplotlib <- reticulate::import("matplotlib")
# matplotlib$use("Agg", force = TRUE)


sample_set = "Mali2"
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/')
```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("mali22_code_lnk/pf_common_vars.R")
```

initialize variable for the sample names

## Declare variables

```{r}
##Copy souporcell files for the optimum clusters

##Sample ID
# sample_name_nms <- c("MSC33", "MSC48","MSC49", "MSC55", "MSC60", "MSC66") %>% sort()

sample_name_nms <- c("MSC33", "MSC48","MSC49", "MSC55", "MSC60", "MSC66", "MSC38", "MSC40", "MSC50_MACS", "MSC53", "MSC57", "MSC24", "MSC37", "MSC39", "MSC45", "MSC50_SLO", "MSC54", "MSC67", "MSC68", "MSC70", "MSC41", "MSC51", "MSC25", "MSC1", "MSC3", "MSC13", "MSC14", "MSC12") %>% sort()

##Samples
# sample_name <- sample_name_nms
# sample_name_nms <- sample_name_nms


```

Read in preprocessed filtered
```{r, eval=T}
all_msc_filt <- readRDS("data/processed/Pf/all_msc_filt.RDS")
```


```{r}

all_msc_filt %>% map(., ~.x@meta.data %>% mutate(stage_c_ag = case_when(StagePrelimC %in% c("Early trophozoite", "Late ring") ~ "Asexual", str_detect(StagePrelimC, "ale") ~ "Gametocytes", T ~ StagePrelimC)) %>% count(stage_c_ag, Strain_DN))

```


```{r}

all_msc_filt %>% map(., ~.x@meta.data %>% mutate(stage_c_ag = case_when(StagePrelimC %in% c("Early trophozoite", "Late ring") ~ "Asexual", str_detect(StagePrelimC, "ale") ~ "Gametocytes", T ~ StagePrelimC)) %>% count(stage_c_ag))

```

```{r}

all_msc_filt %>% map(., ~.x@meta.data %>% mutate(stage_c_ag = case_when(StagePrelimC %in% c("Early trophozoite", "Late ring") ~ "Asexual", str_detect(StagePrelimC, "ale") ~ "Gametocytes", T ~ StagePrelimC)) %>% count(stage_c_ag))

```


## Doublet removal

### SoupX ambient transcript removal

!!!NB - FARM CODE - DONT DELETE
```{r, eval=T}
## Run Soupx in farm
gogo()

## Remove the output files before rerunning since some object it might fail and old object persists
# map(names(all_msc_filt), ~system(paste0('rm data/processed/Pf/', .x,'/seu_obj/soupx_filt_seu_norm.RDS')))


# nextflow run ../mali22_code_lnk/nf_scripts/submsn_soupx.nf --scrpt "/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/soupx.R" --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/filt_seu_sct_norm.RDS" --input_raw_mtx "/lustre/scratch126/tol/teams/lawniczak/projects/malaria_single_cell/mali_field_runs/2022/data/cellranger_runs/Pf/5736STDY*/outs/raw_feature_bc_matrix.h5" --o_file_name "soupx_filt_seu_norm.RDS" --hvg 500 -resume
```


Read in soupx objects processed in farm
FARM CODE
```{r, message=F, warning=F}
##Read BPcells matrices
all_msc_nosct_supx_4_dblt_objs <- list.files("data/processed/Pf", pattern = "soupx_filt_seu_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  # .[sample_name_nms] %>%
  map(readRDS)
```

```{r, message=F, warning=F}
##Read BPcells matrices
all_msc_nosct_supx_4_dblt <- map(all_msc_nosct_supx_4_dblt_objs, ~.x[[1]])
```

Plot of soup estimated proportion
```{r, message=F, warning=F}
##Read BPcells matrices
all_msc_nosct_supx_4_dblt_mdata <- map(all_msc_nosct_supx_4_dblt_objs, ~.x[[2]])

all_msc_nosct_supx_4_dblt_mdata %>% 
  bind_rows(.id = "donor") %>%
  rownames_to_column('bcode') %>%
  select(donor, rho) %>%
  distinct(rho, .keep_all = T) %>%
  ggplot(aes(x = donor, y = rho)) +
  geom_point() +
  # geom_line(aes(group = 1)) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))

```

```{r, message=F, warning=F}
##Read BPcells matrices
rm(all_msc_nosct_supx_4_dblt_objs)
```

```{r, message=F, warning=F}
##Read BPcells matrices
supx_png <- list.files("data/processed/Pf", pattern = "rho_plt.png$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  map(readPNG)

imap(supx_png, ~{
  plot(1:2, type='n', xlab="", ylab="", axes=FALSE, main = .y)
  rasterImage(.x, 1, 1, 2, 2)
  })
```

```{r, message=F, warning=F}
##Read BPcells matrices
# all_msc_nosct_supx_4_dblt[["MSC68"]]
```

Check those that failed soupx automatic detection of soup contaminating fraction due to an issue with marker genes
```{r , eval=T}
failed_supx <- all_msc_nosct_supx_4_dblt %>% 
  .[sample_name_nms] %>%
  names() %>%
  is.na(.) %>%
  sample_name_nms[.]

failed_supx
```

Replace with unadjusted object if soupx not successful

```{r ,include=FALSE, message=FALSE, warning=FALSE}
# ##
# for (i in 1:length(failed_supx)) {
# 
#   print(failed_supx[i])
#   all_msc_nosct_supx_4_dblt[failed_supx[i]] <- CreateSeuratObject(counts = all_msc_filt[[failed_supx[i]]][["RNA"]]$counts, meta.data = all_msc_filt[[failed_supx[i]]]@meta.data) %>% NormalizeData(., verbose = F) %>% FindVariableFeatures(., nfeatures = 500, verbose = T) %>% ScaleData(., verbose = F) %>% RunPCA(., verbose = T) %>% list()
# 
# }
# all_msc_nosct_supx_4_dblt <- all_msc_nosct_supx_4_dblt %>% .[sample_name_nms]
```

```{r ,include=FALSE, message=FALSE, warning=FALSE}
##
for (i in 1:length(failed_supx)) {

  print(failed_supx[i])
  all_msc_nosct_supx_4_dblt[failed_supx[i]] <- CreateSeuratObject(counts = all_msc_filt[[failed_supx[i]]][["RNA"]]$counts, meta.data = all_msc_filt[[failed_supx[i]]]@meta.data) %>% seurat_norm_stand(., hvg = 500) %>% list()

}
all_msc_nosct_supx_4_dblt <- all_msc_nosct_supx_4_dblt %>% .[sample_name_nms]
```


```{r , message=FALSE, warning=FALSE}
# Add stage metadata to supx object
all_msc_nosct_supx_4_dblt <- list(all_msc_nosct_supx_4_dblt, all_msc_filt) %>%
  pmap(~ {
    ..2@meta.data %>%
      dplyr::select(StagePrelimC) %>%
      AddMetaData(..1, .)
       })

```


```{r, eval=T}

imap(all_msc_filt, ~DimPlot(.x, group.by = "StagePrelimC", reduction = "pca") + labs(title = .y))
```


FARM CODE
```{r, eval=T}
## write out seurat bpcells object files for normalization processing in farm
imap(all_msc_nosct_supx_4_dblt, ~saveRDS(.x, paste0("data/processed/Pf/",.y,"/seu_obj/filt_seu_supx.RDS")))
```

!!!NB - FARM CODE - DONT DELETE
```{r, eval=T}
gogo()
## Remove the output files before rerunning since some object it might fail and old object persists
# map(names(all_msc_nosct_supx_4_dblt), ~system(paste0('rm data/processed/Pf/', .x,'/seu_obj/filt_seu_norm_supx.RDS')))

## Run SNORM on farm like below

# nextflow run ../mali22_code_lnk/nf_scripts/submsn_seu_norm.nf --scrpt "/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_stdnorm.R" --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/filt_seu_supx.RDS" --normlzn "norm" --umap_name "UMAP_F_S_NORM" --hvg 500 --cluster_resoln 0.1 --cl_nm "seurat_clusters_supx" --umap_redctn_nm "umap.f.s.norm" --redctn "pca" --integrtd_pc30 "no" --findpc_mthd "perpendicular line" --pca_redctn_nm "pca_soupx" --resume
```


```{r, eval=T}
## write out seurat bpcells object files for normalization processing in farm
# imap(all_msc_bp, ~system(paste0("rm data/processed/Pf/",.y,"/seu_obj/Rplots.pdf")))
```


```{r}
filt_seu_norm_supx_elbo <-  list.files("data/processed/Pf", pattern = "^filt_seu_supx_norm_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readRDS)

imap(filt_seu_norm_supx_elbo, ~.x + labs(title = .y))
```


Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read BPcells matrices
all_msc_nosct_supx_4_dblt <- list.files("data/processed/Pf", pattern = "^filt_seu_supx_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readRDS)
```



#### Visualize gene count in soup corrected
```{r, results='asis'}
imap(all_msc_nosct_supx_4_dblt, ~FeaturePlot(.x, features = 'nFeature_RNA', dims = c(1,3)) +
       labs(title = .y) +
      theme(axis.text=element_text(size=18), 
            axis.title=element_text(size=18,face="bold"), 
            legend.text = element_text(size=22), 
            legend.title = element_text(size=22,face="bold"),
            # plot.title = element_blank()
            )
)

```

#### Mitochondrial percent in soup-corrected objects

```{r}
# ## calculate mitochondrial proportions
# all_msc_nosct_supx_4_dblt <- all_msc_nosct_supx_4_dblt%>% 
#   map(. %>% PercentageFeatureSet(., pattern = "PF3D7-MIT", col.name = 'percent.mt'))
# 
# all_msc_nosct_supx_4_dblt <- all_msc_nosct_supx_4_dblt%>% 
#   map(. %>% PercentageFeatureSet(., pattern = "PF3D7-API", col.name = 'percent.api'))
# 
# ## filter less based on mitochondrial proportions
```


```{r}
## calculate mitochondrial proportions
all_msc_nosct_supx_4_dblt <- all_msc_nosct_supx_4_dblt%>% 
  map(., ~{
    
    mit_fts <- rownames(.x)[str_detect(rownames(.x), "MIT")]
    api_fts <- rownames(.x)[str_detect(rownames(.x), "API")]
    
    .x %>% PercentageFeatureSet(., features = mit_fts, col.name = 'percent.mt') %>%
    PercentageFeatureSet(., features = api_fts, col.name = 'percent.api') 
})

```

```{r, results='asis'}
imap(all_msc_nosct_supx_4_dblt, ~FeaturePlot(.x, features = 'percent.mt', dims = c(1,2)) +labs(title = .y))

```

```{r, fig.height = 5, fig.width = 15}
# markers <- c("PF3D7-0935900", "PF3D7-0406200", "PF3D7-0109100", "PF3D7-0208900")
markers <- c("PF3D7-0935900", "PF3D7-0406200", "PF3D7-0109100", "PF3D7-1325200")

marker_nms <- Pf3D7_genes_plasmoDB %>% filter(gene_id %in% markers)  %>% select(Gene, gene_id) %>% mutate(across(gene_id, ~factor(., levels = markers))) %>% arrange(gene_id)  %>% mutate(across(gene_id, as.character)) %>% deframe

fp_fn <- function(obj = all_msc_nosct_supx_4_dblt[[1]], mks = marker_nms, mk_nms = names(marker_nms), rdctn = "umap.f.s.norm") {
  list(mks, mk_nms) %>%
  pmap(.,~{
    FeaturePlot(obj, features = ..1, dims = c(1,2), reduction = rdctn) + 
      labs(title = ..2) +
      theme(legend.position = 'none')
    }) %>% 
    plot_grid(plotlist = ., nrow = ceiling(length(markers)/4)) 
}

```

```{r, fig.height = 5, fig.width = 15}
imap(all_msc_nosct_supx_4_dblt, ~fp_fn(obj = .x) %>% 
       plot_grid(ggdraw() + draw_label(.y), . ,ncol = 1, rel_heights = c(0.1, 1)))
```

```{r, fig.height = 5, fig.width = 15}
imap(all_msc_nosct_supx_4_dblt, ~fp_fn(obj = .x, rdctn = "pca_soupx") %>% 
       plot_grid(ggdraw() + draw_label(.y), . ,ncol = 1, rel_heights = c(0.1, 1)))
```

Check the distribution of stages - scdblfinder will give error if only one category in stage - Using StagePrelim instead of StagePrelimC
```{r}

all_msc_filt %>% map(., ~.x@meta.data %>% count(StagePrelim, StagePrelimC))

```


## scDblFinder

!!!NB - FARM CODE - DONT DELETE
```{r, eval=T}
gogogo()
## Remove the output files before rerunning since some object it might fail and old object persists
# map(names(all_msc_filt), ~system(paste0('rm data/processed/Pf/', .x,'/seu_obj/scdblf_outs.RDS')))

## Run sdblfinder on farm submsn_soupx.nf --scrpt "/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/soupx.R
# nextflow run ../mali22_code_lnk/nf_scripts/doubletF.nf --scrpt "/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/scdblfindr.R" --filt_obj "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/filt_seu_sct_norm.RDS" --spx_obj "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/filt_seu_supx_norm.RDS" --o_file_name "scdblf_outs.RDS" --resume
```

Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read BPcells matrices
scf_outputs <- list.files("data/processed/Pf", pattern = "^scdblf_outs.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readRDS)
```


Assess agreement between the calls
```{r, message=FALSE}
map(scf_outputs, ~.x %>% select(contains("class")) %>% group_by_all() %>% count())

```

Chsqr of the different scdblfinder flavours tests
```{r, message=FALSE}
pw_scf_comp <- scf_outputs[[1]] %>% select(contains("class")) %>% colnames() %>% combn(., 2, simplify = F)

pw_scf_comp_nms <- map(pw_scf_comp, ~{paste0(.x[[1]], '_VS_', .x[[2]])})

a <- map(scf_outputs, ~{
  tbl = .x
  map(pw_scf_comp, ~{chisq.test(tbl[,.x[[1]]], tbl[,.x[[2]]])[c('statistic', 'p.value')]} %>% base::as.data.frame() %>%  rownames_to_column('test') ) %>%  
    set_names(pw_scf_comp_nms) %>% 
    bind_rows(., .id = "comps")
}) %>% 
    bind_rows(., .id = "donor")

```

```{r, message=FALSE}
##Doublet removal
all_msc_w_dblts <- list(all_msc_filt, scf_outputs) %>%
  pmap(~ {
    ..2 %>%
      column_to_rownames("bcode") %>%
      AddMetaData(..1, .)
       })

```

```{r, message=FALSE}
##Doublet removal
DimPlot(all_msc_nosct_supx_4_dblt[[1]], reduction = 'umap.f.s.norm')
# DimPlot(all_msc_w_dblts[[1]],reduction = "umap.f.s.norm")
```

```{r}
## Add UMAP dimensions from the soupx corrected object used to get doublets
for (i in names(all_msc_w_dblts)) {
  all_msc_w_dblts[[i]]@reductions[["umap.f.s.norm"]] <- all_msc_nosct_supx_4_dblt[[i]]@reductions[["umap.f.s.norm"]]
  all_msc_w_dblts[[i]]@reductions[["pca_soupx"]] <- all_msc_nosct_supx_4_dblt[[i]]@reductions[["pca_soupx"]]
}
```


```{r, message=FALSE}
##Doublet removal
DimPlot(all_msc_w_dblts[[1]])
# DimPlot(all_msc_w_dblts[[1]],reduction = "umap.f.s.norm")
```

##### scdblfinder visualizations
```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Display the combined datasets as an interactive 3D plot
# Display the combined datasets as an interactive 3D plot

plot_ly(data = as.data.frame(all_msc_w_dblts[[4]]@reductions[["umap"]]@cell.embeddings),
        x = ~UMAP_1, y = ~UMAP_2, z = ~UMAP_3,
        color= all_msc_w_dblts[[4]]@meta.data$scf_class_norm,
        colors = c('blue', 'red'),
        opacity = 0.8,
        size = 1, 
        type = 'scatter3d'
)

```

##### doublet score and seurat clusters UMAP
doublet score UMAP plus grouping by seurat clusters to see if some clusters are predominantly doublets


```{r, results='asis'}
all_msc_w_dblts <- map(all_msc_w_dblts, ~FindClusters(.x, resolution = 0.8))

```

```{r, results='asis'}
all_msc_w_dblts  %>% imap(.,~{
    DimPlot(.x, group.by = 'seurat_clusters', label = T)
    })

```

```{r, results='asis'}
all_msc_w_dblts  %>%   imap(.,~{
    FeaturePlot(.x, features = 'scf_score_norm', pt.size = 0.2)
  })

```
```{r, results='asis'}
all_msc_w_dblts  %>%   imap(.,~{
    FeaturePlot(.x, features = 'scf_score_norm', pt.size = 0.2, reduction = "pca")
  })

```


##### MSC14 doublet scores
```{r, message=F, warning=F, eval=FALSE}
##dimplot

# Display the combined datasets as an interactive 3D plot
plot_ly(data = as.data.frame(all_msc_w_dblts[[4]]@reductions[["umap"]]@cell.embeddings),
        x = ~UMAP_1, y = ~UMAP_2, z = ~UMAP_3,
        color= all_msc_w_dblts[[4]]@meta.data$scf_score_norm,
        colors = c('blue', 'red'),
        opacity = 0.8,
        size = 1, 
        type = 'scatter3d'
)

```




#### End of scdblfinder visualizations

```{r}
# rm(all_msc_nosct_corrected_dblt_sce, all_msc_nosct_supx_4_dblt)
```

```{r}
# counts_msc <- map(all_msc_filt, ~.x[['RNA']]$counts)
counts_msc <- map(all_msc_filt, ~as(.x[["RNA"]]$counts, Class = "dgCMatrix"))
genes_msc <- map(all_msc_filt, ~rownames(.x[['RNA']]$counts))

## doublet rate 0.8% (0.008) for every 1000 recovered cells - calculated as recommended https://kb.10xgenomics.com/hc/en-us/articles/360054599512-What-is-the-cell-multiplet-rate-when-using-the-3-CellPlex-Kit-for-Cell-Multiplexing

dbr = map(all_msc_filt, ~(ncol(.)/1000)*0.008)
```


```{r}
library(Matrix)
write(names(counts_msc), file = "data/processed/Pf/don_nms.txt")

imap(counts_msc, ~writeMM(.x, paste0("data/processed/Pf/", .y ,"/seu_obj/counts_msc.mtx")))
imap(genes_msc, ~write(.x, paste0("data/processed/Pf/", .y ,"/seu_obj/genes_msc.txt")))

# dbr = map(all_msc_filt, ~(ncol(.)/1000)*0.008)
```



```{r}
## remove to save space
rm(counts_msc)
rm(genes_msc)
# gogogo()
```

```{r}
gogo()
## Run this script in farm
# cd /lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code/python_nbooks
# conda activate scrublt
# python scrblt.py 
```

```{r}
## Read scrublet output
scrb_doublet_scores <- list.files("data/processed/Pf", pattern = "doublet_scores.csv$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(., ~read.csv(., header = F) %>% t() %>% .[,1] %>% as.vector)
```

```{r}
## Read scrublet output
predicted_doublets <- list.files("data/processed/Pf", pattern = "predicted_doublets.csv$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(., ~read.csv(., header = F) %>% t() %>% .[,1] %>% as.vector)
```


```{r}

scrublet_o <- pmap(list(all_msc_w_dblts, scrb_doublet_scores, predicted_doublets), ~data.frame('bcode'= colnames(..1), 'scrub_scores'=..2, 'scrub_doublet'=..3))
```

Visualize scrublet scores
```{r}
## Read scrublet plots for threshold

scrb_png <- list.files("data/processed/Pf", pattern = "scrblt_thresh.png$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readPNG)

imap(scrb_png, ~{
  plot(1:2, type='n', xlab="", ylab="", axes=FALSE, main = .y)
  rasterImage(.x, 1, 1, 2, 2)
  })
```

```{r}
## Read scrublet plots for threshold

scrb_umap_png <- list.files("data/processed/Pf", pattern = "scrblt_umap.png$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readPNG)

imap(scrb_umap_png, ~{
  plot(1:2, type='n', xlab="", ylab="", axes=FALSE, main = .y)
  rasterImage(.x, 1, 1, 2, 2)
  })
```

```{r}

all_msc_w_dblts <- list(scrublet_o, all_msc_w_dblts) %>%
  pmap(~ ..1 %>% 
         dplyr::select(bcode, scrub_doublet) %>%
         mutate(scrub_doublet = case_when(scrub_doublet == "True" ~ "Doublet", scrub_doublet == "False" ~ "Singlet")) %>%
         column_to_rownames('bcode') %>%
         AddMetaData(..2, .))


```


Add the doublet proportion per cluster for each of the doublet methods assessed

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}
dbt_methods <- c(paste0(c("scf_class"), c("_norm", "_rand")), paste0(c("scf_class"), c("_supx_norm", "_supx_rand")), "scrub_doublet", "strain_gt")

all_msc_w_dblts <- map(all_msc_w_dblts, ~{
  obj = .x
  map(dbt_methods, ~{
  obj@meta.data %>%
    rownames_to_column('bcode') %>%
    dplyr::add_count(seurat_clusters, !!rlang::sym(.x))  %>%
    group_by(seurat_clusters) %>%
    mutate(freq = round(n / n(), 3), 
           !!paste0(.x, "_dbt_nums") := case_when(!!rlang::sym(.x) == "Doublet" ~ n,
                                                  !!rlang::sym(.x) == "Singlet" ~ n()-n),
           !!paste0(.x, "_dbt_prop") := case_when(!!rlang::sym(.x) == "Doublet" ~ freq,
                                                  !!rlang::sym(.x) == "Singlet" ~ 1-freq),
           !!paste0(.x, "_dbt_ovrl_prop") := case_when(!!rlang::sym(.x) == "Doublet" ~ round(n / ncol(obj), 3),
                                                       !!rlang::sym(.x) == "Singlet" ~ round((n()-n) / ncol(obj), 3)),
           !!paste0(.x, "_dbt_allnums") := case_when(!!rlang::sym(.x) == "Doublet" ~ paste(n, n(), ncol(obj), sep = "_"),
                                                     !!rlang::sym(.x) == "Singlet" ~ paste((n()-n), n(), ncol(obj), sep = "_"))
           ) %>%
      ungroup() %>% 
      select('bcode', paste0(.x, "_dbt_prop"), paste0(.x, "_dbt_ovrl_prop"), paste0(.x, "_dbt_nums"), paste0(.x, "_dbt_allnums")) 
    
    }) %>%
      purrr::reduce(., .f = full_join, by = "bcode") %>% 
      column_to_rownames('bcode') %>%
      AddMetaData(obj, .)
  })

```


Check doublet cluster

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}
dbt_methods_optimum <- c("scf_class_supx_rand", "scrub_doublet")

```

### Doublets visualizations

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

imap(all_msc_w_dblts, ~.x@meta.data %>% ggplot(aes(x = seurat_clusters, y= sim_lab1, color = strain_gt)) + geom_boxplot() + geom_hline(yintercept = 0.85) + facet_wrap(. ~ StagePrelimC, nrow = 1, scales = "free_x")+
    labs(title = .y))
```


```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

all_msc_w_dblts <- map(all_msc_w_dblts, ~{
  .x@meta.data %>%
    rownames_to_column('bcodes') %>%
    # mutate(StagePrelimC = ifelse(is.na(StagePrelimC), "Unassigned", StagePrelimC)) %>%
    group_by(stage_lab1) %>%
    mutate(lo_outlr_thresh = quantile(sim_lab1, probs = 0.25) - IQR(sim_lab1) * 1.5,
           lo_outlrs = sim_lab1 <= lo_outlr_thresh,
           q10 = quantile(sim_lab1, probs = .20),
           hetero_dblts = case_when(stage_lab1 %in% c("Male", "Female", "Unassigned") & sim_lab1 <= q10 & lo_outlrs == T ~ "Doublet",
                                    T ~ "Singlet"),
           # hetero_dblts = case_when(stage_lab1 %in% c("Male", "Female", "Unassigned") & strain_gt_dbt_prop >= 0.05 & lo_outlrs == T ~ "Doublet",
           #                          T ~ "Singlet")
           )   %>%
    dplyr::select(bcodes, lo_outlr_thresh, lo_outlrs, hetero_dblts) %>%
    column_to_rownames('bcodes') %>%
    AddMetaData(.x, .) 
    
    })

```



```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

imap(all_msc_w_dblts, ~{
  .x@meta.data %>%
    ggplot(aes(x = seurat_clusters, y= sim_lab1, color = hetero_dblts)) + 
    geom_boxplot() + 
    geom_hline(yintercept = 0.85) + 
    facet_wrap(. ~ StagePrelimC, nrow = 1, scales = "free_x") +
    labs(title = .y)
    })

```

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

map(all_msc_w_dblts, ~{
  .x@meta.data %>%
    count(seurat_clusters, strain_gt_dbt_prop)
    })
```


```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% 
      dplyr::count(strain_gt, hetero_dblts)
)

```



```{r, warning=FALSE, message=FALSE}

imap(all_msc_w_dblts, ~DimPlot(.x, dims = c(1,2), label = T, cells.highlight = .x@meta.data %>% filter(hetero_dblts == "Doublet") %>% row.names(), reduction = "umap.f.s.norm") + labs(title = .y))

```


```{r}

map(all_msc_w_dblts, ~.x@meta.data %>%
      filter(strain_gt_dbt_prop > 0.05) %>% 
      dplyr::count(seurat_clusters, strain_gt, StagePrelimC,lo_outlrs,strain_gt_dbt_prop)  %>%
      group_by(seurat_clusters) %>%
      filter(strain_gt == "Doublet")
    )  

```


```{r}

all_msc_w_dblts[[3]]@meta.data %>%
      filter(seurat_clusters == "5") %>% 
      select(sim_lab1,StagePrelimC, strain_gt_dbt_prop, lo_outlr_thresh, lo_outlrs, hetero_dblts)
 

```


```{r}

all_msc_w_dblts[[3]]@meta.data %>%
      count(StagePrelimC, lo_outlr_thresh)
 

```

```{r, warning=FALSE, message=FALSE}

map(all_msc_w_dblts, ~DimPlot(.x, dims = c(1,2), group.by = "StagePrelimC", reduction = "umap.f.s.norm"))
```



```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% 
      dplyr::add_count(seurat_clusters, strain_gt)  %>%
      group_by(seurat_clusters) %>%
      mutate(freq = round(n / sum(n), 3))# %>%
      # filter(strain_gt == "Doublet" & freq > 0.1) %>%
      # rstatix::identify_outliers()
    )  

```


```{r, fig.height = 3.5, fig.width = 15}
dbt_methods_gtyp <- c(dbt_methods, "strain_gt", "hetero_dblts")

scf_fn <- function(obj = all_msc_w_dblts[[1]], mks = dbt_methods_gtyp, mk_nms = dbt_methods_gtyp, nrws = ceiling(length(dbt_methods_gtyp)/5), redct = "umap_norm") {
  list(mks, mk_nms) %>%
  pmap(.,~{
    DimPlot(obj, dims = c(1,2), label = T, pt.size = 0.01, cells.highlight = obj@meta.data %>% filter(!!rlang::sym(..1) == "Doublet") %>% row.names(), sizes.highlight = 0.1, reduction = redct) + 
      labs(title = ..2) +
      theme(legend.position = 'none')
    }) %>% 
    plot_grid(plotlist = ., nrow = nrws) 
}

```

```{r, fig.height = 8, fig.width = 15}
# 

map(all_msc_w_dblts, ~scf_fn(obj = .x, nrws = ceiling(length(dbt_methods_gtyp)/5), redct = "umap_norm"))
```


```{r, fig.height = 8, fig.width = 15}
# 
map(all_msc_w_dblts, ~scf_fn(obj = .x, nrws = ceiling(length(dbt_methods_gtyp)/5), redct = "pca_soupx"))
```


```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

map(all_msc_w_dblts, ~{
  
  .x@meta.data %>% 
    distinct(seurat_clusters, .keep_all = T) %>% 
    select(contains("_dbt_prop"), contains("_dbt_allnums"), seurat_clusters) %>%
    pivot_longer(cols = -c('strain_gt_dbt_prop', 'strain_gt_dbt_allnums', seurat_clusters), names_pattern = "(.*)_(dbt.*)", names_to = c( "dbm", ".value")) %>% 
    ggplot(aes(y = strain_gt_dbt_prop,x = dbt_prop )) + geom_point() +facet_wrap(.~dbm) + 
    geom_text_repel(aes(label = paste0(seurat_clusters, "(",dbt_allnums,")"))) + 
    geom_hline(yintercept = 0.3) + 
    geom_vline(xintercept = 0.3)
  
})

```

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

map(all_msc_w_dblts, ~{
  
  .x@meta.data %>% 
    distinct(seurat_clusters, .keep_all = T) %>% 
    select(contains("_dbt_prop"), contains("_dbt_nums"), seurat_clusters) %>%
    pivot_longer(cols = -c('strain_gt_dbt_prop', 'strain_gt_dbt_nums', seurat_clusters), names_pattern = "(.*)_(dbt.*)", names_to = c( "dbm", ".value")) %>% 
    ggplot(aes(y = strain_gt_dbt_prop,x = dbt_prop )) + geom_point() +facet_wrap(.~dbm) + 
    geom_text_repel(aes(label = paste0(seurat_clusters, "(",dbt_nums,")"))) + 
    geom_hline(yintercept = 0.3) + 
    geom_vline(xintercept = 0.5)
  
})

```




```{r, warning=FALSE, message=FALSE}

map(all_msc_w_dblts, ~DimPlot(.x, dims = c(1,2), label = T, group.by = "seurat_clusters"))

```


```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

map(all_msc_w_dblts, ~{
  .x@meta.data %>%
    dplyr::count(seurat_clusters, scf_class_supx_norm)  %>%
    group_by(seurat_clusters) %>%
    mutate(freq = round(n / sum(n), 3), 
               scf_dbt_prop = case_when(scf_class_supx_norm == "Doublet" ~ freq,
                                    scf_class_supx_norm == "Singlet" ~ 1-freq)) %>% 
    filter(scf_dbt_prop > 0.1)
  
    }) 

```


```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

map(all_msc_w_dblts, ~{
  .x@meta.data %>%
    dplyr::count(seurat_clusters, strain_gt)  %>%
    group_by(seurat_clusters) %>%
    mutate(freq = round(n / sum(n), 3), 
               scf_dbt_prop = case_when(strain_gt == "Doublet" ~ freq,
                                    strain_gt == "Singlet" ~ 1-freq)) %>% 
    filter(scf_dbt_prop > 0.1)
  
    }) 

```


```{r, results='asis', message=F, warning=F, fig.width = 10, fig.height = 5}
gbox_thme <- theme(axis.text=element_text(size=14),
            axis.title=element_text(size=16,face="bold"),
            legend.text = element_text(size=15),
            title = element_text(size=16,face="bold")
            )

```

```{r, fig.height = 3.5, fig.width = 15}

gbx_fn <- function(obj = all_msc_w_dblts[[1]], mks = dbt_methods_gtyp, nrws = ceiling(length(dbt_methods_gtyp)/5), lgpos = "bottom", xgrp = "StagePrelimC") {
  list(mks) %>%
  pmap(.,~{
    obj@meta.data %>%
      ggplot(., aes(x= !!rlang::sym(xgrp), y=nFeature_RNA, color = !!rlang::sym(..1))) +
      geom_boxplot(aes( color = !!rlang::sym(..1))) +
      geom_point(aes(group=!!rlang::sym(..1)), size = 0.7, position = position_jitterdodge(jitter.width = 0.07)) + 
      labs(title = ..1) +
      theme_classic() +
      gbox_thme +
      theme(legend.position = lgpos,
            legend.title.position = "top") 
    
    }) %>% 
    plot_grid(plotlist = ., nrow = nrws) 
}

```

```{r, fig.height = 8, fig.width = 15}

map(all_msc_w_dblts, ~gbx_fn(obj = .x, mks = dbt_methods_gtyp, nrws = ceiling(length(dbt_methods_gtyp)/4), xgrp = "StagePrelimC"))
```


```{r, fig.height = 8, fig.width = 15}
# 

map(all_msc_w_dblts, ~gbx_fn(obj = .x, mks = dbt_methods_gtyp[!dbt_methods_gtyp == "strain_gt"], nrws = ceiling(length(dbt_methods_gtyp)/4), xgrp = "strain_gt"))
```


```{r, fig.height = 13, fig.width = 18}
# 

map(all_msc_w_dblts, ~gbx_fn(obj = .x, mks = dbt_methods_gtyp, nrws = ceiling(length(dbt_methods_gtyp)/3), xgrp = "seurat_clusters"))
```


##### Boxplots gene count vs doublet status stratified by Strain_DN

```{r, results='asis', message=F, warning=F, fig.width = 10, fig.height = 5, eval=FALSE}
all_msc_w_dblts  %>%
  imap(.,  ~ {
    a_gns = .x@meta.data  %>%
      ggplot(., aes(x=scf_class_rand, y=nFeature_RNA, color = strain_gt)) +
      geom_boxplot(aes( color = strain_gt)) +
      geom_point(aes(group=strain_gt), size = 0.7, position = position_jitterdodge(jitter.width = 0.2)) +
      stat_summary(
        fun.data = stat_box_data, 
        geom = "label_repel", 
        vjust = -2,
        size = 3.5,
        label.padding = unit(0, "lines"),
        position = position_jitterdodge(jitter.width = 0.2),
        direction = "y",
        show.legend = FALSE
      )+
      gbox_thme
    
    print(a_gns)
    
  })

```

```{r, results='asis'}
##adding clusters that are used to display mitochondrial count
map(all_msc_w_dblts, ElbowPlot)
```

```{r, message=FALSE, warning=FALSE}
pc_list <-list(6L,4L,5L, 5L, 5L, 5L)
res_list <- c(0.18,0.12,0.12,0.12,0.12,0.12)

pc_list <- list(rep(6L, length(sample_name_nms)))
res_list <- list(rep(0.4, length(sample_name_nms)))

# all_msc_nosct_corrected_dblt_db <- list(all_msc_w_dblts, pc_list, res_list) %>%
#   pmap(.,~{RunUMAP(..1, dims = 1:..2, n.components = 3L, verbose=F, seed.use = 949) %>%
#          FindNeighbors(., dims = 1:..2, verbose = FALSE) %>%
#          FindClusters(., resolution = ..3, verbose=F)
#   })

```



```{r}
##Seurat object
# all_msc_w_dblts[[1]]@meta.data %>% dplyr::count(seurat_clusters_dblt, scf_class_rand, scf_class_norm)
map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt, scf_class_norm, scrub_doublet))
map(all_msc_w_dblts, ~.x@meta.data %>% mutate(strain_dblt = case_when(strain_gt != 'Doublet' ~ 'Singlet', T ~ strain_gt)) %>% dplyr::count(strain_dblt,scf_class_norm, scrub_doublet))
# all_msc_filt_w_dblts[[4]]@meta.data %>% 
#   dplyr::group_by(seurat_clusters_dblt) %>% 
#   dplyr::count(seurat_clusters_dblt, scf_class_norm) %>%
#   mutate(freq = round(n / sum(n), 3)) 
```



```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt, scf_class_norm)  %>%
      group_by(strain_gt) %>%
      mutate(freq = round(n / sum(n), 3)))  

```


```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt, scrub_doublet)  %>%
      group_by(strain_gt) %>%
      mutate(freq = round(n / sum(n), 3)))  

```


```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt, scf_class_norm) %>%
      group_by(strain_gt) %>%
      mutate(freq = round(n / sum(n), 3)))  

```


```{r}
# dbt_methods <- c("scf_class", "scrub_doublet", "scf_class_norm")
# dbt_methods <- c(paste0(c("scf_class"), c("_norm", "_rand")), paste0(c("scf_class_norm"), rep(c("_norm", "_sct"))), "scrub_doublet")
dbt_methods_stg <- c(paste0(c("scf_class"), c("_norm", "_rand")), paste0(c("scf_class"), c("_supx_norm", "_supx_rand")), "scrub_doublet")


dbt_sens_speci <-map2(all_msc_w_dblts, rep(list(dbt_methods_stg), length(all_msc_w_dblts)), ~{
  dblt_calls <- .x@meta.data %>% 
    dplyr::select(hetero_dblts, dbt_methods_stg) %>% 
    mutate(across(everything(), ~factor(., levels = c("Singlet", "Doublet")))) 
  # a=.y
  map(dbt_methods_stg, ~list("Sensitivity" = sensitivity(data = dblt_calls[,.x], reference = dblt_calls[,"hetero_dblts"]), "Specificity" = specificity(data = dblt_calls[,.x], reference = dblt_calls[,"hetero_dblts"]))) %>%
    set_names(dbt_methods_stg) %>% as.data.frame()
  }) %>% bind_rows(., .id = "donor")

```


```{r}
# # dbt_methods_stg <- c("scf_class_norm", "scrub_doublet", "scf_class_norm")
# dbt_methods_stg <- c(paste0(c("scf_class_norm", "scf_class_norm"), rep(c("_norm", "_rand"), each=2)), "scrub_doublet")
# 
# dbt_sens_speci <-map2(all_msc_w_dblts, rep(list(dbt_methods_stg), length(all_msc_w_dblts)), ~{
#   dblt_calls <- .x@meta.data %>% 
#     dplyr::select(strain_gt, dbt_methods_stg) %>% 
#     mutate(across(everything(), ~factor(., levels = c("Singlet", "Doublet")))) 
#   # a=.y
#   map(dbt_methods_stg, ~list("Sensitivity" = sensitivity(data = dblt_calls[,.x], reference = dblt_calls[,"strain_gt"]), "Specificity" = specificity(data = dblt_calls[,.x], reference = dblt_calls[,"strain_gt"]))) %>%
#     set_names(dbt_methods_stg) %>% as.data.frame()
#   }) %>% bind_rows(., .id = "donor")

```

```{r}
dblt_calls <- all_msc_w_dblts[[1]]@meta.data %>% dplyr::select(strain_gt, dbt_methods_stg) %>% mutate(across(everything(), ~factor(., levels = c("Singlet", "Doublet")))) 

sensitivity(reference = dblt_calls[,"strain_gt"], data = dblt_calls[,"scf_class_norm"])

specificity(reference = dblt_calls[,"strain_gt"], data = dblt_calls[,"scf_class_norm"])

```


```{r}
dbt_sens_speci %>% pivot_longer(cols = -c(donor), names_pattern = "(.*)\\.(S.*)", names_to = c( "Dbt_method", ".value")) %>%
  ggplot(aes(x= donor, y = Sensitivity, color = Dbt_method))  +
  geom_point() +
  geom_line(aes(group = Dbt_method), linetype = "dotted")+
  geom_point(aes(y = Specificity)) +
  geom_line(aes(y = Specificity, group = Dbt_method))+
  scale_y_continuous( name = 'Sensitivity', sec.axis = sec_axis(~. *1,name = "Specificity"))

```





#### Add doublet assignment to raw seurat object to visualize all the cells that are filter out
```{r}

# mt_filt <- rep(0.4, length(all_msc_w_dblts))
mt_filt <- unlist(map(all_msc_w_dblts, ~quantile(.x@meta.data[, "percent.mt"], 0.995, na.rm = T)))
```

## Visualize doublets and other QC classes



```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count
# all_msc_nosct_corrected_dblt_db[[4]] <- AddMetaData(all_msc_nosct_corrected_dblt_db[[4]], old_seurat_clusters)

trunc_axis <- ggh4x::guide_axis_truncated(
  trunc_lower = unit(0, "npc"),
  trunc_upper = unit(2.5, "cm")
)


cell_qc_objs<- list(all_msc_w_dblts, mt_filt) %>%
  pmap(., ~{
  
  cell_qc_filt_tbl <- ..1@meta.data %>%
  mutate('QC_reason' =case_when(strain_gt == "Negative" ~ 'sc_neg', 
                                nFeature_RNA<=gn_lci_cl_seu | nCount_RNA <= rna_lci_cl_seu ~ 'lo_gn_cnt', 
                                nFeature_RNA>=gn_uci_cl_seu | nCount_RNA >= rna_uci_cl_seu ~ 'hi_gn_cnt', 
                                percent.mt>=..2 ~ 'hi_mtp',
                                strain_gt == 'Doublet' & scf_class_supx_rand == 'Doublet' & scrub_doublet == 'Doublet' ~ 'ss_db', 
                                strain_gt == 'Doublet' & scf_class_supx_rand == 'Doublet' & scrub_doublet == 'Singlet' ~ 'ss_db', 
                                strain_gt == 'Doublet' & scf_class_supx_rand == 'Singlet' & scrub_doublet == 'Doublet' ~ 'ss_db', 
                                strain_gt != 'Doublet' & scf_class_supx_rand == 'Doublet' & scrub_doublet == 'Doublet' ~ 'stg_db', 
                                strain_gt == 'Doublet' & scf_class_supx_rand == 'Singlet' & scrub_doublet == 'Singlet' ~ 'strn_db', 
                                strain_gt!= 'Doublet' & scf_class_supx_rand == 'Doublet' & scrub_doublet == 'Singlet' ~ 'stg_db',
                                strain_gt!= 'Doublet' & scf_class_supx_rand == 'Singlet' & scrub_doublet == 'Doublet' ~ 'stg_db', 
                                strain_gt!= 'Doublet' & scf_class_supx_rand == 'Singlet' & scrub_doublet == 'Singlet' ~ 'pass')) %>%
  dplyr::select(QC_reason, StagePrelimC)

##tabulate cells  
cell_qc_filt_tbl %>% dplyr::count(StagePrelimC, QC_reason) %>% print()

##Order the QC filt reasons with the lowest prevalent to the highest prevalent 
cell_qc_filt_lvls <- cell_qc_filt_tbl %>% dplyr::count(QC_reason) %>% arrange(desc(n)) %>% pull(QC_reason)

##Get the QC filt reasons in order of filtering out for manuscript narrative
cell_qc_filt_tbl <- cell_qc_filt_tbl %>% mutate(across(QC_reason, ~factor(., levels=cell_qc_filt_nm_lvls))) 

## add to seurat object as metadata
cell_qc_filt_obj <- ..1 %>% 
  AddMetaData(., cell_qc_filt_tbl) 

## plot the cell qc metrics
cell_qc_plot <- cell_qc_filt_obj %>% DimPlot(., pt.size = 1, reduction = 'umap', dims = c(1,2), group.by = 'QC_reason',  order = rev(cell_qc_filt_lvls)#,
                                             # order = rev(c('Singlet', 'Strain', 'Stage', 'Strain & stage'))
                                             # label = T
                                             ) +
  scale_color_manual(name = 'QC class', 
                     values = cell_qc_cols, 
                     # breaks = c('sc_neg', 'lo_gn_cnt', 'hi_gn_cnt', 'hi_mtp', 'ss_db', 'strn_db', 'stg_db', 'pass'),
                     labels = c('SC Neg', 'Low gene/UMI', 'High gene/UMI', 'High Mt %' , 'Strain-stage Dbt', 'Strain Dbt',  'Stage Dbt', 'Pass') %>% set_names(cell_qc_filt_nm_lvls)) +
  theme_classic() +
  theme(axis.text=element_blank(),
        axis.title=element_blank(), 
        # axis.text=element_text(size=20),
        # axis.title=element_text(size=21,face="bold"), 
        legend.text = element_text(size=20), 
        legend.title = element_text(size=20, face = 'bold'),
        # title = element_text(size=20,face="bold"),
        plot.title = element_blank()#,
        # aspect.ratio = 0.9
        )+
  guides(color = guide_legend(override.aes = list(size = 5.5)), x= trunc_axis, y= trunc_axis)+
  theme(axis.line = element_line(arrow = arrow(angle = 20, length = unit(0.15, "inches"), ends = "last", type = "closed")),
        axis.title = element_text(hjust = 0, size=14, face = 'bold'))+
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL)
  

cell_qc_plot$data <- cell_qc_plot$data %>% rownames_to_column('bcode') %>% left_join(., cell_qc_filt_obj@meta.data[,'old_seu_cluster', drop = F] %>% rownames_to_column('bcode'), by='bcode') %>% column_to_rownames('bcode')

cell_qc_plot<- LabelClusters(cell_qc_plot, id = "old_seu_cluster", size = 7, repel = T)

return(list(cell_qc_filt_obj, cell_qc_plot))

})
```


```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

imap(cell_qc_objs, ~.x[[2]]+ labs(title = .y))
```



```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

mt_plt <- function(tbl, mtf, gp_var='seurat_clusters_norm', gp_cols = cluster_cols){
  
  FeatureScatter(tbl[,tbl@meta.data$QC_reason %in% c('pass', 'hi_mtp')], feature1 = "nCount_RNA", feature2 = "percent.mt", pt.size = 3, group.by = gp_var) +
  scale_color_manual(name= 'Cluster', values = gp_cols ) +
  scale_x_continuous(label=function(y) y / 1000) +
  geom_hline(yintercept = mtf) + 
  labs(y= 'Mt. fraction(%)', x = "Transcript count (X1e3)") +
  theme(axis.text=element_text(size=19),
        # axis.text.x = element_text(angle = 20), 
        axis.title=element_text(size=20,face="bold"), 
        legend.text = element_text(size=20), 
        legend.title = element_text(size=20, face = 'bold'),
        # title = element_text(size=20,face="bold"),
        plot.title = element_blank()#,
        # aspect.ratio = 0.9
        )+
  guides(color = guide_legend(override.aes = list(size = 4)))

}
```


```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

mt_pc_plot_no_col <- list(map(cell_qc_objs, ~.x[[1]]), mt_filt) %>%
  pmap(., ~{ 
    cl_no <- length(levels(..1@meta.data$seurat_clusters_norm))
    
    print(mt_plt(..1, ..2, gp_cols = rep("grey", cl_no)))
    })
# mt_pc_plot
```

```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

mt_pc_plot <- list(map(cell_qc_objs, ~.x[[1]]), mt_filt) %>%
  pmap(., ~{ 
    print(mt_plt(..1, ..2, gp_var='StagePrelimC', gp_cols = sp_fld_colors))
    print(mt_plt(..1, ..2))
    })
# mt_pc_plot
```


```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

mt_b_plt <- function(tbl, mtf){
  
  
 tbl@meta.data %>% ggplot(aes(y= percent.mt, x=seurat_clusters, color = seurat_clusters)) + geom_boxplot() + geom_point() + scale_color_manual(name= 'Cluster', values = cluster_cols)+
  geom_hline(yintercept = mtf)+
  ggpubr::stat_compare_means(label = "p", method = "wilcox.test", ref.group = '1')+ 
  labs(y= 'Mitochondrial \nfraction(%)', x = "Cluster")+
  theme(axis.text=element_text(size=19),
        # axis.text.x = element_text(angle = 20), 
        axis.title=element_text(size=20,face="bold"), 
        legend.text = element_text(size=20), 
        legend.title = element_text(size=20, face = 'bold'),
        # title = element_text(size=20,face="bold"),
        plot.title = element_blank()#,
        # aspect.ratio = 0.9
        )+
  guides(color = guide_legend(override.aes = list(size = 4)))



}
```


```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

list(map(cell_qc_objs, ~.x[[1]]), mt_filt) %>%
  pmap(., ~{ mt_b_plt(..1, ..2)})
```


```{r, results='asis',  fig.width = 8, fig.height = 4}
##adding clusters that are used to display mitochondrial count

list(map(cell_qc_objs, ~.x[[1]][,.x[[1]]@meta.data$QC_reason %in% c('pass')]), mt_filt) %>%
  pmap(., ~{ mt_plt(..1, ..2)})
```


#### Tabulate  doublets
```{r}
map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(scf_class_rand, scf_class_norm))
```

```{r}
map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt, scf_class_norm, scrub_doublet))
```

```{r}

## save file with doublet info
saveRDS(all_msc_w_dblts, "data/processed/Pf/m2_all/all_msc_w_dblts.RDS")

```


```{r, eval=F}

##Remove souporcell doublet
# all_msc_w_dblts <- readRDS("data/processed/Pf/m2_all/all_msc_w_dblts.RDS")

```


```{r}

## Write out file with doublets for sk25
saveRDS(all_msc_w_dblts[c("MSC33", "MSC57")] %>% lapply(., function(x) x@meta.data), "data/processed/Pf/m2_all/all_msc_w_dblts_m33_m57.RDS")

```


```{r}

## Write out metadata
# saveRDS(all_msc_w_dblts %>% lapply(., function(x) x@meta.data), "data/processed/Pf/m2_all/all_msc_w_dblts_mdata.RDS")

```


```{r}
map(all_msc_w_dblts, ~.x@meta.data %>% dplyr::count(strain_gt))
```

#### Remove doublets
##### Remove souporcell doublets and negatives
```{r}

##Remove souporcell doublet
# all_msc_filt_no_strainDblts <- all_msc_w_dblts %>%
#   map(. %>% subset(., subset = strain_gt %in% c("Doublet"), invert = TRUE))

```

##### Remove MSC14 cluster 7 with lots of doublets (6/38 = 16%)
```{r}
##Seurat object
##Remove cluster 7 with lots of doublets MSC14
# subset(all_msc_w_dblts[[4]], subset = seurat_clusters_dblt == "7") %>% .@meta.data %>% dplyr::count(scf_class_norm, scrub_doublet)

##Remove cluster 8 with lots of doublets (0.205) MSC14 - losing 31 singlets
# all_msc_w_dblts[[4]] <- subset(all_msc_w_dblts[[4]], subset = seurat_clusters_dblt != "7")

##Remove cluster 8 with lots of doublets (0.368) MSC14 - losing 12 singlets
# all_msc_w_dblts[[4]] <- subset(all_msc_w_dblts[[4]], subset = seurat_clusters_dblt != "8")

```

##### Check doublet clusters
```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% filter(scf_class_norm_dbt_prop > 0.1) %>% count(seurat_clusters, scf_class_norm_dbt_prop,scf_class_rand_dbt_prop, scrub_doublet_dbt_prop,   scf_class_norm_dbt_nums, scrub_doublet_dbt_nums))

```

##### Remove remaining doublets
```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.@meta.data %>% dplyr::count(scf_class_norm, scrub_doublet))

```
##### Check doublet clusters
```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% count(scf_class_norm_dbt_prop > 0.1))

```


```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% filter(!((scf_class_norm_dbt_prop > 0.1 & scf_class_rand_dbt_prop > 0.1) | scrub_doublet_dbt_prop > 0.1)) %>% rownames_to_column("bcode") %>% mutate(across(c(scf_class_norm_dbt_prop,scf_class_rand_dbt_prop, scrub_doublet_dbt_prop), ~round(., 2))) %>% count(seurat_clusters, scf_class_norm_dbt_prop,scf_class_rand_dbt_prop, scrub_doublet_dbt_prop))

```

```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% filter(scf_class_norm == "Singlet") %>% count(scf_class_norm_dbt_prop < 0.20 & scf_class_rand_dbt_prop < 0.20))

```

```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% filter(scf_class_norm == "Singlet" & scf_class_norm_dbt_prop < 0.20 & scf_class_rand_dbt_prop < 0.20) %>% count(scrub_doublet_dbt_prop < 0.40))

```

```{r}
##Seurat object
##Remove doublets

map(all_msc_w_dblts, ~.x@meta.data %>% filter(scf_class_norm == "Singlet" & scf_class_norm_dbt_prop < 0.20 & scf_class_rand_dbt_prop < 0.20) %>% count(scrub_doublet))

```

```{r}

map(all_msc_w_dblts, ~.x@meta.data %>% filter(scf_class_norm == "Singlet") %>% count(scf_class_norm_dbt_prop, scf_class_rand_dbt_prop) %>% filter(scf_class_norm_dbt_prop>0.2 ))

```

```{r, fig.width=18, fig.height=3}
##Seurat object
##Remove doublets

imap(all_msc_w_dblts["MSC50_SLO"], ~DimPlot(.x, group.by = c("scrub_doublet", "StagePrelim", "scrub_doublet_dbt_prop", "scf_class_norm_dbt_prop", "scf_class_rand_dbt_prop"), ncol = 5) + labs(title =.y))

```

```{r, fig.width=15, fig.height=4}
##Seurat object
##Remove doublets

imap(all_msc_w_dblts["MSC50_SLO"], ~DimPlot(.x, group.by = c("scrub_doublet", "StagePrelim", "scrub_doublet_dbt_prop", "scf_class_norm_dbt_prop"), reduction = "pca") + labs(title =.y))

```

```{r, message=FALSE}
# thogoo()
```

##### Remove remaining doublets

```{r}
##Seurat object
##Remove doublets

# all_msc_w_dblts <- all_msc_w_dblts %>%
#     # map(. %>% subset(., subset = scf_class_norm == "Singlet" & scf_class_norm_dbt_prop < 0.1 & scf_class_rand_dbt_prop < 0.1))
#     map(. %>% subset(., subset = scf_class_norm == "Singlet" & !((scf_class_norm_dbt_prop > 0.1 & scf_class_rand_dbt_prop > 0.1) | scrub_doublet_dbt_prop > 0.1)))
  # map(. %>% subset(., subset = scf_class_supx_rand == "Singlet" & scrub_doublet == 'Singlet'))

```

```{r}
##Seurat object
##Remove stage doublets

all_msc_filt_no_ScfStgDblts <- all_msc_w_dblts %>%
    # map(. %>% subset(., subset = scf_class_norm == "Singlet" & scf_class_norm_dbt_prop < 0.1 & scf_class_rand_dbt_prop < 0.1)) %>%
    map(. %>% subset(., subset = scf_class_norm == "Singlet")) %>%
    map(. %>% subset(., subset = scf_class_norm_dbt_prop < 0.20 & scf_class_rand_dbt_prop < 0.20)) #%>%
    # map(. %>% subset(., subset = scf_class_norm_dbt_prop < 0.1 | scf_class_rand_dbt_prop < 0.1))# %>% original losing male of MSC50_SLO
    #map(. %>% subset(., subset = scrub_doublet_dbt_prop < 0.13)) ## !!NOTE - was 0.1 but MSC50_SLO has all clusters > 0.12
  # map(. %>% subset(., subset = scf_class_supx_rand == "Singlet" & scrub_doublet == 'Singlet'))

## Table of removal of stage doublets by scdblfinder
scf_stg_dblt_rm <- map(all_msc_w_dblts, dim) %>% as.data.frame() %>% .[2,] %>% bind_rows(., map(all_msc_filt_no_ScfStgDblts, dim) %>% as.data.frame() %>% .[2,]) 
scf_stg_dblt_rm %>% t()
```


```{r}
imap(all_msc_filt_no_ScfStgDblts, possibly(~DimPlot(.x, cells.highlight = colnames(.x[,.x@meta.data$scf_class_rand == "Doublet"]), reduction = "pca") + labs(title = .y)))
```


```{r}
imap(all_msc_filt_no_ScfStgDblts, possibly(~DimPlot(.x, cells.highlight = colnames(.x[,.x@meta.data$scf_class_rand == "Doublet"]), reduction = "pca_soupx") + labs(title = .y)))
```

```{r}
map(all_msc_filt_no_ScfStgDblts, ~.x@meta.data %>% count(scf_class_rand))
```

```{r, fig.width=15, fig.height=4}
##Seurat object
##Remove doublets

imap(all_msc_filt_no_ScfStgDblts["MSC50_SLO"], ~DimPlot(.x, group.by = c("scrub_doublet", "StagePrelim", "scrub_doublet_dbt_prop")) + labs(title =.y))

```

```{r}
map(all_msc_filt_no_ScfStgDblts, ~.x@meta.data %>% count(scrub_doublet))
```

```{r}

map(all_msc_filt_no_ScfStgDblts, ~.x@meta.data %>% count(scrub_doublet_dbt_prop, scf_class_norm_dbt_prop, scf_class_rand_dbt_prop) %>% filter(scrub_doublet_dbt_prop>0.3 ))

```

```{r}
##Seurat object
##Remove doublets

all_msc_filt_no_StgDblts <- all_msc_filt_no_ScfStgDblts %>%
    map(. %>% subset(., subset = scrub_doublet == "Singlet")) %>%
    map(. %>% subset(., subset = scrub_doublet_dbt_prop < 0.3))  ## !!NOTE - was 0.1 but MSC50_SLO has high number of doublets - maybe SLO lysed many gams and soup content high

## Table of removal of stage doublets by scdblfinder
scrblt_stg_dblt_rm <- map(all_msc_filt_no_ScfStgDblts, dim) %>% as.data.frame() %>% .[2,] %>% bind_rows(., map(all_msc_filt_no_StgDblts, dim) %>% as.data.frame() %>% .[2,])
scrblt_stg_dblt_rm %>% t()
```


```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4, eval=FALSE}

map(all_msc_w_dblts, ~{
  
  .x@meta.data %>% 
    distinct(seurat_clusters, .keep_all = T) %>% 
    select(contains("_dbt_prop"), contains("_dbt_nums"), seurat_clusters) %>%
    pivot_longer(cols = -c('strain_gt_dbt_prop', 'strain_gt_dbt_nums', seurat_clusters), names_pattern = "(.*)_(dbt.*)", names_to = c( "dbm", ".value")) %>% 
    ggplot(aes(y = strain_gt_dbt_prop,x = dbt_prop )) + geom_point() +facet_wrap(.~dbm) + 
    geom_text_repel(aes(label = paste0(seurat_clusters, "(",dbt_nums,")"))) + 
    geom_hline(yintercept = 0.3) + 
    geom_vline(xintercept = 0.5)
  
})

```

#### Remove unassigned cells and schizonts
!! NOTE - Are unassigned cells entire cluster of cells ?
```{r}
imap(all_msc_filt_no_StgDblts, possibly(~DimPlot(.x, cells.highlight = colnames(.x[,.x@meta.data$StagePrelim == "Unassigned"])) + labs(title = .y)))
```

!! NOTE - Are unassigned cells commited asexuals? Check Ap2-g (PF3D7_1222600), surfin 1.2 (PF3D7_0113600), and surfin 13.1 (PF3D7_1301800)

```{r}
imap(all_msc_filt_no_StgDblts, ~DotPlot(., features = c("PF3D7-1222600", "PF3D7-0113600", "PF3D7-1301800"), group.by = "StagePrelim") + labs(title = .y))
```

```{r}
## MSC39 with 44 unassigned has issues
map(all_msc_filt_no_StgDblts, ~.x@meta.data %>% filter(StagePrelim == "Unassigned") %>% select(StagePrelim, contains("_lab")))
```

!!! NOTE - RESCUING SOME UNASSIGNED CELLS - NOW INCLUDING MSC12 AND ALSO SEE IF COMMITED RINGS EXIST

```{r}
map(all_msc_filt_no_StgDblts, ~.x@meta.data %>% filter(StagePrelim == "Unassigned") %>% select(StagePrelim, contains("_lab")))
```


```{r}
# map(all_msc_filt_no_StgDblts, ~.x@meta.data %>% filter(StagePrelim == "Unassigned") %>% select(StagePrelim, contains("_lab")))

all_msc_filt_no_StgDblts_msc12C <- pmap(
  list(all_msc_filt_no_StgDblts["MSC12"], 
       rep(0.4,length(all_msc_filt_no_StgDblts["MSC12"])), 
       c(rep('ring|trophozoite|developing|schizont', length(all_msc_filt_no_StgDblts["MSC12"]))), 
       c(rep('female|developing|Female|ring|trophozoite|schizont', length(all_msc_filt_no_StgDblts["MSC12"]))), 
       c(rep('male|developing|Male|ring|trophozoite|schizont', length(all_msc_filt_no_StgDblts["MSC12"])))), ~{
         ..1@meta.data %>%
           mutate(across(StagePrelim, as.character)) %>%
           mutate(StagePrelim_rescue = case_when(
             StagePrelim == "Unassigned" & (sim_lab1 > 0.4 | sim_lab2 > 0.4  | sim_lab3 > 0.4) & str_detect(stage_lab1, ..3) & str_detect(stage_lab2, ..3) & str_detect(stage_lab3, ..3) ~ stage_lab1, ## lower cos sim of 0.35 for asexuals instead of 0.4
             StagePrelim == "Unassigned" & (sim_lab1 > 0.4 | sim_lab2 > 0.4  | sim_lab3 > 0.4) & str_detect(stage_lab1, ..4) & str_detect(stage_lab2, ..4) & str_detect(stage_lab3, ..4) ~ "Female developing",
             StagePrelim == "Unassigned" & (sim_lab1 > 0.4 | sim_lab2 > 0.4  | sim_lab3 > 0.4) & str_detect(stage_lab1, ..5) & str_detect(stage_lab2, ..5) & str_detect(stage_lab3, ..5) ~ "Male developing",
             TRUE ~ StagePrelim)) %>%
           mutate(StagePrelim_HMO = case_when(
             StagePrelim_rescue == "Female developing" | StagePrelim_rescue == "Male developing" ~ "Gametocyte (developing)",
             TRUE ~ StagePrelim_rescue),
             StagePrelim = str_to_sentence(StagePrelim_HMO),
             StagePrelimC = case_when(
               str_detect(StagePrelim, "ring|trophozoite|developing|schizont") ~ "Asexual",
               TRUE ~ StagePrelim)) %>%
           dplyr::select(StagePrelim, StagePrelim_rescue, StagePrelimC) %>%
           AddMetaData(..1, .)
       })

```


```{r}
map(all_msc_filt_no_StgDblts_msc12C, ~.x@meta.data %>% count(StagePrelim,StagePrelim_rescue, stage_lab1))
```

```{r}
map(all_msc_filt_no_StgDblts_msc12C, ~.x@meta.data %>% filter(StagePrelim_rescue == "Unassigned") %>% select(StagePrelim_rescue, StagePrelim, contains("_lab")))
```


```{r}
all_msc_filt_no_StgDblts["MSC12"] <- all_msc_filt_no_StgDblts_msc12C
```


```{r}
map(all_msc_filt_no_StgDblts, ~.x@meta.data %>% filter(StagePrelim == "Unassigned") %>% select(StagePrelim, contains("_lab")))
```

```{r}
imap(all_msc_filt_no_StgDblts, possibly(~DimPlot(.x, cells.highlight = colnames(.x[,.x@meta.data$StagePrelim == "Unassigned"])) + labs(title = .y)))
```


```{r}
map(all_msc_filt_no_StgDblts, ~.x@meta.data %>% filter(str_detect(StagePrelim, "schizont")) %>% select(contains("_lab")))
```

Remove unassigned 
Retain schizonts since theres MSC12 culture - these can be removed in future from the other datasets if troublesome
```{r}
##Remove schizonts and unassigned
all_msc_qcd_snglt_stgd <- all_msc_filt_no_StgDblts %>%
  map(. %>% subset(., subset = StagePrelim == "Unassigned" , invert = TRUE))
  # map(. %>% subset(., subset = str_detect(StagePrelim, "schizont") | StagePrelim == "Unassigned" , invert = TRUE))

## Table of removal of schizonts and unassigned
unstgd_rm <- map(all_msc_filt_no_StgDblts, dim) %>% as.data.frame() %>% .[2,] %>% bind_rows(., map(all_msc_qcd_snglt_stgd, dim) %>% as.data.frame() %>% .[2,])# %>% t()
unstgd_rm

# unstgd_schznt_rm <- map(all_msc_filt_no_StgDblts, dim) %>% as.data.frame() %>% .[2,] %>% bind_rows(., map(all_msc_qcd_snglt_stgd, dim) %>% as.data.frame() %>% .[2,])# %>% t()
# unstgd_schznt_rm
```

Table of removed cells in this notebook
```{r}
## Track cell removal
list(scf_stg_dblt_rm, scrblt_stg_dblt_rm, unstgd_rm) %>% set_names("scDblFinder", "Scrublet", "Unassigned") %>% bind_rows(., .id = 'set')
# list(scf_stg_dblt_rm, scrblt_stg_dblt_rm, unstgd_schznt_rm) %>% set_names("scDblFinder", "Scrublet", "Unassigned_Schizont") %>% bind_rows(., .id = 'set')

```

## Visualization of QCd cells -End of QC

### Start of re-normalizing and re-clustering QCd cells for annotation with scmap


```{r}
## Change the default assay

for (i in names(all_msc_qcd_snglt_stgd)) {
  DefaultAssay(all_msc_qcd_snglt_stgd[[i]]) <- "RNA"
}

```
FARM CODE
```{r, eval=T}
##write out for normalization processing in farm

for (i in 1:length(sample_name_nms)) {
# for (i in 32:33) {
  
  ##Transfers
  ##souporcell genotyping files
  saveRDS(all_msc_qcd_snglt_stgd[[sample_name_nms[i]]],
    paste0('data/processed/Pf/', sample_name_nms[i], '/seu_obj/msc_qcd_snglt_stgd.RDS')
    )
  
}


```

```{r, eval=T}
gogo()
## Remove the output files before rerunning since some object it might fail and old object persists
# map(names(all_msc_qcd_snglt_stgd), ~system(paste0('rm data/processed/Pf/', .x,'/seu_obj/msc_stg_qcd.RDS')))

## Run SNORM on farm like below

# nextflow run ../mali22_code_lnk/nf_scripts/submsn_seu_norm.nf --scrpt "/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_stdnorm.R" --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/seu_obj/msc_qcd_snglt_stgd.RDS" --normlzn "norm" --umap_name "UMAP_" --hvg 500 --cluster_resoln 0.1 --cl_nm "seurat_clusters_nm" --umap_redctn_nm "umap" --redctn "pca" --integrtd_pc30 "no" --findpc_mthd "perpendicular line" --ncores "2" --mem "50 GB"  


```



Read in seurat objects processed in farm
```{r, message=F, warning=F, eval=T}
##Read BPcells matrices
all_msc_stg_qcd <- list.files("data/processed/Pf", pattern = "msc_qcd_snglt_stgd_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj.*'))) %>% 
  .[sample_name_nms] %>%
  map(readRDS)
```


```{r, fig.height = 5, fig.width = 15}

imap(all_msc_stg_qcd, ~fp_fn(obj = .x, rdctn = "umap") %>% 
       plot_grid(ggdraw() + draw_label(.y), . ,ncol = 1, rel_heights = c(0.1, 1)))
```


```{r, fig.height = 5, fig.width = 15}

imap(all_msc_stg_qcd, ~fp_fn(obj = .x, rdctn = "pca_soupx") %>% 
       plot_grid(ggdraw() + draw_label(.y), . ,ncol = 1, rel_heights = c(0.1, 1)))
```


```{r}
saveRDS(all_msc_stg_qcd, 'data/processed/Pf/m2_all/all_msc_stg_qcd.RDS')
```


```{r}
# Old filtered qcd object
# gogo()
all_msc_qcd_snglt_stgd2 <- readRDS("data/processed/Pf/m2_all/all_msc_qcd_snglt_stgd.RDS")

```

```{r}
# Old filtered qcd object to compare with current one - numbers misteriously not the same
# gogo()
a=map(all_msc_stg_qcd, dim)
b=map(all_msc_qcd_snglt_stgd2, dim)
a %>% map(., ~.x[2]) %>% as.data.frame() %>% bind_rows(.,(b %>% map(., ~.x[2]) %>% as.data.frame()))
```

```{r}
# prev_rm_cells <- map2(all_msc_stg_qcd, all_msc_qcd_snglt_stgd2, ~subset(.x, cells = colnames(.y), invert = T))
```

```{r}
# map2(all_msc_stg_qcd, prev_rm_cells, ~DimPlot(.x, cells.highlight = colnames(.y)))

```

#### Visualize reclustered QCd cells

```{r, results='asis', message=FALSE, warning=FALSE}
imap(all_msc_stg_qcd, ~VlnPlot(., features = c("nCount_RNA", "nFeature_RNA"), group.by = c("seurat_clusters"), idents = NULL, pt.size = 0.01) + labs(title = .y))
```

```{r, results='asis', message=FALSE, warning=FALSE}
imap(all_msc_stg_qcd, ~VlnPlot(., features = c("nCount_RNA", "nFeature_RNA"), group.by = c("StagePrelimC"), idents = NULL, pt.size = 0.01) + labs(title = .y))
```
```{r, results='asis', message=FALSE, warning=FALSE}
imap(all_msc_stg_qcd, ~DimPlot(., reduction = "umap", label = T, pt.size = 0.5, group.by = "StagePrelim") + labs(title = .y) + scale_color_manual(values = sp_fld_colors))
```

```{r, results='asis', message=FALSE, warning=FALSE}
imap(all_msc_stg_qcd, ~DimPlot(., reduction = "umap", label = T, pt.size = 0.5, group.by = "StagePrelim", dims = c(1,3)) + labs(title = .y) + scale_color_manual(values = sp_fld_colors))
```

```{r, results='asis', message=FALSE, warning=FALSE}
list(all_msc_stg_qcd, sample_name_nms)  %>% 
  purrr::pmap(.,~{
    DimPlot(., reduction = "umap", label = T, pt.size = 0.5)

    # VlnPlot(., features = c("nCount_RNA", "nFeature_RNA"), group.by = "StagePrelimC",idents = NULL, pt.size = 0.01)

  })

```


```{r,  fig.width = 6, fig.height = 4, results='asis'}

cln_umap_stg <- list(all_msc_stg_qcd, sample_name_nms)  %>%
  purrr::pmap(.,  ~ {

    
    p = DimPlot(., reduction = "umap", , pt.size = 1,  label = F, repel = T, label.size = 9, group.by = "StagePrelimC") +
  scale_color_manual(name= 'Stage', values = sp_fld_colors) +
      theme_void()+
      theme(#axis.text=element_text(size=18), 
            #axis.title=element_text(size=18,face="bold"), 
            axis.text=element_blank(), 
            axis.title=element_blank(),
            # title = element_text(size=18,face="bold"),
            title = element_blank()#,
            # aspect.ratio = 1/1,
            ) + 
      # guides(colour = guide_legend(nrow = 7, override.aes = list(size = 5))) ++
    guides(color = F, x= trunc_axis, y= trunc_axis)+
  theme(axis.line = element_line(arrow = arrow(angle = 20, length = unit(0.15, "inches"), ends = "last", type = "closed"), color = 'black'),
        axis.title.x = element_text(hjust = 0, size=14, face = 'bold'),
        axis.title.y = element_text(angle = 90, hjust = 0, size=14, face = 'bold', margin = margin(r = 3)))+
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL)
    
    print(p)
    return(p)

  })

```


### Violin plot gene expression levels
```{r, fig.height=4.5, fig.width=6}
cln_vln_stg <- map(all_msc_stg_qcd,~.x %>%
  VlnPlot(., features = c("nFeature_RNA"), group.by = 'StagePrelimC', pt.size = .001) +
  scale_fill_manual(name= 'Stage', values = sp_fld_colors)+
  scale_y_continuous(label=function(y) y / 1000) +
  theme(axis.text.x = element_blank(),
        axis.text=element_text(size=20),
        axis.title=element_text(size=20,face="bold"),
        axis.title.y=element_text(hjust = 0.5),
        # legend.text = element_text(size=20),
        # legend.title = element_text(size=20, face = 'bold'),
        legend.position = 'none',
        # title = element_text(size=20,face="bold"),
        plot.title = element_blank()
  ) +
  labs(x='Cluster', y = "Genes expressed\n(X 10e3)", title = 'Genes per cell')
)

cln_vln_stg
```

```{r,  fig.width = 6, fig.height = 4, results='asis'}

cln_umap <- list(all_msc_stg_qcd, sample_name_nms)  %>%
  purrr::pmap(.,  ~ {

    
    p = DimPlot(., reduction = "umap", , pt.size = .3,  label = T, repel = T, label.size = 4 ) +
  scale_color_manual(name= 'Cluster', values = cluster_cols) +
      theme_void()+
      theme(#axis.text=element_text(size=18), 
            #axis.title=element_text(size=18,face="bold"), 
            axis.text=element_blank(), 
            axis.title=element_blank(),
            # title = element_text(size=18,face="bold"),
            title = element_blank()#,
            # aspect.ratio = 1/1,
            ) + 
      # guides(colour = guide_legend(nrow = 7, override.aes = list(size = 5))) ++
    guides(color = F, x= trunc_axis, y= trunc_axis)+
  theme(axis.line = element_line(arrow = arrow(angle = 20, length = unit(0.15, "inches"), ends = "last", type = "closed"), color = 'black'),
        axis.title.x = element_text(hjust = 0, size=14, face = 'bold'),
        axis.title.y = element_text(angle = 90, hjust = 0, size=14, face = 'bold', margin = margin(r = 3)))+
  scale_x_continuous(breaks = NULL) +
  scale_y_continuous(breaks = NULL)
    
    print(p)
    return(p)

  })

```


### Violin plot gene expression levels
```{r, fig.height=4.5, fig.width=6}
cln_vln <- map(all_msc_stg_qcd,~.x %>%
  VlnPlot(., features = c("nFeature_RNA"), group.by = 'old_seu_cluster', pt.size = .001) +
  scale_fill_manual(name= 'Cluster', values = cluster_cols)+
  scale_y_continuous(label=function(y) y / 1000) +
  theme(axis.text.x = element_text(angle = 0),
        axis.text=element_text(size=20),
        axis.title=element_text(size=20,face="bold"),
        axis.title.y=element_text(hjust = 0.5),
        legend.text = element_text(size=20),
        legend.title = element_text(size=20, face = 'bold'),
        # title = element_text(size=20,face="bold"),
        plot.title = element_blank()
  ) +
  labs(x='Cluster', y = "Genes expressed\n(X 10e3)", title = 'Genes per cell')
)

cln_vln
```

#### Grouping by strain_gt QCd cells
```{r, results='asis'}

# list(all_msc_stg_qcd[2:5], sample_name_nms[2:5])  %>% 
all_msc_stg_qcd  %>% 
  purrr::imap(.,~{
    
    DimPlot(.x, reduction = "umap", label = T, split.by = 'strain_gt', pt.size = 1)

    
    VlnPlot(.x, features = c("nCount_RNA", "nFeature_RNA"), group.by = 'strain_gt')
    
    FeaturePlot(.x, reduction = "umap", label = T, split.by = 'strain_gt', features ='nCount_RNA', pt.size = 1)
    
  })

```

#### Featureplot reclustered QCd cells
```{r, results='asis'}

map(all_msc_stg_qcd, ~FeaturePlot(., reduction = "umap", features ='percent.mt', pt.size = .2))

```


```{r, results='asis'}

all_msc_stg_qcdmdata <- map(all_msc_stg_qcd, ~..1@meta.data) 

```


```{r, results='asis'}

map(all_msc_stg_qcdmdata, ~.x %>% filter(!(Strain_DN %in% c("Doublet", "Negative"))) %>% count(Strain_DN)) 

```


```{r, results='asis'}

map(all_msc_stg_qcdmdata, ~.x %>% filter(!(Strain_DN %in% c("Doublet", "Negative"))) %>% count(Strain_DN)) 

```


```{r, results='asis'}

map(all_msc_stg_qcdmdata, ~.x %>% filter(!(Strain_DN %in% c("Doublet", "Negative"))) %>% count(StagePrelimC)) 

```




```{r, fig.width = 18, fig.height = 4, message=FALSE, warning=FALSE}
c_stg_shapes = c('Asexual' = 16 , 'Male' = 3,  'Female' = 6)
c_stg_cols= c('Asexual' = "#D7B7C7", 'Male' = "#C4CAA4", 'Female'="#6289A9", 'Developing' = "#C9F6E1", 'Field unlabelled'="lightgrey")


ss_bar_plt <-list(all_msc_stg_qcdmdata, names(all_msc_stg_qcdmdata))  %>% 
  purrr::pmap(.,~{
  a_tbl <- ..1 %>%
    mutate(stage_afm = case_when(str_detect(StagePrelimC, 'ring|troph') ~ 'Asexual', 
                                     str_detect(StagePrelimC, '\\(male') ~ 'Male', 
                                     str_detect(StagePrelimC, 'Female') ~ 'Female',
                                     T ~StagePrelimC),
            stage_ag = case_when(str_detect(StagePrelimC, 'ring|troph') ~ 'Asexual', 
                                    str_detect(StagePrelimC, 'ale') ~ 'Gametocyte',
                                     T ~StagePrelimC)) %>%
      mutate(across(stage_afm, ~factor(., levels=c('Asexual', 'Female', 'Male', 'Field unlabelled')))) %>%
      dplyr::count(Strain_DN, stage_afm) 
  
  str(a_tbl)
  
  ##get stage_ag labels and counts to add to the Strain_DN+stage_afm counts generated above
  stage_ag_cnt <- ..1 %>%
    mutate(stage_afm = case_when(str_detect(StagePrelimC, 'ring|troph') ~ 'Asexual', 
                                     str_detect(StagePrelimC, '\\(male') ~ 'Male', 
                                     str_detect(StagePrelimC, 'Female') ~ 'Female',
                                     T ~StagePrelimC),
            stage_ag = case_when(str_detect(StagePrelimC, 'ring|troph') ~ 'Asexual', 
                                    str_detect(StagePrelimC, 'ale') ~ 'Gametocyte',
                                     T ~StagePrelimC)) %>% 
    dplyr::select(Strain_DN, stage_ag, stage_afm) %>% 
    add_count(Strain_DN, stage_ag, name = 'stage_ag_n') %>% 
    distinct(pick(Strain_DN, stage_afm), .keep_all = T) %>% 
    left_join(a_tbl, ., by =c('Strain_DN', 'stage_afm')) %>% 
    rename(c('Stage'= stage_afm, 'Counts' =n, 'Strain' = Strain_DN))  
  
  str(stage_ag_cnt)
  
    b_plt <- stage_ag_cnt %>%
      # ggplot(., aes(x = Stage, y = Counts, fill = Stage, color=stage_ag_n<30)) +
      ggplot(., aes(x = Stage, y = Counts, fill = Stage)) +
      geom_col(position = position_dodge2()) + #width=0.4, position = position_dodge(width=0.5)
      geom_text(aes(label=Counts), hjust=0.5, vjust= -0.3, position = position_dodge(width = .9), size = 7, show.legend = F, fontface ='bold', colour='black')+
      scale_fill_manual(values = c_stg_cols) + #'Asexual' = "#FFE5B4", 'Male' = "#BFD7B5", 'Female'="#8ab6d6"
      # scale_color_manual(values = c('FALSE' = "white", 'TRUE' = "blue")) +
  geom_tile(aes(x = Stage, y = -10, fill = Stage, height = 14)) +
  facet_wrap( Strain ~ ., nrow = 1) +
      scale_y_continuous(expand = expansion(mult = c(0.01, 0.15))) +
      scale_x_discrete(expand = expansion(add = c(1, 1))) +
      theme_classic() +
  labs( y = 'Counts', title = ..2)+
      theme(
        axis.text.y  = element_text(size = 22),
        axis.title.y  = element_text(size = 22, face = "bold"),
        axis.title.x = element_blank(),
        # axis.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 22),
        legend.title = element_text(size = 22, face = "bold"),
        legend.position="bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text =element_text(size=20,face="bold", colour = 'black'),
        panel.border=element_rect(colour="black",fill='transparent')
      )+
      guides(color = F)
    print(b_plt)
    return(b_plt)
})


```


```{r, fig.width = 18, fig.height = 4, message=FALSE, warning=FALSE, eval=F}


ss_bar_plt <-list( strn_c_mdata)  %>% 
  purrr::pmap(.,~{
  a_tbl <- ..1 %>%
      mutate(across(stage_afm, ~factor(., levels=c('Asexual', 'Female', 'Male', 'Developing', 'Unassigned')))) %>%
      dplyr::count(Strain_DN, stage_afm, .drop = FALSE) 
  
  ##get stage_ag labels and counts to add to the Strain_DN+stage_afm counts generated above
  stage_ag_cnt <- ..1 %>% 
    dplyr::select(Strain_DN, stage_ag, stage_afm) %>% 
    add_count(Strain_DN, stage_ag, name = 'stage_ag_n') %>% 
    distinct(pick(Strain_DN, stage_afm), .keep_all = T) %>% 
    left_join(a_tbl, ., by =c('Strain_DN', 'stage_afm')) %>% 
    rename(c('Stage'= stage_afm, 'Counts' =n, 'Strain' = Strain_DN))  
  
  print(stage_ag_cnt)
  
    b_plt <- stage_ag_cnt %>%
      # ggplot(., aes(x = Stage, y = Counts, fill = Stage, color=stage_ag_n<30)) +
      ggplot(., aes(x = Stage, y = Counts, fill = Stage)) +
      geom_col(position = position_dodge2()) + #width=0.4, position = position_dodge(width=0.5) 
      geom_text(aes(label=Counts), hjust=0.5, vjust= -0.3, position = position_dodge(width = .9), size = 7, show.legend = F, fontface ='bold', colour='black')+
      scale_fill_manual(values = c_stg_cols) + #'Asexual' = "#FFE5B4", 'Male' = "#BFD7B5", 'Female'="#8ab6d6"
      # scale_color_manual(values = c('FALSE' = "white", 'TRUE' = "blue")) +
  geom_tile(aes(x = Stage, y = -10, fill = Stage, height = 14)) +
  facet_wrap( Strain ~ ., nrow = 1) +
      scale_y_continuous(expand = expansion(mult = c(0.01, 0.15))) +
      scale_x_discrete(expand = expansion(add = c(1, 1))) +
      theme_classic() +
  labs( y = 'Counts')+
      theme(
        axis.text.y  = element_text(size = 22),
        axis.title.y  = element_text(size = 22, face = "bold"),
        axis.title.x = element_blank(),
        # axis.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 22),
        legend.title = element_text(size = 22, face = "bold"),
        legend.position="bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text =element_text(size=20,face="bold", colour = 'black'),
        panel.border=element_rect(colour="black",fill='transparent')
      )+ 
      guides(color = F)
    print(b_plt)
    return(b_plt)
})


```

write the Qcd barcodes for souporcell
```{r, results='asis', eval=T}

imap(all_msc_stg_qcd, ~{
  system(paste0('mkdir data/processed/Pf/',.y,'/soupc_GE_postQC/'))
  write(colnames(.x), paste0('data/processed/Pf/',.y,'/soupc_GE_postQC/barcodes.tsv'))
  system(paste0('gzip -f data/processed/Pf/',.y,'/soupc_GE_postQC/barcodes.tsv'))
  
})

```



Packages and environment information
```{r}
gogo()
# nextflow run soupc_v25_m2.nf --id_decode "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/pf_solo_mixed_mdata_decode.csv" --bam "/lustre/scratch126/tol/teams/lawniczak/projects/malaria_single_cell/mali_field_runs/2022/data/cellranger_runs/Pf/5736STDY*/outs/possorted_genome_bam.bam" --bcodes "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/MSC*/soupc_GE_postQC/barcodes.tsv.gz" --o_dir "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/" --soup_dir "soupc_GE_postQC" --scrpt "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/soupc_v25_mnmap_hsat_310.sh" --ref_file "PlasmoDB-66_Pfalciparum3D7_Genome.fasta" --hsat_ref_file "Pf66" -resume
```


Packages and environment information
```{r}
sessionInfo()
```