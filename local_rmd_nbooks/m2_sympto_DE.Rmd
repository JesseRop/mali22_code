---
title: "Integration of donor only and with lab"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(dreamlet)
  library(muscat)
  library(ExperimentHub)
  library(zenith)
  library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  library(tradeSeq)
  library(BiocParallel)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  
})
```


#  integration of all MSC

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/plotting_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code/pf_common_vars.R")
```

```{r setup}
sample_set = "Mali2"

optimum_k_qcd <- c("MSC33" =8, "MSC48" =4, "MSC49" =6, "MSC55" =7, "MSC60" =7, "MSC66" =8, "MSC38" =4, "MSC40" =8, "MSC50_MACS" =1, "MSC53" =1, "MSC57" =1, "MSC24" =1, "MSC37" =5, "MSC39" =4, "MSC45" =1, "MSC50_SLO" =1, "MSC54" =1, "MSC67" =1, "MSC68" =3, "MSC70" =1)

optimum_k_qcd <- optimum_k_qcd[sort(names(optimum_k_qcd))]

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```


read in files 
clean objects all donors
```{r}
msc_w_cln_strns <- readRDS("data/processed/Pf/m2_all/msc_w_cln_strns.RDS")
```

```{r, eval=T}
imap(msc_w_cln_strns, ~DimPlot(.x, group.by = "StrainDon")  + labs(title = .y))
```

```{r, eval=T}
imap(msc_w_cln_strns, ~DimPlot(.x, group.by = "stage")  + labs(title = .y) + scale_color_manual(values = sp_fld_colors))
```

!!!NOTE - Reading in the metadata to add to the mixed species samples which were missed in the initial step - Will need to redo adding to the source
```{r}
mrc_sk21_summary <- read_csv("data/raw/MRC_Sample_Analysis_Summary_Summary.csv", skip = 1) 

mrc_sk21_summary_mxd <- mrc_sk21_summary %>% filter(Sample_Name %in% c("MSC25" ,"MSC41", "MSC51")) %>% mutate(across(Symptomatic, ~str_replace_all(., c("Y" = "Yes", "N" = "No")))) %>% select(Sample_Name,Symptomatic, Hb_Type) %>% rename("donor" = Sample_Name)
```

Remove mixed infections for now
```{r}
# msc_w_cln_strns <- msc_w_cln_strns %>% .[!(names(msc_w_cln_strns) %in% c("MSC25" ,"MSC41", "MSC51"))]
# msc_w_cln_strns <- msc_w_cln_strns %>% .[!(names(msc_w_cln_strns) %in% c("MSC25" , "MSC51"))] ## Retain MSC41 since it is mostly Pf with few Po
msc_w_cln_strns <- msc_w_cln_strns  ## Retain all to assess how they look
```


Strain info
```{r}
strn_c_new_mdata_m22_min_qcd <- readRDS("data/processed/Pf/strn_c_new_mdata_m22_min_qcd.RDS")
```


Integrated asexual
```{r}
## subset where field parasites are for slingshot
v3_m2_asex_harmony_ss_res_fld_pt <- readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony_ss_res_fld_pt.RDS")
```

```{r}
## add metadata for the mixed infections donors
v3_m2_asex_harmony_ss_res_fld_pt_mxdSp <- v3_m2_asex_harmony_ss_res_fld_pt@meta.data %>% 
  rownames_to_column("bcode") %>% 
  left_join(., mrc_sk21_summary_mxd, by = "donor") %>%
  mutate(Symptomatic = coalesce(Symptomatic.x, Symptomatic.y), Hb_Type = coalesce(Hb_Type.x, Hb_Type.y)) %>% 
  select(bcode, Symptomatic, Hb_Type) %>% 
  column_to_rownames("bcode") %>% 
  AddMetaData(v3_m2_asex_harmony_ss_res_fld_pt, .)
```

Remove mixed infections for now
```{r}
# v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_mxdSp[,!(v3_m2_asex_harmony_ss_res_fld_pt_mxdSp$donor %in% c("MSC25" ,"MSC41", "MSC51"))]
# v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_mxdSp[,!(v3_m2_asex_harmony_ss_res_fld_pt_mxdSp$donor %in% c("MSC25", "MSC51"))] ## Retain MSC41 since it is mostly Pf with few Po
v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_mxdSp ## Retain all to assess how they look
```


Remove 1 early ring
```{r}
v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,!(v3_m2_asex_harmony_ss_res_fld_pt_pf$StageFL == "Early ring")]
```

```{r}
v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data %>% 
  mutate(across(Symptomatic, ~case_when(donor == "MSC14" ~ "No", T ~ .)),
         across(Hb_Type, ~case_when(donor == "MSC14" ~ "HbC", T ~ .))) %>% 
  mutate(across(Symptomatic, ~str_replace_all(.,  c("Yes" = "Symptomatic", "No" = "NonSymptomatic")))) %>%
  select(Symptomatic, Hb_Type) %>% 
  AddMetaData(v3_m2_asex_harmony_ss_res_fld_pt_pf, .)
```

Check which stage label to use
```{r}
v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data %>% count(stage, StageFL, StageFL, StageFL_ND)
```

#### Add metadata age, temperature, parasitaemia etc

```{r, fig.width=15, fig.height=5}
donor_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest_METADATA.csv", col_types =  paste0(c(rep("c", 7), "d", "c","d","d", rep("c", 14)), collapse = ""), show_col_types = T)  
donor_mdata <- donor_mdata %>% rename_all(., ~str_to_lower(str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "ยบ"=""))))
```


```{r, fig.width=15, fig.height=5}
## Antoine metadata with age
# adara_donor_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/Antoine_MRC_Sample_Manifest_Metadata.csv", col_types =  paste0(c(rep("c", 7), "d", "c","d","d", rep("c", 14)), collapse = ""), show_col_types = T) 
# adara_donor_mdata <- adara_donor_mdata %>% rename_all(., ~str_to_lower(str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "ยบ"="")))) %>% filter(if_any(everything(), ~!is.na(.)))

```


```{r, fig.width=15, fig.height=5}

donor_mdata %>%
  filter(!is.na(short_name) & str_detect(short_name, "MSC"))%>%
  filter(short_name %in% names(msc_w_cln_strns)) %>% 
  select(short_name,  time_of_sampling, time_of_sample_processing)

```



```{r, fig.width=15, fig.height=5}
library(lubridate)
donor_mdata_cln <- donor_mdata %>%
  filter(!is.na(short_name) & str_detect(short_name, "MSC")) %>% 
  mutate(across(c(parasitaemia_j0, parasitaemia_j1), ~as.numeric(str_remove(., " Pf.*|Tf.*"))), 
         parasitaemia = coalesce(parasitaemia_j0, parasitaemia_j1),
         sampling_time_cln = hms(paste0(str_remove(time_of_sampling, c(" AM| PM")), ":00")),
         processing_time_cln = str_replace_all(time_of_sample_processing, c("15:30 PM" = "3:30 PM") ),
         across(processing_time_cln, ~hms(strftime(strptime(., format="%I:%M %p"), format="%H:%M:%S")))) %>%
  mutate(smpl_wait_time = as.numeric(as.duration(processing_time_cln - sampling_time_cln),"minutes")) %>%
  mutate(fever = case_when(temperature_c >= 37.5 ~ "Fever", temperature_c < 37.5 ~ "NoFever")) #%>%
  # select(short_name, parasitaemia, time_of_sampling, sampling_time_cln, time_of_sample_processing, processing_time_cln, smpl_wait_time)


## Add age from antoine metadata
donor_mdata_slct <- donor_mdata_cln %>% 
  select(short_name, parasitaemia, smpl_wait_time, gender_m_f, weight_kg, symptomatic, temperature_c, fever, age_years) #%>% 
  #left_join(., adara_donor_mdata %>% select(short_name, age_years), by = "short_name")
```


```{r, fig.width=15, fig.height=5}
donor_mdata_cln %>%
  select(time_of_sampling, sampling_time_cln, processing_time_cln)
```

```{r}
donor_mdata_slct   %>% 
  # mutate(across(c(parasitaemia_j0, parasitaemia_j1), ~as.numeric(str_remove(., " Pf.*|Tf.*"))), parasitaemia = coalesce(parasitaemia_j0, parasitaemia_j1))  %>% 
  # filter(donor %in% ) %>%
  ggplot(aes(x = symptomatic, y = parasitaemia)) +
  geom_boxplot()
```

```{r, fig.width=6, fig.height=5}
donor_mdata_slct  %>% select(age_years, symptomatic) %>%  ggplot(aes(x = symptomatic, y = age_years)) + geom_boxplot()
```


```{r, fig.width=6, fig.height=5}
donor_mdata_slct  %>% filter(short_name %in% names(msc_w_cln_strns)) %>% select(age_years, symptomatic) %>%  ggplot(aes(x = symptomatic, y = age_years)) + geom_boxplot()
```


```{r, fig.width=6, fig.height=5}
donor_mdata_slct  %>% filter(short_name %in% names(msc_w_cln_strns)) %>% ggplot(aes(x = symptomatic, y = smpl_wait_time)) + geom_boxplot() + geom_point()
```

```{r}
donor_mdata_slct %>%  
  ggplot(., aes(x = symptomatic, y = temperature_c)) +
  geom_boxplot() +
  geom_point()
```

```{r}
donor_mdata_slct %>%  
  filter(short_name %in% names(msc_w_cln_strns)) %>% 
  ggplot(., aes(x = symptomatic, y = temperature_c)) +
  geom_boxplot() +
  geom_point()
```


```{r}
donor_mdata_slct %>%  
  filter(short_name %in% names(msc_w_cln_strns) & temperature_c >= 37.5) 
```

add metadata
```{r, fig.width=15, fig.height=5}
v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data  %>%
  rownames_to_column("bcode") %>% 
  mutate(donor_nm = str_remove_all(donor, "_SLO|_MACS")) %>%
  select(bcode, donor_nm) %>%
  left_join(., donor_mdata_slct, by=c("donor_nm"="short_name"), relationship = "many-to-one") %>%
  select(bcode, parasitaemia, smpl_wait_time, age_years, gender_m_f, weight_kg, temperature_c, fever) %>% 
  column_to_rownames("bcode") %>% 
  AddMetaData(v3_m2_asex_harmony_ss_res_fld_pt_pf, .)
```

Subset only the field parasites

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
m2_asex_harmony_tr <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$dset == "Field"]
```

Count asexuals per donor
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
m2_asex_harmony_tr@meta.data %>% count(donor, StageFL) %>% group_by(donor) %>% mutate(prop = round(n/sum(n), digits = 2))
```

Check the temp distribution between symptomatic vs asymptomatic
```{r}
m2_asex_harmony_tr@meta.data %>%  
  ggplot(., aes(x = Symptomatic, y = temperature_c)) +
  geom_boxplot() +
  geom_point()
```
Check the donor and strains for >37.5 fever
```{r}
m2_asex_harmony_tr@meta.data %>%  
  filter(temperature_c >= 37.5) %>%
  # count(donor, StrainDon, temperature_c, Symptomatic, StageFL)%>%
  count(donor, temperature_c, Symptomatic, StageFL)
```


Check the pseudotime distribution between symptomatic vs asymptomatic


```{r, fig.width=16, fig.height=4}
sympt_fev_tbl <- m2_asex_harmony_tr@meta.data %>% 
  mutate(fev_sympt = case_when(fever == "Fever" & Symptomatic == "Symptomatic" ~ "Sympto_Fever", fever == "NoFever" & Symptomatic == "NonSymptomatic" ~ "NonSympto_NoFever")) %>%
  add_count(StrainDon, name = "strain_n") %>%
  filter(strain_n > 20)

```

```{r, fig.width=16, fig.height=4}
sympt_fev_tbl %>%
  ggplot(., aes(x = donor, y = pseudotime, colour = StrainDon)) +
  geom_boxplot() +
  facet_wrap(Symptomatic~., scales = "free_x")
```


```{r, fig.width=16, fig.height=4}

sympt_fev_tbl  %>%
  # filter(!is.na(fev_sympt)) %>%
  ggplot(., aes(x = donor, y = pseudotime, colour = StrainDon)) +
  geom_sina(size = 0.2) +
  # geom_boxplot() +
  facet_wrap(fever ~., scales = "free_x")
```

```{r, fig.width=16, fig.height=4}

sympt_fev_tbl  %>%
  filter(!is.na(fev_sympt)) %>%
  ggplot(., aes(x = donor, y = pseudotime, colour = StrainDon)) +
  geom_sina(size = 0.2) +
  # geom_boxplot() +
  facet_wrap(fev_sympt ~., scales = "free_x")
```

```{r, fig.width=16, fig.height=4}

sympt_fev_tbl  %>%
  filter(!is.na(fev_sympt)) %>%
  ggplot(., aes(x = donor, y = pseudotime_fld_only, colour = StrainDon)) +
  geom_sina(size = 0.2) +
  # geom_boxplot() +
  facet_wrap(fev_sympt ~., scales = "free_x")
```

```{r, fig.width=16, fig.height=4}

sympt_fev_tbl  %>%
  filter(!is.na(fev_sympt)) %>%
  ggplot(., aes(x = donor, y = smpl_wait_time, colour = StrainDon)) +
  geom_point() +
  facet_wrap(fev_sympt ~., scales = "free_x")
```

```{r, fig.width=16, fig.height=4}

sympt_fev_tbl  %>%
  filter(!is.na(fev_sympt)) %>%
  ggplot(., aes(x = donor, y = pseudotime, colour = StrainDon)) +
  geom_sina(size = 0.2) +
  # geom_boxplot() +
  facet_wrap(Hb_Type ~., scales = "free_x")
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# pseudobulk the counts based on donor-condition-celltype
pseudo_m2_asex <- AggregateExpression(m2_asex_harmony_tr, assays = "RNA", return.seurat = T, group.by = c("Symptomatic", "fever", "donor", "StageFL", "Hb_Type"))

# each 'cell' is a donor-condition-celltype pseudobulk profile
tail(Cells(pseudo_m2_asex))
```


```{r, fig.width=15, fig.height=5}
## Symptomatic disregarding fever

# batch by stage and symptomatic
pseudo_m2_asex$stage.hb <- paste(pseudo_m2_asex$StageFL, pseudo_m2_asex$Hb_Type, sep = "_")
Idents(pseudo_m2_asex) <- "stage.hb"

# DE
bulk.de.hb <- map(c("Late ring", "Early trophozoite"), ~ FindAllMarkers(object = pseudo_m2_asex[,pseudo_m2_asex$StageFL == .x], test.use = "DESeq2", min.cells.group = 1)) %>%
  set_names(c("Late ring", "Early trophozoite"))

map(bulk.de.hb, ~.x %>% filter(p_val_adj < 0.05) %>% head( n = 10) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene)))
```


```{r}
Idents(pseudo_m2_asex) <- "stage.hb"

imap(bulk.de.hb, ~{
  gns <- .x %>% filter(p_val_adj < 0.05) %>% rownames()
  stg <- .y
  # map(gns, ~VlnPlot(pseudo_m2_asex, features = .x, group.by = "stage.sympt", ncol = 1) )
  map(gns, ~VlnPlot(pseudo_m2_asex, features = .x, group.by = "stage.hb", ncol = 1) )
  })
```

PF3D7-1229300 https://www-ncbi-nlm-nih-gov.ezp.lib.cam.ac.uk/pmc/articles/PMC8527989/
PF3D7_1229200 https://www-ncbi-nlm-nih-gov.ezp.lib.cam.ac.uk/pmc/articles/PMC4286016/
https://www-ncbi-nlm-nih-gov.ezp.lib.cam.ac.uk/pmc/articles/PMC8527989/


```{r, fig.width=15, fig.height=5}
## Symptomatic disregarding fever

# batch by stage and symptomatic
pseudo_m2_asex$stage.sympt <- paste(pseudo_m2_asex$StageFL, pseudo_m2_asex$Symptomatic, sep = "_")
Idents(pseudo_m2_asex) <- "stage.sympt"

# DE
bulk.de <- map(c("Late ring", "Early trophozoite"), ~ FindMarkers(object = pseudo_m2_asex,  ident.1 = paste0(.x, "_Symptomatic"),   ident.2 = paste0(.x, "_NonSymptomatic"), test.use = "DESeq2")) %>%
  set_names(c("Late ring", "Early trophozoite"))

map(bulk.de, ~.x %>% head( n = 10) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene)))
```

```{r, fig.width=15, fig.height=5}
## Symptomatic disregarding fever

# batch by stage, symptomatic & fever
pseudo_m2_asex$stage.sympt.fever <- paste(pseudo_m2_asex$StageFL, pseudo_m2_asex$Symptomatic, pseudo_m2_asex$fever,  sep = "_")
Idents(pseudo_m2_asex) <- "stage.sympt.fever"

# DE
bulk.de.SF <- map(c("Late ring", "Early trophozoite"), ~ FindMarkers(object = pseudo_m2_asex,  ident.1 = paste0(.x, "_Symptomatic_Fever"),   ident.2 = paste0(.x, "_NonSymptomatic_NoFever"), test.use = "DESeq2"))%>%
  set_names(c("Late ring", "Early trophozoite"))

map(bulk.de.SF, ~.x %>% head( n = 10) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene)))
```

PF3D7_1122900, ABCF1 - Apicoplast link to fever https://www-ncbi-nlm-nih-gov.ezp.lib.cam.ac.uk/pmc/articles/PMC8316339/, https://www-ncbi-nlm-nih-gov.ezp.lib.cam.ac.uk/pmc/articles/PMC6155542/
https://www.cell.com/trends/parasitology/fulltext/S1471-4922(22)00039-3?rss=yes#supplementaryMaterial 


```{r, fig.width=15, fig.height=5}
## Symptomatic disregarding fever

# batch by stage, fever
pseudo_m2_asex$stage.fever <- paste(pseudo_m2_asex$StageFL, pseudo_m2_asex$fever,  sep = "_")
Idents(pseudo_m2_asex) <- "stage.fever"

# DE
bulk.de.F <- map(c("Late ring", "Early trophozoite"), ~ FindMarkers(object = pseudo_m2_asex,  ident.1 = paste0(.x, "_Fever"),   ident.2 = paste0(.x, "_NoFever"), test.use = "DESeq2")) %>%
  set_names(c("Late ring", "Early trophozoite"))

map(bulk.de.F, ~.x %>% head( n = 10) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene)))
```


PF3D7-1023100 - https://www.biorxiv.org/content/10.1101/2020.12.10.419788v2.full
We found that HS-Sensitive mutants tended to be sensitive to both artemisinin derivatives and H2O2-induced oxidative stress, while HS-Tolerant mutants were less sensitive to either condition
In addition to the HS-Sensitive mutant PB4 (DHA, dynein, PF3D7_1122900) from the pilot library, we identified three HS-Sensitive dynein mutants in the 1K-library (two different mutants of DHA_12, PF3D7_1202300; one mutant of DHA_10, PF3D7_1023100), indicating the robusticity of the 1K-library screen (Fig. S8A- B).

#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6650087/ - PF3D7-1240400
#https://journals.asm.org/doi/10.1128/mbio.01636-21 https://www.frontiersin.org/articles/10.3389/fmala.2023.1075755/full  - hyp10
#http://dr.iiserpune.ac.in:8080/xmlui/bitstream/handle/123456789/7531/20153385_Abhishek_Kanyal_PhD_Thesis.pdf?sequence=1&isAllowed=y - PF3D7-1401300




```{r}
pmap(list(list("stage.sympt", "stage.sympt.fever", "stage.fever", "stage.hb"), list(bulk.de, bulk.de.SF, bulk.de.F, bulk.de.hb), list(c("_Symptomatic", "_NonSymptomatic"), c("_Symptomatic_Fever", "_NonSymptomatic_NoFever"), c("_Fever", "_NoFever"), c("_HbC", "_HbN"))), ~{ 
  condtn = ..1
  Idents(pseudo_m2_asex) <- condtn
  obj = ..2
  grp = ..3

  imap(obj, ~{
    gns <- .x %>% filter(p_val_adj < 0.05) %>% rownames()
    stg <- .y
    map(gns, ~VlnPlot(pseudo_m2_asex, features = .x, idents = c(paste0(stg, grp[1]), paste0(stg, grp[2])), group.by = condtn, ncol = 1) + labs(title= paste0(.x, grp)) )
    })
})
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
m2_asex_harmony_tr$sympt_don <- paste(m2_asex_harmony_tr$Symptomatic, m2_asex_harmony_tr$donor, sep = "_")
m2_asex_harmony_tr$sympt_fever_don <- paste(m2_asex_harmony_tr$Symptomatic, m2_asex_harmony_tr$fever, m2_asex_harmony_tr$donor, sep = "_")
m2_asex_harmony_tr$fever_don <- paste(m2_asex_harmony_tr$fever, m2_asex_harmony_tr$donor, sep = "_")

m2_asex_harmony_tr$stage.sympt <- paste(m2_asex_harmony_tr$StageFL, m2_asex_harmony_tr$Symptomatic, sep = "_")
m2_asex_harmony_tr$stage.sympt.fever <- paste(m2_asex_harmony_tr$StageFL, m2_asex_harmony_tr$Symptomatic, m2_asex_harmony_tr$fever, sep = "_")
m2_asex_harmony_tr$stage.fever <- paste(m2_asex_harmony_tr$StageFL, m2_asex_harmony_tr$fever, sep = "_")

```



```{r, fig.width= 14, fig.height=4}
pmap(list(list("stage.sympt", "stage.sympt.fever", "stage.fever"), list(bulk.de, bulk.de.SF, bulk.de.F), list(c("_Symptomatic", "_NonSymptomatic"), c("_Symptomatic_Fever", "_NonSymptomatic_NoFever"), c("_Fever", "_NoFever")), list("sympt_don", "sympt_fever_don", "fever_don")), ~{ 
  condtn = ..1
  Idents(m2_asex_harmony_tr) <- condtn
  obj = ..2
  grp = ..3
  grp_condtn = ..4

  imap(obj, ~{
    gns <- .x %>% filter(p_val_adj < 0.05) %>% rownames()
    stg <- .y
    map(gns, ~VlnPlot(m2_asex_harmony_tr, features = .x, idents = c(paste0(stg, grp[1]), paste0(stg, grp[2])), group.by = grp_condtn, ncol = 1) + labs(title= paste0(.x, grp)) )
    })
})
```


```{r, fig.width= 14, fig.height=4}
pmap(list(list("stage.sympt", "stage.sympt.fever", "stage.fever"), list(bulk.de, bulk.de.SF, bulk.de.F), list("sympt_don", "sympt_fever_don", "fever_don")), ~{ 
  condtn = ..1
  Idents(m2_asex_harmony_tr) <- condtn
  obj = ..2
  grp_condtn = ..3

  imap(obj, ~{
    gns <- .x %>% filter(p_val_adj < 0.05) %>% rownames()
    stg <- .y
    DotPlot(m2_asex_harmony_tr, features = gns, group.by = grp_condtn) + labs(title =  stg) 
    })
})
```

```{r, fig.width= 14, fig.height=4}
pmap(list(list(bulk.de, bulk.de.SF, bulk.de.F), list("stage.sympt", "stage.sympt.fever", "stage.fever")), ~{ 
  obj = ..1
  grp_condtn = ..2

  imap(obj, ~{
    DotPlot(m2_asex_harmony_tr, features = .x %>% filter(p_val_adj < 0.05) %>% rownames(), group.by = grp_condtn) + labs(title =  .y) 
    })
})
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
m2_asex_harmony_tr$sympt_fever <- paste(m2_asex_harmony_tr$Symptomatic, m2_asex_harmony_tr$fever, sep = "_")

```

Plot collapsing the donors by the different conditions
```{r, fig.width= 16, fig.height=4}
pmap(list(list("stage.sympt", "stage.sympt.fever", "stage.fever", "stage.hb"), list(bulk.de, bulk.de.SF, bulk.de.F, bulk.de.hb), list("Symptomatic", "sympt_fever", "fever", "Hb_Type")), ~{ 
  condtn = ..1
  Idents(m2_asex_harmony_tr) <- condtn
  obj = ..2
  grp_condtn = ..3

  imap(obj, ~{
    gns <- .x %>% filter(p_val_adj < 0.05) %>% rownames()
    stg <- .y
    # map(gns, ~VlnPlot(m2_asex_harmony_tr, features = .x, idents = c(paste0(stg, grp[1]), paste0(stg, grp[2])), group.by = grp_condtn, ncol = 1) + labs(title= paste0(.x, grp)) )
    map(gns, ~FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StageFL == stg],  reduction = "umap.harmony", features = .x, split.by = grp_condtn, order = T))
    })
})
```



```{r, fig.width=10, fig.height=5}
DimPlot(m2_asex_harmony_tr, reduction = "umap.harmony", group.by = c("Symptomatic", "StageFL"), ncol = 2)
DimPlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StageFL == "Late ring"], reduction = "umap.harmony", split.by = c("Symptomatic"), ncol = 2)
DimPlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StageFL == "Early trophozoite"], reduction = "umap.harmony", split.by = c("Symptomatic"), ncol = 2)
```



```{r, fig.width=10, fig.height=5}
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-0114500", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-1240400", split.by = c("Symptomatic"), ncol = 2, order = T)
```



Feature plots of HbC and HbS upregulated genes stratified by strains only showing strain with more than 20 cells
```{r, fig.width=27, fig.height=3}
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr@meta.data %>% filter(donor %in% c("MSC14", "MSC66", "MSC51")) %>% rownames_to_column('bcode') %>% group_by(StrainDon) %>% filter(n()>20) %>% pull(bcode)], features = "PF3D7-1229200", split.by = c("StrainDon"), ncol = 5, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr@meta.data %>% filter(donor %in% c("MSC14", "MSC66", "MSC51")) %>% rownames_to_column('bcode') %>% group_by(StrainDon) %>% filter(n()>20) %>% pull(bcode)], features = "PF3D7-1229300", split.by = c("StrainDon"), ncol = 5, order = T)

```

Feature plots of HbC and HbS upregulated genes stratified by strains showing all strains 
```{r, fig.width=15, fig.height=3}
DotPlot(m2_asex_harmony_tr, features = c("PF3D7-1229200", "PF3D7-1229300"), group.by = c("StrainDon")) + coord_flip() + theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1), legend.position = "bottom")
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1240400", idents = c("Late ring_Symptomatic", "Late ring_NonSymptomatic"), group.by = "donor_symptomatic")
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# m2_asex_harmony_tr <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$dset == "Field"]
```




```{r}
v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex)
```

```{r}
fld_clusters <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex) %>% pull(harmony_clusters_asex) 

fld_clusters_cutoff <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex) %>% filter(n>200) %>% pull(harmony_clusters_asex) 
```

```{r}
## Retained
DimPlot(v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff], reduction = "umap.harmony", split.by = "dset", label = T)
```

```{r}
## Removed
DimPlot(v3_m2_asex_harmony_ss_res_fld_pt_pf[,!(v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff)], reduction = "umap.harmony", split.by = "dset", label = T)
```


```{r}
## subset where field parasites are for slingshot
# v3_m2_asex_harmony_ss_res_fld_pt_pf <- v3_m2_asex_harmony_ss_res_fld_pt_pf[,v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff]
```


```{r, fig.width=8, fig.height=5}
DimPlot(v3_m2_asex_harmony_ss_res_fld_pt_pf,  reduction = "umap.harmony", split.by = c("Symptomatic"))
```

## Trajectory inference of integrated object
Adjust to get appropriate clustering so as to input into slingshot
```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"

DimPlot(v3_m2_asex_harmony_ss_res_fld_pt_pf, reduction = "umap.harmony", label = T)
# msc_gam_combi_noLE <- FindClusters(msc_gam_combi_noLE, resolution = 0.32, verbose = F)

```

```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
# DimPlot(v3_m2_asex_harmony_ss_res_fld_pt_pf, reduction = "umap.harmony", group.by = "harmony_clusters_asex", pt.size = 0.5, dims = c(1,2), label = T)

```




```{r, results="asis", fig.width= 7, fig.height=5}

umap_meta_df <- m2_asex_harmony_tr@reductions$umap.harmony@cell.embeddings %>% as.data.frame() %>%rownames_to_column("cell_bc") %>% left_join(., m2_asex_harmony_tr@meta.data[,c("stage", "StageFL", "pseudotime", "orig.ident", "donor", "StrainDon", "Symptomatic", "dset")] %>% as.data.frame() %>% rownames_to_column("cell_bc"), by = "cell_bc")  #%>% 
# mutate(across(strain_dset, ~factor(., levels = rev(strain_dset_lvls_don)))) %>% arrange(strain_dset

plt <- umap_meta_df %>% 
  ggplot(aes(x = umapharmony_1, y =umapharmony_2, color = pseudotime)) + geom_point(size=0.5) + 
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        legend.text = element_text(size = 22) ,
        legend.title = element_text(size = 24, face = "bold") )

print(plt)

thm_std <- theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 20) ,
        legend.title = element_text(size = 23, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        legend.position="bottom",
        # legend.direction="vertical"
  )
  
plt = umap_meta_df %>% 
  filter(dset == "Field") %>%
  ggplot(., aes(x = pseudotime, col=StageFL, fill=stage)) + 
  scale_color_manual(name = "Stage", values = sp_fld_colors)+ 
  scale_fill_manual(name = "Stage", values = sp_fld_colors)+
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  thm_std+
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"), fill = 'none')

print(plt)



plt = umap_meta_df %>% 
  filter(dset == "Field") %>%
  ggplot(., aes(x = pseudotime, col=donor, fill=donor)) + 
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  thm_std+
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top", nrow = 4))

print(plt)

plt = umap_meta_df %>% 
  filter(dset == "Field") %>%
  ggplot(., aes(x = pseudotime, col=Symptomatic, fill=Symptomatic)) + 
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  thm_std+
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)

```

## Placing the more sophisticated DE at the top to save on time since MAST findmarkers run takes long

## DREAMLET
## Proper DE accounting for factors
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StageFL %in% c("Early trophozoite", "Late ring"))  %>% group_by(StrainDon,StageFL) %>% filter(n() > 10) %>% dplyr::count(StrainDon, StageFL)
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony_ss_res_fld_pt_pf@meta.data %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StageFL %in% c("Early trophozoite", "Late ring"))  %>% group_by(StrainDon, StageFL) %>% filter(n() > 10) %>% ungroup() %>% add_count(donor, name = "don_count") %>% add_count(StrainDon, name = "strn_count") %>% mutate(strn_prop = strn_count/don_count) %>% dplyr::count(StrainDon, StageFL,don_count,strn_count,strn_prop)
```


Check pseudotime by sampling time
```{r, fig.width=15, fig.height=5}
map(c("smpl_wait_time","parasitaemia"), ~{
  
  m2_asex_harmony_tr@meta.data %>% 
    ggplot(aes(x = !!rlang::sym(.x), y = pseudotime, colour = Symptomatic)) +
    geom_point() 
})
```

Check pseudotime by sampling time
```{r, fig.width=15, fig.height=5}
map(c("smpl_wait_time","parasitaemia"), ~{
  
  m2_asex_harmony_tr@meta.data %>% 
    ggplot(aes(x = !!rlang::sym(.x), y = mean(pseudotime), colour = Symptomatic)) +
    geom_point() +
  geom_smooth(method = "lm")
  
})
```

```{r, fig.width=15, fig.height=5}
m2_asex_harmony_tr@meta.data %>% 
  lm(formula =pseudotime ~ smpl_wait_time + parasitaemia, data = .)
```

```{r}
st_dist <- m2_asex_harmony_tr@meta.data %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% group_by(donor) 

```

```{r}
st_dist %>%  ggplot(aes(x = donor, fill = StrainDon, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x")
```


```{r, fig.width= 10, fig.height= 4}
m2_asex_harmony_tr@meta.data %>% count(donor, Symptomatic) %>% filter(n>20) %>% ggplot(aes(x = donor, fill = donor, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x")
```


```{r, fig.width= 10, fig.height= 4}
m2_asex_harmony_tr@meta.data %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% ggplot(aes(x = donor, fill = StrainDon, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x") + theme(legend.position = "right")
```


```{r}
## Only those with asexuals and included in analysis
map(c("parasitaemia", "age_years", "smpl_wait_time"), ~{
  donor_mdata_slct %>% 
  filter(short_name %in% str_remove(unique(st_dist$donor), "_SLO")) %>%
  ggplot(aes(x = symptomatic, y = !!rlang::sym(.x))) +
  geom_boxplot() +
  geom_point()
})
```



Subset to retain only field asexual strains with great than 20 strains per straindon group. Remove stages with few cells - early rings and schizonts which are a minority and maybe poorly labelled
```{r, results="asis"}
qcd_asex <- m2_asex_harmony_tr@meta.data %>% rownames_to_column("bcode") %>% add_count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% pull(bcode)
  
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
m2_asex_harmony_tr_strn20 <- m2_asex_harmony_tr[,qcd_asex]
```

```{r, fig.width=15, fig.height=5}
m2_asex_tr_sce <- as.SingleCellExperiment(m2_asex_harmony_tr_strn20)
```

## check the strains going into the analysis

```{r, results="asis"}
# only keep cells with sufficient reads
m2_asex_tr_sce <- m2_asex_tr_sce[rowSums(counts(m2_asex_tr_sce) > 0) > 0, ]

## 

# compute QC metrics
m2_asex_qc <- perCellQCMetrics(m2_asex_tr_sce)

# remove cells with few or many detected genes
ol <- isOutlier(metric = m2_asex_qc$detected, nmads = 2, log = TRUE)

table(ol)

```


```{r, results="asis"}
# only keep cells with sufficient reads
m2_asex_tr_sce <- m2_asex_tr_sce[, !ol]
plotReducedDim(m2_asex_tr_sce, dimred = "UMAP.HARMONY")
```

###################### PSEUDOTIME CHUNKING END  ############################################

## pseudotime chunks used for all the DE methods below and can be used for DEseq2 above as well
### Calculate pseudotime chunks
```{r}
##Generate pseudotime chunks categories with range of highest and lowest pseudotime values and breaks numbers to ensure balanced representation of cells and drop the cells without strain information

##Remove those without pseudotime
m2_asex_tr_sce_pt_chunks <- m2_asex_tr_sce[,!is.na(m2_asex_tr_sce@colData[,'pseudotime'])]

      # print(sce_obj)
m2_asex_tr_sce_pt_chunks@colData[,c('ptime_cat', 'ptime_bal_cat')] <- m2_asex_tr_sce_pt_chunks@colData[,c( "pseudotime"), drop=F] %>%
        data.frame() %>% 
        mutate(ptime_cat = cut(!!rlang::sym("pseudotime"),  
                               breaks = c(-Inf, seq(min(!!rlang::sym("pseudotime")),  max(!!rlang::sym("pseudotime")), round((max(!!rlang::sym("pseudotime")) - min(!!rlang::sym("pseudotime")))/7, 2)), Inf)),
               pt_rank = dense_rank(!!rlang::sym("pseudotime")),
               ptime_bal_cat = cut(pt_rank,  
                               breaks = c(-Inf, seq(min(pt_rank),  max(pt_rank), round((max(pt_rank) - min(pt_rank))/7, 2)), Inf))
               ) %>%
  mutate(ptime_grp_rnk = dense_rank(factor(ptime_cat)),
         ptime_bal_grp_rnk = dense_rank(factor(ptime_bal_cat)),
         ptime_cat = paste0("ptime_", ptime_grp_rnk),
         ptime_bal_cat = paste0("ptime_", ptime_bal_grp_rnk)
         ) %>%
        dplyr::select(ptime_cat, ptime_bal_cat)

```


```{r}
plotReducedDim(m2_asex_tr_sce_pt_chunks, dimred = "UMAP.HARMONY", colour_by = "ptime_bal_cat")
```


```{r}
m2_asex_tr_sce_pt_chunks@colData[,c("ptime_bal_cat", "donor")] %>% as.data.frame() %>% dplyr::count(ptime_bal_cat)
```

```{r}
plotReducedDim(m2_asex_tr_sce_pt_chunks, dimred = "UMAP.HARMONY", colour_by = "ptime_cat")
```

```{r}
m2_asex_tr_sce_pt_chunks@colData[,c("ptime_cat", "donor")] %>% as.data.frame() %>% dplyr::count(ptime_cat)
```

```{r}
m2_asex_tr_sce_pt_chunks_sset <- m2_asex_tr_sce_pt_chunks[,m2_asex_tr_sce_pt_chunks$ptime_cat %in% c("ptime_3", "ptime_4", "ptime_5", "ptime_6", "ptime_7")]
```

```{r}
m2_asex_tr_sce_pt_chunks_sset@colData[,c("ptime_cat", "donor")] %>% as.data.frame() %>% dplyr::count(ptime_cat)
```

```{r}
# ##Generate pseudotime chunks categories with range of highest and lowest pseudotime values and breaks numbers to ensure balanced representation of cells and drop the cells without strain information
# cut_pt_denom <- rep(c(6,6,6,6), 2)
# # pts <- rep(c("female_pt", "female_pt", "male_pt", "male_pt" ),4)
# pts <- rep(c("female_pt", "male_pt" ),4)
# 
# 
# msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_ptchunks <- list(msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci, pts, cut_pt_denom) %>%
#   pmap(
#     # possibly(
#     ~{
#       sce_obj <- ..1[,!is.na(..1@colData[,'dset'])]
#       # print(sce_obj)
#       sce_obj@colData[,'ptime_cat'] <- sce_obj@colData[,c( ..2), drop=F] %>%
#         data.frame() %>% 
#         mutate(ptime_cat = cut(!!rlang::sym(..2),  breaks = c(-Inf, seq(min(!!rlang::sym(..2)),  max(!!rlang::sym(..2)), round((max(!!rlang::sym(..2)) - min(!!rlang::sym(..2)))/..3, 2)), Inf))) %>%
#         dplyr::select(ptime_cat)
#       
#       # print(glimpse(a))
#       return(sce_obj)
#     }
#     # , 'e')
#   )
# 
# ##Retain only for MSC14 as we dont want to compare field vs lab for the other samples
# # msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_ptchunks <- msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_ptchunks[str_detect(names(msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_ptchunks), "msc14")]
# msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_ptchunks

```

### Calculate pseudotime chunks donor strains
```{r}
# ##Generate pseudotime chunks categories with range of highest and lowest pseudotime values and breaks numbers to ensure balanced representation of cells and drop the cells without strain information
# cut_pt_denom <- rep(c(6,6), 9)
# pts <- rep(c("female_pt",  "male_pt" ), 9)
# 
# 
# msc_gcombi_noLE_sub_sce_unbal_ptchunks <- list(msc_gcombi_noLE_sub_mf_sce_unbal_auto_ci_strainsAll, pts, cut_pt_denom) %>%
#   pmap(
#     # possibly(
#     ~{
#       sce_obj <- ..1[,!is.na(..1@colData[,'lf_strain'])]
#       # print(sce_obj)
#       sce_obj@colData[,'ptime_cat'] <- sce_obj@colData[,c( ..2), drop=F] %>%
#         data.frame() %>% 
#         mutate(ptime_cat = cut(!!rlang::sym(..2),  breaks = c(-Inf, seq(min(!!rlang::sym(..2)),  max(!!rlang::sym(..2)), round((max(!!rlang::sym(..2)) - min(!!rlang::sym(..2)))/..3, 2)), Inf))) %>%
#         dplyr::select(ptime_cat)
#       
#       # print(glimpse(a))
#       return(sce_obj)
#     }
#     # , 'e')
#   )
#   

```


###################### PSEUDOTIME CHUNKING END  ############################################

###################### DREAMLET START   ############################################

## DREAMLET & MUSCAT  - DONOR WITH RANDOM EFFECTS

Tabulate and get the pseudotime chunks with most numbers 3,4,5
```{r, results="asis", eval=FALSE}
m2_asex_tr_sce_pt_chunks@colData[, c("ptime_cat", "Symptomatic", "donor")] %>% data.frame() %>% count(ptime_cat, Symptomatic)
```

```{r, results="asis", eval=FALSE}
m2_asex_tr_sce_pt_chunks_345 <- m2_asex_tr_sce_pt_chunks[,m2_asex_tr_sce_pt_chunks@colData$ptime_cat %in% c("ptime_3", "ptime_4", "ptime_5", "ptime_6", "ptime_7")]
```

```{r, results="asis", eval=FALSE}
m2_asex_tr_sce_pt_chunks_345@colData[, c("ptime_cat", "Symptomatic", "donor", "StrainDon")] %>% data.frame() %>% count(ptime_cat, Symptomatic, StrainDon)
```

```{r, results="asis"}
## How to account for batch in tradeseq 
## https://github.com/statOmics/tradeSeq/issues/97
set.seed(123456)
data(countMatrix, package = "tradeSeq")
data(crv, package = "tradeSeq")

batch_infection <- DataFrame(
Infection = sample(x = c("Mock", "Infection1", "Infection2"), size = ncol(countMatrix), replace = TRUE),
Batch = sample(x = c("A", "B", "C"), size = ncol(countMatrix), replace = TRUE)
)

rownames(batch_infection) <- colnames(countMatrix)

design <- model.matrix(~Infection + Batch, batch_infection)

## Batch design correction for tradeseq
model.matrix(~  donor, m2_asex_tr_sce_pt_chunks_345@colData[, c("donor", "Symptomatic")] %>% data.frame())

## tradeseq manual example - Batch design correction for tradeseq
counts <- as.matrix(countMatrix)

batch <- factor(rep(c("A", "B"), each = ncol(counts)/2))
U <- model.matrix(~batch)
sceBatch <- fitGAM(counts = counts,
                   U = U,
                   sds = crv, 
                   nknots = 6, 
                   verbose = FALSE)
```

```{r, results="asis"}
## Save for tradeseq
saveRDS(m2_asex_tr_sce_pt_chunks_345, "data/raw/Pf/m2_asex_tr_sce_pt_chunks_345.RDS")
```

```{r, results="asis", eval=FALSE}

m2_asex_tr_sce_pt_chunks_345@colData[, c("Symptomatic", "ptime_cat",  "donor")] %>% data.frame() %>% count(Symptomatic, ptime_cat, donor)
```

```{r, results="asis", eval=FALSE}

m2_asex_tr_sce_pt_chunks_345@colData[, c("Symptomatic", "ptime_cat",  "donor", "StrainDon")] %>% data.frame() %>% count(Symptomatic, ptime_cat, StrainDon)
```


## Dreamlet - pseudobulk by Strain and donor as random intercept effect

```{r, results="asis"}
# Since 'ind' is the individual and 'StimStatus' is the stimulus status,
# create unique identifier for each sample
# m2_asex_tr_sce$id <- paste0(m2_asex_tr_sce$Symptomatic, m2_asex_tr_sce$donor, m2_asex_tr_sce$StrainDon)
m2_asex_tr_sce_pt_chunks_345$id <- paste0(m2_asex_tr_sce_pt_chunks_345$Symptomatic, m2_asex_tr_sce_pt_chunks_345$StrainDon)


# Create pseudobulk data by specifying cluster_id and sample_id
# Count data for each cell type is then stored in the `assay` field
# assay: entry in assayNames(sce) storing raw counts
# cluster_id: variable in colData(sce) indicating cell clusters
# sample_id: variable in colData(sce) indicating sample id for aggregating cells
m2_asex_tr_pb <- aggregateToPseudoBulk(m2_asex_tr_sce_pt_chunks_345,
  assay = "counts",
  # cluster_id = "StageFL",
  cluster_id = "ptime_cat",
  sample_id = "id",
  verbose = FALSE
)

# one 'assay' per cell type
assayNames(m2_asex_tr_pb)
```



```{r, results="asis"}
# one 'assay' per cell type
assayNames(m2_asex_tr_pb)

metadata(m2_asex_tr_pb)$aggr_means
```


```{r, results="asis"}

# form <- ~ (1|donor) + Symptomatic + pseudotime
form <- ~ Symptomatic + (1|donor)

# Normalize and apply voom/voomWithDreamWeights
res.proc <- processAssays(m2_asex_tr_pb, form, min.count = 2)

# the resulting object of class dreamletProcessedData stores
# normalized data and other information
res.proc
```

```{r, results="asis", eval=FALSE}
# gogo()
```

```{r, results="asis"}
# Normalize and apply voom/voomWithDreamWeights
details(res.proc)
```

```{r, results="asis"}
# show voom plot for each cell clusters
plotVoom(res.proc)
```

```{r, results="asis"}

# run variance partitioning analysis
vp.lst <- fitVarPart(res.proc, form)
```

```{r, results="asis"}
# Show variance fractions at the gene-level for each cell type
genes <- vp.lst$gene[1:2]
plotPercentBars(vp.lst[vp.lst$gene %in% genes, ])
```


```{r, results="asis", fig.width=10, fig.height=10}
# Summarize variance fractions genome-wide for each cell type
plotVarPart(vp.lst, label.angle = 60)
```

```{r, results="asis"}
# Differential expression analysis within each assay,
# evaluated on the voom normalized data
# res.dl <- dreamlet(res.proc, form, method = "random")
res.dl <- dreamlet(res.proc, form)

# names of estimated coefficients
coefNames(res.dl)
```

```{r, results="asis"}
# the resulting object of class dreamletResult
# stores results and other information
res.dl
```

```{r, results="asis"}
plotVolcano(res.dl, coef = "SymptomaticSymptomatic")
```

```{r, results="asis"}
# genes <- c("PF3D7-1240400", "PF3D7-1240900")
# plotGeneHeatmap(res.dl, coef = "SymptomaticSymptomatic", genes = genes)
```

```{r, results="asis"}
conflicts_prefer(dreamlet::topTable)
# results from full analysis
topTable(res.dl, coef = "SymptomaticSymptomatic") 
```

```{r, results="asis"}
# only B cells
topTable(res.dl[["ptime_3"]], coef = "SymptomaticSymptomatic") %>% arrange(adj.P.Val)
```

```{r, results="asis"}
plotForest(res.dl, coef = "SymptomaticSymptomatic", gene = c("PF3D7-1346400"))
```

```{r, results="asis"}
genes <- c("PF3D7-1346400", "PF3D7-1478600", "PF3D7-0205000")
plotGeneHeatmap(res.dl, coef = "SymptomaticSymptomatic", genes = genes)
```


```{r, results="asis"}
m2_asex_tr_sce_pt_chunks_345_seu <- as.Seurat(m2_asex_tr_sce_pt_chunks_345) 
```


```{r, results="asis"}
FeaturePlot(m2_asex_tr_sce_pt_chunks_345_seu, features = c("PF3D7-1346400", "PF3D7-0205000"), split.by = "Symptomatic") 
```

```{r, results="asis"}
# get data
df <- extractData(res.proc, "ptime_3", genes = "PF3D7-1346400")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-1346400`, colour = donor)) +
  geom_boxplot() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-1346400")
```

```{r, results="asis"}
# get data
df <- extractData(res.proc, "ptime_3", genes = "PF3D7-0205000")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-0205000`, colour = donor)) +
  geom_boxplot() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-0205000")
```

```{r, results="asis"}
# create a contrasts called 'Diff' that is the difference between expression
# in the stimulated and controls.
# More than one can be specified
contrasts <- c(Diff = "SymptomaticSymptomatic - SymptomaticNonSymptomatic")

# Evalaute the regression model without an intercept term.
# Instead estimate the mean expression in stimulated, controls and then
# set Diff to the difference between the two
res.dl2 <- dreamlet(res.proc, ~ 0 + Symptomatic, contrasts = contrasts)

# see estimated coefficients
coefNames(res.dl2)
```

```{r, results="asis"}
# Volcano plot of Diff
plotVolcano(res.dl2[1:2], coef = "Diff")
```

```{r, results="asis"}
# results from full analysis
topTable(res.dl, coef = "SymptomaticSymptomatic")

```


```{r, results="asis"}
# results from full analysis
# topTable(res.dl, coef = "SymptomaticNonSymptomatic")

```


```{r, results="asis", eval=FALSE}
# results from full analysis
topTable(res.dl, coef = "SymptomaticNonSymptomatic")

```

```{r, results="asis", eval=FALSE}
gogo()
```

## Dreamlet - pseudobulk by donor and donor as random intercept effect

```{r, results="asis"}
# Since 'ind' is the individual and 'StimStatus' is the stimulus status,
# create unique identifier for each sample
# m2_asex_tr_sce$id <- paste0(m2_asex_tr_sce$Symptomatic, m2_asex_tr_sce$donor, m2_asex_tr_sce$StrainDon)
m2_asex_tr_sce_pt_chunks_345$symp_don <- paste0(m2_asex_tr_sce_pt_chunks_345$Symptomatic, m2_asex_tr_sce_pt_chunks_345$donor)


# Create pseudobulk data by specifying cluster_id and sample_id
# Count data for each cell type is then stored in the `assay` field
# assay: entry in assayNames(sce) storing raw counts
# cluster_id: variable in colData(sce) indicating cell clusters
# sample_id: variable in colData(sce) indicating sample id for aggregating cells
m2_asex_tr_pb_don <- aggregateToPseudoBulk(m2_asex_tr_sce_pt_chunks_345,
  assay = "counts",
  # cluster_id = "StageFL",
  cluster_id = "ptime_cat",
  sample_id = "symp_don",
  verbose = FALSE
)

# one 'assay' per cell type
assayNames(m2_asex_tr_pb_don)
```


```{r, results="asis"}
# one 'assay' per cell type
assayNames(m2_asex_tr_pb_don)

metadata(m2_asex_tr_pb_don)$aggr_means
```



```{r, results="asis"}

# form <- ~ (1|donor) + Symptomatic + pseudotime
form <- ~ Symptomatic + (1|donor)

# Normalize and apply voom/voomWithDreamWeights
res.proc_don <- processAssays(m2_asex_tr_pb_don, form, min.count = 2)

# the resulting object of class dreamletProcessedData stores
# normalized data and other information
res.proc_don
```


```{r, results="asis"}
# Normalize and apply voom/voomWithDreamWeights
details(res.proc_don)
```

```{r, results="asis"}
# show voom plot for each cell clusters
plotVoom(res.proc_don)
```


```{r, results="asis"}

# run variance partitioning analysis
vp.lst_don <- fitVarPart(res.proc_don, form)
```


```{r, results="asis"}
# Show variance fractions at the gene-level for each cell type
genes <- vp.lst_don$gene[1:2]
plotPercentBars(vp.lst_don[vp.lst_don$gene %in% genes, ])
```


```{r, results="asis", fig.width=10, fig.height=10}
# Summarize variance fractions genome-wide for each cell type
plotVarPart(vp.lst_don, label.angle = 60)
```


```{r, results="asis"}
# Differential expression analysis within each assay,
# evaluated on the voom normalized data
# res.dl <- dreamlet(res.proc_don, form, method = "random")
res.dl_don <- dreamlet(res.proc_don, form)

# names of estimated coefficients
coefNames(res.dl_don)
```


```{r, results="asis"}
# the resulting object of class dreamletResult
# stores results and other information
res.dl_don
```

```{r, results="asis"}
plotVolcano(res.dl_don, coef = "SymptomaticSymptomatic")
```


```{r, results="asis"}
conflicts_prefer(dreamlet::topTable)
# results from full analysis
topTable(res.dl_don, coef = "SymptomaticSymptomatic") 
```


```{r, results="asis"}
# only B cells
topTable(res.dl_don[["ptime_3"]], coef = "SymptomaticSymptomatic") %>% arrange(adj.P.Val)
```

```{r, results="asis"}
plotForest(res.dl_don, coef = "SymptomaticSymptomatic", gene = c("PF3D7-1346400"))
```

```{r, results="asis"}
genes <- c("PF3D7-1346400", "PF3D7-1478600", "PF3D7-0205000")
plotGeneHeatmap(res.dl_don, coef = "SymptomaticSymptomatic", genes = genes)
```


```{r, fig.width= 30, fig.height=8}
m2_asex_tr_sce_pt_chunks_345_seu$symp_don <- paste(m2_asex_tr_sce_pt_chunks_345_seu$Symptomatic, m2_asex_tr_sce_pt_chunks_345_seu$donor, sep = "_")
FeaturePlot(m2_asex_tr_sce_pt_chunks_345_seu, features = c("PF3D7-1346400", "PF3D7-0205000"), split.by = c("symp_don")) 
```


```{r, results="asis"}
# get data
df <- extractData(res.proc_don, "ptime_3", genes = "PF3D7-1346400")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-1346400`, colour = donor)) +
  geom_point() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-1346400")
```

```{r, results="asis"}
# get data
df <- extractData(res.proc_don, "ptime_3", genes = "PF3D7-0205000")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-0205000`, colour = donor)) +
  geom_point() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-0205000")
```


```{r, results="asis"}
# create a contrasts called 'Diff' that is the difference between expression
# in the stimulated and controls.
# More than one can be specified
contrasts <- c(Diff = "SymptomaticSymptomatic - SymptomaticNonSymptomatic")

# Evalaute the regression model without an intercept term.
# Instead estimate the mean expression in stimulated, controls and then
# set Diff to the difference between the two
res.dl2 <- dreamlet(res.proc_don, ~ 0 + Symptomatic, contrasts = contrasts)

# see estimated coefficients
coefNames(res.dl2)
```


## Dreamlet following guidance from https://medium.com/@grioni.andrea/mastering-single-cell-rna-seq-with-dreamlet-41ead4650723 

```{r, results="asis"}
# create a contrasts called 'Diff' that is the difference between expression
m2_asex_tr_sce_pt_chunks_345
```
```{r, results="asis"}
# Extract read counts for each Channel/celltype
ctorder = c("ptime_3", "ptime_4", "ptime_5")
df_counts <- map_dfr(ctorder, function(x) {
  data <- assay(pb, x)
  data.frame(
    celltype = x,
    ID = colnames(data),
    readCounts = Matrix::colSums(data)
  )
})

```

```{r, results="asis"}
# Convert celltype to a factor with the specified order
df_counts$celltype <- factor(df_counts$celltype, levels = ctorder)
```


```{r, results="asis"}
# Removing cells with 0 reads.
df_counts <- df_counts[df_counts$readCounts > 0, ]
```


```{r, results="asis"}
# Generate violin plot to visualize the distribution of read counts for each cell type
ggplot(df_counts, aes(x = celltype, y = readCounts, fill = celltype)) +  
  # Violin plot
  geom_violin() + 
  
  # Boxplot inside violin
  geom_boxplot(width = 0.1, outlier.size = 0.1) +
  
  # Theme and aesthetics
  theme_bw() + 
  theme(
    aspect.ratio = 1, 
    plot.title = element_text(hjust = 0.5),
    legend.position = "none",
    axis.title.y = element_blank()
  ) + 
  
  # Log scale for y-axis
  scale_y_log10() +
  
  # Horizontal layout
  coord_flip() +
  
  # Labels and title
  labs(
    y = "Number of reads observed for each CellType",
    x = NULL,
    title = 'Reads per cell cluster for each CellType'
  )
```

Show the normalized reads for cell ratio.
```{r, results="asis"}
# Convert cell counts to dataframe and pivot to longer format
df_rate <- cellCounts(pb) |>
  as_tibble(rownames = "ID") |>
  tidyr::pivot_longer(cols = -ID, values_to = "ncells", names_to = "celltype") |>
  dplyr::mutate(celltype = factor(celltype, ctorder))

# Join dataframes and compute normalized reads
df_joined <- df_counts |>
  dplyr::inner_join(df_rate, by = c("celltype", "ID")) |>
  dplyr::mutate(normalizedReads = readCounts/ncells)
```


```{r, results="asis"}
# Create a violin plot to visualize the normalized read counts for each 'celltype'
df_joined |>
  ggplot(aes(celltype, normalizedReads, fill = celltype)) +  
    # Display distribution of normalized read counts using a violin plot
    geom_violin(color = NA) + 
    # Add a boxplot inside the violin plot for a summarized view
    geom_boxplot(width = 0.1, outlier.size = 0.1) +
    # Use the classic theme for a polished appearance
    theme_classic() + 
    # Adjust theme settings for optimal visualization
    theme(
      aspect.ratio = 1, 
      plot.title = element_text(hjust = 0.5),
      legend.position = "none"
    ) + 
    # Apply a log scale to the y-axis for better data representation
    scale_y_log10() +
    # Present the plot horizontally for clarity
    coord_flip() +
    # Define labels for the plot
    labs(
      y = 'Normalized Reads (Reads per cell)', 
      x = NULL, 
      title = 'Normalized Reads per Cell for Each Channel'
    )
```



```{r, results="asis"}
df <- cellTypeSpecificity( pb )

plotViolin(df, assays=ctorder)
```


```{r, results="asis"}
# Process the 'df' dataframe to extract top marker genes for each cell type
my_markers <- df |> 
  # Convert the dataframe to a tibble and assign row names to 'gene' column
  tibble::as_tibble(rownames = "gene") |>

  # Exclude rows with 'gene' values containing the pattern "ENSG"
  dplyr::filter(!str_detect(gene, "ENSG")) |>

  # Transform the dataframe to a long format, with 'cellType' and 'CPM' columns
  tidyr::pivot_longer(
    cols = !c(gene, totalCPM), 
    names_to = "cellType", 
    values_to = "CPM"
  ) |>

  # Compute the percentage of CPM for each gene relative to 'totalCPM'
  dplyr::mutate(percentCPM = CPM / totalCPM * 100) |>

  # Organize data by 'cellType' and order within each group by 'percentCPM'
  dplyr::group_by(cellType) |>
  dplyr::arrange(desc(percentCPM)) |>

  # Retain only the top 3 genes for each cell type
  dplyr::slice(1:3) |>

  # Keep only the 'cellType' and 'gene' columns
  dplyr::select(cellType, gene) |>

  # Eliminate any repeated rows
  dplyr::distinct() |>

  # Convert the tibble to a named vector with 'cellType' as names and 'gene' as values
  tibble::deframe()
```



```{r, results="asis"}
# Plot percent bars for the specified genes and assays
plotPercentBars(df, genes = unique(my_markers), assays = ctorder)
```



```{r, results="asis"}
dreamlet::plotHeatmap(
  df,
  genes=unique(my_markers),
  assays=ctorder)
```



```{r, results="asis"}
# Create a formula for normalization
form = ~ (1|SubID) + (1|poolID) + Sex + scale(Age) + Dx
```


```{r, results="asis"}

```

###################### DREAMLET END  ############################################

###################### MILO START   ############################################

```{r, results="asis"}
traj_milo <- Milo(m2_asex_tr_sce)
```


```{r, results="asis"}
traj_milo <- buildGraph(traj_milo, k = 30, d = 30, reduced.dim = "PCA")
```

```{r, results="asis"}
traj_milo <- makeNhoods(traj_milo, prop = 0.1, k = 30, d=30, refined = TRUE, reduced_dims = "PCA")

```

```{r, results="asis"}
plotNhoodSizeHist(traj_milo)
```

```{r, results="asis"}
# traj_milo <- countCells(traj_milo, meta.data = data.frame(colData(traj_milo)), samples="StrainDon")
traj_milo <- countCells(traj_milo, meta.data = data.frame(colData(traj_milo)), sample="donor")
```

```{r, results="asis"}
head(nhoodCounts(traj_milo))
```

```{r, results="asis"}
traj_design <- data.frame(colData(traj_milo))[,c("donor", "Symptomatic")]
# traj_design <- data.frame(colData(traj_milo))[,c("StrainDon", "Symptomatic", "donor")]
traj_design <- distinct(traj_design)
# rownames(traj_design) <- traj_design$StrainDon
rownames(traj_design) <- traj_design$donor
## Reorder rownames to match columns of nhoodCounts(milo)
# traj_design <- traj_design[colnames(nhoodCounts(traj_milo)), , drop=FALSE]

traj_design

# embryo_design <- data.frame(colData(embryo_milo))[,c("sample", "stage", "sequencing.batch")]
# 
# ## Convert batch info from integer to factor
# embryo_design$sequencing.batch <- as.factor(embryo_design$sequencing.batch) 
# embryo_design <- distinct(embryo_design)
# rownames(embryo_design) <- embryo_design$sample
# 
# embryo_design
```

```{r, results="asis"}
traj_milo <- calcNhoodDistance(traj_milo, d=30)
```

```{r, results="asis"}
da_results <- testNhoods(traj_milo, design = ~ Symptomatic, design.df = traj_design)
# da_results <- testNhoods(traj_milo, design = ~ donor + Symptomatic, design.df = traj_design)
```

```{r, results="asis"}
da_results %>%
  arrange(SpatialFDR) %>%
  head() 
```


```{r, results="asis"}
ggplot(da_results, aes(PValue)) + geom_histogram(bins=50)
```

```{r, results="asis"}
ggplot(da_results, aes(logFC, -log10(SpatialFDR))) + 
  geom_point() +
  geom_hline(yintercept = 1) ## Mark significance threshold (10% FDR)
```


```{r, results="asis"}
traj_milo <- buildNhoodGraph(traj_milo)

```

```{r, results="asis"}
conflicts_prefer(graphics::layout)
## Plot single-cell UMAP
plotReducedDim(traj_milo, dimred = "UMAP.HARMONY", colour_by="Symptomatic", text_by = "seurat_clusters", 
                          text_size = 3, point_size=0.5)+
  guides(fill="none") + 
  plotNhoodGraphDA(traj_milo, da_results, alpha=0.05, layout = "UMAP.HARMONY") #+
  # plot_layout(guides="collect")



# ## Plot neighbourhood graph
# nh_graph_pl <- plotNhoodGraphDA(embryo_milo, da_results, layout="umap",alpha=0.1) 
#   
# umap_pl + nh_graph_pl +
#   plot_layout(guides="collect")
```

```{r, results="asis"}
# da_results <- annotateNhoods(traj_milo, da_results, coldata_col = "ptime_cat")
da_results <- annotateNhoods(traj_milo, da_results, coldata_col = "seurat_clusters")
head(da_results)
```


```{r, results="asis"}
ggplot(da_results, aes(seurat_clusters_fraction)) + geom_histogram(bins=50)
# ggplot(da_results, aes(ptime_cat_fraction)) + geom_histogram(bins=50)
```

```{r, results="asis"}
da_results$seurat_clusters <- ifelse(da_results$seurat_clusters_fraction < 0.7, "Mixed", da_results$seurat_clusters)
```


```{r, results="asis"}
plotDAbeeswarm(da_results, group.by = "seurat_clusters")
```

```{r, results="asis"}
## Add log normalized count to Milo object
traj_milo <- logNormCounts(traj_milo)

da_results$NhoodGroup <- as.numeric(da_results$SpatialFDR < 0.1 & da_results$logFC < 0)
# da_nhood_markers <- findNhoodGroupMarkers(traj_milo, da_results, subset.row = rownames(traj_milo)[1:10])

```

```{r, results="asis"}
da_nhood_markers <- findNhoodGroupMarkers(traj_milo, da_results, subset.row = rownames(traj_milo), 
                                          aggregate.samples = TRUE, sample_col = "donor")

```

```{r, results="asis"}
head(da_nhood_markers)
```

Automatic grouping of neighbourhoods

```{r, results="asis"}
## Run buildNhoodGraph to store nhood adjacency matrix
traj_milo <- buildNhoodGraph(traj_milo)

## Find groups
da_results <- groupNhoods(traj_milo, da_results, max.lfc.delta = 2)
head(da_results)
```

```{r, results="asis"}
plotNhoodGroups(traj_milo, da_results, layout="UMAP.HARMONY") 
```



```{r, results="asis"}
plotDAbeeswarm(da_results, group.by = "NhoodGroup")
```

```{r, results="asis"}
# trial with parameters adjusted
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 1) , group.by = "NhoodGroup") + ggtitle("max LFC delta=1")
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 2)   , group.by = "NhoodGroup") + ggtitle("max LFC delta=2")
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 3)   , group.by = "NhoodGroup") + ggtitle("max LFC delta=3")
```


```{r, results="asis"}
# trial with parameters adjusted
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 5, overlap=1) , group.by = "NhoodGroup") + ggtitle("overlap=5")
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 5, overlap=5)   , group.by = "NhoodGroup") + ggtitle("overlap=10")
plotDAbeeswarm(groupNhoods(traj_milo, da_results, max.lfc.delta = 5, overlap=10)   , group.by = "NhoodGroup") + ggtitle("overlap=20")
```


```{r, results="asis"}
set.seed(42)
da_results <- groupNhoods(traj_milo, da_results, max.lfc.delta = 10, overlap=1)
plotNhoodGroups(traj_milo, da_results, layout="UMAP.HARMONY")
```


```{r, results="asis"}
plotDAbeeswarm(da_results, group.by = "NhoodGroup")
```



Finding gene signatures for neighbourhoods

```{r, results="asis"}
## Exclude zero counts genes
keep.rows <- rowSums(logcounts(traj_milo)) != 0
traj_milo <- traj_milo[keep.rows, ]

## Find HVGs
dec <- modelGeneVar(traj_milo)
hvgs <- getTopHVGs(dec, n=200)
head(hvgs)
```

one-vs-all differential gene expression for each neighbourhood group
```{r, results="asis"}
nhood_markers <- findNhoodGroupMarkers(traj_milo, da_results, subset.row = hvgs, 
                                       aggregate.samples = TRUE, sample_col = "donor")

head(nhood_markers)
```

```{r, results="asis"}
gr2_markers <- nhood_markers[c("GeneID", "logFC_6", "adj.P.Val_6")] 
colnames(gr2_markers) <- c("GeneID", "logFC", "adj.P.Val")

head(gr2_markers[order(gr2_markers$adj.P.Val), ])
```
subset.groups tests 8-VS-all markers
```{r, results="asis"}
nhood_markers8 <- findNhoodGroupMarkers(traj_milo, da_results, subset.row = hvgs, 
                                       aggregate.samples = TRUE, sample_col = "donor",
                                       subset.groups = c("8")
                                       )

head(nhood_markers8)
```

Compare neighbourhoods - seems like it is each neighbour hood versus all the rest otherwise there should be only one p value
```{r, results="asis"}
nhood_markers2 <- findNhoodGroupMarkers(traj_milo, da_results, subset.row = hvgs,
                                       subset.nhoods = da_results$NhoodGroup %in% c('1','2'),
                                       aggregate.samples = TRUE, sample_col = "donor")

head(nhood_markers2)
```

```{r, results="asis"}
ggplot(nhood_markers2, aes(logFC_2,-log10(adj.P.Val_2 ))) + 
  geom_point(alpha=0.5, size=0.5) +
  geom_hline(yintercept = 2)
```

```{r, results="asis"}
markers <- nhood_markers2$GeneID[nhood_markers$adj.P.Val_2 < 0.3 & nhood_markers2$logFC_2 > 0]
```

```{r, results="asis"}
plotNhoodExpressionGroups(traj_milo, da_results, features=markers[1:20],
                          subset.nhoods = da_results$NhoodGroup %in% c('3','2'), scale=TRUE,
                          grid.space = "fixed")
```

DGE testing within a group
```{r, results="asis"}
dge_9 <- testDiffExp(traj_milo, da_results, design = ~ Symptomatic, meta.data = data.frame(colData(traj_milo)), subset.nhoods=da_results$NhoodGroup=="3")
```

```{r, results="asis"}
dge_9
```

Milo GLLM

```{r, results="asis"}
# traj_milo <- Milo(m2_asex_tr_sce_pt_chunks)
```

```{r, results="asis"}
traj_sce <- m2_asex_tr_sce_pt_chunks
```

```{r, results="asis"}
# uncomment the row below to allow multi-processing and comment out the SerialParam line.
# bpparam <- MulticoreParam(workers=4)
bpparam <- SerialParam()
register(bpparam)
```

```{r, results="asis"}
# set.seed(42)
# # remove sparser cells
# drop.cells <- colSums(counts(traj_sce)) < 600
# traj_sce <- computePooledFactors(traj_sce[, !drop.cells], BPPARAM=bpparam)
# traj_sce <- logNormCounts(traj_sce)
# 
# pbmc.hvg <- modelGeneVar(traj_sce)
# pbmc.hvg$FDR[is.na(pbmc.hvg$FDR)] <- 1
# 
# traj_sce <- runPCA(traj_sce, subset_row=rownames(traj_sce)[pbmc.hvg$FDR < 0.5], scale=TRUE, ncomponents=30, assay.type="logcounts", name="PCA", BPPARAM=bpparam)
# traj_sce
```

```{r, results="asis"}
# set.seed(42)
# traj_sce <- runUMAP(traj_sce, n_neighbors=30, pca=20, BPPARAM=bpparam) # add a UMAP for plotting results later
# 
# traj_milo_gllm <- Milo(traj_sce) # from the SCE object
# reducedDim(traj_milo_gllm, "UMAP") <- reducedDim(traj_sce, "UMAP")
# 
# plotUMAP(traj_milo_gllm, colour_by="StageFL") + plotUMAP(traj_milo_gllm, colour_by="donor")
```



```{r, results="asis"}
# set.seed(42)
# traj_milo_gllm <- Milo(m2_asex_tr_sce_pt_chunks) # from the SCE object
traj_milo_gllm <- Milo(m2_asex_tr_sce) # from the SCE object
reducedDim(traj_milo_gllm, "UMAP") <- reducedDim(m2_asex_tr_sce, "UMAP.HARMONY")

plotUMAP(traj_milo_gllm, colour_by="StageFL") + plotUMAP(traj_milo_gllm, colour_by="donor")
```

```{r, results="asis"}
set.seed(42)
# we build KNN graph
traj_milo_gllm <- buildGraph(traj_milo_gllm, k = 60, d = 30)
```

```{r, results="asis"}
traj_milo_gllm <- makeNhoods(traj_milo_gllm, prop = 0.2, k = 60, d=30, refined = TRUE, refinement_scheme="graph") # make nhoods using graph-only as this is faster
```

```{r, results="asis"}
# colData(traj_milo_gllm)$ObsID <- paste(colData(traj_milo_gllm)$tenx_lane, colData(traj_milo_gllm)$sampleid, sep="_")
traj_milo_gllm <- countCells(traj_milo_gllm, meta.data = data.frame(colData(traj_milo_gllm)), samples="StrainDon") # make the nhood X sample counts matrix
```

```{r, results="asis"}
head(nhoodCounts(traj_milo_gllm))
```

```{r, results="asis"}
plotNhoodSizeHist(traj_milo_gllm)
```

```{r, results="asis"}
symp.design <- data.frame(colData(traj_milo_gllm))[,c("donor", "StrainDon", "Symptomatic")]
symp.design <- distinct(symp.design)
rownames(symp.design) <- symp.design$StrainDon
## Reorder rownames to match columns of nhoodCounts(milo)
symp.design <- symp.design[colnames(nhoodCounts(traj_milo_gllm)), , drop=FALSE]
table(symp.design$Symptomatic)
```


```{r, results="asis"}
symp.design
```

```{r, results="asis", eval=FALSE}
set.seed(42)
rownames(symp.design) <- symp.design$StrainDon

da_results <- testNhoods(traj_milo_gllm, design = ~ Symptomatic + (1|donor), design.df = symp.design, fdr.weighting="graph-overlap", glmm.solver="HE-NNLS", REML=TRUE, norm.method="TMM", BPPARAM = bpparam, fail.on.error=FALSE, max.iters = 1000)
```

```{r, results="asis", eval=FALSE}
table(da_results$SpatialFDR < 0.99)
```

```{r, results="asis", eval=FALSE}
which(is.na(da_results$logFC))
```

```{r, results="asis", eval=FALSE}
which(checkSeparation(traj_milo_gllm, design.df=symp.design, condition="Symptomatic", min.val=5))
```

```{r, results="asis", eval=FALSE}
length(which(checkSeparation(traj_milo_gllm, design.df=symp.design, condition="Symptomatic", min.val=5)))
```

```{r, results="asis", fig.width=30, fig.height=20, eval=FALSE}
plotNhoodCounts(traj_milo_gllm, which(checkSeparation(traj_milo_gllm, design.df=symp.design, condition="Symptomatic", min.val=5)), design.df=symp.design, condition="Symptomatic")
```

```{r, results="asis", eval=FALSE}
head(da_results[!is.na(da_results$logFC), ])
```

```{r, results="asis", eval=FALSE}
da_results[!is.na(da_results$logFC) & da_results$Converged == T, ] %>% arrange(PValue)
```

```{r, results="asis", eval=FALSE}
traj_milo_gllm <- buildNhoodGraph(traj_milo_gllm, overlap=25)

# we need to subset the plotting results as it can't handle the NAs internally.
plotUMAP(traj_milo_gllm, colour_by="Symptomatic") + plotNhoodGraphDA(traj_milo_gllm, da_results[!is.na(da_results$logFC), ], subset.nhoods=!is.na(da_results$logFC), alpha=0.1) +  plot_layout(guides="auto" )
```


```{r, results="asis", eval=FALSE}
set.seed(42)
# we need to use place the test variable at the end of the formula
glm_results <- testNhoods(traj_milo_gllm, design = ~Symptomatic, design.df = symp.design, fdr.weighting="graph-overlap",
                          REML=TRUE, norm.method="TMM", BPPARAM = bpparam)
```

```{r, results="asis", eval=FALSE}
table(glm_results$SpatialFDR < 0.1)
```

```{r, results="asis", eval=FALSE}
plotUMAP(traj_milo_gllm, colour_by="Symptomatic") + plotNhoodGraphDA(traj_milo_gllm, glm_results, alpha=0.1) +
  plot_layout(guides="auto" )
```

```{r, results="asis", fig.width=12, fig.height=4, eval=FALSE}
comp.da <- merge(da_results, glm_results, by='Nhood')
comp.da$Sig <- "none"
comp.da$Sig[comp.da$SpatialFDR.x < 0.1 & comp.da$SpatialFDR.y < 0.1] <- "Both"
comp.da$Sig[comp.da$SpatialFDR.x >= 0.1 & comp.da$SpatialFDR.y < 0.1] <- "GLM"
comp.da$Sig[comp.da$SpatialFDR.x < 0.1 & comp.da$SpatialFDR.y >= 0.1] <- "GLMM"

ggplot(comp.da, aes(x=logFC.x, y=logFC.y)) +
    geom_point(data=comp.da[, c("logFC.x", "logFC.y")], aes(x=logFC.x, y=logFC.y),
               colour='grey80', size=1) +
    geom_point(aes(colour=Sig)) +
    labs(x="GLMM LFC", y="GLM LFC") +
    facet_wrap(~Sig) +
    NULL
```


```{r, results="asis", eval=FALSE}
gogo()
```

```{r, results="asis", eval=FALSE}
library(scRNAseq)
# uncomment the row below to allow multi-processing and comment out the SerialParam line.
# bpparam <- MulticoreParam(workers=4)
bpparam <- SerialParam()
register(bpparam)

pbmc.sce <- KotliarovPBMCData(mode="rna", ensembl=TRUE) # download the PBMC data from Kotliarov _et al._
```

```{r, results="asis", eval=FALSE}
# downsample cells to reduce compute time
prop.cells <- 0.75
n.cells <- floor(ncol(pbmc.sce) * prop.cells)
set.seed(42)
keep.cells <- sample(colnames(pbmc.sce), size=n.cells)
pbmc.sce <- pbmc.sce[, colnames(pbmc.sce) %in% keep.cells]


# downsample the number of samples
colData(pbmc.sce)$ObsID <- paste(colData(pbmc.sce)$tenx_lane, colData(pbmc.sce)$sampleid, sep="_")
n.samps <- 80
keep.samps <- sample(unique(colData(pbmc.sce)$ObsID), size=n.samps)
keep.cells <- rownames(colData(pbmc.sce))[colData(pbmc.sce)$ObsID %in% keep.samps]
pbmc.sce <- pbmc.sce[, colnames(pbmc.sce) %in% keep.cells]

pbmc.sce

```

```{r, results="asis", eval=FALSE}
pbmc.milo <- Milo(pbmc.sce) # from the SCE object
```

```{r, results="asis", eval=FALSE}
pbmc.design <- data.frame(colData(pbmc.milo))[,c("tenx_lane", "adjmfc.time", "sample", "sampleid", "timepoint", "ObsID")]
pbmc.design <- distinct(pbmc.design)
rownames(pbmc.design) <- pbmc.design$ObsID        
```


```{r, results="asis", eval=FALSE}
pbmc.design      
```


```{r, results="asis", eval=FALSE}
pbmc.design %>% count(tenx_lane, ObsID, adjmfc.time)   
```


```{r, results="asis", eval=FALSE}
pbmc.design %>%
  group_by(tenx_lane) %>%
  summarise(count = n_distinct(adjmfc.time)) 
```

```{r, results="asis", eval=FALSE}
symp.design %>% count(tenx_lane, ObsID)   
```

```{r, results="asis"}

```

```{r, results="asis"}

```


```{r, results="asis"}
# gogo()
```
## MUSCAT


```{r, results="asis"}
## solution to error https://github.com/HelenaLC/muscat/issues/88

m2_asex_tr_sce_musct <- prepSCE(m2_asex_tr_sce_pt_chunks, 
               kid = "ptime_cat", # subpopulation assignments
               gid = "Symptomatic",  # group IDs (ctrl/stim)
               sid = "donor",   # sample IDs (ctrl/stim.1234)
               drop = TRUE) #
```

```{r, results="asis"}
pb <- aggregateData(m2_asex_tr_sce_musct,
    assay = "counts", 
    fun = "sum")

# one sheet per subpopulation
assayNames(pb)
```

```{r, results="asis"}
t(head(assay(pb)))
```



```{r, results="asis"}
pb_mds <- pbMDS(pb)
# use very distinctive shaping of groups & change cluster colors
pb_mds <- pb_mds + 
  scale_shape_manual(values = c(17, 4)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(8, "Set2"))
# change point size & alpha
pb_mds$layers[[1]]$aes_params$size <- 5
pb_mds$layers[[1]]$aes_params$alpha <- 0.6
# pb_mds
```

```{r, results="asis"}
# run DS analysis
res <- pbDS(pb, verbose = FALSE)
# access results table for 1st comparison
tbl <- res$table[[1]]
# one data.frame per cluster
names(tbl)
```

```{r, results="asis"}
# view results for 1st cluster
k1 <- tbl[[2]]
head(format(k1[, -ncol(k1)], digits = 2))
```

```{r, results="asis"}
# construct design & contrast matrix
ei <- metadata(m2_asex_tr_sce_musct)$experiment_info
mm <- model.matrix(~ 0 + ei$group_id)
dimnames(mm) <- list(ei$sample_id, levels(ei$group_id))
contrast <- makeContrasts("Yes-No", levels = mm)

# run DS analysis
pbDS(pb, design = mm, contrast = contrast)
```


```{r, results="asis"}
# filter FDR < 5%, abs(logFC) > 1 & sort by adj. p-value
tbl_fil <- lapply(tbl, function(u) {
  u <- dplyr::filter(u, p_adj.loc < 0.3, abs(logFC) > .01)
  dplyr::arrange(u, p_adj.loc)
})

# nb. of DS genes & % of total by cluster
n_de <- vapply(tbl_fil, nrow, numeric(1))
p_de <- format(n_de / nrow(m2_asex_tr_sce_musct) * 100, digits = 3)
data.frame("#DS" = n_de, "%DS" = p_de, check.names = FALSE)
```



```{r, results="asis"}
# view top 2 hits in each cluster
top2 <- bind_rows(lapply(tbl_fil, top_n, 2, p_adj.loc))
format(top2[, -ncol(top2)], digits = 2)
```



```{r, results="asis"}
frq <- calcExprFreqs(m2_asex_tr_sce_musct, assay = "counts", th = 0)
# one sheet per cluster
assayNames(frq)
```


```{r, results="asis"}
# expression frequencies in each
# sample & group; 1st cluster
t(head(assay(frq), 5))
```



```{r, results="asis"}
gids <- levels(m2_asex_tr_sce_musct$group_id)
frq10 <- vapply(as.list(assays(frq)), 
  function(u) apply(u[, gids] > 0.00001, 1, any), 
  logical(nrow(m2_asex_tr_sce_musct)))
t(head(frq10))
```

```{r, results="asis"}
nk <- length(kids <- levels(m2_asex_tr_sce_musct$cluster_id))
ns <- length(sids <- levels(m2_asex_tr_sce_musct$sample_id))
names(kids) <- kids; names(sids) <- sids
```



```{r, results="asis"}
tbl_fil2 <- lapply(kids, function(k)
  tryCatch(
    expr = { dplyr::filter(tbl_fil[[k]], 
    gene %in% names(which(frq10[, k])))}, error = function(e) NULL))

tbl_fil2<-tbl_fil2[!sapply(tbl_fil2,is.null)]

# nb. of DS genes & % of total by cluster
n_de <- vapply(tbl_fil2, nrow, numeric(1))
p_de <- format(n_de / nrow(m2_asex_tr_sce_musct) * 100, digits = 3)
data.frame("#DS" = n_de, "%DS" = p_de, check.names = FALSE)
```


```{r, results="asis", eval=FALSE}
# tidy format; attach pre-computed expression frequencies
resDS(m2_asex_tr_sce_musct, res, bind = "row", frq = frq)

# big-table (wide) format; attach CPMs
resDS(m2_asex_tr_sce_musct, res, bind = "col", cpm = TRUE)
```


```{r, results="asis"}
# compute expression frequencies on the fly
resDS(m2_asex_tr_sce_musct, res, frq = TRUE)
```


```{r, results="asis", eval=FALSE}
library(UpSetR)
de_gs_by_k <- map(tbl_fil, "gene")
upset(fromList(de_gs_by_k))
```


```{r, results="asis", eval=FALSE}
# pull top-8 DS genes across all clusters
top8 <- bind_rows(tbl_fil) %>% 
  slice_min(p_adj.loc, n = 8, 
    with_ties = FALSE) %>% 
  pull("gene")

# for ea. gene in 'top8', plot t-SNE colored by its expression 
ps <- lapply(top8, function(g)
  .plot_dr(m2_asex_tr_sce_musct[, cs100], "TSNE", g) + 
    ggtitle(g) + theme(legend.position = "none"))

# arrange plots
plot_grid(plotlist = ps, ncol = 4, align = "vh")
```


```{r, results="asis"}
plotExpression(m2_asex_tr_sce_musct[, m2_asex_tr_sce_musct$cluster_id == "ptime_4"],
  features = tbl_fil$ptime_3$gene[seq_len(1)],
  x = "sample_id", colour_by = "group_id", ncol = 3) +
  guides(fill = guide_legend(override.aes = list(size = 5, alpha = 1))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results="asis"}
plotExpression(m2_asex_tr_sce_musct[, m2_asex_tr_sce_musct$cluster_id == "ptime_4"],
  features = tbl_fil$ptime_4$gene[seq_len(2)],
  x = "sample_id", colour_by = "group_id", ncol = 3) +
  guides(fill = guide_legend(override.aes = list(size = 5, alpha = 1))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r, results="asis", eval=FALSE}
# top-5 DS genes per cluster
pbHeatmap(m2_asex_tr_sce_musct, res[[1]], k = "ptime_4")
```


```{r, results="asis", eval=FALSE}
# top-5 DS genes per cluster
pbHeatmap(m2_asex_tr_sce_musct, res, top_n = 1)
```

## MUSCAT mixed

```{r, results="asis", eval=F}
## solution to error https://github.com/HelenaLC/muscat/issues/88

m2_asex_tr_sce_musct_sd <- prepSCE(m2_asex_tr_sce_pt_chunks, 
               kid = "ptime_cat", # subpopulation assignments
               gid = "Symptomatic",  # group IDs (ctrl/stim)
               sid = "StrainDon",   # sample IDs (ctrl/stim.1234)
               # drop = TRUE
               ) #
```

```{r, results="asis", eval=F}
# 1st approach
mm <- mmDS(m2_asex_tr_sce_musct_sd, method = "nbinom",
  n_cells = 10, n_samples = 2,
  min_count = 1, min_cells = 20)

# 2nd & 3rd approach
# mm <- mmDS(m2_asex_tr_sce_musct, method = "vst", vst = "sctransform")
# mm <- mmDS(m2_asex_tr_sce_musct, method = "nbinom")
```



## MUSCAT

```{r, results="asis"}
## solution to error https://github.com/HelenaLC/muscat/issues/88

m2_asex_tr_sce_musct345 <- prepSCE(m2_asex_tr_sce_pt_chunks_345, 
               kid = "ptime_cat", # subpopulation assignments
               gid = "Symptomatic",  # group IDs (ctrl/stim)
               sid = "donor",   # sample IDs (ctrl/stim.1234)
               drop = TRUE) #
```

```{r, results="asis"}
pb <- aggregateData(m2_asex_tr_sce_musct345,
    assay = "counts", 
    fun = "sum")

# one sheet per subpopulation
assayNames(pb)
```

```{r, results="asis"}
t(head(assay(pb)))
```



```{r, results="asis"}
pb_mds <- pbMDS(pb)
# use very distinctive shaping of groups & change cluster colors
pb_mds <- pb_mds + 
  scale_shape_manual(values = c(17, 4)) +
  scale_color_manual(values = RColorBrewer::brewer.pal(8, "Set2"))
# change point size & alpha
pb_mds$layers[[1]]$aes_params$size <- 5
pb_mds$layers[[1]]$aes_params$alpha <- 0.6
# pb_mds
```

```{r, results="asis"}
# run DS analysis
res <- pbDS(pb, verbose = FALSE)
# access results table for 1st comparison
tbl <- res$table[[1]]
# one data.frame per cluster
names(tbl)
```

```{r, results="asis"}
# view results for 1st cluster
k1 <- tbl[[2]]
head(format(k1[, -ncol(k1)], digits = 2))
```

```{r, results="asis"}
# construct design & contrast matrix
ei <- metadata(m2_asex_tr_sce_musct345)$experiment_info
mm <- model.matrix(~ 0 + ei$group_id)
dimnames(mm) <- list(ei$sample_id, levels(ei$group_id))
contrast <- makeContrasts("Yes-No", levels = mm)

# run DS analysis
pbDS(pb, design = mm, contrast = contrast)
```


```{r, results="asis"}
# filter FDR < 5%, abs(logFC) > 1 & sort by adj. p-value
tbl_fil <- lapply(tbl, function(u) {
  u <- dplyr::filter(u, p_adj.loc < 0.3, abs(logFC) > .01)
  dplyr::arrange(u, p_adj.loc)
})

# nb. of DS genes & % of total by cluster
n_de <- vapply(tbl_fil, nrow, numeric(1))
p_de <- format(n_de / nrow(m2_asex_tr_sce_musct345) * 100, digits = 3)
data.frame("#DS" = n_de, "%DS" = p_de, check.names = FALSE)
```



```{r, results="asis"}
# view top 2 hits in each cluster
top2 <- bind_rows(lapply(tbl_fil, top_n, 2, p_adj.loc))
format(top2[, -ncol(top2)], digits = 2)
```



```{r, results="asis"}
frq <- calcExprFreqs(m2_asex_tr_sce_musct345, assay = "counts", th = 0)
# one sheet per cluster
assayNames(frq)
```


```{r, results="asis"}
# expression frequencies in each
# sample & group; 1st cluster
t(head(assay(frq), 5))
```



```{r, results="asis"}
gids <- levels(m2_asex_tr_sce_musct345$group_id)
frq10 <- vapply(as.list(assays(frq)), 
  function(u) apply(u[, gids] > 0.00001, 1, any), 
  logical(nrow(m2_asex_tr_sce_musct345)))
t(head(frq10))
```

```{r, results="asis"}
nk <- length(kids <- levels(m2_asex_tr_sce_musct345$cluster_id))
ns <- length(sids <- levels(m2_asex_tr_sce_musct345$sample_id))
names(kids) <- kids; names(sids) <- sids
```



```{r, results="asis"}
tbl_fil2 <- lapply(kids, function(k)
  tryCatch(
    expr = { dplyr::filter(tbl_fil[[k]], 
    gene %in% names(which(frq10[, k])))}, error = function(e) NULL))

tbl_fil2<-tbl_fil2[!sapply(tbl_fil2,is.null)]

# nb. of DS genes & % of total by cluster
n_de <- vapply(tbl_fil2, nrow, numeric(1))
p_de <- format(n_de / nrow(m2_asex_tr_sce_musct345) * 100, digits = 3)
data.frame("#DS" = n_de, "%DS" = p_de, check.names = FALSE)
```


```{r, results="asis", eval=FALSE}
# tidy format; attach pre-computed expression frequencies
resDS(m2_asex_tr_sce_musct345, res, bind = "row", frq = frq)

# big-table (wide) format; attach CPMs
resDS(m2_asex_tr_sce_musct345, res, bind = "col", cpm = TRUE)
```


```{r, results="asis"}
# compute expression frequencies on the fly
resDS(m2_asex_tr_sce_musct345, res, frq = TRUE)
```


```{r, results="asis", eval=FALSE}
library(UpSetR)
de_gs_by_k <- map(tbl_fil, "gene")
upset(fromList(de_gs_by_k))
```


```{r, results="asis", eval=FALSE}
# pull top-8 DS genes across all clusters
top8 <- bind_rows(tbl_fil) %>% 
  slice_min(p_adj.loc, n = 8, 
    with_ties = FALSE) %>% 
  pull("gene")

# for ea. gene in 'top8', plot t-SNE colored by its expression 
ps <- lapply(top8, function(g)
  .plot_dr(m2_asex_tr_sce_musct345[, cs100], "TSNE", g) + 
    ggtitle(g) + theme(legend.position = "none"))

# arrange plots
plot_grid(plotlist = ps, ncol = 4, align = "vh")
```


```{r, results="asis"}
plotExpression(m2_asex_tr_sce_musct345[, m2_asex_tr_sce_musct345$cluster_id == "ptime_4"],
  features = tbl_fil$ptime_3$gene[seq_len(1)],
  x = "sample_id", colour_by = "group_id", ncol = 3) +
  guides(fill = guide_legend(override.aes = list(size = 5, alpha = 1))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r, results="asis"}
plotExpression(m2_asex_tr_sce_musct345[, m2_asex_tr_sce_musct345$cluster_id == "ptime_4"],
  features = tbl_fil$ptime_4$gene[seq_len(2)],
  x = "sample_id", colour_by = "group_id", ncol = 3) +
  guides(fill = guide_legend(override.aes = list(size = 5, alpha = 1))) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r, results="asis", eval=FALSE}
# top-5 DS genes per cluster
pbHeatmap(m2_asex_tr_sce_musct345, res[[1]], k = "ptime_4")
```


```{r, results="asis", eval=FALSE}
# top-5 DS genes per cluster
pbHeatmap(m2_asex_tr_sce_musct345, res, top_n = 1)
```


## !!NOTE- MISC CODE - TO BE DELETED IF NOT NEEDED PSEUDOBULK DE ON ENTIRE CLUSTER



```{r}
harmony_int <-  readRDS("data/processed/Pf/m2_all/harmony_int.RDS")
```


```{r}
harmony_int <- JoinLayers(harmony_int)
```


```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor) 

```

```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor, StagePrelimC)  %>% pivot_wider(names_from = StagePrelimC, values_from = n)

```

```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor)

```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# pseudobulk the counts based on donor-condition-celltype
pseudo_m2 <- AggregateExpression(harmony_int, assays = "RNA", return.seurat = T, group.by = c("Symptomatic", "donor", "StageFL"))

# each 'cell' is a donor-condition-celltype pseudobulk profile
tail(Cells(pseudo_m2))
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
pseudo_m2$stage.sympt <- paste(pseudo_m2$StageFL, pseudo_m2$Symptomatic, sep = "_")
```


```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.Fem.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Female_Yes", 
                         ident.2 = "Female_No",
                         test.use = "DESeq2")

head(m2_bulk.Fem.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
# ifnb$donor_id.stim <- paste0(ifnb$stim, "-", ifnb$donor_id)
harmony_int$donor_symptomatic <- paste0(harmony_int$donor, harmony_int$Symptomatic, sep = "_")

# generate violin plot 
Idents(harmony_int) <- "stage.sympt"
# print(merge_dat[merge_dat$gene%in%common[1:2],c('gene','p_val.sc','p_val.bulk')])
```

```{r, fig.width=15, fig.height=5}
harmony_int$stage.sympt <- paste(harmony_int$StageFL, harmony_int$Symptomatic, sep = "_")
Idents(harmony_int) <- "stage.sympt"

```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=10, fig.height=5}
FeaturePlot(harmony_int[,harmony_int$StageFL == "Female"],  reduction = "umap.harmony", features = "PF3D7-1101300", split.by = c("Symptomatic"), ncol = 2, order = T)

```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.FLE.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Female LE_Yes", 
                         ident.2 = "Female LE_No",
                         test.use = "DESeq2")
head(m2_bulk.FLE.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.M.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Male_Yes", 
                         ident.2 = "Male_No",
                         test.use = "DESeq2")
head(m2_bulk.M.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```


```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.ET.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Early trophozoite_Yes", 
                         ident.2 = "Early trophozoite_No",
                         test.use = "DESeq2")
head(m2_bulk.ET.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.LR.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Late ring_Yes", 
                         ident.2 = "Late ring_No",
                         test.use = "DESeq2")
head(m2_bulk.LR.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```



```{r, fig.width=15, fig.height=5}
VlnPlot(pseudo_m2, features = "PF3D7-0114500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
# ifnb$donor_id.stim <- paste0(ifnb$stim, "-", ifnb$donor_id)
harmony_int$donor_symptomatic <- paste0(harmony_int$donor, harmony_int$Symptomatic, sep = "_")

# generate violin plot 
Idents(harmony_int) <- "stage.sympt"
# print(merge_dat[merge_dat$gene%in%common[1:2],c('gene','p_val.sc','p_val.bulk')])
```

```{r, fig.width=15, fig.height=5}
harmony_int$stage.sympt <- paste(harmony_int$StageFL, harmony_int$Symptomatic, sep = "_")
Idents(harmony_int) <- "stage.sympt"

```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1401300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1401300", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") 
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1240400", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") 
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```

###################### MISCellanous DREAMLET START - to be deleted   ############################################

## Dreamlet

```{r, results="asis"}
# Since 'ind' is the individual and 'StimStatus' is the stimulus status,
# create unique identifier for each sample
# m2_asex_tr_sce$id <- paste0(m2_asex_tr_sce$Symptomatic, m2_asex_tr_sce$donor, m2_asex_tr_sce$StrainDon)
m2_asex_tr_sce_pt_chunks$id <- paste0(m2_asex_tr_sce_pt_chunks$Symptomatic, m2_asex_tr_sce_pt_chunks$donor)


# Create pseudobulk data by specifying cluster_id and sample_id
# Count data for each cell type is then stored in the `assay` field
# assay: entry in assayNames(sce) storing raw counts
# cluster_id: variable in colData(sce) indicating cell clusters
# sample_id: variable in colData(sce) indicating sample id for aggregating cells
m2_asex_tr_pb <- aggregateToPseudoBulk(m2_asex_tr_sce_pt_chunks,
  assay = "counts",
  # cluster_id = "StageFL",
  cluster_id = "ptime_cat",
  sample_id = "id",
  verbose = FALSE
)

# one 'assay' per cell type
assayNames(m2_asex_tr_pb)
```



```{r, results="asis"}
# one 'assay' per cell type
assayNames(m2_asex_tr_pb)

metadata(m2_asex_tr_pb)$aggr_means
```


```{r, results="asis"}

# form <- ~ (1|donor) + Symptomatic + pseudotime
form <- ~ Symptomatic + pseudotime

# Normalize and apply voom/voomWithDreamWeights
res.proc <- processAssays(m2_asex_tr_pb, form, min.count = 2)

# the resulting object of class dreamletProcessedData stores
# normalized data and other information
res.proc
```

```{r, results="asis", eval=FALSE}
gogo()
```

```{r, results="asis"}
# Normalize and apply voom/voomWithDreamWeights
details(res.proc)
```

```{r, results="asis"}
# show voom plot for each cell clusters
plotVoom(res.proc)
```

```{r, results="asis"}

# run variance partitioning analysis
vp.lst <- fitVarPart(res.proc, form)
```

```{r, results="asis"}
# Show variance fractions at the gene-level for each cell type
genes <- vp.lst$gene[1:2]
plotPercentBars(vp.lst[vp.lst$gene %in% genes, ])
```


```{r, results="asis", fig.width=10, fig.height=10}
# Summarize variance fractions genome-wide for each cell type
plotVarPart(vp.lst, label.angle = 60)
```

```{r, results="asis"}
# Differential expression analysis within each assay,
# evaluated on the voom normalized data
res.dl <- dreamlet(res.proc, form, method = "random")

# names of estimated coefficients
coefNames(res.dl)
```

```{r, results="asis"}
# the resulting object of class dreamletResult
# stores results and other information
res.dl
```

```{r, results="asis"}
plotVolcano(res.dl, coef = "SymptomaticSymptomatic")
```

```{r, results="asis"}
# genes <- c("PF3D7-1240400", "PF3D7-1240900")
# plotGeneHeatmap(res.dl, coef = "SymptomaticSymptomatic", genes = genes)
```

```{r, results="asis"}
conflicts_prefer(dreamlet::topTable)
# results from full analysis
topTable(res.dl, coef = "SymptomaticSymptomatic")
```

```{r, results="asis"}
# only B cells
topTable(res.dl[["ptime_3"]], coef = "SymptomaticSymptomatic")
```

```{r, results="asis"}
plotForest(res.dl, coef = "SymptomaticSymptomatic", gene = c("PF3D7-1240400"))
```

```{r, results="asis"}
# get data
df <- extractData(res.proc, "ptime_3", genes = "PF3D7-1240400")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-1240400`)) +
  geom_boxplot() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-1240400")
```

```{r, results="asis"}
# create a contrasts called 'Diff' that is the difference between expression
# in the stimulated and controls.
# More than one can be specified
contrasts <- c(Diff = "SymptomaticSymptomatic - SymptomaticNonSymptomatic")

# Evalaute the regression model without an intercept term.
# Instead estimate the mean expression in stimulated, controls and then
# set Diff to the difference between the two
res.dl2 <- dreamlet(res.proc, ~ 0 + Symptomatic, contrasts = contrasts)

# see estimated coefficients
coefNames(res.dl2)
```

```{r, results="asis"}
# Volcano plot of Diff
plotVolcano(res.dl2[1:2], coef = "Diff")
```

```{r, results="asis"}
# results from full analysis
topTable(res.dl, coef = "SymptomaticSymptomatic")

```


```{r, results="asis"}
# results from full analysis
# topTable(res.dl, coef = "SymptomaticNonSymptomatic")

```


```{r, results="asis", eval=FALSE}
# results from full analysis
topTable(res.dl, coef = "SymptomaticNonSymptomatic")

```

```{r, results="asis", eval=FALSE}
gogo()
```

###################### MISCellanous DREAMLET END - to be deleted   ############################################

