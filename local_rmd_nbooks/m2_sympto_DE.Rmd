---
title: "Integration of donor only and with lab"
date: "2024-01-05"
author: "Jesse Rop"
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  # library(sctransform)
  # library(rgl)
  library(ggrepel)
  # library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  # library(ggnewscale)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  # library(scmap)
  library(SingleCellExperiment)
  library(pheatmap)
  library(plotly)
  # library(Hmisc)
  # library(rmarkdown)
  library(RColorBrewer)
  # library(MAST)
  library(ggvenn)
  # library("biomaRt")
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(dreamlet)
  library(muscat)
  library(ExperimentHub)
  library(zenith)
  library(scater)
  library(slingshot)
  library(harmony)
  library(ggforce)
  library(miloR)
  library(scater)
  library(scran)
  library(patchwork)
  # library(scRNAseq)
  library(scuttle)
  library(irlba)
  library(BiocParallel)
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflicts_prefer(dplyr::count)
  conflicts_prefer(base::as.data.frame)
  
})
```


#  integration of all MSC

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/plotting_common_fns.R")
source("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/mali22_code/pf_common_vars.R")
```

```{r setup}
sample_set = "Mali2"

optimum_k_qcd <- c("MSC33" =8, "MSC48" =4, "MSC49" =6, "MSC55" =7, "MSC60" =7, "MSC66" =8, "MSC38" =4, "MSC40" =8, "MSC50_MACS" =1, "MSC53" =1, "MSC57" =1, "MSC24" =1, "MSC37" =5, "MSC39" =4, "MSC45" =1, "MSC50_SLO" =1, "MSC54" =1, "MSC67" =1, "MSC68" =3, "MSC70" =1)

optimum_k_qcd <- optimum_k_qcd[sort(names(optimum_k_qcd))]

# knitr::opts_knit$set(root.dir = paste0("/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/", sample_set))
knitr::opts_knit$set(root.dir = paste0("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/", sample_set))
```


NB-LOCAL CODE
```{r, eval=F}

system(paste0("rsync -av jr35@farm5:/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/",sample_set,"/data/processed/Pf/all_msc_filt_no_dblts.RDS /Users/jr35/Google\\ Drive/My\\ Drive/PHD_documents/malaria_phd/",sample_set,"/data/processed/Pf/"
))

```

initialize variable for the sample names

```{r}
all_msc_filt_no_dblts <- readRDS("data/processed/Pf/all_msc_filt_no_dblts.RDS")
```


```{r}
strn_c_new_mdata_m22_min_qcd <- readRDS("data/processed/Pf/strn_c_new_mdata_m22_min_qcd.RDS")
```


```{r, fig.width=12, fig.height=4}
# add stage metadata
all_msc_filt_no_dblts <- pmap(list(all_msc_filt_no_dblts[names(strn_c_new_mdata_m22_min_qcd)], strn_c_new_mdata_m22_min_qcd, names(strn_c_new_mdata_m22_min_qcd)), ~{
  ..2 %>% 
  mutate(StrainDon = paste0(str_remove(..3, "SC"), "_", StrainQCd)) %>%
  select(bcode, StrainQCd, StrainDon) %>% 
    column_to_rownames("bcode") %>%
  AddMetaData(..1,.)
})

```


```{r, eval=T}

imap(all_msc_filt_no_dblts, ~DimPlot(.x, group.by = "StrainDon")  + labs(title = .y))
```


```{r}
msc_qcd_anotd <-readRDS("../Mali/data/processed/DB52e_star/msc_qcd_anotd.RDS")

```

```{r, eval=T}

msc_qcd_anotd_mdata_14 <- msc_qcd_anotd[["MSC14"]]@meta.data %>% mutate(StrainQCd= strain_qcd) 
```


```{r, fig.width = 18, fig.height = 4, message=FALSE, warning=FALSE}

strn_c_new_mdata_m22_min_qcd <-  strn_c_new_mdata_m22_min_qcd[names(optimum_k_qcd[optimum_k_qcd>1])]

ss_bar_plt <-list( c(strn_c_new_mdata_m22_min_qcd, list(msc_qcd_anotd_mdata_14 )), c(names(strn_c_new_mdata_m22_min_qcd), "MSC14"))  %>% 
  purrr::pmap(.,~{
  a_tbl <- ..1 %>%
      mutate(across(stage_afm, ~factor(., levels=c('Asexual', 'Female', 'Male', 'Developing', 'Unassigned')))) %>%
      dplyr::count(StrainQCd, stage_afm, .drop = FALSE) 
  
  ##get stage_ag labels and counts to add to the StrainQCd+stage_afm counts generated above
  stage_ag_cnt <- ..1 %>% 
    dplyr::select(StrainQCd, stage_ag, stage_afm) %>% 
    add_count(StrainQCd, stage_ag, name = 'stage_ag_n') %>% 
    distinct(pick(StrainQCd, stage_afm), .keep_all = T) %>% 
    left_join(a_tbl, ., by =c('StrainQCd', 'stage_afm')) %>% 
    rename(c('Stage'= stage_afm, 'Counts' =n, 'Strain' = StrainQCd))  
  
  print(stage_ag_cnt)
  
    b_plt <- stage_ag_cnt %>%
      # ggplot(., aes(x = Stage, y = Counts, fill = Stage, color=stage_ag_n<30)) +
      ggplot(., aes(x = Stage, y = Counts, fill = Stage)) +
      geom_col(position = position_dodge2()) + #width=0.4, position = position_dodge(width=0.5) 
      geom_text(aes(label=Counts), hjust=0.5, vjust= -0.3, position = position_dodge(width = .9), size = 7, show.legend = F, fontface ='bold', colour='black')+
      scale_fill_manual(values = c_stg_cols) + #'Asexual' = "#FFE5B4", 'Male' = "#BFD7B5", 'Female'="#8ab6d6"
      # scale_color_manual(values = c('FALSE' = "white", 'TRUE' = "blue")) +
  geom_tile(aes(x = Stage, y = -10, fill = Stage, height = 14)) +
  facet_wrap( Strain ~ ., nrow = 1) +
      scale_y_continuous(expand = expansion(mult = c(0.01, 0.15))) +
      scale_x_discrete(expand = expansion(add = c(1, 1))) +
      theme_classic() +
  labs( y = 'Counts', title = ..2)+
      theme(
        axis.text.y  = element_text(size = 22),
        axis.title.y  = element_text(size = 22, face = "bold"),
        axis.title.x = element_blank(),
        # axis.title = element_text(size = 18, face = "bold"),
        legend.text = element_text(size = 22),
        legend.title = element_text(size = 22, face = "bold"),
        legend.position="bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text =element_text(size=20,face="bold", colour = 'black'),
        panel.border=element_rect(colour="black",fill='transparent')
      )+ 
      guides(color = F)
    print(b_plt)
    return(b_plt)
})


```

```{r, fig.width=12, fig.height=4}
# add stage metadata
all_msc_filt_no_dblts <- map(all_msc_filt_no_dblts, ~{
  .x@meta.data %>% 
  rownames_to_column('bcode') %>%
  mutate(donor = str_remove(orig.ident, ".mrna"), 
         # strain_don = case_when(str_detect(orig.ident, "MSC") ~ paste0(Strain_DN, "_", donor))
         ) %>%
  left_join(., irods_id_sk21_mdata_cln %>% select(sample_nm, Symptomatic, Hb_Type), by = c("donor" = "sample_nm")) %>%
  select(bcode, donor, Symptomatic, Hb_Type) %>%
  column_to_rownames('bcode') %>% 
  AddMetaData(.x,.)
})

```



```{r, eval=T}

imap(all_msc_filt_no_dblts, ~DimPlot(.x, group.by = "StagePrelimC") + scale_color_manual(values = sp_fld_colors) + labs(title = .y))
```

```{r, eval=T}

imap(all_msc_filt_no_dblts, ~DimPlot(.x, group.by = "StagePrelimC", reduction = "pca") + scale_color_manual(values = sp_fld_colors) + labs(title = .y))
```

```{r}
all_msc_filt_no_dblts <- all_msc_filt_no_dblts[!names(all_msc_filt_no_dblts) %in% c("MSC38", "MSC39")]
```



```{r}
##Read MCA V3 blood stage reference dataset
# EF_V3_ref <- readRDS("../sc_velo/data/raw/RoadtoUMAP/pseudotime/raw_combined_cut_0.4.RDS")
EF_V3_ref <- readRDS("../Mali/data/raw/mca_v3_ref/raw_combined_cut_0.4_nodoublets_stagenew.RDS")
```

```{r}
##make refined metadata column that includes the gametocyte substages for finer resolution mapping
EF_V3_ref <- EF_V3_ref@meta.data %>%
  mutate(stage_fine = case_when(optionB_Stage == "no assignment" ~ as.character(Stage),
                                TRUE ~ as.character(optionB_Stage))
  ) %>% 
  mutate(across(stage_fine, ~str_to_sentence(str_replace_all(., c("Gametocytes"="Gametocyte", "comitted" = "committed"))))) %>%
  mutate(across(stage_fine, ~droplevels(factor(., levels = stg_refnd_lvls)))) %>%
  mutate(across(stagenewx, ~droplevels(factor(str_to_sentence(.), levels = stg_refnd_lvls)))) %>% 
  dplyr::select(stage_fine, stagenewx) %>%
  AddMetaData(EF_V3_ref, .)
```




```{r}
harmony_int <-  readRDS("data/processed/Pf/m2_all/harmony_int.RDS")
```


```{r}
harmony_int <- JoinLayers(harmony_int)
```


```{r}

DimPlot(harmony_int, reduction = "umap.harmony", group.by = c("StagePrelimAll", "harmony_clusters"), combine = F, label = T)
```

```{r, fig.width=6, fig.height=5}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(harmony_int, reduction = "umap.harmony", group.by = "StagePrelim", label = F, dims = c(1,2)) + scale_color_manual(values = sp_fld_colors)
```




```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(harmony_int@reductions[["umap.harmony"]]@cell.embeddings),
        x = ~umapharmony_1, y = ~umapharmony_2, z = ~umapharmony_3,
        color= harmony_int@meta.data$StagePrelimC,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 1, 
        type = 'scatter3d'
)

```


```{r}
v3_m2_asex_harmony <-  readRDS("data/processed/Pf/m2_all/v3_m2_asex_harmony.RDS")
```


```{r}
v3_m2_asex_harmony <- JoinLayers(v3_m2_asex_harmony)
```


```{r, fig.width=6, fig.height=5}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "StagePrelimC", label = F, dims = c(1,2)) + scale_color_manual(values = sp_fld_colors)
```

```{r, fig.width=12, fig.height=4}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = c("orig.ident", "StagePrelim"), label = F)
```


```{r, fig.width=6, fig.height=5}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "harmony_clusters_asex", label = T, dims = c(1,2))
```




```{r, fig.width=12, fig.height=4}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = c("StageFL"), label = F)
```

```{r, fig.width=12, fig.height=4}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "pca", group.by = c("StageFL"), label = F)
```

```{r, fig.width=12, fig.height=4}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
DimPlot(v3_m2_asex_harmony, reduction = "pca", group.by = c("dset"), label = F)
```

```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_harmony@reductions[["pca"]]@cell.embeddings),
        x = ~PC_1, y = ~PC_2, z = ~PC_3,
        color= v3_m2_asex_harmony@meta.data$StageFL,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.2, 
        type = 'scatter3d'
)

```



```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_harmony@reductions[["umap.harmony"]]@cell.embeddings),
        x = ~umapharmony_1, y = ~umapharmony_2, z = ~umapharmony_3,
        color= v3_m2_asex_harmony@meta.data$StageFL,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.2, 
        type = 'scatter3d'
)

```


```{r, warning=FALSE, message=FALSE, eval=FALSE}
# Display the combined datasets as an interactive 3D plot

plot_ly(data = data.frame(v3_m2_asex_harmony@reductions[["umap.harmony"]]@cell.embeddings),
        x = ~umapharmony_1, y = ~umapharmony_2, z = ~umapharmony_3,
        color= v3_m2_asex_harmony@meta.data$StageFL,
        # colors = c('blue', 'red'),
        opacity = 0.8,
        size = 0.2, 
        type = 'scatter3d'
)

```


```{r}
strn_c_new_mdata_m22_min_qcd_mg <- strn_c_new_mdata_m22_min_qcd %>% 
  bind_rows(., .id = "donor") %>% 
  mutate(bcode = paste0(str_remove(donor, "SC"), "_", bcode), 
         StrainDon = paste0(str_remove(donor, "SC"), "_", StrainQCd)) %>%
  select(bcode, StrainQCd, StrainDon) %>% 
  column_to_rownames("bcode") 
```

```{r, fig.width=12, fig.height=4}
# add stage metadata
v3_m2_asex_harmony <- strn_c_new_mdata_m22_min_qcd_mg %>% select(StrainDon) %>%  AddMetaData(v3_m2_asex_harmony,.)

```

```{r, fig.width=12, fig.height=4}
# add stage metadata
v3_m2_asex_harmony <- v3_m2_asex_harmony@meta.data %>% 
  rownames_to_column('bcode') %>%
  mutate(donor = str_remove(orig.ident, ".mrna"), 
         # strain_don = case_when(str_detect(orig.ident, "MSC") ~ paste0(Strain_DN, "_", donor))
         ) %>%
  left_join(., irods_id_sk21_mdata_cln %>% select(sample_nm, Symptomatic, Hb_Type), by = c("donor" = "sample_nm")) %>%
  select(bcode, donor, Symptomatic, Hb_Type) %>%
  column_to_rownames('bcode') %>% 
  AddMetaData(v3_m2_asex_harmony,.)

```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony@meta.data %>% filter(str_detect(donor, "MSC")) %>% dplyr::count(donor, Symptomatic, Hb_Type)
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
m2_asex_harmony_tr <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# pseudobulk the counts based on donor-condition-celltype
pseudo_m2_asex <- AggregateExpression(m2_asex_harmony_tr, assays = "RNA", return.seurat = T, group.by = c("Symptomatic", "donor", "StagePrelim"))

# each 'cell' is a donor-condition-celltype pseudobulk profile
tail(Cells(pseudo_m2_asex))
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
pseudo_m2_asex$stage.sympt <- paste(pseudo_m2_asex$StagePrelim, pseudo_m2_asex$Symptomatic, sep = "_")
```


```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2_asex) <- "stage.sympt"

bulk.LR.de <- FindMarkers(object = pseudo_m2_asex, 
                         ident.1 = "Late ring_Yes", 
                         ident.2 = "Late ring_No",
                         test.use = "DESeq2")
head(bulk.LR.de, n = 15)
```



```{r, fig.width=15, fig.height=5}

head(bulk.LR.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
#https://www.ncbi.nlm.nih.gov/pmc/articles/PMC6650087/ - PF3D7-1240400
#https://journals.asm.org/doi/10.1128/mbio.01636-21 https://www.frontiersin.org/articles/10.3389/fmala.2023.1075755/full  - hyp10
#http://dr.iiserpune.ac.in:8080/xmlui/bitstream/handle/123456789/7531/20153385_Abhishek_Kanyal_PhD_Thesis.pdf?sequence=1&isAllowed=y - PF3D7-1401300
```

```{r, fig.width=15, fig.height=5}
VlnPlot(pseudo_m2_asex, features = "PF3D7-0114500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
```



```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
# ifnb$donor_id.stim <- paste0(ifnb$stim, "-", ifnb$donor_id)
m2_asex_harmony_tr$donor_symptomatic <- paste0(m2_asex_harmony_tr$donor, m2_asex_harmony_tr$Symptomatic, sep = "_")

# generate violin plot 
Idents(m2_asex_harmony_tr) <- "stage.sympt"
# print(merge_dat[merge_dat$gene%in%common[1:2],c('gene','p_val.sc','p_val.bulk')])
```

```{r, fig.width=15, fig.height=5}
m2_asex_harmony_tr$stage.sympt <- paste(m2_asex_harmony_tr$StagePrelim, m2_asex_harmony_tr$Symptomatic, sep = "_")
Idents(m2_asex_harmony_tr) <- "stage.sympt"

```

```{r, fig.width=7, fig.height=3.5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-0114500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1240400", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1233300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-0819500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1401300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
```


```{r, fig.width=6, fig.height=3}
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"],  reduction = "umap.harmony", features = "PF3D7-0114500", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"],  reduction = "umap.harmony", features = "PF3D7-1240400", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"],  reduction = "umap.harmony", features = "PF3D7-1233300", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"],  reduction = "umap.harmony", features = "PF3D7-0819500", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"],  reduction = "umap.harmony", features = "PF3D7-1401300", split.by = c("Symptomatic"), ncol = 2, order = T)


```


```{r, fig.width=15, fig.height=5}
VlnPlot(pseudo_m2_asex, features = "PF3D7-0114500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
VlnPlot(pseudo_m2_asex, features = "PF3D7-1240400", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
VlnPlot(pseudo_m2_asex, features = "PF3D7-1233300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
VlnPlot(pseudo_m2_asex, features = "PF3D7-0819500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
VlnPlot(pseudo_m2_asex, features = "PF3D7-1401300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 

```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2_asex) <- "stage.sympt"

bulk.ET.de <- FindMarkers(object = pseudo_m2_asex, 
                         ident.1 = "Early trophozoite_Yes", 
                         ident.2 = "Early trophozoite_No",
                         test.use = "DESeq2")

head(bulk.ET.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))

```

```{r, fig.width=7, fig.height=3.5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1401300", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1240400", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1469400", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic")  + theme(legend.position = "none")
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-0321600", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") + theme(legend.position = "none")
```


```{r, fig.width=6, fig.height=3}
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Early trophozoite"],  reduction = "umap.harmony", features = "PF3D7-1401300", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Early trophozoite"],  reduction = "umap.harmony", features = "PF3D7-1240400", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Early trophozoite"],  reduction = "umap.harmony", features = "PF3D7-1469400", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Early trophozoite"],  reduction = "umap.harmony", features = "PF3D7-0321600", split.by = c("Symptomatic"), ncol = 2, order = T)


```


```{r, fig.width=10, fig.height=5}
DimPlot(m2_asex_harmony_tr, reduction = "umap.harmony", group.by = c("Symptomatic", "StagePrelim"), ncol = 2)
```

```{r, fig.width=10, fig.height=5}
DimPlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Late ring"], reduction = "umap.harmony", split.by = c("Symptomatic"), ncol = 2)
```

```{r, fig.width=10, fig.height=5}
DimPlot(m2_asex_harmony_tr[,m2_asex_harmony_tr$StagePrelim == "Early trophozoite"], reduction = "umap.harmony", split.by = c("Symptomatic"), ncol = 2)
```

```{r, fig.width=10, fig.height=5}
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-0114500", split.by = c("Symptomatic"), ncol = 2, order = T)
```


```{r, fig.width=10, fig.height=5}
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-1240400", split.by = c("Symptomatic"), ncol = 2, order = T)
```

```{r, fig.width=30, fig.height=10}
FeaturePlot(m2_asex_harmony_tr, features = "PF3D7-1240400", split.by = "donor_symptomatic", ncol = 5)
```
```{r, fig.width=30, fig.height=10}
FeaturePlot(m2_asex_harmony_tr, features = "PF3D7-0114500", split.by = "donor_symptomatic", ncol = 5)
```

```{r, fig.width=10, fig.height=5}
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-1240400", split.by = c("Symptomatic"), ncol = 2, order = T)
FeaturePlot(m2_asex_harmony_tr,  reduction = "umap.harmony", features = "PF3D7-0114500", split.by = c("Symptomatic"), ncol = 2, order = T)
```



```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(m2_asex_harmony_tr, features = "PF3D7-1240400", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic")
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# m2_asex_harmony_tr <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]
```


```{r, fig.width=12, fig.height=4}
# add stage metadata
# harmony_int <- harmony_int@meta.data %>% 
#   rownames_to_column('bcode') %>%
#   mutate(donor = str_remove(orig.ident, ".mrna"), 
#          strain_don = case_when(str_detect(orig.ident, "MSC") ~ paste0(Strain_DN, "_", donor))
#          ) 
#   select(bcode, donor, strain_don, donor, Symptomatic, Hb_Type) %>%
#   column_to_rownames('bcode') %>% 
#   AddMetaData(harmony_int,.)


```


```{r}
harmony_int <-  readRDS("data/processed/Pf/m2_all/harmony_int.RDS")
```


```{r}
harmony_int <- JoinLayers(harmony_int)
```


```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor) 

```

```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor, StagePrelimC)  %>% pivot_wider(names_from = StagePrelimC, values_from = n)

```

```{r, warning=FALSE, message=FALSE, eval=T}
# Display the combined datasets as an interactive 3D plot
harmony_int@meta.data %>% dplyr::count(Symptomatic, donor)

```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# pseudobulk the counts based on donor-condition-celltype
pseudo_m2 <- AggregateExpression(harmony_int, assays = "RNA", return.seurat = T, group.by = c("Symptomatic", "donor", "StagePrelim"))

# each 'cell' is a donor-condition-celltype pseudobulk profile
tail(Cells(pseudo_m2))
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
pseudo_m2$stage.sympt <- paste(pseudo_m2$StagePrelim, pseudo_m2$Symptomatic, sep = "_")
```


```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.Fem.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Female_Yes", 
                         ident.2 = "Female_No",
                         test.use = "DESeq2")

head(m2_bulk.Fem.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
# ifnb$donor_id.stim <- paste0(ifnb$stim, "-", ifnb$donor_id)
harmony_int$donor_symptomatic <- paste0(harmony_int$donor, harmony_int$Symptomatic, sep = "_")

# generate violin plot 
Idents(harmony_int) <- "stage.sympt"
# print(merge_dat[merge_dat$gene%in%common[1:2],c('gene','p_val.sc','p_val.bulk')])
```

```{r, fig.width=15, fig.height=5}
harmony_int$stage.sympt <- paste(harmony_int$StagePrelim, harmony_int$Symptomatic, sep = "_")
Idents(harmony_int) <- "stage.sympt"

```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=10, fig.height=5}
FeaturePlot(harmony_int[,harmony_int$StagePrelim == "Female"],  reduction = "umap.harmony", features = "PF3D7-1101300", split.by = c("Symptomatic"), ncol = 2, order = T)

```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.FLE.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Female LE_Yes", 
                         ident.2 = "Female LE_No",
                         test.use = "DESeq2")
head(m2_bulk.FLE.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.M.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Male_Yes", 
                         ident.2 = "Male_No",
                         test.use = "DESeq2")
head(m2_bulk.M.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```


```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.ET.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Early trophozoite_Yes", 
                         ident.2 = "Early trophozoite_No",
                         test.use = "DESeq2")
head(m2_bulk.ET.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```

```{r, fig.width=15, fig.height=5}
Idents(pseudo_m2) <- "stage.sympt"

m2_bulk.LR.de <- FindMarkers(object = pseudo_m2, 
                         ident.1 = "Late ring_Yes", 
                         ident.2 = "Late ring_No",
                         test.use = "DESeq2")
head(m2_bulk.LR.de, n = 15) %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene))
```



```{r, fig.width=15, fig.height=5}
VlnPlot(pseudo_m2, features = "PF3D7-0114500", idents = c("Late ring_Yes", "Late ring_No"), group.by = "stage.sympt", ncol = 1) 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
# ifnb$donor_id.stim <- paste0(ifnb$stim, "-", ifnb$donor_id)
harmony_int$donor_symptomatic <- paste0(harmony_int$donor, harmony_int$Symptomatic, sep = "_")

# generate violin plot 
Idents(harmony_int) <- "stage.sympt"
# print(merge_dat[merge_dat$gene%in%common[1:2],c('gene','p_val.sc','p_val.bulk')])
```

```{r, fig.width=15, fig.height=5}
harmony_int$stage.sympt <- paste(harmony_int$StagePrelim, harmony_int$Symptomatic, sep = "_")
Idents(harmony_int) <- "stage.sympt"

```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1401300", idents = c("Late ring_Yes", "Late ring_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```


```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1401300", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") 
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1240400", idents = c("Early trophozoite_Yes", "Early trophozoite_No"), group.by = "donor_symptomatic") 
```

```{r, fig.width=15, fig.height=5}
# create a new column to annotate sample-condition-celltype in the single-cell dataset
VlnPlot(harmony_int, features = "PF3D7-1101300", idents = c("Female_Yes", "Female_No"), group.by = "donor_symptomatic") 
```


#### Slingshot


```{r}
## slingshot
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "harmony_clusters_asex")
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "dset")
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", split.by = "dset", label = T)
```


```{r}
## slingshot
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "harmony_clusters_asex")
DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "dset")
```


```{r}
v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex)
```

```{r}
fld_clusters <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex) %>% pull(harmony_clusters_asex) 

fld_clusters_cutoff <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]@meta.data %>% count(harmony_clusters_asex) %>% filter(n>200) %>% pull(harmony_clusters_asex) 
```

```{r}
## Retained
DimPlot(v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff], reduction = "umap.harmony", split.by = "dset", label = T)
```

```{r}
## Removed
DimPlot(v3_m2_asex_harmony[,!(v3_m2_asex_harmony@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff)], reduction = "umap.harmony", split.by = "dset", label = T)
```


```{r}
## subset where field parasites are for slingshot
v3_m2_asex_harmony_fld_sset <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$harmony_clusters_asex %in% fld_clusters_cutoff]
```


```{r, fig.width=8, fig.height=5}
DimPlot(v3_m2_asex_harmony_fld_sset,  reduction = "umap.harmony", split.by = c("Symptomatic"))
```

## Trajectory inference of integrated object
Adjust to get appropriate clustering so as to input into slingshot
```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"

DimPlot(v3_m2_asex_harmony_fld_sset, reduction = "umap.harmony", label = T)
# msc_gam_combi_noLE <- FindClusters(msc_gam_combi_noLE, resolution = 0.32, verbose = F)

```

```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
DimPlot(v3_m2_asex_harmony_fld_sset, reduction = "umap.harmony", group.by = "harmony_clusters_asex", pt.size = 0.5, dims = c(1,2), label = T)

```

```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
# cl_markrs <- FindMarkers(v3_m2_asex_harmony_fld_sset, ide)

```


```{r}
## 
v3_m2_asex_harmony_fld_sset <- FindClusters(v3_m2_asex_harmony_fld_sset, resolution = 0.05, cluster.name = "harmony_clusters_asex")


```

```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
DimPlot(v3_m2_asex_harmony_fld_sset, reduction = "umap.harmony", group.by = "harmony_clusters_asex", pt.size = 0.5, dims = c(1,2), label = T)

```

```{r}
## subset where field parasites are for slingshot
saveRDS(v3_m2_asex_harmony_fld_sset, "data/processed/Pf/m2_all/v3_m2_asex_harmony_fld_sset.RDS")
```

```{r, eval=T}
# gogo()
## Run SNORM on farm like below
# nextflow run submsn_slingshot.nf --scrpt "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/seurat_sce/slingshot.R" --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/v3_m2_asex_harmony_fld_sset.RDS" --o_file_name "v3_m2_asex_harmony_fld_sshot.RDS" --umap_nm "umap.harmony" --clstr "harmony_clusters_asex" --s_clstr "0" --e_clstr "2" --resume
```


```{r, eval=T}
# gogo()
## Run SNORM on farm like below
# nextflow run submsn_slingshot.nf --scrpt "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/multipurpose_scripts/seurat_sce/slingshot.R" --input_seu "/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/v3_m2_asex_harmony_fld_sset.RDS" --o_file_name "v3_m2_asex_harmony_fld_sshot.RDS" --umap_nm "umap.harmony" --clstr "StageFL" --s_clstr "late ring" --e_clstr "early trophozoite" --resume
```

```{r, eval=T}
v3_m2_asex_harmony_sce_ss <- readRDS("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/processed/Pf/m2_all/v3_m2_asex_harmony_fld_sshot.RDS")
```

```{r, eval =F}
##Raw counts - Preparing single cell experiment object for slingshot trajectory inference and tradeseq DE

#logcounts(msc14_sub_sce[[i]]) <- log2(counts(msc14_sub_sce[[i]]) + 1)
##This command gives error below when running the entire notebook or this whole chunk so run the command independently - coulb be and issue with rmd
##Error in x$.self$finalize() : attempt to apply non-function - need blank line after

sce_obj_creatn <- function( seu_obj, umap = "umap"){

    sce_obj <- SingleCellExperiment(assays = list(counts = as(seu_obj[["RNA"]]$counts, Class = "dgCMatrix")), colData = seu_obj@meta.data)
    
    logcounts(sce_obj) <- log2((counts(sce_obj) + 1))
    normcounts(sce_obj) <- as(seu_obj[["RNA"]]$data, Class = "dgCMatrix")
    rowData(sce_obj)$feature_symbol <- str_replace(rownames(sce_obj), "-", "_")
    reducedDims(sce_obj) <- SimpleList(PCA = seu_obj@reductions[["pca"]]@cell.embeddings, UMAP = seu_obj@reductions[[umap]]@cell.embeddings)
    
    return(sce_obj)

}

```


```{r, eval =F}
# v3_m2_asex_harmony_sce <- sce_obj_creatn(seu_obj = v3_m2_asex_harmony, umap = "umap.harmony")
```

Run slingshot for trajectory inference
```{r, eval =F}
##Function -slingshot

##Run slingshot to determine trajectories
# msc_y21_mca_fem_combi_sce$seurat_clusters <- as.character(msc_y21_mca_fem_combi_sce$seurat_clusters)
# msc_y21_mca_fem_combi_sce <- list(msc_y21_mca_fem_combi_sce, start.clus, end.clus) %>%
# sling_start <- function(sce_obj, s_clstr, clstr ="seurat_clusters", e_clstr = NULL){ 
#   slingshot(sce_obj, 
#             clusterLabels = clstr, 
#             reducedDim = "PCA", 
#             start.clus = s_clstr,
#             end.clus = e_clstr,
#             shrink =1, 
#             stretch = 1,
#             allow.break = F)
#   
# }

```


```{r, fig.width=6, fig.height=5, eval =F}
# visualize by batch and cell type annotation
# cell type annotations were previously added by Azimuth
# DimPlot(v3_m2_asex_harmony, reduction = "umap.harmony", group.by = "StagePrelimC", label = F, dims = c(1,2)) + scale_color_manual(values = sp_fld_colors)
```

```{r, eval =F}
# msc_gam_combi_noLE_sce <- sling_start(sce_obj = msc_gam_combi_noLE_sce, s_clstr = "early stalk", clstr = "stage_int")
# v3_m2_asex_harmony_sce_ss <- sling_start(sce_obj = v3_m2_asex_harmony_sce, s_clstr = "11", clstr = "harmony_clusters_asex")

```

```{r}
##Prepare slingshot dataset (SDS) object 
v3_m2_asex_harmony_sce_ss_sds <- SlingshotDataSet(v3_m2_asex_harmony_sce_ss)

plot(reducedDims(v3_m2_asex_harmony_sce_ss)$PCA[,1:2], col = brewer.pal(9,"Set1")[as.factor(v3_m2_asex_harmony_sce_ss$StagePrelim)], pch=16, asp = 0.7)
lines(v3_m2_asex_harmony_sce_ss_sds, lwd=2, col="black",dims = 1:2)
```




```{r, results="asis"}

umap_meta_df <- reducedDims(v3_m2_asex_harmony_sce_ss)$UMAP[,c(1,2,3)] %>% as.data.frame() %>%rownames_to_column("cell_bc") %>% left_join(., v3_m2_asex_harmony_sce_ss@colData[,c("StagePrelim", "slingPseudotime_1", "slingPseudotime_2", "orig.ident")] %>% as.data.frame() %>% rownames_to_column("cell_bc"), by = "cell_bc")  #%>% 
# mutate(across(strain_dset, ~factor(., levels = rev(strain_dset_lvls_don)))) %>% arrange(strain_dset

tm <- theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        legend.text = element_text(size = 22) ,
        legend.title = element_text(size = 24, face = "bold") )

umap_meta_df %>% 
  ggplot(aes(x = umapharmony_1, y =umapharmony_2, color = slingPseudotime_1)) + geom_point(size=0.5) + 
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  tm

umap_meta_df %>% 
  ggplot(aes(x = umapharmony_2, y =umapharmony_3, color = slingPseudotime_1)) + geom_point(size=0.5) + 
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  tm


```

```{r, results="asis"}

# plot(reducedDims(v3_m2_asex_harmony_sce_ss)$UMAP[,1:2], col = brewer.pal(7,"Set1")[as.factor(v3_m2_asex_harmony_sce_ss$harmony_clusters_asex)], pch=16, asp = 0.7)
# lines(v3_m2_asex_harmony_sce_ss_sds, lwd=2, col="black",dims = 1:2)
# 
# plot(reducedDims(v3_m2_asex_harmony_sce_ss)$UMAP[,2:3], col = brewer.pal(7,"Set1")[as.factor(v3_m2_asex_harmony_sce_ss$harmony_clusters_asex)], pch=16, asp = 0.7)
# lines(v3_m2_asex_harmony_sce_ss_sds, lwd=2, col="black",dims = 2:3)

umap_meta_df <- reducedDims(v3_m2_asex_harmony_sce_ss)$UMAP[,c(1,2)] %>% as.data.frame() %>%rownames_to_column("cell_bc") %>% left_join(., v3_m2_asex_harmony_sce_ss@colData[,c("StagePrelim", "slingPseudotime_1", "slingPseudotime_2", "orig.ident", "StrainDon", "Symptomatic")] %>% as.data.frame() %>% rownames_to_column("cell_bc"), by = "cell_bc")  #%>% 
# mutate(across(strain_dset, ~factor(., levels = rev(strain_dset_lvls_don)))) %>% arrange(strain_dset

plt <- umap_meta_df %>% 
  ggplot(aes(x = umapharmony_1, y =umapharmony_2, color = slingPseudotime_1)) + geom_point(size=0.5) + 
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        legend.text = element_text(size = 22) ,
        legend.title = element_text(size = 24, face = "bold") )

print(plt)

plt <- umap_meta_df %>% 
  ggplot(aes(x = umapharmony_1, y =umapharmony_2, color = slingPseudotime_2)) + geom_point(size=0.5) + 
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Greens") + 
  theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        legend.text = element_text(size = 22) ,
        legend.title = element_text(size = 24, face = "bold") )

print(plt)

plt = umap_meta_df %>% 
  ggplot(., aes(x = slingPseudotime_1, col=StagePrelim, fill=StagePrelim)) + 
  scale_color_manual(name = "Stage", values = sp_fld_colors)+ 
  scale_fill_manual(name = "Stage", values = sp_fld_colors)+
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)


plt = umap_meta_df %>% 
  ggplot(., aes(x = slingPseudotime_2, col=StagePrelim, fill=StagePrelim)) + 
  scale_color_manual(name = "Stage", values = sp_fld_colors)+ 
  scale_fill_manual(name = "Stage", values = sp_fld_colors)+
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)

plt = umap_meta_df %>% 
  ggplot(., aes(x = slingPseudotime_1, col=orig.ident, fill=orig.ident)) + 
  # scale_color_manual(name = "Stage")+
  # scale_fill_manual(name = "Stage")+
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)

plt = umap_meta_df %>% 
  ggplot(., aes(x = slingPseudotime_2, col=orig.ident, fill=orig.ident)) + 
  # scale_color_manual(name = "Stage")+
  # scale_fill_manual(name = "Stage")+
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)


```

## Placing the more sophisticated DE at the top to save on time since MAST findmarkers run takes long

## DREAMLET
## Proper DE accounting for factors
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StagePrelim %in% c("Early trophozoite", "Late ring"))  %>% group_by(StrainDon,StagePrelim) %>% filter(n() > 10) %>% dplyr::count(StrainDon, StagePrelim)
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StagePrelim %in% c("Early trophozoite", "Late ring"))  %>% group_by(StrainDon, StagePrelim) %>% filter(n() > 10) %>% ungroup() %>% add_count(donor, name = "don_count") %>% add_count(StrainDon, name = "strn_count") %>% mutate(strn_prop = strn_count/don_count) %>% dplyr::count(StrainDon, StagePrelim,don_count,strn_count,strn_prop)
```


```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
irods_id_sk21_mdata_cln
```

```{r, fig.width=15, fig.height=5}
donor_mdata <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Manifest_METADATA_raw.csv") 
donor_mdata <- donor_mdata %>% rename_all(., ~str_to_lower(str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "º"=""))))
```

```{r}
donor_mdata   %>% 
  mutate(across(c(parasitaemia_j0, parasitaemia_j1), ~as.numeric(str_remove(., " Pf.*|Tf.*"))), parasitaemia = coalesce(parasitaemia_j0, parasitaemia_j1))  %>% 
  # filter(donor %in% ) %>%
  ggplot(aes(x = symptomatic, y = parasitaemia)) +
  geom_boxplot()
```


```{r, fig.width=15, fig.height=5}
library(lubridate)
donor_mdata <- donor_mdata %>% 
  mutate(across(c(parasitaemia_j0, parasitaemia_j1), ~as.numeric(str_remove(., " Pf.*|Tf.*"))), 
         parasitaemia = coalesce(parasitaemia_j0, parasitaemia_j1),
         sampling_time_cln = lubridate::hms(paste0(str_remove(time_of_sampling, c(" AM| PM")), ":00")),
         processing_time_cln = lubridate::hms(time_of_sample_processing))  %>%
  mutate(smpl_wait_time = as.numeric(as.duration(processing_time_cln - sampling_time_cln),"minutes")) 

donor_mdata_slct <- donor_mdata %>% 
  select(short_name, parasitaemia, smpl_wait_time, age_years, gender_m_f, weight_kg)
```



```{r, fig.width=15, fig.height=5}
donor_mdata  %>% select(age_years, symptomatic) %>%  ggplot(aes(x = symptomatic, y = age_years)) + geom_boxplot()
```

add metadata
```{r, fig.width=15, fig.height=5}
v3_m2_asex_harmony_fld_sset <- v3_m2_asex_harmony_fld_sset@meta.data %>% rownames_to_column("short_name") %>% 
  left_join(., donor_mdata_slct) %>%  column_to_rownames("short_name") %>% 
  select(parasitaemia, smpl_wait_time, age_years, gender_m_f, weight_kg) %>% 
  AddMetaData(v3_m2_asex_harmony_fld_sset, .)
```

Add pseudotime
```{r, fig.width=15, fig.height=5}
v3_m2_asex_harmony_fld_sset <- v3_m2_asex_harmony_fld_sset@meta.data %>% 
  rownames_to_column("cell_bc") %>% 
  left_join(., v3_m2_asex_harmony_sce_ss@colData[,c("slingPseudotime_1", "slingPseudotime_2")] %>% 
              as.data.frame() %>% rownames_to_column("cell_bc"), by = "cell_bc") %>% 
  column_to_rownames("cell_bc") %>%
  AddMetaData(v3_m2_asex_harmony_fld_sset, .)
```


```{r, fig.width=15, fig.height=5}
donor_sk21_summary <- read_csv("/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/data/raw/MRC_Sample_Analysis_Summary_Summary.csv", skip = 1) 
donor_sk21_summary <- donor_sk21_summary %>% rename_all(., ~str_replace_all(.,c("\\["="_", "\\]"="", " "="", "-"="",  "\\/"="_", "º"="")))
```


```{r, fig.width=15, fig.height=5}
donor_sk21_summary %>% filter(mixed_infection== "pf", mixed_infection2=="solo") %>%  select(Sample_Name, pf, pm, po, mixed_infection, mixed_infection2) %>% view
```

```{r, fig.width=15, fig.height=5}
donor_sk21_summary %>% filter(mixed_infection== "pf" & mixed_infection2=="solo") %>%  select(Sample_Name, pf, pm, po, mixed_infection, mixed_infection2) %>% view
```



```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# v3_m2_asex_harmony_fld_sset@meta.data %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StagePrelim %in% c("Early trophozoite", "Late ring"))  %>% group_by(StrainDon,StagePrelim) %>% filter(n() > 10) %>% dplyr::count(StrainDon) %>% group_by(donor) %>% mutate(prop = n/sum(n))
```

## check the strains going into the analysis
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# v3_m2_asex_harmony_fld_sset@meta.data  %>% filter(count(donor, StagePrelim) > 20) %>% filter(!str_detect(StrainDon, "Doublet|Negative") & StagePrelim %in% c("Early trophozoite", "Late ring")) 
```

```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
v3_m2_asex_harmony@meta.data %>% dplyr::count(StrainDon, StagePrelim)
```
## Dreamlet
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
m2_asex_harmony_tr <- v3_m2_asex_harmony_fld_sset[,v3_m2_asex_harmony_fld_sset@meta.data$dset == "Field"]
m2_asex_tr_sce <- as.SingleCellExperiment(m2_asex_harmony_tr)
```

## check the strains going into the analysis
```{r, fig.width=15, fig.height=5}
# visualize by batch and cell type annotation
# m2_asex_harmony_tr <- v3_m2_asex_harmony[,v3_m2_asex_harmony@meta.data$dset == "Field"]
# m2_asex_tr_sce <- as.SingleCellExperiment(m2_asex_harmony_tr)
```


```{r, results="asis"}
# only keep cells with sufficient reads
m2_asex_tr_sce <- m2_asex_tr_sce[rowSums(counts(m2_asex_tr_sce) > 0) > 0, ]

## Remove stages with few cells - early rings and schizonts
m2_asex_tr_sce <- m2_asex_tr_sce[,(m2_asex_tr_sce@colData$StagePrelim %in% c("Early trophozoite", "Late ring"))]

## Remove strain doublets
m2_asex_tr_sce <- m2_asex_tr_sce[,str_detect(m2_asex_tr_sce@colData$StrainDon, "Doublet")]

# compute QC metrics
m2_asex_qc <- perCellQCMetrics(m2_asex_tr_sce)

# remove cells with few or many detected genes
ol <- isOutlier(metric = m2_asex_qc$detected, nmads = 2, log = TRUE)

table(ol)

```


```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% group_by(donor) %>% filter(n() > 1 )

```


```{r}
st_dist <- v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% group_by(donor) 

```

```{r}
st_dist %>% mutate(across(Symptomatic, ~str_replace_all(., c("No" = "Asymptomatic", "Yes" = "Symptomatic")))) %>% ggplot(aes(x = donor, fill = StrainDon, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x")
```


```{r}
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic) %>% filter(n>20)  %>% mutate(across(Symptomatic, ~str_replace_all(., c("No" = "Asymptomatic", "Yes" = "Symptomatic")))) %>% ggplot(aes(x = donor, fill = donor, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x")
```

```{r, results="asis"}
plotReducedDim(m2_asex_tr_sce, dimred = "UMAP.HARMONY")
```


```{r, results="asis"}
# only keep cells with sufficient reads
m2_asex_tr_sce <- m2_asex_tr_sce[, !ol]
plotReducedDim(m2_asex_tr_sce, dimred = "UMAP.HARMONY")
```


```{r, results="asis"}
# Since 'ind' is the individual and 'StimStatus' is the stimulus status,
# create unique identifier for each sample
m2_asex_tr_sce$id <- paste0(m2_asex_tr_sce$Symptomatic, m2_asex_tr_sce$donor, m2_asex_tr_sce$StrainDon)


# Create pseudobulk data by specifying cluster_id and sample_id
# Count data for each cell type is then stored in the `assay` field
# assay: entry in assayNames(sce) storing raw counts
# cluster_id: variable in colData(sce) indicating cell clusters
# sample_id: variable in colData(sce) indicating sample id for aggregating cells
m2_asex_tr_pb <- aggregateToPseudoBulk(m2_asex_tr_sce,
  assay = "counts",
  cluster_id = "StagePrelim",
  sample_id = "id",
  verbose = FALSE
)

# one 'assay' per cell type
assayNames(m2_asex_tr_pb)
```



```{r, results="asis"}
# one 'assay' per cell type
assayNames(m2_asex_tr_pb)

metadata(m2_asex_tr_pb)$aggr_means
```


```{r, results="asis"}

form <- ~ Symptomatic + nCount_RNA + slingPseudotime_1
# Normalize and apply voom/voomWithDreamWeights
res.proc <- processAssays(m2_asex_tr_pb, form, min.count = 5)

# the resulting object of class dreamletProcessedData stores
# normalized data and other information
res.proc
```

```{r, results="asis"}
# Normalize and apply voom/voomWithDreamWeights
details(res.proc)
```

```{r, results="asis"}
# show voom plot for each cell clusters
plotVoom(res.proc)
```

```{r, results="asis"}

# run variance partitioning analysis
vp.lst <- fitVarPart(res.proc, form)
```

```{r, results="asis"}
# Show variance fractions at the gene-level for each cell type
genes <- vp.lst$gene[2:4]
plotPercentBars(vp.lst[vp.lst$gene %in% genes, ])
```


```{r, results="asis"}
# Summarize variance fractions genome-wide for each cell type
plotVarPart(vp.lst, label.angle = 60)
```

```{r, results="asis"}
# Differential expression analysis within each assay,
# evaluated on the voom normalized data
res.dl <- dreamlet(res.proc, form)

# names of estimated coefficients
coefNames(res.dl)
```

```{r, results="asis"}
# the resulting object of class dreamletResult
# stores results and other information
res.dl
```

```{r, results="asis"}
plotVolcano(res.dl, coef = "SymptomaticYes")
```

```{r, results="asis"}
genes <- c("PF3D7-1240400", "PF3D7-1240900")
plotGeneHeatmap(res.dl, coef = "SymptomaticYes", genes = genes)
```

```{r, results="asis"}
conflicts_prefer(dreamlet::topTable)
# results from full analysis
topTable(res.dl, coef = "SymptomaticYes")
```

```{r, results="asis"}
# only B cells
topTable(res.dl[["Late ring"]], coef = "SymptomaticYes")
```

```{r, results="asis"}
plotForest(res.dl, coef = "SymptomaticYes", gene = c("PF3D7-1240400"))
```

```{r, results="asis"}
# get data
df <- extractData(res.proc, "Late ring", genes = "PF3D7-1240400")

# set theme
thm <- theme_classic() +
  theme(aspect.ratio = 1, plot.title = element_text(hjust = 0.5))

# make plot
ggplot(df, aes(Symptomatic, `PF3D7-1240400`)) +
  geom_boxplot() +
  thm +
  ylab(bquote(Expression ~ (log[2] ~ CPM))) +
  ggtitle("PF3D7-1240400")
```

```{r, results="asis"}
# create a contrasts called 'Diff' that is the difference between expression
# in the stimulated and controls.
# More than one can be specified
contrasts <- c(Diff = "SymptomaticYes - SymptomaticNo")

# Evalaute the regression model without an intercept term.
# Instead estimate the mean expression in stimulated, controls and then
# set Diff to the difference between the two
res.dl2 <- dreamlet(res.proc, ~ 0 + Symptomatic, contrasts = contrasts)

# see estimated coefficients
coefNames(res.dl2)
```

```{r, results="asis"}
# Volcano plot of Diff
plotVolcano(res.dl2[1:2], coef = "Diff")
```

```{r, results="asis"}
# results from full analysis
topTable(res.dl, coef = "SymptomaticYes")

```


```{r, results="asis"}
# results from full analysis
topTable(res.dl, coef = "SymptomaticNo")

```

## Milo

```{r, results="asis"}
# results from full analysis
topTable(res.dl, coef = "SymptomaticNo")

```

## MAST DE of interesting clusters and also for strains


```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
DimPlot(v3_m2_asex_harmony_fld_sset, reduction = "umap.harmony", group.by = "harmony_clusters_asex", pt.size = 0.5, dims = c(1,2), label = T)

```

```{r}
## Weird cluster 2 markers
Idents(v3_m2_asex_harmony_fld_sset) <- "harmony_clusters_asex"
cl2_markrs <- FindMarkers(v3_m2_asex_harmony_fld_sset, ident.1 = "2")

```

```{r}
## Weird cluster 2 markers
cl2_markrs %>% rownames_to_column('gene_id')  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene,`Genomic Location (Gene)`))

## PF3D7-0204900 https://www.sciencedirect.com/science/article/pii/S0006291X20321744#abs0010
## PF3D7-0204900 https://academic.oup.com/femsre/article/30/4/596/2367720
## Possible copy number variant since they are in the same location in the genome

## GARP - antigarp induces pf death and present in relatively resistant individuals https://pubmed.ncbi.nlm.nih.gov/32427965/
## GARP high expression in K13580Y mutant as well as pfemp1 - https://www.biorxiv.org/content/biorxiv/early/2023/12/06/2023.12.06.570387.full.pdf 

## FNT Drug target - due to its housekeeping role in lactate efflux during the intraerythrocytic stage https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8428694/

## FNT Drug target - due to its housekeeping role in lactate efflux during the intraerythrocytic stage https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8428694/

## PfA-M17 essential gene and drug target (compound 3) implicated in the final stage of hemoglobin digestion - https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9470162/ https://journals.plos.org/plospathogens/article?id=10.1371/journal.ppat.1010926 

##PF3D7-1223900 Contained in drug resistance gene duplication https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7774857/ https://genomemedicine.biomedcentral.com/articles/10.1186/s13073-019-0708-9, https://www.ncbi.nlm.nih.gov/pmc/articles/PMC9948948/

```

```{r}
## Expression of AF1 genes in unique cluster - https://www.biorxiv.org/content/10.1101/2024.01.20.576496v1.full.pdf
cl2_markrs %>% rownames_to_column('gene_id') %>% mutate(across(gene_id, ~str_replace(., "-", "_"))) %>% filter(gene_id %in% c("PF3D7_1035500", "PF3D7_1035600", "PF3D7_1035400", "PF3D7_1035300", "PF3D7_0930300", "PF3D7_0207600", "PF3D7_0207500", "PF3D7_1149200", "PF3D7_0401800", "PF3D7_1370300", "PF3D7_1149000", "PF3D7_0935900", "PF3D7_0936000", "PF3D7_1039000", "PF3D7_1149300", "PF3D7_0424400", "PF3D7_0830800", "PF3D7_1477600", "PF3D7_0935800")) %>% mutate(across(gene_id, ~str_replace(., "_", "-"))) %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene,`Genomic Location (Gene)`))

```

```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(harmony_clusters_asex, donor)
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(seurat_clusters, donor, Symptomatic)
```

```{r}
## Weird cluster 2 markers
harmony_int@meta.data %>% filter(harmony_clusters == "2") %>% count(harmony_clusters, seurat_clusters, donor)
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(harmony_clusters_asex, seurat_clusters, donor)
```


```{r}
## Weird cluster 2 markers
harmony_int@meta.data %>% filter(harmony_clusters == "2") %>% count(harmony_clusters, seurat_clusters, donor)
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(harmony_clusters_asex, seurat_clusters, donor, Strain_DN) %>% arrange(desc(n))
```

```{r}
## Weird cluster 2 markers
cbs<- v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% rownames()

harmony_int@meta.data %>% rownames_to_column("bcode") %>% filter(bcode %in% cbs) %>% count(harmony_clusters, seurat_clusters, donor) %>% arrange(desc(n))

```

```{r}

DimPlot(harmony_int[,harmony_int@meta.data$StagePrelimC == "Asexual"], reduction = "umap.harmony", cells.highlight = cbs, pt.size = 0.5, dims = c(1,2), label = F)
DimPlot(v3_m2_asex_harmony_fld_sset, reduction = "umap.harmony",cells.highlight = cbs, pt.size = 0.5, dims = c(1,2), label = F)

cbs_49 <- v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2" & donor == "MSC49") %>% rownames() %>% str_remove(., "M49_")
DimPlot(all_msc_filt_no_dblts[["MSC49"]], cells.highlight = cbs_49, pt.size = 0.5, dims = c(1,2), label = F)

cbs_48 <- v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% rownames() %>% str_remove(., "M48_")
DimPlot(all_msc_filt_no_dblts[["MSC48"]], cells.highlight = cbs_48, pt.size = 0.5, dims = c(1,2), label = F)

```

```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(harmony_clusters_asex, donor)

```


```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(harmony_clusters_asex == "2") %>% count(harmony_clusters_asex, StrainDon) %>% arrange(desc(n))

```


```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(donor %in% c("MSC48", "MSC49")) %>% count(harmony_clusters_asex, StrainDon) %>% arrange(desc(n))

```


```{r}
# gogogo()
```

```{r}
m48_wc <- str_remove(colnames(v3_m2_asex_harmony_fld_sset[,v3_m2_asex_harmony_fld_sset@meta.data$harmony_clusters_asex == "2" & v3_m2_asex_harmony_fld_sset@meta.data$donor == "MSC48"]), "M48_")
```

```{r}
DimPlot(all_msc_filt_no_dblts[["MSC48"]], cells.highlight = m48_wc)

```

```{r}
m49_wc <- str_remove(colnames(v3_m2_asex_harmony_fld_sset[,v3_m2_asex_harmony_fld_sset@meta.data$harmony_clusters_asex == "2" & v3_m2_asex_harmony_fld_sset@meta.data$donor == "MSC49"]), "M49_")

```

```{r}
DimPlot(all_msc_filt_no_dblts[["MSC49"]], cells.highlight = m49_wc)

```

```{r}
msc49 <- all_msc_filt_no_dblts[["MSC49"]]@meta.data %>% rownames_to_column("bcode") %>% mutate(w_clst_stgs = case_when(bcode %in% m49_wc ~ "wrd_asex", T ~ StagePrelim)) %>% column_to_rownames("bcode") %>% select(w_clst_stgs) %>% AddMetaData(all_msc_filt_no_dblts[["MSC49"]], .) 

# m49_asex <- all_msc_filt_no_dblts[["MSC49"]][,all_msc_filt_no_dblts[["MSC49"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]
# 
# 
# m49_asex <- m49_asex@meta.data %>% rownames_to_column("bcode") %>% mutate(w_clst = case_when(bcode %in% m49_wc ~ "wrd_clstr", T ~ "other_clstr")) %>% column_to_rownames("bcode") %>% select(w_clst) %>% AddMetaData(m49_asex, .)
# 
# DimPlot(m49_asex, group.by = "w_clst")
# 

```

```{r}
VlnPlot(msc49, features = "PF3D7-0204800", group.by = "w_clst_stgs")
VlnPlot(msc49, features = "PF3D7-0204900", group.by = "w_clst_stgs")
```


```{r}
VlnPlot(msc49, features = "PF3D7-0406200", group.by = "w_clst_stgs")
```

```{r}

m49_asex <- all_msc_filt_no_dblts[["MSC49"]][,all_msc_filt_no_dblts[["MSC49"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]
m49_asex <- m49_asex@meta.data %>% rownames_to_column("bcode") %>% mutate(w_clst = case_when(bcode %in% m49_wc ~ "wrd_clstr", T ~ "other_clstr")) %>% column_to_rownames("bcode") %>% select(w_clst) %>% AddMetaData(m49_asex, .)

DimPlot(m49_asex, group.by = "w_clst")


```


```{r}
Idents(m49_asex) <- "w_clst"
# w_markrs <- FindMarkers(m49_asex, ident.1 = )

m49_asex_seu <- m49_asex

m49_asex_seu[["RNA"]]$data <- as(object = m49_asex_seu[["RNA"]]$data, Class = "dgCMatrix")
all.markers <- FindAllMarkers(object = m49_asex_seu, test.use = "MAST")
head(all.markers, 10)

```


```{r}

m48_asex <- all_msc_filt_no_dblts[["MSC48"]][,all_msc_filt_no_dblts[["MSC48"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]
m48_asex <- m48_asex@meta.data %>% rownames_to_column("bcode") %>% mutate(w_clst = case_when(bcode %in% m48_wc ~ "wrd_clstr", T ~ "other_clstr")) %>% column_to_rownames("bcode") %>% select(w_clst) %>% AddMetaData(m48_asex, .)
DimPlot(m48_asex, group.by = "w_clst")


```

```{r}
Idents(m48_asex) <- "w_clst"
# w_markrs <- FindMarkers(m48_asex, ident.1 = )

m48_asex_seu <- m48_asex

m48_asex_seu[["RNA"]]$data <- as(object = m48_asex_seu[["RNA"]]$data, Class = "dgCMatrix")
w48_all.markers <- FindMarkers(object = m48_asex_seu, test.use = "MAST", ident.1 = "wrd_clstr", ident.2 = "other_clstr")
head(w48_all.markers, 10)

```

```{r}
m48_asex_seu@meta.data %>% count(StrainDon)
m49_asex_seu@meta.data %>% count(StrainDon)

```


```{r}
m48_asex_seu <- m48_asex_seu[, !str_detect(m48_asex_seu@meta.data$StrainDon, "Negative|Doublet")]

m49_asex_seu <- m49_asex_seu[, !str_detect(m49_asex_seu@meta.data$StrainDon, "Negative|Doublet") ]
```

```{r}
Idents(m48_asex_seu) <- "StrainDon"

m48_asex_seu@meta.data %>% count(StrainDon)
m48_strn_d_markers <- FindMarkers(object = m48_asex_seu, test.use = "MAST", ident.1 = "M48_SC2", ident.2 = "M48_SC4")
m48_strn_d_markers_df <- m48_strn_d_markers %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m48_strn_d_markers_df %>% filter(p_val_adj < 0.05)

# PF3D7_1016300 PF3D7_1127000 https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8527989/
# PF3D7_1127000 https://elifesciences.org/reviewed-preprints/95879
# PF3D7_1223900 https://www.biorxiv.org/content/10.1101/2023.02.13.528367v1.full
# PF3D7_1324900 https://www.sciencedirect.com/science/article/pii/S2213716523001376
```


```{r}
Idents(m49_asex_seu) <- "StrainDon"

m49_asex_seu@meta.data %>% count(StrainDon)
m49_strn_d_markers <- FindMarkers(object = m49_asex_seu, test.use = "MAST", ident.1 = "M49_SC1", ident.2 = "M49_SC5")
m49_strn_d_markers_antd <- m49_strn_d_markers  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))

m49_strn_d_markers_antd %>% filter(p_val_adj < 1e-20)

## vps3 extracellular vessicle content https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8764524/
## ΔHsp70x - virulence cytoadhesion - dispensable 
##VAR_PF3D7-1041300: Mapping immune variation and var gene switching in naive hosts infected with Plasmodium falciparum - PMC.html
##CBP2 ΔGEXP07 parasites have a growth advantage compared to wild-type parasites https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7078486/
##CBP2 ΔGEXP07 parasites have a growth advantage compared to wild-type parasites https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7078486/
## MAHRP2 interacts with pfemp1 rers cleft  https://www.nature.com/articles/ncomms16044, https://journals.asm.org/doi/10.1128/msphere.00755-21
```


```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & str_detect(StrainDon, "Doublet|Negative")) %>% count(donor, Symptomatic, StrainDon)

```


```{r}
## Weird cluster 2 markers
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% group_by(donor) %>% filter(n() > 1 )

```

```{r}
st_dist <- v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic, StrainDon) %>% filter(n>20) %>% group_by(donor) %>% filter(n() > 1 )

```

```{r}
st_dist %>% mutate(across(Symptomatic, ~str_replace_all(., c("No" = "Asymptomatic", "Yes" = "Symptomatic")))) %>% ggplot(aes(x = donor, fill = StrainDon, y = n)) + geom_col(position = position_dodge2()) + facet_wrap(Symptomatic~., scales = "free_x")
```


```{r}
sstbl <- read_csv("strns_symp.csv") 
```
```{r, fig.width=4, fig.height=5}
sstbl %>% ggplot(aes(x=Status, y=Strain)) + geom_boxplot() + geom_point(aes(colour = Donor))
```

```{r}
v3_m2_asex_harmony_fld_sset@meta.data %>% filter(dset != "Lab" & !(str_detect(StrainDon, "Doublet|Negative"))) %>% count(donor, Symptomatic, StrainDon) %>% mutate(across(Symptomatic, ~str_replace_all(., c("No" = "Asymptomatic", "Yes" = "Symptomatic")))) %>% ggplot(aes(x = donor, fill = StrainDon, y = n)) + geom_col() 
```

```{r}
m33_asex_seu <- all_msc_filt_no_dblts[["MSC33"]][,all_msc_filt_no_dblts[["MSC33"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]
m33_asex_seu <- m33_asex_seu[, str_detect(m33_asex_seu@meta.data$StrainDon, "SC2|SC5|SC6|SC7")]

m33_asex_seu[["RNA"]]$data <- as(object = m33_asex_seu[["RNA"]]$data, Class = "dgCMatrix")

Idents(m33_asex_seu) <- "StrainDon"

m33_asex_seu@meta.data %>% count(StrainDon)
m33_strn_d_markers <- FindAllMarkers(object = m33_asex_seu, test.use = "MAST")
m33_strn_d_markers_df <- m33_strn_d_markers  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m33_strn_d_markers_df %>% filter(p_val_adj < 1e-5)

```

```{r}
m55_asex_seu <- all_msc_filt_no_dblts[["MSC55"]][,all_msc_filt_no_dblts[["MSC55"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]

m55_asex_seu[["RNA"]]$data <- as(object = m55_asex_seu[["RNA"]]$data, Class = "dgCMatrix")

Idents(m55_asex_seu) <- "StrainDon"

m55_asex_seu@meta.data %>% count(StrainDon)
m55_strn_d_markers <- FindMarkers(object = m55_asex_seu, test.use = "MAST", ident.1 = "M55_SC6", ident.2 = "M55_SC8")
m55_strn_d_markers_df <- m55_strn_d_markers  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m55_strn_d_markers_df %>% filter(p_val_adj < 1e-5)

```


```{r}
m60_asex_seu <- all_msc_filt_no_dblts[["MSC60"]][,all_msc_filt_no_dblts[["MSC60"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]

m60_asex_seu[["RNA"]]$data <- as(object = m60_asex_seu[["RNA"]]$data, Class = "dgCMatrix")

Idents(m60_asex_seu) <- "StrainDon"

m60_asex_seu@meta.data %>% count(StrainDon)
m60_strn_d_markers <- FindMarkers(object = m60_asex_seu, test.use = "MAST", ident.1 = "M60_SC3", ident.2 = "M60_SC7")
m60_strn_d_markers_df <- m60_strn_d_markers  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m60_strn_d_markers_df %>% filter(p_val_adj < 1e-5)

```


```{r}

# m60_strn_d_markers_ds <- FindMarkers(object = m60_asex_seu, test.use = "MAST", ident.1 = "M60_SC3", ident.2 = "M60_SC7", max.cells.per.ident = 90)
# m60_strn_d_markers_ds_df <- m60_strn_d_markers_ds  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
# m60_strn_d_markers_ds_df %>% filter(p_val_adj < 0.05)
```

```{r}
m66_asex_seu <- all_msc_filt_no_dblts[["MSC66"]][,all_msc_filt_no_dblts[["MSC66"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]

m66_asex_seu[["RNA"]]$data <- as(object = m66_asex_seu[["RNA"]]$data, Class = "dgCMatrix")

Idents(m66_asex_seu) <- "StrainDon"

m66_asex_seu@meta.data %>% count(StrainDon)
m66_strn_d_markers1 <- FindMarkers(object = m66_asex_seu, test.use = "MAST", ident.1 = "M66_SC5", ident.2 = "M66_SC8")
m66_strn_d_markers1_df <- m66_strn_d_markers1 %>% rownames_to_column("gene")  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m66_strn_d_markers1_df %>% filter(p_val_adj < 1e-5)

```


```{r}
Idents(m66_asex_seu) <- "StrainDon"

m66_asex_seu@meta.data %>% count(StrainDon)
m66_strn_d_markers2 <- FindMarkers(object = m66_asex_seu, test.use = "MAST", ident.1 = "M66_SC7", ident.2 = "M66_SC8")
m66_strn_d_markers2_df <- m66_strn_d_markers2 %>% rownames_to_column("gene")  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m66_strn_d_markers2_df %>% filter(p_val_adj < 1e-5)

```


```{r}
Idents(m66_asex_seu) <- "StrainDon"

m66_asex_seu@meta.data %>% count(StrainDon)
m66_strn_d_markers3 <- FindMarkers(object = m66_asex_seu, test.use = "MAST", ident.1 = "M66_SC5", ident.2 = "M66_SC7")
m66_strn_d_markers3_df <- m66_strn_d_markers3 %>% rownames_to_column("gene")  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m66_strn_d_markers3_df %>% filter(p_val_adj < 1e-5)

```


```{r}
m14_asex_seu <- msc_qcd_anotd[["MSC14"]][,msc_qcd_anotd[["MSC14"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]

m14_asex_seu@meta.data %>% count(strain_qcd)

```

```{r}

Idents(m14_asex_seu) <- "strain_qcd"

m14_strn_d_markers <- FindMarkers(object = m14_asex_seu, test.use = "MAST", ident.1 = "SC1", ident.2 = "SC2")
m14_strn_d_markers_df <- m14_strn_d_markers %>% rownames_to_column("gene")  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m14_strn_d_markers_df %>% filter(p_val_adj < 0.05)

```


```{r}
m14_strn_d_markers2 <- FindMarkers(object = m14_asex_seu, test.use = "MAST", ident.1 = "SC1", ident.2 = "SC6")
m14_strn_d_markers2_df <- m14_strn_d_markers2 %>% rownames_to_column("gene")  %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))
m14_strn_d_markers2_df %>% filter(p_val_adj < 0.05)

```

```{r}
# M48, M49, M60
ggvenn(list("M48" = m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M49" = m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M60" = m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)))

```


```{r, fig.height=3.8, fig.width=3.8}
# M48, M49, M60
ggvenn(list("M48" = m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M49" = m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M60" = m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)),
       show_percentage = F,
       text_size = 6)

```

```{r}
# M48, M49, M60
ggvenn(list("M48" = m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M49" = m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M60" = m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M14" = m14_strn_d_markers2_df %>% filter(p_val_adj < 0.05) %>% pull(gene)))

```


```{r}
# M48, M49, M60
ggvenn(list("M48" = m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M49" = m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M60" = m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene),
            "M14" = m14_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)))

```

```{r}
# M48, M49, M60
m48_g <- m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)
m49_g <- m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene)
m60_g <- m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)


m48_m60_g_ovlp <- m48_g[m48_g %in% m60_g]
m49_m60_g_ovlp <- m49_g[m49_g %in% m60_g]

```

```{r}
# M48, M49, M60
m49_m60_g_ovlp <- m49_g[m49_g %in% m60_g]

m49_strn_d_markers_antd %>% filter(gene %in% m49_m60_g_ovlp) %>% mutate(don = "M49") %>% bind_rows(., m60_strn_d_markers_df %>% filter(gene %in% m49_m60_g_ovlp) %>% mutate(don = "M60")) %>% ggplot(aes(x = avg_log2FC, y = Gene, fill = don)) + geom_col(position = position_dodge2()) 
```
```{r, fig.height=5.5, fig.width=4}
# M48, M49, M60
m49_m60_g_ovlp <- m49_g[m49_g %in% m60_g]

m49_strn_d_markers_antd %>% filter(gene %in% m49_m60_g_ovlp) %>% mutate(don = "M49") %>% bind_rows(., m60_strn_d_markers_df %>% filter(gene %in% m49_m60_g_ovlp) %>% mutate(don = "M60")) %>% ggplot(aes(x = avg_log2FC, y = Gene, fill = don)) + geom_col() 
```


```{r}
# M48, M49, M60
m48_g <- m48_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)
m49_g <- m49_strn_d_markers_antd %>% filter(p_val_adj < 0.05) %>% pull(gene)
m60_g <- m60_strn_d_markers_df %>% filter(p_val_adj < 0.05) %>% pull(gene)


m48_m60_g_ovlp <- m48_g[m48_g %in% m60_g]
m49_m60_g_ovlp <- m49_g[m49_g %in% m60_g]
m48_m49_g_ovlp <- m48_g[m48_g %in% m49_g]

```

```{r, fig.width=4, fig.height=2}
# M48, M49, M60

m49_strn_d_markers_antd %>% filter(gene %in% m48_m49_g_ovlp) %>% mutate(don = "M49") %>% bind_rows(., m48_strn_d_markers_df %>% filter(gene %in% m48_m49_g_ovlp) %>% mutate(don = "M48")) %>% ggplot(aes(x = avg_log2FC, y = Gene, fill = don)) + geom_col() 
```
```{r}
# M48, M49, M60

m49_strn_d_markers_antd %>% filter(gene %in% m48_m49_g_ovlp) %>% mutate(don = "M49") %>% bind_rows(., m48_strn_d_markers_df %>% filter(gene %in% m48_m49_g_ovlp) %>% mutate(don = "M48")) %>% ggplot(aes(x = avg_log2FC, y = Gene, fill = don)) + geom_col() 
```

```{r}
Idents(m48_asex) <- "StrainDon"
w48_markrs <- FindAllMarkers(m48_asex)

```

```{r}
m48_asex <- all_msc_filt_no_dblts[["MSC48"]][,all_msc_filt_no_dblts[["MSC48"]]@meta.data$StagePrelim %in% c("Early trophozoite", "Late ring")]

```

```{r}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
FeaturePlot(v3_m2_asex_harmony_fld_sset, features = "scf_class_rand_dbt_prop", reduction = "umap.harmony", order = T)

```


```{r, fig.width=15, fig.height=3}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
FeaturePlot(harmony_int, features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), reduction = "umap.harmony", order = T, ncol = 5)

```


```{r, fig.width=15, fig.height=3}
## 
VlnPlot(v3_m2_asex_harmony_fld_sset, features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), ncol = 5)

```
```{r, fig.width=6, fig.height=3}
## 
VlnPlot(v3_m2_asex_harmony_fld_sset, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, split.by = "StagePrelim", pt.size = 0)

```

```{r, fig.width=18, fig.height=3}
## 
VlnPlot(v3_m2_asex_harmony_fld_sset, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2, split.by = "StrainDon", pt.size = 0)

```

```{r, fig.width=6, fig.height=3}
## 
DimPlot(v3_m2_asex_harmony_fld_sset,  split.by = "dset", reduction = "umap.harmony", dims = c(2,3))

```

```{r, fig.width=6, fig.height=3}
## 
DimPlot(v3_m2_asex_harmony_fld_sset,  split.by = "dset", reduction = "umap.harmony", dims = c(2,3))

```

```{r, fig.width=15, fig.height=3}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
FeaturePlot(harmony_int, features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), reduction = "umap.harmony", order = T, ncol = 5)

```



```{r, fig.width=18, fig.height=6}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
VlnPlot(harmony_int[, harmony_int@meta.data$StagePrelimC == "Asexual"], features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), ncol = 5, pt.size = 0, group.by = "harmony_clusters")

```

```{r, fig.width=12, fig.height=6}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
FeaturePlot(harmony_int[, harmony_int@meta.data$StagePrelimC == "Asexual"], features = c("PF3D7-0204800", "PF3D7-0204900"), order = T, ncol = 2, pt.size = 1, reduction = "umap.harmony")

```

```{r, fig.width=18, fig.height=6}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
harmony_int <- harmony_int@meta.data %>% rownames_to_column('bcode') %>% mutate(wd_cluster = case_when(bcode %in% cbs ~ "weird_asx", T ~ StagePrelim)) %>% select(bcode, wd_cluster) %>% column_to_rownames('bcode') %>% AddMetaData(harmony_int, .)


```

```{r, fig.width=18, fig.height=6}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
VlnPlot(harmony_int[, harmony_int@meta.data$StagePrelimC == "Asexual"], features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), ncol = 5, pt.size = 0, group.by = "wd_cluster")
VlnPlot(harmony_int, features = c("PF3D7-0204800", "PF3D7-0204900", "PF3D7-0113000", "PF3D7-0316600", "PF3D7-0220000"), ncol = 5, pt.size = 0, group.by = "wd_cluster")

```


```{r, fig.width=12, fig.height=6}
## Adjusting resolution to find the optimum for slingshot trajectory inference to avoid error  "values must be length 150, but FUN(X[[1]]) result is length 38689"
DotPlot(harmony_int, features = c("PF3D7-0204800", "PF3D7-0204900"), group.by = "StagePrelim")

```



## Assess distribution of strains over pseudotime

```{r, results="asis", fig.width=5, fig.height=3.5}
library("ggpubr")

gbox_theme<- theme(axis.text=element_text(size=15),
        axis.title=element_text(size=15,face="bold"), 
        legend.text = element_text(size = 15) ,
        legend.title = element_text(size = 15, face = "bold"),
        legend.position = "bottom")
        
dens_thme <- theme(axis.text=element_text(size=22),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=22,face="bold"), 
        legend.text = element_text(size = 20) ,
        legend.title = element_text(size = 20, face = "bold"),
        legend.position = "bottom")
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M49_SC1", "M49_SC5")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M49_SC1", "M49_SC5")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl%>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.3), size=2, bw = 0.3, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  dens_thme +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") + 
  stat_compare_means(method = "wilcox.test") +gbox_theme
  


```



```{r, results="asis", fig.width=5, fig.height=3.5}
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M60_SC3", "M60_SC7")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M60_SC3", "M60_SC7")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl %>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.3), size=2, bw = 0.3, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") + stat_compare_means(method = "wilcox.test")+gbox_theme


```


```{r, results="asis", fig.width=5, fig.height=3.5}
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M48_SC2", "M48_SC4")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M48_SC2", "M48_SC4")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl %>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.48), size=2, bw = 0.48, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))


tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") + stat_compare_means(method = "wilcox.test")+gbox_theme


```


```{r, results="asis", fig.width=5, fig.height=4}
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M55_SC6", "M55_SC8")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M55_SC6", "M55_SC8")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl%>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.48), size=2, bw = 0.48, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))



tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") + stat_compare_means(method = "wilcox.test")+gbox_theme

```


```{r, results="asis", fig.width=5, fig.height=4}
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M66_SC5", "M66_SC7")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M66_SC5", "M66_SC7", "M66_SC8")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl%>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.48), size=2, bw = 0.48, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))


tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") +stat_compare_means(method = "anova", aes(label = ..p.signif..))+gbox_theme

```


```{r, results="asis"}
smpl = umap_meta_df %>% 
  filter(StrainDon %in% c("M33_SC6", "M33_SC7")) %>% 
  count(StrainDon) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(StrainDon %in% c("M33_SC2","M33_SC5", "M33_SC6", "M33_SC7")) %>% 
  group_by(StrainDon) %>% 
  slice_sample(n = smpl) 

tbl%>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.48), size=2, bw = 0.48, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))


tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="StrainDon", col="StrainDon") +stat_compare_means(method = "kruskal.test", aes(label = ..p.signif..))+gbox_theme

```

```{r, results="asis"}
smpl = umap_meta_df %>% 
  filter(!is.na(Symptomatic)) %>% 
  count(Symptomatic) %>% pull(n) %>% min()

tbl = umap_meta_df %>% 
  filter(!is.na(Symptomatic)) %>% 
  group_by(Symptomatic) %>% 
  slice_sample(n = smpl) 

tbl%>%
  ggplot(., aes(x = slingPseudotime_1, col=Symptomatic, fill=Symptomatic)) + 
  geom_density(aes(y = ..count..*0.48), size=2, bw = 0.48, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

tbl %>% 
  ggboxplot(., y = "slingPseudotime_1",x="Symptomatic", col="Symptomatic") +stat_compare_means(method = "wilcox.test")


```



```{r}
m49_asex_seu_pt <- m49_asex_seu %>% AddMetaData(., umap_meta_df %>% filter(orig.ident == "MSC49.mrna") %>% mutate(across(cell_bc, ~str_remove(., "M[0-9]*_")))%>% select(cell_bc, slingPseudotime_1) %>% column_to_rownames("cell_bc") %>% filter(!is.na(slingPseudotime_1)))

m49_asex_seu_pt <- m49_asex_seu_pt[,!is.na(m49_asex_seu_pt@meta.data$slingPseudotime_1)]

Idents(m49_asex_seu_pt) <- "StrainDon"

m49_asex_seu_pt@meta.data %>% count(StrainDon)
m49_strn_d_markers_pt <- FindMarkers(object = m49_asex_seu_pt, test.use = "MAST", ident.1 = "M49_SC1", ident.2 = "M49_SC5", latent.vars = "slingPseudotime_1")
m49_strn_d_markers_antd_pt <- m49_strn_d_markers_pt  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))

m49_strn_d_markers_antd_pt %>% filter(p_val_adj < 1e-20)

## vps3 extracellular vessicle content https://www.ncbi.nlm.nih.gov/pmc/articles/PMC8764524/
## ΔHsp70x - virulence cytoadhesion - dispensable 
##VAR_PF3D7-1041300: Mapping immune variation and var gene switching in naive hosts infected with Plasmodium falciparum - PMC.html
##CBP2 ΔGEXP07 parasites have a growth advantage compared to wild-type parasites https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7078486/
##CBP2 ΔGEXP07 parasites have a growth advantage compared to wild-type parasites https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7078486/
## MAHRP2 interacts with pfemp1 rers cleft  https://www.nature.com/articles/ncomms16044, https://journals.asm.org/doi/10.1128/msphere.00755-21
```


```{r}
m60_asex_seu_pt <- m60_asex_seu %>% AddMetaData(., umap_meta_df %>% filter(orig.ident == "MSC60.mrna") %>% mutate(across(cell_bc, ~str_remove(., "M[0-9]*_")))%>% select(cell_bc, slingPseudotime_1) %>% column_to_rownames("cell_bc") %>% filter(!is.na(slingPseudotime_1)))

m60_asex_seu_pt <- m60_asex_seu_pt[,!is.na(m60_asex_seu_pt@meta.data$slingPseudotime_1)]

Idents(m60_asex_seu_pt) <- "StrainDon"

m60_asex_seu_pt@meta.data %>% count(StrainDon)
m60_strn_d_markers_pt <- FindMarkers(object = m60_asex_seu_pt, test.use = "MAST", ident.1 = "M60_SC3", ident.2 = "M60_SC7", latent.vars = "slingPseudotime_1")
m60_strn_d_markers_antd_pt <- m60_strn_d_markers_pt  %>% rownames_to_column("gene") %>% left_join(Pf3D7_genes_plasmoDB%>% select(gene_id, Gene), by = c("gene"="gene_id"))

m60_strn_d_markers_antd_pt %>% filter(p_val_adj < 1e-5)

```

```{r, results="asis"}
plt = umap_meta_df %>% 
  filter(StrainDon %in% c("M60_SC1", "M60_SC5")) %>%
  ggplot(., aes(x = slingPseudotime_1, col=StrainDon, fill=StrainDon)) + 
  geom_density(aes(y = ..count..*0.18), size=2, bw = 0.18, alpha=.2)+
  # geom_freqpoly()+
  theme_classic()+
  theme(axis.text=element_text(size=26),
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1), 
        axis.title=element_text(size=30,face="bold"), 
        legend.text = element_text(size = 26) ,
        legend.title = element_text(size = 28, face = "bold"),
        # legend.box.margin = margin(t = 0, r = 4.1, b = 0, l = 0, unit = "cm"),#######
        # legend.position="bottom",
        # legend.direction="vertical"
  ) +
  labs(x = "Pseudotime", y="Counts") +
  guides(color = guide_legend(override.aes = list(size = 4), title.position = "top"))

print(plt)

```

