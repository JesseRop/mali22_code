---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(scran)
  library(SingleR)
  library(scDblFinder)
  library(duckplyr)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::intersect)
  conflicts_prefer(dplyr::desc)
  conflicts_prefer(dplyr::count)
})
```



# MSC Preprocessing

## setup, read input files and exploratory visualizations and general functions

```{r, setup}

knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source common functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")

```


initialize variable for the sample names

```{r}
# slct_sample_names <-c("MSC48", "MSC68", "MSC14", "MSC49", "MSC60", "MSC66", "MSC67", "MSC70", "MSC24", "MSC33", "MSC40", "MSC54", "MSC55") %>% str_sort(., numeric = T)

```

###################START- RAW READING#############

```{r, eval=T}
pf_solo_mixed_mdata_decode <- read_csv("data/raw/pf_solo_mixed_mdata_decode.csv")
```

## Genotype clustering for MSC

Read in clusters.tsv files with assignment of cells to strains and PCA plots metrics

Transfer clusters.tsv files with assignment of cells to strains and PCA plots metrics for the best K from farm to my local Mac

```{r}

# slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm
# ## get relevant sample names
# pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)
# 
# ##Sample ID
# sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
# smpl_nms <-str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)

```


```{r}
# Remove poor quality samples
# poorQC_samples <- c("MSC1", "MSC24", "MSC37", "MSC38", "MSC39") 
# sample_name <- sample_name[!(sample_name %in% poorQC_samples)] %>% str_sort(., numeric = T)
```

```{r}

slct_sample_names <- pf_solo_mixed_mdata_decode$sample_nm
# slct_sample_names <-c("MSC68", "MSC14", "MSC49", "MSC55") %>% str_sort(., numeric = T)


# ## poor quality samples
sample_rm <- c("MSC1", "MSC24", "MSC37", "MSC38", "MSC39")
sample_mxd <- pf_solo_mixed_mdata_decode %>% filter(mixed_infection2 == "mixed") %>% pull(sample_nm)
# 
# # slct_sample_names[-c(sample_rm)]
slct_sample_names <- slct_sample_names[!(slct_sample_names %in% c(sample_rm, sample_mxd))]

## get relevant sample names
pf_solo_mixed_mdata_decode_slct <- pf_solo_mixed_mdata_decode %>% filter(sample_nm %in% slct_sample_names)

##Sample ID
sample_name <- str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)
smpl_nms <-str_sort(pf_solo_mixed_mdata_decode_slct$sample_nm)

##Sample IDs
source_irods <- pf_solo_mixed_mdata_decode_slct[,c('sample_nm', 'irods_id')] %>% deframe() %>%.[sample_name]

```

```{r, message=F, warning=F, eval=T}
## Save manual selection of thresholds
man_thresh <- readRDS("data/processed/Pf/m2_all/man_thresh.RDS")
```

Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read BPcells matrices
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))

sample_names <- rep(sample_name, 2) 
# sample_name_all <- c(sample_name, paste0(sample_name, "_150"), paste0(sample_name, "_edrops50"))
# sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))
sample_name_all <- c(paste0(sample_name, "_cr"), paste0(sample_name, "_edrops", man_thresh[sample_name]), paste0(sample_name, "_cbendr"))

```



###### Compare cellranger and cellbender for MSC33 and MSC50_SLO since these are strange samples with some cells missing in cellbender but in present in cellranger and emptydrops
```{r, message=F, warning=F}
slct_sample_names_33_50 <-c("MSC50_SLO", "MSC33", "MSC70") %>% str_sort(., numeric = T)
sample_name_cr_cb_33_50 <- c(paste0(slct_sample_names_33_50, "_cr"), paste0(slct_sample_names_33_50, "_cbendr"))
sample_name_cr_cb_33_50
```

```{r, message=F, warning=F}
##Read BPcells matrices
all_seu_prelim_stg_norm_m55_M50SLO <- list.files("data/processed/Pf", pattern = "bpseu_(cr|cbendr|edrops50)_prelim_stg_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpseu|_prelim.*'))) %>% 
# all_seu_norm <- list.files("data/processed/Pf", pattern = "bpc_seu.*_sct.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_sct.*'))) %>% 
  .[sample_name_cr_cb_33_50] %>%
  map(readRDS)

```

```{r, warning=FALSE, message=FALSE}
imap(all_seu_prelim_stg_norm_m55_M50SLO, ~DimPlot(.x, dims = c(1,2), label = F, group.by = "sR_fine_stg") + labs(title = .y) +scale_color_manual(values = sp_col_new))

```


```{r, message=F, warning=F, eval=T}
##Read BPcells matrices
all_cbender_gene_mdata_m55_M50SLO <- list.files("data/processed/Pf", pattern = "cb_gene_mdata.csv$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/cbender/cb_gene_mdata.*'))) %>% 
  .[slct_sample_names_33_50] %>%
  .[!is.na(.)] %>%
  map(read_csv) 
```

```{r, message=F, warning=F, eval=T}
##Read BPcells matrices
all_cbender_gene_mdata_m55_M50SLO[["MSC33"]] %>% arrange(desc(ambient_expression)) 
```


```{r, message=F, warning=F, eval=T}
##Read BPcells matrices
all_cbender_mdata_m55_M50SLO <- list.files("data/processed/Pf", pattern = "cb_mdata.csv$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/cbender/cb_mdata.*'))) %>% 
  .[slct_sample_names_33_50] %>%
  .[!is.na(.)] %>%
  map(read_csv) 
```


```{r, message=F, warning=F, eval=T}
##Read BPcells matrices
all_cbender_mdata_m55_M50SLO[["MSC33"]] %>% head
```


```{r, warning=FALSE, message=FALSE}
all_seu_prelim_stg_norm_m33_cr <- all_seu_prelim_stg_norm_m55_M50SLO[['MSC33_cr']]@meta.data %>%
  rownames_to_column('barcode') %>%
  mutate("in_cb" = ifelse(barcode %in% colnames(all_seu_prelim_stg_norm_m55_M50SLO[['MSC33_cbendr']]), "yes", "no")) %>% 
  left_join(., all_cbender_mdata_m55_M50SLO[['MSC33']], by = "barcode", suffix = c(".x", ".y")) %>%
  column_to_rownames('barcode') %>%
  select(in_cb, contains(".y")) %>%
  AddMetaData(all_seu_prelim_stg_norm_m55_M50SLO[['MSC33_cr']],. )

```

```{r, warning=FALSE, message=FALSE}
DimPlot(all_seu_prelim_stg_norm_m33_cr, dims = c(1,2), label = F, group.by = "in_cb") 

```

```{r, warning=FALSE, message=FALSE}
all_seu_prelim_stg_norm_m33_cr@meta.data %>% 
  ggplot(aes(x = in_cb, y = background_fraction.y)) +
  geom_boxplot()

```


```{r, warning=FALSE, message=FALSE}
imap(all_seu_prelim_stg_norm_m55_M50SLO, ~DimPlot(.x, dims = c(1,2), label = F, group.by = "sR_fine_stg") + labs(title = .y) +scale_color_manual(values = sp_col_new))

```


```{r, message=F, warning=F}
# slct_sample_names <-c("MSC24", "MSC68", "MSC14", "MSC49", "MSC55") %>% str_sort(., numeric = T)
# sample_name_ed_cr <- c(paste0(sample_name, "_edrops50"), paste0(sample_name, "_cbendr"))
sample_name_ed_cr <- c(paste0(sample_name, "_edrops", man_thresh[sample_name]), paste0(sample_name, "_cbendr"))

sample_name_ed_cr
```

```{r, message=F, warning=F}
##Read BPcells matrices
all_seu_prelim_stg_norm <- list.files("data/processed/Pf", pattern = "bpseu_(cr|cbendr|edrops[0-9]+)_prelim_stg_norm.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpseu|_prelim.*'))) %>% 
# all_seu_norm <- list.files("data/processed/Pf", pattern = "bpc_seu.*_sct.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_sct.*'))) %>% 
  .[sample_name_ed_cr] %>%
  map(readRDS)

```


Read in seurat objects processed in farm
```{r, message=F, warning=F}
##Read elbo plots
all_seu_prelim_stg_norm_elbo <- list.files("data/processed/Pf", pattern = "bpseu_(cr|cbendr|edrops50)_prelim_stg_norm_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpseu|_prelim.*'))) %>% 
# all_seu_norm_elbo <- list.files("data/processed/Pf", pattern = "bpc_seu.*_sct_elbo.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
#   set_names(nm = (str_remove_all(.,'data/processed/Pf/|/seu_obj/|bpc_seu|_sct.*'))) %>% 
  .[sample_name_ed_cr] %>%
  map(readRDS)

all_seu_prelim_stg_norm_elbo
```


```{r}
map(all_seu_prelim_stg_norm, ~{table(.x@meta.data$nFeature > 100)})
```

```{r, warning=FALSE, message=FALSE}
imap(all_seu_prelim_stg_norm, ~DimPlot(.x, dims = c(1,2), label = T) + labs(title = .y))

```

```{r, warning=FALSE, message=FALSE}
imap(all_seu_prelim_stg_norm, ~DimPlot(.x, dims = c(1,2), label = T, group.by = "sR_fine_stg") + labs(title = .y) +scale_color_manual(values = sp_col_new))

```

```{r, warning=FALSE, message=FALSE}
## ap2g
imap(all_seu_prelim_stg_norm, possibly(~{FeaturePlot(.x, features = "PF3D7-1222600", order = T) + labs(title = .y)}, "missing"))
imap(all_seu_prelim_stg_norm, possibly(~{FeaturePlot(.x, features = "PF3D7-1222600", reduction = "pca", order = T) + labs(title = .y)}, "missing"))
```


```{r, warning=FALSE, message=FALSE}
## ccp4
imap(all_seu_prelim_stg_norm, possibly(~{FeaturePlot(.x, features = "PF3D7-1215500", order = T) + labs(title = .y)}, "missing"))
imap(all_seu_prelim_stg_norm, possibly(~{FeaturePlot(.x, features = "PF3D7-1215500", reduction = "pca", order = T) + labs(title = .y)}, "missing"))
```


```{r, warning=FALSE, message=FALSE}
## Pfs16
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0406200") + labs(title = .y))
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0406200", reduction = "pca") + labs(title = .y))
```


```{r, warning=FALSE, message=FALSE}
## sbp1
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0501300") + labs(title = .y))
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0501300", reduction = "pca") + labs(title = .y))
```


```{r, warning=FALSE, message=FALSE}
## mget
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-1469900") + labs(title = .y))
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-1469900", reduction = "pca") + labs(title = .y))
```


```{r, warning=FALSE, message=FALSE}
## ccp4
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0903800") + labs(title = .y))
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "PF3D7-0903800", reduction = "pca") + labs(title = .y))
```


```{r, warning=FALSE, message=FALSE}
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "nFeature_RNA") + labs(title = .y))
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, features = "nFeature_RNA", reduction = "pca") + labs(title = .y))
```


```{r}

# ncount_filt <- unlist(map(all_seu_prelim_stg_norm, ~quantile(.x@meta.data[, "nCount_RNA"], 0.999, na.rm = T)))
```


```{r, results='asis'}
std_theme <- theme(axis.text=element_text(size=18), 
            axis.title=element_text(size=18,face="bold"), 
            legend.text = element_text(size=22), 
            legend.title = element_text(size=22,face="bold"))


```

```{r, results='asis'}
# pmap(list(all_seu_prelim_stg_norm, ncount_filt, names(all_seu_prelim_stg_norm)), ~{
#     VlnPlot(..1, feature = "nCount_RNA", group.by = "seurat_clusters", pt.size = 1)+ 
#       # scale_color_manual(values = sp_fld_colors) +
#       geom_hline(yintercept = ..2)  +
#       labs(title = ..3) +
#       std_theme
# 
#   })

```

```{r, results='asis'}
# gogo()
```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
plts_seu <- imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = T) +  theme_void() + theme(legend.position = "none") + labs(title = .y), "no cells"))

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plot_grid(plotlist = plts_seu[1:28], ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plot_grid(plotlist = plts_seu[29:56], ncol = 4)

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
plts <- imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = T, cells.highlight =  colnames(.x[,.x@meta.data$nFeature_RNA <100]), sizes.highlight = 0.05) + 
                                     theme(legend.position = "none",
                                           axis.text = element_blank(),
                                           axis.title = element_blank()) +
                                     labs(title = .y), "no cells"))

```


```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plot_grid(plotlist = plts[1:28], ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
plot_grid(plotlist = plts[29:56], ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plts[[29]]
```




```{r, warning=FALSE, message=FALSE, fig.width=16, fig.height=4}
# imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, label = T, features = c("nFeature_RNA", "nCount_RNA"), ncol = 4, dims = c(1,3)) + 
#        labs(title = .y) )

```

```{r, warning=FALSE, message=FALSE, fig.width=16, fig.height=4}
imap(all_seu_prelim_stg_norm, ~FeaturePlot(.x, label = T, features = c("nFeature_RNA", "nCount_RNA"), ncol = 2) + 
       labs(title = .y) )

```



```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in edrops but not in cellbender
ed_notin_cb <- pmap(list(
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")],
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")],
  names(all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")])),~{
  DimPlot(..1, label = T, cells.highlight = colnames(..1)[!colnames(..1) %in% colnames(..2)], sizes.highlight = 0.1, label.size = 6) + 
      theme_void() +
      theme(legend.position = "none", text = element_text(size =12)) +labs(title = ..3)
})

```


```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plot_grid(plotlist = ed_notin_cb, ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
cb_notin_ed <- pmap(list(
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")],
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")],
  names(all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")])),~{
  DimPlot(..2, label = T, cells.highlight = colnames(..2)[!colnames(..2) %in% colnames(..1)], sizes.highlight = 0.1, label.size = 6) + 
      theme_void() +
      theme(legend.position = "none", text = element_text(size =12)) +labs(title = ..3)
})

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
plot_grid(plotlist = cb_notin_ed, ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in both edrops and cellbender
ed_in_cb <- pmap(list(
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")],
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")],
  names(all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")])), ~{
  DimPlot(..1, label = T, cells.highlight = colnames(..1)[colnames(..1) %in% colnames(..2)], sizes.highlight = 0.01, label.size = 6) + 
      theme_void() +
      theme(legend.position = "none", text = element_text(size =12), 
            # axis.title = element_blank(), axis.text = element_blank()
            ) +labs(title = ..3)  
})

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
plot_grid(plotlist = ed_in_cb, ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=5}
## in both cellbender and edrops
cb_in_ed <- pmap(list(
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")],
  all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "edrops")],
  names(all_seu_prelim_stg_norm[str_detect(names(all_seu_prelim_stg_norm), "cbendr")])), ~{
  DimPlot(..1, label = T, cells.highlight = colnames(..1)[colnames(..1) %in% colnames(..2)], sizes.highlight = 0.01, label.size = 6) + 
      theme_void() +
      theme(legend.position = "none", text = element_text(size =12), 
            # axis.title = element_blank(), axis.text = element_blank()
            ) +labs(title = ..3)  
})

```


```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
## in cellbender but not in edrops
plot_grid(plotlist = cb_in_ed, ncol = 4)

```



```{r, warning=FALSE, message=FALSE}
map(all_seu_prelim_stg_norm, ~DimPlot(.x, group.by = "mthds_union"))

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
plts_mthds <- imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = F, group.by = "mthds_union") +  theme_void() + theme(legend.position = "bottom") + labs(title = .y), "no cells"))

```

```{r, warning=FALSE, message=FALSE, fig.height= 15, fig.width= 12, eval=T}
plot_grid(plotlist = plts_mthds[1:28], ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.height= 15, fig.width= 12, eval=T}
plot_grid(plotlist = plts_mthds[29:56], ncol = 4)

```

```{r, warning=FALSE, message=FALSE, fig.height= 14, fig.width= 10, eval=T}
plot_grid(plotlist = plts_mthds[29:56], ncol = 4)
```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = T, cells.highlight =  colnames(.x[,.x@meta.data$nFeature_RNA <100]), sizes.highlight = 0.05) + 
                                     theme(legend.position = "none",
                                           text = element_text(size =20)) +
                                     labs(title = .y), "no cells"))

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = T, cells.highlight =  colnames(.x[,.x@meta.data$sR_fine_stg %in% c("weak_score", "discrepantFM")]), sizes.highlight = 0.05) + 
                                     theme(legend.position = "none",
                                           text = element_text(size =20)) +
                                     labs(title = .y), "no cells"))

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, possibly(~DimPlot(.x, label = F, group.by =  "sR_fine_stg", label.size = 6) + 
                                     scale_color_manual(values = sp_col_new) +
                                     theme(legend.position = "none",
                                           text = element_text(size =20)) +
                                     labs(title = .y), "no cells"))

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, possibly(~FeaturePlot(.x, label = F, features =  "sR_actl_score", label.size = 6, order = T) + 
                                     # scale_color_manual(values = sp_col_new) +
                                     theme(legend.position = "none",
                                           text = element_text(size =20), 
                                           axis.title = element_blank(), 
                                           axis.text = element_blank()) +
                                     labs(title = .y), "no cells"))

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, possibly(~FeaturePlot(.x, label = F, features =  "nCount_RNA", label.size = 6, order = T) + 
                                     # scale_color_manual(values = sp_col_new) +
                                     theme(legend.position = "none",
                                           text = element_text(size =20), 
                                           axis.title = element_blank(), 
                                           axis.text = element_blank()) +
                                     labs(title = .y), "no cells"))

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, ~.x@meta.data %>% 
       count(nFeature_RNA <100 , sR_fine_stg)
     )

```



```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=3}
# gogo()
```

```{r, warning=FALSE, message=FALSE, fig.width=10, fig.height=3}
## in cellbender but not in edrops
soupc_status_cols <- c(singlet = "#f79256", doublet = "#048ba8", unassigned = "#a8dadc")
```



```{r, warning=FALSE, message=FALSE, fig.width=28, fig.height=4}
## in cellbender but not in edrops
fn_stg_barp_tbl <- imap(all_seu_prelim_stg_norm, ~.x@meta.data %>% 
       count(nFeature_RNA <100 , sR_fine_stg) %>%
       rename("gn_less100" = `nFeature_RNA < 100`) %>%
       mutate(across(gn_less100, ~str_extract(., "^."))) %>%
       group_by(gn_less100) %>%
       mutate(prop_n = round(n/sum(n), 2))
     ) %>%
  bind_rows(., .id = "donor") %>%
  filter(str_detect(donor, "cbendr")) %>%
  ungroup() 

n_per_facet <- fn_stg_barp_tbl %>% count(donor, gn_less100) %>% pull(n) %>% max()
bar_width <- 0.8 / n_per_facet

# ggplot(df, aes(x = category, y = value)) +
#     geom_col(width = bar_width) +
#     facet_nested_wrap(~ region + country, ncol = 3) +
#     theme_minimal()


fn_stg_barp <- fn_stg_barp_tbl %>%
  ggplot(aes(x = sR_fine_stg, y = prop_n, fill = sR_fine_stg)) +
  geom_col(position = position_dodge()) +
  # geom_text(aes(label=n), hjust=0.5, vjust= -0.3, position = position_dodge(width = .9), size = 4.4, show.legend = F) +
  scale_fill_manual(values = sp_col_new) +
  facet_nested(. ~ donor + gn_less100, scales = "free_x", space = "free") +
  theme_classic() + 
  theme(text = element_text(size =20),
        axis.text.x = element_blank())

fn_stg_barp
```


```{r, warning=FALSE, message=FALSE, fig.width=26, fig.height=4}
## in cellbender but not in edrops
fn_stg_barp+ 
  theme(legend.position = "bottom")
```



```{r, fig.width = 14, fig.height = 3, message=FALSE, warning=FALSE}
imap(all_seu_prelim_stg_norm, ~.x@meta.data %>% 
       count(nFeature_RNA <100 , sR_fine_stg) %>%
       rename("gn_less100" = `nFeature_RNA < 100`) %>%
       group_by(gn_less100) %>%
       mutate(prop_n = round(n/sum(n), 2))
     ) %>%
  bind_rows(., .id = "donor") %>%
  filter(str_detect(donor, "cbendr")) %>%
  ungroup() %>%
  ggplot(aes(x = gn_less100, y = prop_n, fill = sR_fine_stg)) +
  geom_col(position= position_dodge(width = .9)) +
  scale_fill_manual(values =  sp_col_new, guide = guide_legend( direction = "horizontal"  ))+
  geom_text(aes(label=n), angle=90, hjust=0.5, vjust= -0.3, position = position_dodge(width = .9), size = 4.4, show.legend = F)+
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.2))) +
  scale_x_discrete(expand = expansion(add = c(1.2, 0.8))) +
  # facet_grid(.~Strain_DN) +
  ggh4x::facet_nested_wrap(vars(donor, gn_less100),  nrow = 1, scales = "free_x") +
  theme_classic() +
  labs( y = 'Counts (X100)')+
      theme(
        axis.text.y  = element_text(size = 14),
        axis.title.y  = element_text(size = 14),
        axis.title.x = element_blank(),
        legend.text = element_text(size = 14),
        legend.title = element_text(size = 14, face = "bold"),
        legend.position="bottom",
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.text =element_text(size=15, colour = 'black'),
        panel.border=element_rect(colour="black",fill='transparent')#,
      ) +
    guides(fill = guide_legend( nrow = 1, title.position = "left"))

```


```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.8}
## in cellbender but not in edrops
dblt_cols <- c(Singlet = "#ffd9b4", Doublet ="#6A5ACD")
```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.5}
## in cellbender but not in edrops
imap(all_seu_prelim_stg_norm, ~.x@meta.data %>% 
       count(nFeature_RNA <100 , sR_fine_stg)
     )


```



```{r, warning=FALSE, message=FALSE, fig.width=16, fig.height=4}
## ccp4
imap(all_seu_prelim_stg_norm, ~DimPlot(.x, label = T, group.by = c("sR_fine_stg", "seurat_clusters"), ncol = 2) + 
       labs(title = .y) )

```






```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.8}

imap(all_seu_prelim_stg_norm, ~{
  .x@meta.data %>%
    # filter(nFeature_RNA < 300) %>%
    ggplot(aes(x = log10(nFeature_RNA), y= log10(nCount_RNA), color = sR_fine_stg)) + 
    geom_point(size = 0.1) + 
    scale_color_manual(values = sp_col_new) +
    geom_hline(yintercept = log10(100)) + 
    geom_vline(xintercept = log10(100)) +
    geom_vline(xintercept = log10(80)) +
    labs(title = .y) +
    theme_classic()+
                                     theme(legend.position = "none",
                                           text = element_text(size =20), 
                                           # axis.title = element_blank(), 
                                           # axis.text = element_blank()
                                           ) 
    })

```

```{r, warning=FALSE, message=FALSE, fig.width=4, fig.height=4.8}

imap(all_seu_prelim_stg_norm, ~{
  .x@meta.data %>%
    filter(nFeature_RNA < 300) %>%
    ggplot(aes(x = log10(nFeature_RNA), y= log10(nCount_RNA), color = sR_fine_stg)) + 
    geom_point(size = 1) + 
    scale_color_manual(values = sp_col_new) +
    geom_hline(yintercept = log10(100)) + 
    geom_vline(xintercept = log10(100)) +
    geom_vline(xintercept = log10(80)) +
    labs(title = .y) +
    theme_classic()+
                                     theme(legend.position = "none",
                                           text = element_text(size =20), 
                                           axis.title = element_blank(),
                                           axis.text = element_blank()
                                           ) 
    })

```

```{r, warning=FALSE, message=FALSE, fig.width=14, fig.height= 4}

imap(all_seu_prelim_stg_norm, ~{
  .x@meta.data %>%
    ggplot(aes(x = nFeature_RNA > 100, y= sR_actl_score, color = sR_fine_stg)) + 
    geom_sina() + 
    scale_color_manual(values = sp_col_new) +
    geom_hline(yintercept = 0.85) + 
    facet_wrap(. ~ sR_fine_stg, nrow = 1, scales = "free_x") +
    labs(title = .y)
    })

```

