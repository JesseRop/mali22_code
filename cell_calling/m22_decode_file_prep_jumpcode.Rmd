---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  library(scmap)
  # library(ggsankey)
  # library(findPC)
  library(BPCells)
  library(furrr)
  library(future.batchtools)
  library(parallel)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
})
```


```{r, setup}

# knitr::opts_knit$set(root.dir = '/Users/jr35/Google Drive/My Drive/PHD_documents/malaria_phd/Mali2')
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2/')
```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("../multipurpose_scripts_lnk/seurat_sce/seu_sce_common_fns.R")
source("../multipurpose_scripts_lnk/plotting_common_fns.R")
source("mali22_code_lnk/pf_common_vars.R")
```


initialize variable for the sample names

```{r}
irods_id_sk21_mdata_cln <- read_csv("data/raw/irods_id_sk21_mdata_cln.csv") %>%
  mutate(sample_nm = str_remove_all(sample_name, "_JC")) %>%
  arrange(sample_nm)

smpl_nms <-irods_id_sk21_mdata_cln$sample_nm
#c("MSC24", "MSC33", "MSC37", "MSC38", "MSC39", "MSC40", "MSC45", "MSC48", "MSC49", "MSC50_MACS", "MSC50_SLO", "MSC53", "MSC54", "MSC55", "MSC57", "MSC60", "MSC66", "MSC67", "MSC68", "MSC70")
# source_irods <- c("5736STDY11771545", "5736STDY11771544", "5736STDY11771536", "5736STDY11771546", "5736STDY11771535")
# sample_name <- c("MSC1272", "MSC13", "MSC3", "MSC14", "MSC1")
```


```{r}
(mrc_sk21_summary <- read_csv("data/raw/MRC_Sample_Analysis_Summary_Summary.csv", skip = 1) )
```


```{r}
mrc_sk21_summary %>% filter(str_detect(mixed_infection, "pf") & (str_detect(shortids, "SetB|SetC") | Sample_Name %in% c("MSC1", "MSC3", "MSC13", "MSC14", "MSC12C72")) )
```

```{r}
## Preprocessing to count number of runs per sample JC + non_JC
pf_22_jcode_run_num <- mrc_sk21_summary %>% 
  filter(str_detect(mixed_infection, "pf") & (str_detect(shortids, "SetB|SetC") | Sample_Name %in% c("MSC1", "MSC3", "MSC13", "MSC14", "MSC12C72") )) %>%
  mutate(sample_nm = str_remove_all(Sample_Name, "_JC|C72")) %>%
  group_by(sample_nm) %>%
  add_count(name = "runs") %>%
  rename('irods_id' = Sanger_SampleID)

```


```{r}
## Merging Jumpcode and non-jumpcode files for the same pair and including all the samples
pf_22_jcode_runs <- pf_22_jcode_run_num %>% 
  ungroup() %>%
  mutate(jc_sample = if_else(str_detect(Sample_Name, "JC"), "jcode_yes", "jcode_no")) %>%
  select(jc_sample, sample_nm, irods_id, mixed_infection2, Jumpcode) %>%
  pivot_wider(names_from = jc_sample, values_from =  irods_id) %>%
  mutate(irods_id_mrg = case_when(Jumpcode == "Yes" ~ paste(jcode_no,jcode_yes, sep = ","),
                                  T ~ jcode_no),
         irods_id_mrg = str_remove(irods_id_mrg, ",NA"))

```

```{r}
## Merging Jumpcode and non-jumpcode files for the same pair and including all the samples
pf_22_jcode_mergeYesNo <- pf_22_jcode_runs %>% 
  filter(!is.na(jcode_yes)) %>% 
  mutate("irods_samples" = irods_id_mrg)

pf_22_jcode_No <- pf_22_jcode_runs %>% 
  filter(!is.na(jcode_yes)) %>% 
  mutate("irods_samples" = jcode_no)

pf_solo_mixed_mdata_jcode_merge <- rbind(pf_22_jcode_No, pf_22_jcode_mergeYesNo) %>% 
  mutate(irods_id = str_replace(irods_samples, ",", "_"),
         sample_nm = case_when(str_detect(irods_id, "_") ~ paste0(sample_nm, "C"),
                               T ~ paste0(sample_nm, "noJC")))
  
pf_solo_mixed_jcode_merge_decode_cellranger <- pf_solo_mixed_mdata_jcode_merge %>%
  select(sample_nm, irods_id, mixed_infection2, irods_samples) 

pf_solo_mixed_jcode_merge_decode <- pf_solo_mixed_mdata_jcode_merge %>%
  select(sample_nm, irods_id, mixed_infection2) 


```

```{r, eval=T}
write_tsv(pf_solo_mixed_jcode_merge_decode_cellranger, "data/raw/pf_solo_mixed_jcode_merge_decode_cellranger.tsv")
write_csv(pf_solo_mixed_jcode_merge_decode, "data/raw/pf_solo_mixed_jcode_merge_decode.csv")

```


```{r}
## Getting only the jumpcode run where a sample was ran twice (non-jumpcode and jumpcode)
pf_22_jcode <- pf_22_jcode_run_num %>%
  filter(runs == 1 | runs ==2 & str_detect(Sample_Name, "JC")) 

```


```{r}
## Getting both pf solo infections and those mixed with other species
pf_solo_mixed_mdata <- pf_22_jcode %>% 
  group_by(sample_nm) %>%
  add_count(name = "runs") %>%
  filter(pf > 200) %>%
  filter(!(Sample_Name %in% c("MSC65", "MSC69-71")))  #%>%
  #filter(runs == 1 | runs ==2 & str_detect(Sample_Name, "JC")) 
```

```{r}
pf_solo_mixed_mdata
```

```{r}
## Getting  pf solo infections
pf_solo_mdata <- pf_solo_mixed_mdata %>% 
  filter(str_detect(mixed_infection2, "solo")) 
```

```{r}
pf_solo_mdata
```

Copy the irods metadata file from local into farm
```{r, eval=T}
write_csv(pf_solo_mixed_mdata, "data/raw/pf_solo_mixed_mdata.csv")
```

```{r, eval=T}
pf_solo_mixed_mdata_decode <- pf_solo_mixed_mdata %>% select(sample_nm, irods_id, mixed_infection2)

write_csv(pf_solo_mixed_mdata_decode, "data/raw/pf_solo_mixed_mdata_decode.csv")
```


```{r, eval=T}
pf_all_mdata <- rbind(pf_solo_mixed_mdata, pf_solo_mixed_mdata_jcode_merge %>% select(-c(irods_samples)))

write_csv(pf_all_mdata, "data/raw/pf_all_mdata.csv")
```


```{r, eval=T}
pf_all_id_decode <- pf_all_mdata %>% select(sample_nm, irods_id,  mixed_infection2)

write_csv(pf_all_id_decode, "data/raw/pf_all_id_decode.csv")
```

## Genotype clustering for MSC

Read in clusters.tsv files with assignment of cells to strains and PCA plots metrics

Transfer clusters.tsv files with assignment of cells to strains and PCA plots metrics for the best K from farm to my local Mac

```{r}

##Sample ID
sample_name <- str_sort(pf_solo_mixed_mdata$sample_nm)
smpl_nms <-str_sort(pf_solo_mixed_mdata$sample_nm)

##Sample IDs
source_irods <- pf_solo_mixed_mdata[,c('sample_nm', 'irods_id')] %>% deframe() %>%.[sample_name]

```

