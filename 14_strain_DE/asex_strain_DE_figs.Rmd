---
title: "MSC QC and preprocessing"
date: '2022-07-11'
author: 'Jesse Rop'
output:
  html_document:
    toc: true
    theme: united
    code_folding: hide
    df_print: paged
---

```{r}
suppressPackageStartupMessages({
  library(Seurat)
  library(sctransform)
  # library(rgl)
  library(patchwork)
  # library(DoubletFinder)
  library(ggrepel)
  library(ggpubr)
  library(dplyr) 
  library(stringr)
  library(purrr)
  library(readr)
  library(tibble)
  library(ggplot2)
  library(tidyr)
  library(cowplot)
  # library(scDblFinder)
  library(SeuratData)
  library(SeuratDisk)
  library(plotly)
  library(Hmisc)
  library(rmarkdown)
  library(RColorBrewer)
  # library(Platypus)
  library(ggvenn)
  library(conflicted)
  # library(SoupX)
  library(MetBrewer)
  library(ggh4x)
  library(SingleCellExperiment)
  # library(scmap)
  # library(ggsankey)
  # library(findPC)
  library(BPCells)
  # library(furrr)
  # library(future.batchtools)
  library(parallel)
  library(EnhancedVolcano)
  library(DropletUtils)
  library(ggforce)
  library(slingshot)
  library(openxlsx)
  
  conflict_prefer("select", "dplyr")
  conflict_prefer("filter", "dplyr")
  conflict_prefer("rename", "dplyr")
  conflict_prefer("map", "purrr")
  conflict_prefer("count", "dplyr")
  conflicts_prefer(base::saveRDS)
  conflicts_prefer(SingleCellExperiment::colData)
  conflicts_prefer(base::as.data.frame)
  conflicts_prefer(base::as.factor)
})
```







# MSC Preprocessing


## setup, read input files and exploratory visualizations and general functions


```{r, setup}
# library(reticulate)
# # use_condaenv("/Users/jr35/envs/scv_jupcon/", required = TRUE)
# # matplotlib <- reticulate::import("matplotlib")
# # matplotlib$use("Agg", force = TRUE)
# 
# knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali')
knitr::opts_knit$set(root.dir = '/lustre/scratch126/tol/teams/lawniczak/users/jr35/phd/Mali2')

```

### Common functions

#### Source commong functions, varriables and tables
```{r}
##Boxplot labeling function
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/seurat_sce/seu_sce_common_fns.R")
source("/nfs/users/nfs_j/jr35/multipurpose_scripts/plotting_common_fns.R")
source("/nfs/users/nfs_j/jr35/Mali2/mali22_code/pf_common_vars.R")
source("mali22_code_lnk/project_plotting_fns.R")

```

```{r, message=F, warning=F}
## Generated in 'm2_integration_asx_clustr_gn_explrtn.Rmd'
# asex_noM55_jcC_harmony <- readRDS('data/processed/Pf/m2_all/v3_m2_asex_cr_filt_noM55_jcC_norm_harmony_jnd_fine_clustrs3.RDS')
asex_noM55_jcC_harmony <- readRDS('data/processed/Pf/m2_all/integrated_asex_exploration/v3_m2_asex_cr_filt_noM55_jcC_norm_harmony_jnd_fine_clustrs.RDS')

```

```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
DimPlot(asex_noM55_jcC_harmony, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_clusters_fine_erings", label.size = 6, label.box = F) +
  scale_color_manual(values = seu_cols) +
  scale_fill_manual(values = seu_cols) +
  theme_classic() +
  labs(title = "", x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 15),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        # axis.title = element_blank()
        ) 

```

```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
DimPlot(asex_noM55_jcC_harmony, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_clusters_fine_erings", label.size = 6, label.box = F, dims = c(1,3)) +
  scale_color_manual(values = seu_cols) +
  scale_fill_manual(values = seu_cols) +
  theme_classic() +
  labs(title = "", x = "UMAP1", y= "UMAP3") +
  theme(text = element_text(size = 15),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        # axis.title = element_blank()
        ) 

```

```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
## Generated in 'm22_raw_integration_asex_pseudotime.Rmd'
asex_noM55_jcC_harmony_no_comtd <- readRDS("data/processed/Pf/m2_all/strain_DE/asex_noM55_jcC_harmony_no_comtd.RDS")

```

```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
DimPlot(asex_noM55_jcC_harmony_no_comtd, label = T, reduction = "umap.harmony_PC_man", group.by = "harmony_clusters_fine_erings", label.size = 6, label.box = F) +
  scale_color_manual(values = seu_cols) +
  scale_fill_manual(values = seu_cols) +
  theme_classic() +
  labs(title = "", x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 15),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        # axis.title = element_blank()
        ) 

```


```{r}
## Generated in 'm22_raw_integration_asex_pseudotime.Rmd'
asex_noM55_jcC_harmony_no_comtd_pt <- readRDS("data/processed/Pf/asex_noM55_jcC_harmony_no_comtd_pt3.RDS")

```


```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
FeaturePlot(asex_noM55_jcC_harmony_no_comtd_pt, features = c("slingPseudotime_1"), reduction = "umap.harmony_PC_man", pt.size = 0.01) +
  theme_classic() +
  labs(title = "", x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 15),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) 

```

#### Pseudotime clusters starting from 0 to 1

```{r, warning=FALSE, message=FALSE, fig.width=3, fig.height=3}
DimPlot(asex_noM55_jcC_harmony_no_comtd_pt, reduction = "umap.harmony_PC_man", group.by = "harmony_clusters_ss", order = T, pt.size = 0.5)+ 
  theme_classic() +
  labs(title = "", x = "UMAP 1", y= "UMAP 2") +
  theme(text = element_text(size = 15),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        # axis.title = element_blank()
        ) 

```

#### Pseudotime as calculated by slingshot
```{r, results="asis", fig.width= 1.5, fig.height=3}

FeaturePlot(asex_noM55_jcC_harmony_no_comtd_pt, features = c("slingPseudotime_1"), reduction = "umap.harmony_PC_man", pt.size = 0.01) +
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        axis.ticks = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 15) ,
        legend.title = element_text(size = 15, face = "bold") ) +
    guides(color = guide_colourbar(title.position = "top"))




```

```{r, results="asis", fig.width= 3, fig.height=3}

FeaturePlot(asex_noM55_jcC_harmony_no_comtd_pt, features = c("slingPseudotime_1"), reduction = "umap.harmony_PC_man", pt.size = 0.01) +
  scale_color_distiller(name="Pseudotime", direction = 1, palette = "Blues") + 
  theme_classic()+
  theme(axis.text=element_blank(), 
        axis.title=element_blank(),
        axis.ticks = element_blank(),
        legend.position = "bottom",
        legend.text = element_text(size = 15) ,
        legend.title = element_text(size = 15, face = "bold") ) +
    guides(color = guide_colourbar(title.position = "top"))




```


```{r}
# Generated in 'm22_raw_MAST_intradon_DE_Chiyun.Rmd' for plotting
v3_m2_asex_cr_filt_norm_harmony_pt_downsampling_chunks <- readRDS("data/processed/Pf/m2_all/strain_DE/v3_m2_asex_cr_filt_norm_harmony_pt_downsampling_chunks.RDS")
```

```{r}
DimPlot(v3_m2_asex_cr_filt_norm_harmony_pt_downsampling_chunks, reduction = "umap.harmony_PC_man", group.by = "downsampling_ptime_bal_cat", cols = ptc_cols, label = T ) +
  theme(legend.position = "none")
```


```{r, warning=FALSE, message=FALSE, fig.width=3.5, fig.height=3}
DimPlot(v3_m2_asex_cr_filt_norm_harmony_pt_downsampling_chunks, reduction = "umap.harmony_PC_man", group.by = "downsampling_ptime_bal_cat", label.size = 5, label.box = T, label = T, label.color = "white", repel = F) +
  geom_text(aes(label=paste0("N=", dim(v3_m2_asex_cr_filt_norm_harmony_pt_downsampling_chunks)[2]), x = 1, y = 4), size = 8, fontface ='plain')+
  theme_classic() +
  scale_color_manual(values = ptc_cols) +
  scale_fill_manual(values = ptc_cols) +
  labs(title = "", x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 17),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) 


```

```{r, message=FALSE, warning=FALSE}
# Generated in 'm22_raw_MAST_intradon_DE_Chiyun.Rmd' for plotting
m2_asex_bal_seu_plot <- readRDS('data/processed/Pf/m2_all/m2_asex_bal_seu.RDS')

```

```{r}
m2_asex_bal_seu_plot <- m2_asex_bal_seu_plot@meta.data %>%
  mutate(PtimeC = str_remove(ptime_bal_cat, "PT")) %>% 
  select(PtimeC) %>%
  AddMetaData(m2_asex_bal_seu_plot, .)
  
```

```{r, warning=FALSE, message=FALSE, fig.width=3.5, fig.height=3}
DimPlot(m2_asex_bal_seu_plot, reduction = "umap.harmony_PC_man", group.by = "ptime_bal_cat", label.size = 6, label.box = T, label = T, label.color = "black") +
  geom_text(aes(label=paste0("N=", dim(m2_asex_bal_seu_plot)[2]), x = 1, y = 4), size = 8, fontface ='plain')+
  theme_classic() +
  scale_color_manual(values = ptc_cols2) +
  scale_fill_manual(values = ptc_cols2) +
  labs(title = "", x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 17),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) 


```


```{r, fig.width=8, fig.height=3}
m2_asex_bal_seu_plot@meta.data %>% 
  count( donor,  strain) %>% 
  mutate(across(donor, ~str_remove_all(., "SC|C"))) %>% 
  group_by( donor) %>% 
  mutate(strn_n = n_distinct(strain)) %>% 
  filter(strn_n >1) %>%
  ggplot(aes(x = strain, y = n)) +
  geom_col() +
  # geom_col(position = position_dodge2()) + #width=0.4, position = position_dodge(width=0.5) 
  geom_text(aes(label=n), hjust=-0.05, vjust= 0.5, position = position_dodge(width = .9), size = 6.5, show.legend = F, fontface ='bold', angle = 90)+
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.55))) +
  facet_nested_wrap(vars(donor), nrow = 1, scales = "free_x") +
  theme_classic() +
  labs(y = "Counts", x= "Strain") +
  theme(axis.text.x = element_text(angle = 90),
        strip.text = element_text(size = 18, face = "bold"),
        text = element_text(size = 18)) 
```


```{r, fig.width=16, fig.height=3}
m2_asex_bal_seu_plot@meta.data %>% 
  count( donor, ptime_bal_cat, strain) %>% 
  mutate(across(donor, ~str_remove_all(., "SC|SLO|C|_")),
         across(ptime_bal_cat, ~str_remove_all(., "\\."))) %>% 
  group_by( donor) %>% 
  mutate(strn_n = n_distinct(strain)) %>% 
  filter(strn_n >1) %>%
  ggplot(aes(x = strain, y = n)) +
  geom_col() +
  # geom_col(position = position_dodge2()) + #width=0.4, position = position_dodge(width=0.5) 
  geom_text(aes(label=n), hjust=-0.05, vjust= 0.5, position = position_dodge(width = .9), size = 5, show.legend = F, fontface ='bold', angle = 90)+
  facet_nested_wrap(vars(donor,ptime_bal_cat), nrow = 1, scales = "free_x") +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        strip.text = element_text(size = 14),
        text = element_text(size = 14)) 
```

```{r, fig.width=10, fig.height=12}
# generated in 'm2_tseq_interstrain_intradon_DE.Rmd'
umap_meta_df_bal_cells_plot <- readRDS("data/processed/Pf/m2_all/strain_DE/umap_meta_df_bal_cells_plot.RDS")
```

```{r, fig.width=10, fig.height=8}
umap_meta_df_bal_cells_plot_cln <- umap_meta_df_bal_cells_plot %>%
  mutate(across(pt_set, ~str_replace(str_remove(., "SC"), "C_", "_")))

```

```{r, fig.width=10, fig.height=8}
umap_meta_df_bal_cells_plot_cln_labels <- umap_meta_df_bal_cells_plot_cln %>% 
                  filter(bal_de == "yes" & Strain != "Other") %>% 
                  distinct(donor, pt_set,Strain, .keep_all = T) %>%
                  group_by(donor, pt_set) %>%
                  mutate(y_pos = rank(-as.numeric(Strain)) * 1.5,
                         y_vjust = n_distinct(Strain))
```

```{r, fig.width=3, fig.height=2.8}
strn_sizes <- ifelse(strain_nms == "Other", 0.01, 0.5) %>% set_names(strain_nms)

```

```{r, fig.width=10, fig.height=8}
umap_meta_df_bal_cells_plot_cln %>%
      ggplot(., aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = Strain, size = Strain))+
      geom_point() +
      scale_color_manual(values = strain_cols_n)+
      scale_size_manual(values = strn_sizes) +
      geom_text(data = umap_meta_df_bal_cells_plot_cln_labels, 
                aes(x = 1, y = y_pos, vjust = y_vjust-4.6, label = strain_n), 
                size = 5#, 
                # color = "black"
                ) +
      facet_wrap(pt_set ~ ., ncol = 7) +
      theme_classic()+
      # scale_color_manual(values = sp_fld_colors) +
      theme(#legend.position = "bottom", 
        legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=13,face="bold", colour = 'black'))+
  # guides(x = "axis_nested") +
  labs(x = "UMAP_1", y="UMAP_2")
  
```

```{r, fig.width=4, fig.height=4}
umap_meta_df_bal_cells_plot_cln %>%
      filter(donor == "MSC49C" & str_detect(pt_set, "M49") & Strain != "Other") %>%
      ggplot(., aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = Strain))+
      geom_point() +
      scale_color_manual(values = strain_cols_n)+
      # scale_size_manual(values = strn_sizes) +
      # geom_text(data = umap_meta_df_bal_cells_plot_cln_labels %>% filter(donor == "MSC49C") , 
      #           aes(x = 1, y = y_pos, vjust = y_vjust-4.6, label = strain_n), 
      #           size = 5#, 
      #           # color = "black"
      #           ) +
      # facet_wrap(pt_set ~ ., ncol = 7) +
      theme_classic()+
      # scale_color_manual(values = sp_fld_colors) +
      theme(#legend.position = "bottom", 
        legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=13,face="bold", colour = 'black'))+
  # guides(x = "axis_nested") +
  labs(x = "UMAP_1", y="UMAP_2")
  
```

```{r, warning=FALSE, message=FALSE, fig.width=3.5, fig.height=2.5}
FeaturePlot(m2_asex_bal_seu_plot[, m2_asex_bal_seu_plot$donor == "MSC49C" & m2_asex_bal_seu_plot$strain == "SC2"], reduction = "umap.harmony_PC_man", features = "pseudotime", pt.size = 2) +
  # geom_text(aes(label=paste0("N=", dim(m2_asex_bal_seu_plot)[2]), x = 1, y = 4), size = 8, fontface ='plain')+
  scale_color_distiller(direction = 1, palette = "Blues") + 
  theme_classic() +
  # scale_color_manual(values = ptc_cols2) +
  # scale_fill_manual(values = ptc_cols2) +
  # labs( x = "UMAP1", y= "UMAP2") +
  theme(text = element_text(size = 17),
        legend.position = "none",
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) 

```

```{r, fig.width=4, fig.height=4}

m2_asex_bal_seu_plot_df <- m2_asex_bal_seu_plot@reductions$umap.harmony_PC_man@cell.embeddings[,c(1,2,3)] %>% 
  as.data.frame() %>%
  rownames_to_column("cell_bc") %>%
  left_join(., m2_asex_bal_seu_plot@meta.data[,c("stage_fld", "slingPseudotime_1",  "orig.ident", "dset", "donor", "strain")] %>%
              as.data.frame() %>% rownames_to_column("cell_bc"), by = "cell_bc") %>% mutate(tr = 0)

```

```{r, fig.width=4, fig.height=4}
m2_asex_bal_seu_plot_df %>%
  ggplot(., aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2))+
      geom_point(data = m2_asex_bal_seu_plot_df %>% filter(donor == "MSC49C"), aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = slingPseudotime_1), inherit.aes = F) +
      # scale_size_manual(values = strn_sizes) +
      # geom_text(data = umap_meta_df_bal_cells_plot_cln_labels %>% filter(donor == "MSC49C") , 
      #           aes(x = 1, y = y_pos, vjust = y_vjust-4.6, label = strain_n), 
      #           size = 5#, 
      #           # color = "black"
      #           ) +
      # facet_wrap(pt_set ~ ., ncol = 7) +
      theme_classic()+
      # scale_color_manual(values = sp_fld_colors) +
      theme(#legend.position = "bottom", 
        legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=13,face="bold", colour = 'black'))+
  # guides(x = "axis_nested") +
  labs(x = "UMAP_1", y="UMAP_2")
  
```


```{r, fig.width=3.5, fig.height=2.5}
m2_asex_bal_seu_plot_df %>%
  ggplot(., aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = dset))+
      geom_point() +
      scale_color_manual(values = "grey")+
      # scale_color_manual(values = "#ededed")+
      ggnewscale::new_scale_color() +
      geom_point(data = m2_asex_bal_seu_plot_df %>% filter(donor == "MSC49C" & strain == "SC2"), aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = slingPseudotime_1), size = 2.5, inherit.aes = F) +
      scale_color_distiller(direction = 1, palette = "Blues") + 
  theme_classic() +
 theme(#legend.position = "bottom", 
        legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=13,face="bold", colour = 'black'))+
  # guides(x = "axis_nested") +
  labs(x = "UMAP_1", y="UMAP_2")
  
```


```{r, fig.width=3.5, fig.height=2.5}
m2_asex_bal_seu_plot_df %>%
  ggplot(., aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = dset))+
      geom_point() +
      scale_color_manual(values = "grey")+
      # scale_color_manual(values = "#ededed")+
      ggnewscale::new_scale_color() +
      geom_point(data = m2_asex_bal_seu_plot_df %>% filter(donor == "MSC49C" & strain == "SC5"), aes(x = umapharmonyPCman_1, y = umapharmonyPCman_2, colour = slingPseudotime_1), size = 2.5, inherit.aes = F) +
      scale_color_distiller(direction = 1, palette = "Blues") + 
  theme_classic() +
 theme(#legend.position = "bottom", 
        legend.position = "none",
        axis.text = element_blank(),
        axis.title = element_blank(),
        axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=13,face="bold", colour = 'black'))+
  # guides(x = "axis_nested") +
  labs(x = "UMAP_1", y="UMAP_2")
  
```


```{r, fig.width=10, fig.height=12}
# generated in 'm2_tseq_interstrain_intradon_DE.Rmd'
umap_meta_df_bal_cells_plot <- readRDS("data/processed/Pf/m2_all/strain_DE/umap_meta_df_bal_cells_plot.RDS")
```

```{r}
# Generated in 'm2_tseq_MAST_DE_comprsn.Rmd' 
mast_tde_corr_tbls <- readRDS("data/processed/Pf/m2_all/strain_DE/mast_tde_corr_tbls.RDS")

```

```{r}
# Generated in 'm2_GO_all.Rmd' 
mast_tde_corr_tbls_sig <- readRDS("data/processed/Pf/m2_all/strain_DE/mast_tde_corr_tbls_sig.RDS")

```

##### Tradeseq VS MAST comparisons

```{r}
pw_corr_plot <- function(g_tbls = mast_tde_corr_tbls, x_pos = 10, y_pos = 5){

      ggplot(g_tbls, aes(x=waldStat, y=-log10(p_val_adj))) +
              # geom_point() + 
              # facet_grid(.~pw_comparison, scales = "free_x") +
              geom_point(aes(color = pw_comparison)) +
              # scale_color_manual(values = fld_strns_nf54_7g8_comps_col, name = "Comparison") +
              stat_cor(method = "pearson", label.x = mean(g_tbls$waldStat)*20, label.y = mean(-log10(g_tbls$p_val_adj))*20, size = 5)+ 
              geom_vline( xintercept = 20)+
              geom_hline( yintercept = -log10(0.05))+
              labs(x = "tradeSeq waldStat", y = "Adjusted\nMAST P(-log10)") +
              theme_classic()+
              theme(axis.text=element_text(size=16), 
                    axis.title=element_text(size=16,face="bold"), 
                    legend.text = element_text(size = 14) ,
                    legend.title = element_text(size = 16, face = "bold"),
                    strip.text.x = element_text(size = 16, face = "bold"))
}
```


Correlation between MAST and tradeseq 
```{r, fig.width=4.5, fig.height=4}
# pw_corr_plot(g_tbls = mast_tde_corr_tbls)
de_corr_plts <- map(mast_tde_corr_tbls,  ~{
  pw_corr_plot(.x %>% mutate(across(pw_comparison, ~str_remove_all(., "_|s_"))) %>% filter(!str_detect(pw_comparison, 'SC.vs[L|N|7].*'))%>% filter(!str_detect(pw_comparison, 'NF54_A'))) +
    theme(legend.position = "bottom") +
  guides(color = guide_legend(ncol = 3, override.aes = list(size = 4), title.position = "top"))
    
  } )

de_corr_plts
```

### Individual gene visualization most common DE genes and also those that are shown in literature to be important in evolution etc

```{r, results='asis', warning=F, message=F}
solo_don <- c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C")
```


Read in tradeseq files from local
```{r}
asex_bal_ts_plts <- list.files('data/processed/Pf', pattern = "m2_asex_bal_ts.RDS$", full.names = T, recursive = T, include.dirs = T) %>% 
  set_names(nm = (str_remove_all(.,'data/processed/Pf/|/tradeseq.*'))) %>%
  .[solo_don] %>%
  map(readRDS)

```

```{r, warning=FALSE, message=FALSE}
# for (nm in names(asex_bal_ts_plts)) {
#   asex_bal_ts_plts[[nm]]@colData[,colnames(asex_bal_ts_plts[[nm]])] <-  asex_bal_ts_plts[[nm]]
# }
```

```{r}
asex_bal_ts_plts 

```

```{r, fig.width=10, fig.height=12}
# generated in 'm2_GO_all.Rmd'
DE_genes_freq <- readRDS("data/processed/Pf/m2_all/strain_DE/DE_genes_freq.RDS")

```


```{r, results='asis', warning=F, message=F, fig.width=5.5, fig.height=4}

# Visualise tradeseq fitted generalised additive models
tde_smooth_plt_light <- function(tde, lege_pos = "bottom", gn, gn_name, curve_cols) {
  
  plotSmoothers(tde, assays(tde)$counts, gene = gn, alpha = 1,  border = TRUE, curvesCols = curve_cols) +
            labs(title = gn_name) +
            theme(text = element_text(size = 14),
                  legend.position = lege_pos) +
            guides(color = guide_legend(override.aes = list(size = 2), title.position = "top", ncol = 1))
}

```

```{r, results='asis', warning=F, message=F, fig.width=5.5, fig.height=4}
gns2plotsmoother <- map(DE_genes_freq, ~.x %>% filter(freq_btwn_don >= 3) %>% 
      select(donor, gene_id, Gene) %>% 
      distinct(., .keep_all = T) %>% 
      split(., f = factor(.$gene_id)) %>%
      map(., ~split(.x, f = factor(.$donor)))
      
    )

```


```{r, results='asis', warning=F, message=F, fig.width=8, fig.height=4}
a <- imap(gns2plotsmoother[[1]][1],~{
  gn_tbl <- .x
  gn_nm <- str_remove(.y, "MS.*")
  
  map(gn_tbl, ~{
  lg_map <- str_remove_all(levels(asex_bal_ts_plts[[.x$donor]]$tradeSeq$conditions), "M.*_|M.*SLOC_") %>% set_names(paste0("Lineage 1_", levels(asex_bal_ts_plts[[.x$donor]]$tradeSeq$conditions)))
  
  cols = strain_cols_n[lg_map]

  names(cols) = paste0("Lineage 1_", str_remove_all(.x$donor, "SC|C$"), "_",names(cols))
  
  print(lg_map)
    
  tde_smooth_plt_light(tde = asex_bal_ts_plts[[.x$donor]], lege_pos = "bottom", gn = .x$gene_id, gn_name = .x$donor, curve_cols = cols) +
      scale_colour_manual(breaks = names(lg_map),
                           labels = lg_map,
                         values = cols
                         ) +
      theme(#legend.position = "none",
            plot.title = element_text(hjust = 0.5)
            ) +
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
      
    }) %>%
  cowplot::plot_grid(plotlist = ., ncol = 3, labels = gn_nm, label_size = 12, hjust = 0.1, vjust = 0.5 )
})
a
```


```{r, results='asis', warning=F, message=F}
# Generated in 'm2_tseq_MAST_DE_comprsn.Rmd' 
gn_tble_gg_smoother<- readRDS("data/processed/Pf/m2_all/strain_DE/gn_tble_gg_smoother.RDS") 
# gn_tble_gg_smoother_data <- readRDS("data/processed/Pf/m2_all/strain_DE/gn_tble_gg_smoother_data.RDS")

```

```{r, fig.width=4, fig.height=4}
manual_tseq_smoothers_plot <- function(tseq_dset, gn_xprsn_tbl, gene_id, plot_ttl) {
  
  df_curves <- predictSmooth(tseq_dset, gene = gene_id, nPoints = 100, tidy = TRUE) %>% 
    mutate(strain = str_remove(condition, "M.*_"))
  
  ggplot(gn_xprsn_tbl, aes(x = slingPseudotime_1 , y = log1p(!!rlang::sym(gene_id)+1), colour = strain)) + 
    geom_point() +
    geom_line(data = df_curves, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1) +
    scale_colour_manual(values = strain_cols_n) +
    labs(title = plot_ttl) +
    theme_classic() +
    theme(legend.position="bottom") +
    guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
}
```


```{r, fig.width=4, fig.height=4}

manual_tseq_smoothers_plot(tseq_dset = asex_bal_ts_plts[["MSC60C"]], gn_xprsn_tbl = gn_tble_gg_smoother[["MSC60C"]], gene_id = "PF3D7-0113000", plot_ttl = "id")
```

```{r, results='asis', warning=F, message=F, fig.width=8, fig.height=4}
a <- imap(gns2plotsmoother[[1]][1], ~{
  gn_tbl <- .x
  gn_nm <- str_remove(.y, "MS.*")
  
  print(gn_nm)
  
  map(gn_tbl, ~{
    manual_tseq_smoothers_plot(tseq_dset = asex_bal_ts_plts[[.x$donor]], gn_xprsn_tbl = gn_tble_gg_smoother[[.x$donor]], gene_id = .x$gene_id, plot_ttl = .x$donor)
      
    }) %>%
  cowplot::plot_grid(plotlist = ., ncol = 3, labels = gn_nm, label_size = 12, hjust = 0.1, vjust = 0.5 )
})

a
```

```{r, fig.width=4, fig.height=4}

df_curves <- predictSmooth(asex_bal_ts_plts[["MSC60C"]], gene = "PF3D7-0113000", nPoints = 100, tidy = TRUE) %>% 
  mutate(strain = str_remove(condition, "M.*_"))

ggplot(gn_tble_gg_smoother[["MSC60C"]], aes(x = slingPseudotime_1 , y = log1p(`PF3D7-0113000`+1), colour = strain)) + 
                             geom_point() +
                             geom_line(data = df_curves, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1) +
                             scale_colour_manual(values = strain_cols_n) +
  labs(title = "Gene") +
  theme_classic()+
                             theme(legend.position="bottom") +
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
```


```{r, fig.width=8, fig.height=4}

df_curves_don <- map(asex_bal_ts_plts[c("MSC33C", "MSC60C", "MSC66C")], ~predictSmooth(.x, gene = "PF3D7-0113000", nPoints = 100, tidy = TRUE) %>% 
  mutate(strain = str_remove(condition, "M.*_"))) %>% bind_rows(., .id = "donor")
gn_tble_gg_smoother_don <- gn_tble_gg_smoother[c("MSC33C", "MSC60C", "MSC66C")] %>% bind_rows(., .id = "donor")

ggplot(gn_tble_gg_smoother_don, aes(x = slingPseudotime_1 , y = log1p(`PF3D7-0113000`+1), colour = strain)) + 
                             geom_point(size = 1) +
                             geom_line(data = df_curves_don, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1) +
                             facet_wrap(donor ~ ., scales = "free_x") +
                             scale_colour_manual(values = strain_cols_n) +
  labs(title = "Gene") +
  theme_classic()+
                             theme(legend.position="bottom") +
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
```



```{r, fig.width=8, fig.height=5}
gn_tble_gg_smoother_don_all <- gn_tble_gg_smoother %>% 
  bind_rows(., .id = "donor") %>% 
  select(strain, cell_bc, starts_with("PF3D7"), donor, slingPseudotime_1)  %>% 
  pivot_longer(cols = starts_with("PF3D7"), names_to = "gene_id", values_to = "expression") %>% 
  left_join(., Pf3D7_genes_plasmoDB %>% dplyr::select(gene_id, Gene), by = 'gene_id') %>%
  mutate(across(Gene, ~ifelse(is.na(.x), gene_id, Gene)))
```


```{r, fig.width=8, fig.height=5}

df_curves_don_all <- map(asex_bal_ts_plts, ~predictSmooth(.x, gene = rownames(.x), nPoints = 100, tidy = TRUE) %>% 
  mutate(strain = str_remove(condition, "M.*_"))) %>%
  bind_rows(., .id = "donor") %>% 
  rename("gene_id" = gene) %>% 
  left_join(., Pf3D7_genes_plasmoDB %>% dplyr::select(gene_id, Gene), by = c('gene_id')) %>%
  mutate(across(Gene, ~ifelse(is.na(.x), gene_id, Gene)))

```

```{r, fig.width=8, fig.height=5}
df_curves_don <- df_curves_don_all %>% filter(gene_id %in% c("PF3D7-0113000", "PF3D7-1102700") & donor %in% c("MSC33C", "MSC60C", "MSC66C"))

gn_tble_gg_smoother_don <- gn_tble_gg_smoother_don_all %>% 
  filter(donor %in% c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C") & gene_id %in% c("PF3D7-0113000", "PF3D7-1102700")) 

ggplot(gn_tble_gg_smoother_don, aes(x = slingPseudotime_1 , y = log1p(expression+1), colour = strain)) + 
                             geom_point(size = 1) +
                             geom_line(data = df_curves_don, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1) +
                             facet_grid(gene_id ~ donor, scales = "free") +
                             scale_colour_manual(values = strain_cols_n) +
  labs(title = "Gene") +
  theme_classic2()+
                             theme(legend.position="bottom") +
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
```


### Plotting DE genes that are highly prevalent between donors
```{r}
mast_tde_corr_tbls <- readRDS('data/processed/Pf/m2_all/strain_DE/mast_tde_corr_tbls.RDS')
```


```{r, fig.width=10, fig.height=12}
asx_fre2_gns <- map(DE_genes_freq, ~.x %>% filter(freq_btwn_don >=2) %>% pull(gene_id) %>% unique())
```

```{r, results='asis', warning=F, message=F}
top_wstat <- map(mast_tde_corr_tbls, ~.x %>%
    filter(gene_id %in% asx_fre2_gns[[1]] & waldStat > 50 & p_val_adj < 1e-20) %>%
      left_join(., Pf3D7_genes_plasmoDB %>% dplyr::select(gene_id, Gene), by = 'gene_id')) %>% 
  bind_rows() %>%
  arrange(desc(waldStat)) %>% 
  select(gene_id, Gene) %>% 
  distinct(gene_id, .keep_all = T) %>%
  head(., n = 10) 

top_wstat
```

```{r, results='asis', warning=F, message=F}
top_mastLFC <- map(mast_tde_corr_tbls, ~.x %>%
    filter(gene_id %in% asx_fre2_gns[[1]] & waldStat > 50 & p_val_adj < 1e-20) %>%
      left_join(., Pf3D7_genes_plasmoDB %>% dplyr::select(gene_id, Gene), by = 'gene_id')) %>% 
  bind_rows() %>%
  arrange(desc(abs(avg_log2FC))) %>% 
  select(gene_id, Gene)  %>%
  distinct(gene_id, .keep_all = T) %>% 
  head(n = 10)

top_mastLFC
```


```{r, results='asis', warning=F, message=F}
base::intersect(top_wstat$gene_id, top_mastLFC$gene_id)

top_wstat_mastLFC <- top_wstat[top_wstat$gene_id %in% base::intersect(top_wstat$gene_id, top_mastLFC$gene_id),]
top_wstat_mastLFC_noVAR <- top_wstat_mastLFC %>% filter(!str_detect(Gene, "VAR"))
```


```{r, fig.width=10, fig.height=10}

tseq_smoother_facet_allDons_plot_fn <- function(gns = top_wstat_mastLFC_noVAR$gene_id) {
  
  df_curves_don <- df_curves_don_all %>% filter(gene_id %in% gns & donor %in% c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C"))

gn_tble_gg_smoother_don <- gn_tble_gg_smoother_don_all %>% 
  filter(donor %in% c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C") & gene_id %in% gns) 

ggplot(gn_tble_gg_smoother_don, aes(x = slingPseudotime_1 , y = log1p(expression+1), colour = strain)) + 
                             geom_point(size = 0.5) +
                             geom_line(data = df_curves_don, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1.5) +
                             facet_grid2(Gene ~ donor, scales = "free") +
                             scale_colour_manual(values = strain_cols_n) +
  # labs(title = "Gene") +
  theme_classic2()+
  theme(legend.position = "bottom", 
        # legend.position = "none",
        axis.text = element_text(size=14,face="plain", colour = 'black'),
        axis.title = element_text(size=14,face="plain", colour = 'black'),
        # axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=14,face="bold", colour = 'black'))+
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
}
```


```{r, fig.width=10, fig.height=10}

df_curves_don <- df_curves_don_all %>% filter(gene_id %in% top_wstat_mastLFC_noVAR$gene_id & donor %in% c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C"))

gn_tble_gg_smoother_don <- gn_tble_gg_smoother_don_all %>% 
  filter(donor %in% c("MSC33C", "MSC49C", "MSC50_SLOC", "MSC60C", "MSC66C", "MSC68C") & gene_id %in% top_wstat_mastLFC_noVAR$gene_id) 

ggplot(gn_tble_gg_smoother_don, aes(x = slingPseudotime_1 , y = log1p(expression+1), colour = strain)) + 
                             geom_point(size = 0.5) +
                             geom_line(data = df_curves_don, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1.5) +
                             facet_grid2(Gene ~ donor, scales = "free") +
                             scale_colour_manual(values = strain_cols_n) +
  # labs(title = "Gene") +
  theme_classic2()+
  theme(legend.position = "bottom", 
        # legend.position = "none",
        axis.text = element_text(size=14,face="plain", colour = 'black'),
        axis.title = element_text(size=14,face="plain", colour = 'black'),
        # axis.ticks = element_blank(),
        # strip.text =element_text(size=16,face="bold", colour = 'black'),
        strip.text =element_text(size=14,face="bold", colour = 'black'))+
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
```


```{r, fig.width=10, fig.height=5}
## GCH1, PTPS, DHPS, DHFS, DHFR-TS, FT1, SHMT
folate_pway_gns <- c("PF3D7-1224000", "PF3D7-0628000", "PF3D7-0810800", "PF3D7-1324800", "PF3D7-0417200", "PF3D7-0828600", "PF3D7-1116500", "PF3D7-1456100")
```


```{r, fig.width=10, fig.height=12}
tseq_smoother_facet_allDons_plot_fn(gns = folate_pway_gns)
```


```{r, results='asis', warning=F, message=F, fig.width=5.5, fig.height=4}
gns2plotsmoother_df <- map(DE_genes_freq, ~.x %>% filter(freq_btwn_don >= 3) %>% 
      select(donor, gene_id, Gene) %>% 
      distinct(., .keep_all = T) #%>% 
      # split(., f = factor(.$gene_id)) #%>%
      # map(., ~split(.x, f = factor(.$donor)))
      
    )
gns2plotsmoother_df
```

```{r, results='asis', warning=F, message=F, fig.width=5.5, fig.height=4}
unique(gns2plotsmoother_df[[1]]$Gene) %>% dput()
```

```{r, fig.width=10, fig.height=9}
## Previous fig size when we incorporating strains with a lower threshold of at least than 100 cells resulting in more cells. = fig.width=10, fig.height=15

df_curves_don2 <- gns2plotsmoother_df[[1]] %>% select(donor, gene_id) %>% left_join(., df_curves_don_all, by = c("donor", "gene_id")) 

gn_tble_gg_smoother_don2 <- gns2plotsmoother_df[[1]] %>% 
  select(donor, gene_id) %>% 
  left_join(., gn_tble_gg_smoother_don_all, by = c("donor", "gene_id"))  

ggplot(gn_tble_gg_smoother_don2, aes(x = slingPseudotime_1 , y = log1p(expression+1), colour = strain)) + 
                             geom_point(size = 0.5) +
                             geom_line(data = df_curves_don2, aes(x = time, y = log1p(yhat+1), colour = strain), linewidth = 1.5) +
                             facet_nested_wrap(vars(Gene, donor), scales = "free", ncol = 6) +
                             scale_colour_manual(values = strain_cols_n) +
  # labs(title = "Gene") +
  theme_classic2()+
                             theme(legend.position="bottom") +
      guides(color = guide_legend(override.aes = list(size = 3), title.position = "top", nrow = 1))
```

Heatmaps of sig genes examples

Heatmap plotting function

```{r, fig.width=7.5, fig.height=2}
## Direction of upregulation
# strain_up <- c('PF3D7-0400400' ='SC1', "PF3D7-0412400" ='SC1', 'PF3D7-0421300' ='SC5', "PF3D7-0412700" ='SC5', 'PF3D7-0712900' ='SC5', 'PF3D7-1041300' ='SC5', "PF3D7-0632800" ='SC5', 'PF3D7-0937800' ='SC5', 'PF3D7-1240600' ='SC5', 'PF3D7-1240400' ='SC5', 'PF3D7-0808700' ='SC5', 'PF3D7-0900100' ='N')
strain_up <- c('PF3D7-0400400' ='SC1', "PF3D7-0412400" ='SC1', 'PF3D7-0421300' ='SC5', "PF3D7-0412700" ='SC5', 'PF3D7-0712900' ='SC5', 'PF3D7-1041300' ='SC5', "PF3D7-0632800" ='SC5', 'PF3D7-0937800' ='SC5', 'PF3D7-1240600' ='SC5', 'PF3D7-1240400' ='SC5', 'PF3D7-0808700' ='SC5', 'PF3D7-0900100' ='SC1')
```
```{r, fig.width=7.5, fig.height=2}
## Direction of upregulation
mast_tde_corr_tbls


```

```{r, fig.width=7.5, fig.height=2}
## Ups group

var_grps <- c('PF3D7-0400400' ='A', "PF3D7-0412400" ='B/C', 'PF3D7-0421300' ='C', "PF3D7-0412700" ='C', 'PF3D7-0712900' ='B', 'PF3D7-1041300' ='B', "PF3D7-0632800" ='B', 'PF3D7-0937800' ='B', 'PF3D7-1240600' ='C', 'PF3D7-1240400' ='B/C', 'PF3D7-0808700' ='B/C', 'PF3D7-0900100' ='B')

# var_gn_info <- data.frame(strain_up) %>% 
#   rownames_to_column("gene_id") %>% 
#   left_join(., data.frame(var_grps) %>% rownames_to_column("gene_id"))

var_gn_info <- data.frame(var_grps) %>% rownames_to_column("gene_id")
```

```{r}
# gene_annot <- var_gn_info %>% mutate(across(strain_up, ~paste0("M49_", .))) %>% rename("Up" = strain_up, VAR = "var_grps") %>% select(-c(Up))
gene_annot <- var_gn_info %>% dplyr::rename(VAR = "var_grps") 

var_cols <- c("A" = "#8343b7" , "B/C" = "#a8253a", "B" =  "#b0921d", "C" = "#fd3a17", "OV" = "grey", "NV" = "lightgrey")
```

```{r}
### Annotation groups for the header ie column
# gns = cond_gns_de_asx[["MSC49C"]] %>% filter(pvalue < 0.05) %>% arrange(desc(waldStat)) %>%   mutate(wstat_rank = rank(-waldStat)) %>% filter(., wstat_rank < 20 | str_detect(Gene, "VAR")) %>% pull(gene_id)

gns = all_sig_gns_df[[1]] %>% filter(donor == "MSC49C") %>%
  pull(gene_id)

# print(str(gns))
##Edited from the original version to allow the labelling of rows with gene names
msc_yhatSmooth_w_annot <- predictSmooth(asex_bal_ts_plts[["MSC49C"]], gene = gns, nPoints = 30, tidy = FALSE) %>% 
  t() %>%scale() %>% t() %>% as.data.frame()%>% 
  rownames_to_column('gene_id') %>% 
  left_join(., Pf3D7_genes_plasmoDB  %>% dplyr::select("Gene", "gene_id", "Ka_Ks"), by = 'gene_id') %>% 
  left_join(., gene_annot, by = 'gene_id') %>%
  mutate(across(c("VAR"), ~case_when(is.na(.) & str_detect(Gene, "VAR") ~ "OV", 
                                     is.na(.) ~ "NV",
                                     T ~ .))) %>%
  mutate(Gene = case_when(is.na(Gene) ~ gene_id, T ~ Gene)) %>% 
  mutate(across(Gene, ~str_remove(., "VAR_"))) %>%
  dplyr::select(-c(gene_id)) %>% 
  column_to_rownames('Gene')

msc_yhatSmooth <- msc_yhatSmooth_w_annot %>% 
  dplyr::select(-c(Ka_Ks, VAR)) 

# print(str(msc_yhatSmooth))
msc_col_annot <- predictSmooth(asex_bal_ts_plts[["MSC49C"]], gene = gns, nPoints = 30, tidy = T)  %>% 
  mutate(point = paste0("point", rep(rep(1:30,length(unique(asex_bal_ts_plts[["MSC49C"]]@colData$tradeSeq$conditions))),length(gns))), 
         lin_id = paste0('lineage', lineage,'_condition', condition, '_',point)) %>%
  rownames_to_column('No')  %>% 
  dplyr::select(lin_id,time,condition)%>% 
  distinct()%>% 
  column_to_rownames('lin_id') %>%
  rename('Pseudotime' = time, 'Strain' = condition)
# print(str(msc_col_annot))

hmap2<- ComplexHeatmap::Heatmap(msc_yhatSmooth %>% as.data.frame() %>% as.matrix(),
                               cluster_columns = FALSE,
                               show_row_names = T, 
                               show_column_names = F, 
                               # main = comp_grps,
                               show_heatmap_legend = T,
                               # silent = TRUE,
                               left_annotation = rowAnnotation(df= msc_yhatSmooth_w_annot %>% select(VAR),
                                                               col = list(VAR = var_cols ),
                                                               annotation_name_gp = gpar(fontsize = 14, fontface = "bold"),
                                                               annotation_legend_param = list(Strain = list(title = "Strain"),
                                                                                               direction = "horizontal",
                                                                                               title_gp = gpar(fontsize = 12, fontface = "bold"),
                                                                                               labels_gp = gpar(fontsize = 12),
                                                                                               ncol = 3),
                                                                  show_legend = c(FALSE)),
                               top_annotation = HeatmapAnnotation(df= msc_col_annot %>% dplyr::select( Strain,Pseudotime) ,
                                                                  col = list(Strain = strain_don_cols[unique(msc_col_annot[, "Strain"])],
                                                                             Pseudotime = colorRamp2(c(min(msc_col_annot[,"Pseudotime"]), max(msc_col_annot[,"Pseudotime"])), c("white", "#281e5d"))), 
                                                                  annotation_name_gp = gpar(fontsize = 14, fontface = "bold"), 
                                                                  annotation_legend_param = list(Strain = list(title = "Strain"), 
                                                                                                 direction = "horizontal", 
                                                                                                 title_gp = gpar(fontsize = 12, fontface = "bold"), 
                                                                                                 labels_gp = gpar(fontsize = 12)),
                                                                  show_legend = c(T, FALSE) ##https://support.bioconductor.org/p/82447/
                               ),
                               # fontsize = 14,
                               # heatmap_legend_param = list(ncol = 1, nrow = 4, legend_direction = "vertical", by_row = T),
                               # heatmap_legend_param = list(direction = "horizontal", legend_gp = gpar(fontsize = lgsize)),
                               heatmap_legend_param = list(title = "Expression",
                                                           title_gp = gpar(fontsize = 12, fontface = "bold"),
                                                           labels_gp = gpar(fontsize = 12),
                                                           direction = "horizontal"#,
                                                           # direction = "vertical",
                                                           # labels_rot = 90#,
                                                           # grid_width = unit(6, "mm"),
                                                           # legend_width = unit(lg_width, "cm")
                               ),
                               row_names_gp = grid::gpar(fontsize = 14)
                               # 
) %>%
  ##Merging legends into 1 column. Could be set to F
  draw(., newpage = F, merge_legends = T, heatmap_legend_side = "bottom", annotation_legend_side = "bottom")



```

```{r, fig.height=8, fig.width=3.6}
hmap2
# c("#b7e577", "#3ce07e")
```


```{r, fig.width=10, fig.height=12}
# generated in 'm2_GO_all.Rmd'
all_sig_gns_df <- readRDS("data/processed/Pf/m2_all/strain_DE/all_sig_gns_df.RDS")
```


```{r, results='asis', warning=F, message=F, fig.width= 4, fig.height=3}
map(all_sig_gns_df, ~{.x %>% 
  arrange(desc(freq_btwn_don), Gene) %>%
  distinct(donor, gene_id, Gene, freq_btwn_don) %>%
  mutate(across(freq_btwn_don, factor)) %>% 
  distinct(gene_id, .keep_all = T) %>%
  count(freq_btwn_don) %>%
  ggplot(aes(x = freq_btwn_don, y = n)) +
  geom_col()+
  geom_text(aes(label=n), hjust=0.5, vjust= -0.3, size = 5, show.legend = F, fontface = 'bold')+
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  labs(x = "Frequency across donors", y = "DE gene count") +
  theme_classic() +
  theme(text = element_text(size = 17),
        axis.text = element_text(size = 16)) 
})
```

## Samples to be included in the paper
```{r, message=F, warning=F, eval=T}
key_samples <- c("MSC3", "MSC13", "MSC14", "MSC33C", "MSC40C", "MSC45", "MSC48C", "MSC49C", "MSC50_MACS", "MSC50_SLOC", "MSC53", "MSC54", "MSC57", "MSC60C", "MSC66C", "MSC67", "MSC68C", "MSC70C")

don_order <- str_remove(key_samples, "C$")
don_order_m <- str_remove_all(key_samples, "SC|C$")
```


```{r, fig.width=15, fig.height=5}
donor_mdata_slct <- readRDS("data/processed/Pf/m2_all/donor_mdata_slct.RDS")
donor_mdata_slct %>% glimpse
```


```{r, fig.width=15, fig.height=5}
donor_mdata_slct %>% filter(short_name %in% don_order) %>% count(symptomatic_dara_new, short_name, symptomatic, condition, fever, sympto_groups)
```


#################START Write stage markers DE to excel sheet for manuscript - may need own notebook ###############################


```{r, eval=T}
##!!!! NOTE - MANUSCRIPT MAST TRADESEQ DE table
##Preprocess the list of field_lab DE dfs with appropriate names to workbook with each stage as a sheet and add important metadata

mast_tde_de_export <- mast_tde_corr_tbls_sig %>% 
  map(., 
      ~dplyr::rename(., c('tradeseq_waldStat' = waldStat, 'tradeseq_pvalue' = pvalue)) %>% 
        dplyr::rename_with(., ~paste0('MAST_',.), c('p_val', 'avg_log2FC', 'pct.1', 'pct.2', 'p_val_adj')) ) %>%
  bind_rows(., .id = "donor") %>%
  select(donor, gene_id, Gene, everything()) %>%
  select(-c(mast)) %>%
  group_by(gene_id) %>%
  mutate(freq_btwn_don = n_distinct(donor)) %>%
  group_by(donor) %>%
  arrange(desc(abs(MAST_avg_log2FC)), .by_group = T) %>% 
  mutate(top_wstat_mast = ifelse((freq_btwn_don > 1 & tradeseq_waldStat > 50 & MAST_p_val_adj < 1e-20 & !str_detect(Gene, "VAR")), "yes", "no"))
  
mast_tde_de_export %>% ungroup() %>% count(freq_btwn_don)
mast_tde_de_export
```

```{r, results='asis', warning=F, message=F}
# mast_tde_de_export %>%
#   ungroup() %>%
#   mutate(top_wstat_mastLFC_noVAR = ifelse(freq_btwn_don > 1 & tradeseq_waldStat > 50 & MAST_p_val_adj < 1e-20 & !str_detect(Gene, "VAR"), "yes", "no")) %>%
#   slice_max()

```

```{r, eval=T}
mast_tde_de_export %>% 
  ungroup() %>% 
  arrange(desc(freq_btwn_don), Gene) %>%
  # distinct(donor, gene_id, Gene, freq_btwn_don) %>%
  # mutate(across(freq_btwn_don, factor)) %>% 
  distinct(gene_id, .keep_all = T) %>%
  count(freq_btwn_don)
```


```{r, eval=T}
##!!!! NOTE - MANUSCRIPT MAST TRADESEQ DE table
##Preprocess the list of field_lab DE dfs with appropriate names to workbook with each stage as a sheet and add important metadata
mast_tde_de_export_list <- list(mast_tde_de_export) %>% set_names(c("asexual within_donor DE genes"))

## Write out field versus lab and powered separate field and separate lab as RDS so as to include the GO analysis

##Export the list of field strain_strain DE dfs with appropriate names to workbook with each stage as a sheet
createWorksheet(mast_tde_de_export_list, "data/processed/Pf/m2_all/strain_DE/data S5 - Within-donor clones DE genes MAST & tradeseq DE.xlsx") 

```



```{r, eval=F}
##!!!! NOTE - MANUSCRIPT MAST TRADESEQ DE table
##Preprocess the list of field_lab DE dfs with appropriate names to workbook with each stage as a sheet and add important metadata
mast_tde_de_export <- mast_tde_corr_tbls %>% 
  map(., 
      # ~filter(., waldStat > 10 & p_val_adj <0.05 &(str_detect(pw_comparison, 'Field_vs_Lab') | str_detect(pw_comparison, 'SC._vs_SC.') | str_detect(pw_comparison, 'NF54_vs_7G8'))) %>% #WSTAT_OFF
      ~filter(., waldStat > 0 & p_val_adj <0.05 &(str_detect(pw_comparison, 'Field_vs_Lab') | str_detect(pw_comparison, 'SC._vs_SC.') | str_detect(pw_comparison, 'NF54_vs_7G8'))) %>%
        dplyr::rename(c('tradeseq_waldStat' = waldStat, 'tradeseq_pvalue' = pvalue)) %>% dplyr::rename_with(., ~paste0('MAST_',.), c('p_val', 'avg_log2FC', 'pct.1', 'pct.2', 'p_val_adj')) %>% left_join(.,Pf3D7_genes_plasmoDB %>% dplyr::select(gene_id, Gene), by = 'gene_id'))

names(mast_tde_de_export) <- str_replace_all(str_remove(names(mast_tde_de_export), 'FieldVlab_|lf_StrainsDE_'), c('asx'='Asexual DE', 'fh'='Female (HE) DE', 'fl'='Female (LE) DE', 'mh'='Male (HE) DE'))

##Export the list of field_lab DE dfs with appropriate names to workbook with each stage as a sheet
# createWorksheet(mast_tde_de_export[c(1,3:5)], "../Mali/v3_science_manuscript/tables/fvl_mast_tde_de_export.xlsx") 

## Write out field versus lab and powered separate field and separate lab as RDS so as to include the GO analysis
saveRDS(mast_tde_de_export[c(1:8, 25:28)], "../Mali/v3_science_manuscript/tables/fvl_n_powered_mast_tde_de_export.RDS")
  
##Get weak powered analysis
mast_tde_de_export_wk <- mast_tde_de_export[c(17:19,21:24)]

##Retain only weak SC6 comparisons in msc14 female
mast_tde_de_export_wk["MSC14_f_don"] <- map(mast_tde_de_export_wk["MSC14_f_don"],  ~filter(.x, str_detect(pw_comparison, "SC6")))

names(mast_tde_de_export_wk) <- paste0(2:(length(mast_tde_de_export_wk)+1), ".", str_replace_all(names(mast_tde_de_export_wk), c("f_don" = "female", "m_don" = "male")))

##Export the list of field strain_strain DE dfs with appropriate names to workbook with each stage as a sheet
# createWorksheet(mast_tde_de_export[c(17:24)], "../Mali/v3_science_manuscript/tables/data S13 - Field strains MAST & tradeseq DE.xlsx") 
createWorksheet(mast_tde_de_export_wk, "../Mali/v3_science_manuscript/tables/data S14 - Low confidence field strains MAST & tradeseq DE.xlsx") 
```



